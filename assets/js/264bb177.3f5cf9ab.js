"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[11886],{3905:(e,t,a)=>{a.d(t,{Zo:()=>h,kt:()=>p});var s=a(67294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,s)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,s,n=function(e,t){if(null==e)return{};var a,s,n={},i=Object.keys(e);for(s=0;s<i.length;s++)a=i[s],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)a=i[s],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var r=s.createContext({}),c=function(e){var t=s.useContext(r),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},h=function(e){var t=c(e.components);return s.createElement(r.Provider,{value:t},e.children)},g={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},u=s.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,r=e.parentName,h=o(e,["components","mdxType","originalType","parentName"]),u=c(a),p=n,d=u["".concat(r,".").concat(p)]||u[p]||g[p]||i;return a?s.createElement(d,l(l({ref:t},h),{},{components:a})):s.createElement(d,l({ref:t},h))}));function p(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,l=new Array(i);l[0]=u;var o={};for(var r in t)hasOwnProperty.call(t,r)&&(o[r]=t[r]);o.originalType=e,o.mdxType="string"==typeof e?e:n,l[1]=o;for(var c=2;c<i;c++)l[c]=a[c];return s.createElement.apply(null,l)}return s.createElement.apply(null,a)}u.displayName="MDXCreateElement"},54507:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>r,contentTitle:()=>l,default:()=>g,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var s=a(87462),n=(a(67294),a(3905));const i={sidebar_position:8070,slug:"2021-03-25",title:"Log all the searches going through Elasticsearch",authors:"mpolinowski",tags:["LINUX","Elasticsearch"]},l=void 0,o={unversionedId:"DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries/index",id:"DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries/index",title:"Log all the searches going through Elasticsearch",description:"Bakhtapur, Nepal",source:"@site/docs/DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries/index.md",sourceDirName:"DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries",slug:"/DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries/2021-03-25",permalink:"/docs/DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries/2021-03-25",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Elasticsearch",permalink:"/docs/tags/elasticsearch"}],version:"current",sidebarPosition:8070,frontMatter:{sidebar_position:8070,slug:"2021-03-25",title:"Log all the searches going through Elasticsearch",authors:"mpolinowski",tags:["LINUX","Elasticsearch"]},sidebar:"tutorialSidebar",previous:{title:"Elasticsearch 7 to log Linux System Events",permalink:"/docs/DevOps/Elasticsearch/2021-03-26-elasticsearch7-for-syslog-messages/2021-03-26"},next:{title:"Elasticsearch Cheat Sheet",permalink:"/docs/DevOps/Elasticsearch/2021-03-25-elasticsearch7-activate-logging-of-search-queries/elasticsearch-cheat-sheet"}},r={},c=[{value:"Enable logging of all searches",id:"enable-logging-of-all-searches",level:2},{value:"Inspecting the logs",id:"inspecting-the-logs",level:2},{value:"Disable logging of all searches",id:"disable-logging-of-all-searches",level:2},{value:"Logging Indexing Requests",id:"logging-indexing-requests",level:2},{value:"Working on the Live System",id:"working-on-the-live-system",level:2},{value:"Activate the search query logging",id:"activate-the-search-query-logging",level:3},{value:"Check that the logging is active",id:"check-that-the-logging-is-active",level:3}],h={toc:c};function g(e){let{components:t,...i}=e;return(0,n.kt)("wrapper",(0,s.Z)({},h,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Bakhtapur, Nepal",src:a(58444).Z,width:"1500",height:"542"})),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#enable-logging-of-all-searches"},"Enable logging of all searches")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#inspecting-the-logs"},"Inspecting the logs")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#disable-logging-of-all-searches"},"Disable logging of all searches")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#logging-indexing-requests"},"Logging Indexing Requests")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#working-on-the-live-system"},"Working on the Live System"),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#activate-the-search-query-logging"},"Activate the search query logging")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"#check-that-the-logging-is-active"},"Check that the logging is active"))))),(0,n.kt)("p",null,"I always wondered why there is no one-button-solution in Kibana to log all searches and indexation requests sent to Elasticsearch in the engine log file. It would be very helpful to see what users are searching for to add new tags:","[keywords]",' to articles that will position the "correct" article more prominent based on the search queries that are used.'),(0,n.kt)("h2",{id:"enable-logging-of-all-searches"},"Enable logging of all searches"),(0,n.kt)("p",null,"We are going to leverage the ",(0,n.kt)("strong",{parentName:"p"},"slowlog")," functionality.  The ",(0,n.kt)("strong",{parentName:"p"},"slowlog")," functions logs everything that takes to long to be processed. Since search queries are usually fast they tend not to show up. But we can lower the threshold making sure that they will be recorded. I am working with an index ",(0,n.kt)("inlineCode",{parentName:"p"},"apache-access-log")," that was created earlier. To change the settings for this index run the following command in Kibana:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'PUT apache-access-log/_settings\n{\n  "index.search.slowlog.threshold.query.trace": "0s",\n  "index.search.slowlog.level": "trace"\n}\n')),(0,n.kt)("p",null,"I am running a search query in Kibana for the IP address `49.149.224.133``and get 17 hits:"),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Elasticeasrch Log Search Queries",src:a(75936).Z,width:"1505",height:"909"})),(0,n.kt)("h2",{id:"inspecting-the-logs"},"Inspecting the logs"),(0,n.kt)("p",null,"My Elasticsearch container is running under the name ",(0,n.kt)("inlineCode",{parentName:"p"},"elasticsearch"),". To check it's logs I need to run the following command:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"docker logs elasticsearch\n")),(0,n.kt)("p",null,"And the log file shows a new entry at the bottom - this is our search query:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'{"type": "index_search_slowlog", "timestamp": "2021-08-04T05:37:26,667Z", "level": "TRACE", "component": "i.s.s.query", "cluster.name": "docker-cluster", "node.name": "debian11", "message": "[apache-access-log][0]", "took": "21.5ms", "took_millis": "21", "total_hits": "16 hits", "types": "[]", "stats": "[]", "search_type": "QUERY_THEN_FETCH", "total_shards": "1", "source": "{\\"size\\":500,\\"query\\":{\\"bool\\":{\\"filter\\":[{\\"multi_match\\":{\\"query\\":\\"49.149.224.133\\",\\"fields\\":[],\\"type\\":\\"best_fields\\",\\"operator\\":\\"OR\\",\\"slop\\":0,\\"prefix_length\\":0,\\"max_expansions\\":50,\\"lenient\\":true,\\"zero_terms_query\\":\\"NONE\\",\\"auto_generate_synonyms_phrase_query\\":true,\\"fuzzy_transpositions\\":true,\\"boost\\":1.0}}],\\"adjust_pure_negative\\":true,\\"boost\\":1.0}},\\"version\\":true,\\"_source\\":false,\\"stored_fields\\":\\"*\\",\\"fields\\":[{\\"field\\":\\"*\\",\\"include_unmapped\\":true},{\\"field\\":\\"@timestamp\\",\\"format\\":\\"strict_date_optional_time\\"},{\\"field\\":\\"read_timestamp\\",\\"format\\":\\"strict_date_optional_time\\"}],\\"script_fields\\":{},\\"sort\\":[{\\"_score\\":{\\"order\\":\\"desc\\"}}],\\"track_total_hits\\":2147483647,\\"highlight\\":{\\"pre_tags\\":[\\"@kibana-highlighted-field@\\"],\\"post_tags\\":[\\"@/kibana-highlighted-field@\\"],\\"fragment_size\\":2147483647,\\"fields\\":{\\"*\\":{}}}}", "id": "292795eb-82df-4bee-858d-254e4a1192d7", "cluster.uuid": "InACjldtRnu-vUy85P4txw", "node.id": "MsvdkSEdRBmBUftW7CciIw"  }\n')),(0,n.kt)("p",null,"The part we want is inside the ",(0,n.kt)("strong",{parentName:"p"},"source field"),". As it is JSON inside a JSON it\u2019s escaped, we just need to replace ",(0,n.kt)("inlineCode",{parentName:"p"},'\\"')," by ",(0,n.kt)("inlineCode",{parentName:"p"},'"')," and we are good to go:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'"{"size":500,"query":{"bool":{"filter":[{"multi_match":{"query":"49.149.224.133","fields":[],"type":"best_fields","operator":"OR","slop":0,"prefix_length":0,"max_expansions":50,"lenient":true,"zero_terms_query":"NONE","auto_generate_synonyms_phrase_query":true,"fuzzy_transpositions":true,"boost":1.0}}],"adjust_pure_negative":true,"boost":1.0}},"version":true,"_source":false,"stored_fields":"*","fields":[{"field":"*","include_unmapped":true},{"field":"@timestamp","format":"strict_date_optional_time"},{"field":"read_timestamp","format":"strict_date_optional_time"}],"script_fields":{},"sort":[{"_score":{"order":"desc"}}],"track_total_hits":2147483647,"highlight":{"pre_tags":["@kibana-highlighted-field@"],"post_tags":["@/kibana-highlighted-field@"],"fragment_size":2147483647,"fields":{"*":{}}}}"\n')),(0,n.kt)("p",null,"I copy the logfile to ",(0,n.kt)("inlineCode",{parentName:"p"},"/opt/logstash/elasticsearch.log")," and use the following Logstash configuration to ingest the log into Elasticsearch ",(0,n.kt)("inlineCode",{parentName:"p"},"/opt/logstash/pipeline/logstash.conf"),":"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'input {\n  file {\n    path => "/usr/share/logstash/elasticsearch.log"\n    start_position => "beginning"\n    sincedb_path => "/dev/null"\n  }\n}\nfilter {\n  json {\n      source => "message"\n  }\n}\noutput {\n   elasticsearch {\n     hosts => "http://localhost:9200"\n     index => "elasticsearch-log"\n  }\n\nstdout {}\n\n}\n')),(0,n.kt)("p",null,"And run Logstash with the new configuration file:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},'docker run \\\n   --name logstash \\\n   --net=host \\\n   --rm -it \\\n   -v /opt/logstash/pipeline/logstash.conf:/usr/share/logstash/pipeline/logstash.conf \\\n   -v /opt/logstash/elasticsearch.log:/usr/share/logstash/elasticsearch.log \\\n   -e "ELASTIC_HOST=localhost:9200" \\\n   -e "XPACK_SECURITY_ENABLED=false" \\\n   -e "XPACK_REPORTING_ENABLED=false" \\\n   -e "XPACK_MONITORING_ENABLED=false" \\\n   -e "XPACK_MONITORING_ELASTICSEARCH_USERNAME=elastic" \\\n   -e "XPACK_MONITORING_ELASTICSEARCH_PASSWORD=changeme" \\\n   logstash:7.13.4\n')),(0,n.kt)("p",null,"This will give me the following result:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'{\n          "source" => "{\\"size\\":500,\\"query\\":{\\"bool\\":{\\"filter\\":[{\\"multi_match\\":{\\"query\\":\\"49.149.224.133\\",\\"fields\\":[],\\"type\\":\\"best_fields\\",\\"operator\\":\\"OR\\",\\"slop\\":0,\\"prefix_length\\":0,\\"max_expansions\\":50,\\"lenient\\":true,\\"zero_terms_query\\":\\"NONE\\",\\"auto_generate_synonyms_phrase_query\\":true,\\"fuzzy_transpositions\\":true,\\"boost\\":1.0}}],\\"adjust_pure_negative\\":true,\\"boost\\":1.0}},\\"version\\":true,\\"_source\\":false,\\"stored_fields\\":\\"*\\",\\"fields\\":[{\\"field\\":\\"*\\",\\"include_unmapped\\":true},{\\"field\\":\\"@timestamp\\",\\"format\\":\\"strict_date_optional_time\\"},{\\"field\\":\\"read_timestamp\\",\\"format\\":\\"strict_date_optional_time\\"}],\\"script_fields\\":{},\\"sort\\":[{\\"_score\\":{\\"order\\":\\"desc\\"}}],\\"track_total_hits\\":2147483647,\\"highlight\\":{\\"pre_tags\\":[\\"@kibana-highlighted-field@\\"],\\"post_tags\\":[\\"@/kibana-highlighted-field@\\"],\\"fragment_size\\":2147483647,\\"fields\\":{\\"*\\":{}}}}",\n           "level" => "TRACE",\n       "component" => "i.s.s.query",\n            "path" => "/usr/share/logstash/elasticsearch.log",\n            "type" => "index_search_slowlog",\n         "node.id" => "MsvdkSEdRBmBUftW7CciIw",\n            "took" => "21.5ms",\n      "@timestamp" => 2021-08-04T09:32:57.956Z,\n            "host" => "debian11",\n       "node.name" => "debian11",\n       "timestamp" => "2021-08-04T05:37:26,667Z",\n           "types" => "[]",\n      "total_hits" => "16 hits",\n              "id" => "292795eb-82df-4bee-858d-254e4a1192d7",\n         "message" => "[apache-access-log][0]",\n    "cluster.uuid" => "InACjldtRnu-vUy85P4txw",\n           "stats" => "[]",\n        "@version" => "1",\n    "total_shards" => "1",\n     "search_type" => "QUERY_THEN_FETCH",\n     "took_millis" => "21",\n    "cluster.name" => "docker-cluster"\n}\n')),(0,n.kt)("p",null,"Now instead of removing all the lines that I don't need explicitly:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'mutate {\n    remove_field => ["level", "@timestamp", "path", "host", "@version" ...]\n  }\n')),(0,n.kt)("p",null,"I want to ",(0,n.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/logstash/current/plugins-filters-prune.html"},"use a whitelist to prune everything")," BUT the ",(0,n.kt)("inlineCode",{parentName:"p"},"source")," field:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'input {\n    file {\n      path => "/usr/share/logstash/elasticsearch.log"\n      start_position => "beginning"\n      sincedb_path => "/dev/null"\n    }\n  }\n  filter {\n    json {\n        source => "message"\n    }\n    prune {\n          interpolate => false\n          whitelist_names => ["source"]\n    }\n    ruby {\n      code => "\n        # Recursively remove `nil`s and empty objects from event\n        def remove_nils!(hash)\n          hash.each do |k, v|\n            if v.nil?\n              hash.delete(k)\n            elsif v.is_a?(Hash)\n              if v.empty?\n                hash.delete(k)\n              else\n                result = remove_nils!(v)\n                if result.empty?\n                  hash.delete(k)\n                else\n                  hash[k] = result\n                end\n              end\n            end\n          end\n        end\n        event_hash = event.to_hash\n        event.cancel\n        # This one could be improved, stay tuned!\n        new_event_block.call(\n          LogStash::Event.new(\n            remove_nils!(event_hash)\n          )\n        )\n        "\n    }\n  }\n  output {\n     elasticsearch {\n       hosts => "http://localhost:9200"\n       index => "elasticsearch-log"\n    }\n  \n  stdout {}\n  \n  }\n')),(0,n.kt)("p",null,"To delete the indexed data and re-run run Logstash with the new configuration:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"curl -XDELETE -u elastic:changeme http://localhost:9200/elasticsearch-log\n")),(0,n.kt)("p",null,'Note that "nasty bit" in the configuration named ruby I added because the pruning process left me with a lot of empty ',(0,n.kt)("inlineCode",{parentName:"p"},"{}")," outputs. I wanted to remove them... but it is not exactly working the way I want. I will have to get back to this later. But the important result is a cleaned up output:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'{\n      "@version" => "1",\n      "@timestamp" => 2021-08-04T10:13:52.032Z,\n      "source" => "{\\"size\\":500,\\"query\\":{\\"bool\\":{\\"filter\\":[{\\"multi_match\\":{\\"query\\":\\"49.149.224.133\\",\\"fields\\":[],\\"type\\":\\"best_fields\\",\\"operator\\":\\"OR\\",\\"slop\\":0,\\"prefix_length\\":0,\\"max_expansions\\":50,\\"lenient\\":true,\\"zero_terms_query\\":\\"NONE\\",\\"auto_generate_synonyms_phrase_query\\":true,\\"fuzzy_transpositions\\":true,\\"boost\\":1.0}}],\\"adjust_pure_negative\\":true,\\"boost\\":1.0}},\\"version\\":true,\\"_source\\":false,\\"stored_fields\\":\\"*\\",\\"fields\\":[{\\"field\\":\\"*\\",\\"include_unmapped\\":true},{\\"field\\":\\"@timestamp\\",\\"format\\":\\"strict_date_optional_time\\"},{\\"field\\":\\"read_timestamp\\",\\"format\\":\\"strict_date_optional_time\\"}],\\"script_fields\\":{},\\"sort\\":[{\\"_score\\":{\\"order\\":\\"desc\\"}}],\\"track_total_hits\\":2147483647,\\"highlight\\":{\\"pre_tags\\":[\\"@kibana-highlighted-field@\\"],\\"post_tags\\":[\\"@/kibana-highlighted-field@\\"],\\"fragment_size\\":2147483647,\\"fields\\":{\\"*\\":{}}}}"\n}\n')),(0,n.kt)("h2",{id:"disable-logging-of-all-searches"},"Disable logging of all searches"),(0,n.kt)("p",null,"To go back to the default configuration:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'PUT foobar/_settings\n{\n  "index.search.slowlog.threshold.query.trace": "500ms",\n  "index.search.slowlog.level": "info"\n}\n')),(0,n.kt)("h2",{id:"logging-indexing-requests"},"Logging Indexing Requests"),(0,n.kt)("p",null,"This is less common but we can do the same with the indexing options. Enabling slowlog with full source (warning this can be heavy):"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'PUT foobar/_settings\n{\n  "index.indexing.slowlog.threshold.index.trace": "0s",\n  "index.indexing.slowlog.level": "trace",\n  "index.indexing.slowlog.source": true\n}\n')),(0,n.kt)("p",null,"Getting back to the defaults:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'PUT foobar/_settings\n{\n  "index.indexing.slowlog.threshold.index.trace": "500ms",\n  "index.indexing.slowlog.level": "info",\n  "index.indexing.slowlog.source": "1000"\n}\n')),(0,n.kt)("h2",{id:"working-on-the-live-system"},"Working on the Live System"),(0,n.kt)("h3",{id:"activate-the-search-query-logging"},"Activate the search query logging"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'PUT index_2021_06_07/_settings\n{\n  "index.search.slowlog.threshold.query.trace": "0s",\n  "index.search.slowlog.level": "trace"\n}\n')),(0,n.kt)("h3",{id:"check-that-the-logging-is-active"},"Check that the logging is active"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"tail -f `docker inspect --format='{{.LogPath}}' elasticsearch_container`\n")),(0,n.kt)("p",null,"This command (replace the container name with the name of your Elasticsearch container) will print out log entries as they are written to the Elasticsearch logfile. Now run a search from your web frontend - it should show up like this:  ",(0,n.kt)("inlineCode",{parentName:"p"},'{"multi_match":{"query": "My Search Query",')),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},'{"log":"{\\"type\\": \\"index_search_slowlog\\", \\"timestamp\\": \\"2021-08-04T14:02:06,307Z\\", \\"level\\": \\"TRACE\\", \\"component\\": \\"i.s.s.query\\", \\"cluster.name\\": \\"docker-cluster\\", \\"node.name\\": \\"9954f7648983\\", \\"message\\": \\"[index_2021_06_07][0]\\", \\"took\\": \\"1.6ms\\", \\"took_millis\\": \\"1\\", \\"total_hits\\": \\"272 hits\\", \\"types\\": \\"[\\\\\\"_doc\\\\\\"]\\", \\"stats\\": \\"[]\\", \\"search_type\\": \\"QUERY_THEN_FETCH\\", \\"total_shards\\": \\"1\\", \\"source\\": \\"{\\\\\\"from\\\\\\":0,\\\\\\"size\\\\\\":5,\\\\\\"query\\\\\\":{\\\\\\"bool\\\\\\":{\\\\\\"must\\\\\\":[{\\\\\\"bool\\\\\\":{\\\\\\"must\\\\\\":[{\\\\\\"bool\\\\\\":{\\\\\\"should\\\\\\":[{\\\\\\"multi_match\\\\\\":{\\\\\\"query\\\\\\":\\\\\\"Port Weiterleitung AVM Fritzbox\\\\\\",\\\\\\"fields\\\\\\":[\\\\\\"abstract^5.0\\\\\\",\\\\\\"description^3.0\\\\\\",\\\\\\"tags^10.0\\\\\\",\\\\\\"title^8.0\\\\\\"],\\\\\\"type\\\\\\":\\\\\\"best_fields\\\\\\",\\\\\\"operator\\\\\\":\\\\\\"OR\\\\\\",\\\\\\"slop\\\\\\":0,\\\\\\"fuzziness\\\\\\":\\\\\\"1\\\\\\",\\\\\\"prefix_length\\\\\\":0,\\\\\\"max_expansions\\\\\\":50,\\\\\\"zero_terms_query\\\\\\":\\\\\\"NONE\\\\\\",\\\\\\"auto_generate_synonyms_phrase_query\\\\\\":true,\\\\\\"fuzzy_transpositions\\\\\\":true,\\\\\\"boost\\\\\\":1.0}},{\\\\\\"multi_match\\\\\\":{\\\\\\"query\\\\\\":\\\\\\"Port Weiterleitung AVM Fritzbox\\\\\\",\\\\\\"fields\\\\\\":[\\\\\\"abstract^5.0\\\\\\",\\\\\\"description^3.0\\\\\\",\\\\\\"tags^10.0\\\\\\",\\\\\\"title^8.0\\\\\\"],\\\\\\"type\\\\\\":\\\\\\"phrase\\\\\\",\\\\\\"operator\\\\\\":\\\\\\"OR\\\\\\",\\\\\\"slop\\\\\\":0,\\\\\\"prefix_length\\\\\\":0,\\\\\\"max_expansions\\\\\\":50,\\\\\\"zero_terms_query\\\\\\":\\\\\\"NONE\\\\\\",\\\\\\"auto_generate_synonyms_phrase_query\\\\\\":true,\\\\\\"fuzzy_transpositions\\\\\\":true,\\\\\\"boost\\\\\\":1.0}}],\\\\\\"adjust_pure_negative\\\\\\":true,\\\\\\"minimum_should_match\\\\\\":\\\\\\"1\\\\\\",\\\\\\"boost\\\\\\":1.0}}],\\\\\\"adjust_pure_negative\\\\\\":true,\\\\\\"boost\\\\\\":1.0}}],\\\\\\"adjust_pure_negative\\\\\\":true,\\\\\\"boost\\\\\\":1.0}},\\\\\\"_source\\\\\\":{\\\\\\"includes\\\\\\":[\\\\\\"*\\\\\\"],\\\\\\"excludes\\\\\\":[]}}\\", \\"cluster.uuid\\": \\"1F9RN9roSXqf1sa2Sam7yQ\\", \\"node.id\\": \\"bFc0o2JrTBqG0zf9Wydh3g\\"  }\\n","stream":"stdout","time":"2021-08-04T14:02:06.311539637Z"}\n')),(0,n.kt)("p",null,"Now I am going to check the file location of my ES container log:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"docker inspect --format='{{.LogPath}}' elasticsearch_container\n\n/var/lib/docker/containers/9954f76489836bf3def6cc49605f533439431dbcb5e06914eb457055fad54ebf/9954f76489836bf3def6cc49605f533439431dbcb5e06914eb457055fad54ebf-json.log                                       \n")),(0,n.kt)("p",null,"I copied the file and cleaned it up - removed all those annoying back-slashes! Also removed a few things trying to make the Log valid JSON... but what a mess those logs are! Really not happy with that."),(0,n.kt)("p",null,"Let's run Logstash with a regular Structured Data / JSON configuration and see what happens:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-json"},'input {\n  file {\n    path => "/usr/share/logstash/wiki_elasticseach_2021-08-05.json"\n    start_position => "beginning"\n    sincedb_path => "/dev/null"\n  }\n}\nfilter {\n  json {\n      source => "message"\n  }\n}\noutput {\n   elasticsearch {\n     hosts => "http://localhost:9200"\n     index => "elasticsearch-log-json"\n  }\n\nstdout {}\n\n}\n')),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},'docker run \\\n   --name logstash \\\n   --net=host \\\n   --rm -it \\\n   -v /opt/logstash/pipeline/logstash.conf:/usr/share/logstash/pipeline/logstash.conf \\\n   -v /opt/logstash/wiki_elasticseach_2021-08-05.json:/usr/share/logstash/wiki_elasticseach_2021-08-05.json \\\n   -e "ELASTIC_HOST=localhost:9200" \\\n   -e "XPACK_SECURITY_ENABLED=false" \\\n   -e "XPACK_REPORTING_ENABLED=false" \\\n   -e "XPACK_MONITORING_ENABLED=false" \\\n   -e "XPACK_MONITORING_ELASTICSEARCH_USERNAME=elastic" \\\n   -e "XPACK_MONITORING_ELASTICSEARCH_PASSWORD=changeme" \\\n   logstash:7.13.4\n')),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Elasticeasrch Log Search Queries",src:a(83495).Z,width:"1489",height:"567"})),(0,n.kt)("p",null,"To delete the indexed data:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},"curl -XDELETE -u elastic:changeme http://localhost:9200/elasticsearch-log-json\n")),(0,n.kt)("p",null,"I found the Docker Log hard to work with. I might try to activate the Elasticsearch SlowLog directly. Currently the ES instance logs to STDOUT and Docker writes it to file. So I end up with two structures wrapped around each other. Also the ES does not separate to different log files this way - everything is just one big blob of broken JSON."))}g.isMDXComponent=!0},75936:(e,t,a)=>{a.d(t,{Z:()=>s});const s=a.p+"assets/images/Elasticeasrch_Log_Search_Queries_01-35eb76128679470ab70e4dbfc53c4b6b.png"},83495:(e,t,a)=>{a.d(t,{Z:()=>s});const s=a.p+"assets/images/Elasticeasrch_Log_Search_Queries_02-5a30444fe043feb66fe4c5cbf41bdcec.png"},58444:(e,t,a)=>{a.d(t,{Z:()=>s});const s=a.p+"assets/images/photo-456tdsfggd_67gfh6dgdf4_d-ce46b6b3b5abb2f099879ac2721568d8.jpg"}}]);