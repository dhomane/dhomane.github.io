"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[65578],{3905:(e,a,t)=>{t.d(a,{Zo:()=>p,kt:()=>u});var n=t(67294);function o(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function r(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?r(Object(t),!0).forEach((function(a){o(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function i(e,a){if(null==e)return{};var t,n,o=function(e,a){if(null==e)return{};var t,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||(o[t]=e[t]);return o}(e,a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)t=r[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var s=n.createContext({}),c=function(e){var a=n.useContext(s),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},p=function(e){var a=c(e.components);return n.createElement(s.Provider,{value:a},e.children)},d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},m=n.forwardRef((function(e,a){var t=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),m=c(t),u=o,k=m["".concat(s,".").concat(u)]||m[u]||d[u]||r;return t?n.createElement(k,l(l({ref:a},p),{},{components:t})):n.createElement(k,l({ref:a},p))}));function u(e,a){var t=arguments,o=a&&a.mdxType;if("string"==typeof e||o){var r=t.length,l=new Array(r);l[0]=m;var i={};for(var s in a)hasOwnProperty.call(a,s)&&(i[s]=a[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var c=2;c<r;c++)l[c]=t[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}m.displayName="MDXCreateElement"},66297:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var n=t(87462),o=(t(67294),t(3905));const r={sidebar_position:8020,slug:"2021-08-08",title:"Nomad Access Control Lists",authors:"mpolinowski",tags:["Nomad","Linux"]},l=void 0,i={unversionedId:"DevOps/Hashicorp/2021-08-08--hashicorp-nomad-access-control-lists/index",id:"DevOps/Hashicorp/2021-08-08--hashicorp-nomad-access-control-lists/index",title:"Nomad Access Control Lists",description:"Central, Hongkong",source:"@site/docs/DevOps/Hashicorp/2021-08-08--hashicorp-nomad-access-control-lists/index.md",sourceDirName:"DevOps/Hashicorp/2021-08-08--hashicorp-nomad-access-control-lists",slug:"/DevOps/Hashicorp/2021-08-08--hashicorp-nomad-access-control-lists/2021-08-08",permalink:"/docs/DevOps/Hashicorp/2021-08-08--hashicorp-nomad-access-control-lists/2021-08-08",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-08-08--hashicorp-nomad-access-control-lists/index.md",tags:[{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:8020,frontMatter:{sidebar_position:8020,slug:"2021-08-08",title:"Nomad Access Control Lists",authors:"mpolinowski",tags:["Nomad","Linux"]},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Consul Refresher - Services",permalink:"/docs/DevOps/Hashicorp/2021-08-09--hashicorp-consul-services/2021-08-09"},next:{title:"Nomad Job Configuration",permalink:"/docs/DevOps/Hashicorp/2021-08-07--hashicorp-nomad-job-configuration/2021-08-07"}},s={},c=[{value:"Enabling Nomad ACLs",id:"enabling-nomad-acls",level:2},{value:"ACL Bootstrap",id:"acl-bootstrap",level:3},{value:"Create Management Tokens",id:"create-management-tokens",level:2},{value:"Updating a Token",id:"updating-a-token",level:3},{value:"Nomad ACL Policy",id:"nomad-acl-policy",level:2}],p={toc:c};function d(e){let{components:a,...r}=e;return(0,o.kt)("wrapper",(0,n.Z)({},p,r,{components:a,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Central, Hongkong",src:t(68762).Z,width:"1500",height:"544"})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#enabling-nomad-acls"},"Enabling Nomad ACLs"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#acl-bootstrap"},"ACL Bootstrap")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#create-management-tokens"},"Create Management Tokens"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#updating-a-token"},"Updating a Token")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#nomad-acl-policy"},"Nomad ACL Policy"))),(0,o.kt)("h2",{id:"enabling-nomad-acls"},"Enabling Nomad ACLs"),(0,o.kt)("p",null,"The ",(0,o.kt)("a",{parentName:"p",href:"https://www.nomadproject.io/docs/configuration/acl"},"acl stanza")," configures the Nomad agent to enable ACLs and tunes various ACL parameters. The APIs needed to manage policies and tokens are not enabled until ACLs are enabled. To begin, you need to enable the ACLs on the servers (master & minions):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/nomad.d/nomad.hcl\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'data_dir = "/opt/nomad/data"\nbind_addr = "0.0.0.0"\ndatacenter = "instaryun"\n\nacl {\n  enabled = true\n}\n')),(0,o.kt)("h3",{id:"acl-bootstrap"},"ACL Bootstrap"),(0,o.kt)("p",null,"Now restart the Nomad service on ",(0,o.kt)("strong",{parentName:"p"},"all servers")," (!) and bootstrap the ACLs from your master:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"sudo service nomad restart\nnomad acl bootstrap\n")),(0,o.kt)("p",null,"If you forget to add it to one of your servers, you will get the following error message when trying to bootstrap the ACLs:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nomad acl bootstrap\nError bootstrapping: Unexpected response code: 400 (ACL support disabled)\n")),(0,o.kt)("p",null,"The bootstrap command will print out your bootstrap token. Copy it's content and write it to file ",(0,o.kt)("inlineCode",{parentName:"p"},"bootstrap.token")," in your home directory - you can make it unreadable to other users with ",(0,o.kt)("inlineCode",{parentName:"p"},"chmod 600 bootstrap.token"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cfg"},"Accessor ID  = e02bd587-1f96-f60f-c79b-4c5beadae911\nSecret ID    = 3fffa295-5f90-acb2-3d47-8ac7add477a6\nName         = Bootstrap Token\nType         = management\nGlobal       = true\nPolicies     = n/a\nCreate Time  = 2021-08-29 13:41:08.988749307 +0000 UTC\nCreate Index = 5651\nModify Index = 5651\n")),(0,o.kt)("p",null,"Trying a Nomad command will now give you a permission error:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nomad node status\nError querying node status: Unexpected response code: 403 (Permission denied)\n")),(0,o.kt)("p",null,"Just like the TLS certs I will now add the ",(0,o.kt)("strong",{parentName:"p"},"Secret ID")," to my ",(0,o.kt)("inlineCode",{parentName:"p"},".bashrc"),", ",(0,o.kt)("inlineCode",{parentName:"p"},".bash_profile")," or whatever shell config you use (e.g. ",(0,o.kt)("inlineCode",{parentName:"p"},".zshrc"),"):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-cfg"},'## Nomad Environment Variables\nexport NOMAD_ADDR=https://localhost:4646\nexport NOMAD_CACERT=~/nomad_certs/nomad-ca.pem\nexport NOMAD_CLIENT_CERT=~/nomad_certs/cli.pem\nexport NOMAD_CLIENT_KEY=~/nomad_certs/cli-key.pem\nexport NOMAD_TOKEN="3fffa295-5f90-acb2-3d47-8ac7add477a6"\n')),(0,o.kt)("p",null,"Logout and back in or ",(0,o.kt)("inlineCode",{parentName:"p"},"source .zshrc")," and try again:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nomad node status\n\nID        DC         Name      Class   Drain  Eligibility  Status\n3d32b138  instaryun  debian11  <none>  false  eligible     ready\n")),(0,o.kt)("p",null,"And it works!"),(0,o.kt)("p",null,"We can inspect the active token with:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nomad acl token self\n\nAccessor ID  = e02bd587-1f96-f60f-c79b-4c5beadae911\nSecret ID    = 3fffa295-5f90-acb2-3d47-8ac7add477a6\nName         = Bootstrap Token\nType         = management\nGlobal       = true\nPolicies     = n/a\nCreate Time  = 2021-08-29 13:41:08.988749307 +0000 UTC\nCreate Index = 5651\nModify Index = 5651\n")),(0,o.kt)("h2",{id:"create-management-tokens"},"Create Management Tokens"),(0,o.kt)("p",null,"Once you have bootstrapped ACLs on the servers of the authoritative region, you can ",(0,o.kt)("a",{parentName:"p",href:"https://www.nomadproject.io/docs/commands/acl/token-create.html"},"create the replication tokens")," for all of the non-authoritative regions in a multi-region configuration. These tokens must be management-type tokens since they are used to communicate with ACL API in the authoritative region. Let's create a token for our Nomad UI:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad ACL Tokens",src:t(59118).Z,width:"1140",height:"396"})),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'nomad acl token create -type="management" -global=true -name="inyun_management"\n\nAccessor ID  = 3bddc836-4112-39c7-70f1-59394c964b88\nSecret ID    = 1e7cec46-26b1-4016-07c5-b56a645da2bf\nName         = inyun_management\nType         = management\nGlobal       = true\nPolicies     = n/a\nCreate Time  = 2021-08-29 14:15:14.118184124 +0000 UTC\nCreate Index = 5689\nModify Index = 5689\n')),(0,o.kt)("p",null,"The token was successfully added:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nomad acl token list\n\nName              Type        Global  Accessor ID\ninyun_management  management  true    3bddc836-4112-39c7-70f1-59394c964b88\nBootstrap Token   management  true    e02bd587-1f96-f60f-c79b-4c5beadae911\n")),(0,o.kt)("p",null,"Now all we need to do, is to load the ",(0,o.kt)("strong",{parentName:"p"},"Secret ID")," into the Nomad UI. Note that it will be stored in the local storage and disappear when you clear your browser history:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad ACL Tokens",src:t(41276).Z,width:"1136",height:"650"})),(0,o.kt)("h3",{id:"updating-a-token"},"Updating a Token"),(0,o.kt)("p",null,"You can update the ",(0,o.kt)("a",{parentName:"p",href:"https://www.nomadproject.io/docs/commands/acl/token-create#general-options"},"token options")," with the following commands:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'nomad acl token update -type="client" {TOKEN_ACCESSOR_ID}\n')),(0,o.kt)("h2",{id:"nomad-acl-policy"},"Nomad ACL Policy"),(0,o.kt)("p",null,"An ",(0,o.kt)("a",{parentName:"p",href:"https://learn.hashicorp.com/tutorials/nomad/access-control-policies?in=nomad/access-control"},"ACL policy")," contains one or more rules. Rules contain coarse-grained policy dispositions. Rules typically have several policy dispositions:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"read"),": allow the resource to be read but not modified"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"write"),": allow the resource to be read and modified"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"deny"),": do not allow the resource to be read or modified. Deny takes precedence when multiple policies are associated with a token."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("strong",{parentName:"li"},"list"),": allow the resource to be listed but not inspected in detail. Applies only to plugins.")),(0,o.kt)("p",null,"The coarse-grained policy dispositions are shorthand for the following fine- grained namespace capabilities:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Policy"),(0,o.kt)("th",{parentName:"tr",align:null},"Capabilities"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"deny"),(0,o.kt)("td",{parentName:"tr",align:null},"deny")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"read"),(0,o.kt)("td",{parentName:"tr",align:null},"list-jobs, read-job, csi-list-volume, csi-read-volume, list-scaling-policies, read-scaling-policy, read-job-scaling")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"write"),(0,o.kt)("td",{parentName:"tr",align:null},"list-jobs, read-job, submit-job, dispatch-job, read-logs, read-fs, alloc-exec, alloc-lifecycle, csi-write-volume, csi-mount-volume, list-scaling-policies, read-scaling-policy, read-job-scaling, scale-job")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"scale"),(0,o.kt)("td",{parentName:"tr",align:null},"list-scaling-policies, read-scaling-policy, read-job-scaling, scale-job")))),(0,o.kt)("p",null,"We can create a fine-grained profile that exactly matches a users demands - e.g. :"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Submit a Job: ",(0,o.kt)("inlineCode",{parentName:"li"},"submit-job")),(0,o.kt)("li",{parentName:"ol"},"Inspect the job: ",(0,o.kt)("inlineCode",{parentName:"li"},"read-job")),(0,o.kt)("li",{parentName:"ol"},"List running jobs: ",(0,o.kt)("inlineCode",{parentName:"li"},"list-job")),(0,o.kt)("li",{parentName:"ol"},"Dispatch jobs: ",(0,o.kt)("inlineCode",{parentName:"li"},"dispatch-job")),(0,o.kt)("li",{parentName:"ol"},"Check logs: ",(0,o.kt)("inlineCode",{parentName:"li"},"read-logs"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'namespace "default" {\n  capabilities = ["submit-job","list-jobs","read-job", "dispatch-job", "read-logs"]\n}\n')),(0,o.kt)("p",null,"When both the policy shorthand and a capabilities list are provided, the capabilities are merged. The following will give the user to wich this policy is applied all read rights and additionally the 3 rights that are listed under the ",(0,o.kt)("inlineCode",{parentName:"p"},"write")," policy:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'namespace "default" {\n  policy       = "read"\n  capabilities = ["submit-job","dispatch-job", "read-logs"]\n}\n')),(0,o.kt)("p",null,"I will create the policy in my home directory on the master server:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nano ~/nomad_certs/developer_policy.hcl\n")),(0,o.kt)("p",null,"To apply the policy:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'nomad acl policy apply -description="Developer Policy" developer developer_policy.hcl\nSuccessfully wrote "developer" ACL policy!\n')),(0,o.kt)("p",null,"The policy is now available:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"nomad acl policy list\nName       Description\ndeveloper  Developer Policy\n")),(0,o.kt)("p",null,"We can now create a ACL token that uses the developer policy:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'nomad acl token create -name="developer" -policy=developer -type=client > developer.token\n')))}d.isMDXComponent=!0},59118:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/Nomad_ACLs_01-c5d8a54fb494ad6193d8f2edb255bb11.png"},41276:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/Nomad_ACLs_02-baaee94408885beac9bf59d0610ea5df.png"},68762:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-7cd991afab591600e429487f495b9b94.jpg"}}]);