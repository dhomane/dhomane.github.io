"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[88586],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var r=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=p(n),m=a,h=u["".concat(s,".").concat(m)]||u[m]||d[m]||o;return n?r.createElement(h,i(i({ref:t},c),{},{components:n})):r.createElement(h,i({ref:t},c))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var p=2;p<o;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}u.displayName="MDXCreateElement"},88548:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>l,toc:()=>p});var r=n(87462),a=(n(67294),n(3905));const o={sidebar_position:9090,slug:"2017-12-24",title:"NGINX, Node.js & Security",authors:"mpolinowski",tags:["LINUX","NGINX"]},i=void 0,l={unversionedId:"DevOps/NGINX/2017-12-24--nginx-node-security/index",id:"DevOps/NGINX/2017-12-24--nginx-node-security/index",title:"NGINX, Node.js & Security",description:"Sydney, Australia",source:"@site/docs/DevOps/NGINX/2017-12-24--nginx-node-security/index.mdx",sourceDirName:"DevOps/NGINX/2017-12-24--nginx-node-security",slug:"/DevOps/NGINX/2017-12-24--nginx-node-security/2017-12-24",permalink:"/docs/DevOps/NGINX/2017-12-24--nginx-node-security/2017-12-24",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/NGINX/2017-12-24--nginx-node-security/index.mdx",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"NGINX",permalink:"/docs/tags/nginx"}],version:"current",sidebarPosition:9090,frontMatter:{sidebar_position:9090,slug:"2017-12-24",title:"NGINX, Node.js & Security",authors:"mpolinowski",tags:["LINUX","NGINX"]},sidebar:"tutorialSidebar",previous:{title:"NGINX Ingress with Cert-Manager",permalink:"/docs/DevOps/NGINX/2019-02-05--nginx-ingress-cert-manager/2019-02-05"},next:{title:"Using NGINX as proxy for your nodejs apps",permalink:"/docs/DevOps/NGINX/2017-10-01--using-nginx-as-proxy-for-your-nodejs-apps/2017-10-01"}},s={},p=[{value:"1 Useful links",id:"1-useful-links",level:2},{value:"2 Install Nginx and Adjust the Firewall",id:"2-install-nginx-and-adjust-the-firewall",level:2},{value:"3 FirewallD",id:"3-firewalld",level:2},{value:"4 Create a login",id:"4-create-a-login",level:2},{value:"5 nginx.conf",id:"5-nginxconf",level:2},{value:"6 virtual.conf",id:"6-virtualconf",level:2},{value:"7 GoDaddy Certs",id:"7-godaddy-certs",level:2},{value:"Generate a CSR and Private Key",id:"generate-a-csr-and-private-key",level:3},{value:"Download your key from GoDaddy",id:"download-your-key-from-godaddy",level:3},{value:"Install Certificate On Web Server",id:"install-certificate-on-web-server",level:3},{value:"8 LetsEncrypt and Certbot",id:"8-letsencrypt-and-certbot",level:2},{value:"Install Certbot on CentOS 7",id:"install-certbot-on-centos-7",level:3},{value:"Run Certbot",id:"run-certbot",level:3},{value:"Setting Up Auto Renewal",id:"setting-up-auto-renewal",level:3},{value:"Systemd",id:"systemd",level:4},{value:"Cron.d",id:"crond",level:4},{value:"TLS-SNI-01 challenge Deactivated",id:"tls-sni-01-challenge-deactivated",level:3},{value:"Troubleshooting",id:"troubleshooting",level:3}],c={toc:p};function d(e){let{components:t,...o}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Sydney, Australia",src:n(29677).Z,width:"1500",height:"764"})),(0,a.kt)("h1",{id:"using-nginx-as-proxy-for-your-nodejs-apps"},"Using NGINX as proxy for your nodejs apps"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"We want to set up NGINX with http/2 to serve multiple node apps and an instance of Elasticsearch on a single centOS server")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#using-nginx-as-proxy-for-your-nodejs-apps"},"Using NGINX as proxy for your nodejs apps"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#1-useful-links"},"1 Useful links")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#2-install-nginx-and-adjust-the-firewall"},"2 Install Nginx and Adjust the Firewall")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#3-firewalld"},"3 FirewallD")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#4-create-a-login"},"4 Create a login")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#5-nginxconf"},"5 nginx.conf")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#6-virtualconf"},"6 virtual.conf")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#7-godaddy-certs"},"7 GoDaddy Certs"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#generate-a-csr-and-private-key"},"Generate a CSR and Private Key")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#download-your-key-from-godaddy"},"Download your key from GoDaddy")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#install-certificate-on-web-server"},"Install Certificate On Web Server")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#8-letsencrypt-and-certbot"},"8 LetsEncrypt and Certbot"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#install-certbot-on-centos-7"},"Install Certbot on CentOS 7")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#run-certbot"},"Run Certbot")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#setting-up-auto-renewal"},"Setting Up Auto Renewal"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#systemd"},"Systemd")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#crond"},"Cron.d")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#tls-sni-01-challenge-deactivated"},"TLS-SNI-01 challenge Deactivated")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#troubleshooting"},"Troubleshooting"))))))),(0,a.kt)("h2",{id:"1-useful-links"},"1 Useful links"),(0,a.kt)("hr",null),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://kyup.com/tutorials/set-http-authentication-nginx/"},"Apache2-Utils")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.ssllabs.com/ssltest/"},"SSL Labs")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-with-http-2-support-on-ubuntu-16-04"},"Set up NGINX with http/2")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-on-centos-7/"},"Create a self-signed Certificate")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-centos-7"},"How To Secure Nginx with Let's Encrypt on CentOS 7")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html"},"Installing Elasticsearch")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.elastic.co/guide/en/kibana/current/install.html"},"Installing Kibana")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://www.elastic.co/downloads/x-pack"},"Installing X-Pack"))),(0,a.kt)("h2",{id:"2-install-nginx-and-adjust-the-firewall"},"2 Install Nginx and Adjust the Firewall"),(0,a.kt)("hr",null),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Step One")," \u2014 Nginx is not available in CentOS's default repositories - but we can install it from the EPEL (extra packages for Enterprise Linux) repository.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," sudo yum install epel-release\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Step Two")," \u2014 Next, we can install Nginx.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," sudo yum install nginx\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Step Three")," \u2014 Start the Nginx service and test it inside your browser http://server_domain_name_or_IP/")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," sudo systemctl start nginx\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Step Four")," \u2014 Check that the service is up and running by typing:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," systemctl status nginx\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Step Five")," \u2014 You will also want to enable Nginx, so it starts when your server boots:")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"}," sudo systemctl enable nginx\n")),(0,a.kt)("h2",{id:"3-firewalld"},"3 FirewallD"),(0,a.kt)("hr",null),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Step One")," \u2014 Installation")),(0,a.kt)("p",null,"Open ports 80 and 443 in ",(0,a.kt)("a",{parentName:"p",href:"http://www.firewalld.org/"},"FirewallD")),(0,a.kt)("p",null,"To start the service and enable FirewallD on boot:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl start firewalld\nsudo systemctl enable firewalld\n")),(0,a.kt)("p",null,"To stop and disable it:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl stop firewalld\nsudo systemctl disable firewalld\n")),(0,a.kt)("p",null,"Check the firewall status. The output should say either running or not running:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo firewall-cmd --state\n")),(0,a.kt)("p",null,"To view the status of the FirewallD daemon:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl status firewalld\n")),(0,a.kt)("p",null,"To reload a FirewallD configuration:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo firewall-cmd --reload\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("strong",{parentName:"li"},"Step Two")," \u2014 Configuration")),(0,a.kt)("p",null,"Add the http/s rule to the permanent set and reload FirewallD."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo firewall-cmd --zone=public --add-service=https --permanent\nsudo firewall-cmd --zone=public --add-service=http --permanent\nsudo firewall-cmd --reload\n")),(0,a.kt)("p",null,"Allow traffic / block traffic over ports:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo firewall-cmd --zone=public --add-port=12345/tcp --permanent\nsudo firewall-cmd --zone=public --remove-port=12345/tcp --permanent\n")),(0,a.kt)("p",null,"Verify open ports:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"firewall-cmd --list-ports\n")),(0,a.kt)("p",null,"Check the firewall status:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo firewall-cmd --state\n")),(0,a.kt)("p",null,"To view the status of the FirewallD daemon:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo systemctl status firewalld\n")),(0,a.kt)("p",null,"To reload a FirewallD configuration:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo firewall-cmd --reload\n")),(0,a.kt)("h2",{id:"4-create-a-login"},"4 Create a login"),(0,a.kt)("hr",null),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo htpasswd -c /etc/nginx/.htpasswd USERNAME\nNew password: xxxxxxxxx\nRe-type new password: xxxxxxxxx\n")),(0,a.kt)("h2",{id:"5-nginxconf"},"5 nginx.conf"),(0,a.kt)("p",null,"/etc/nginx/nginx.conf"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-nginx"},"user nginx;\nworker_processes 8;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] '$request' '\n                      '$status $body_bytes_sent '$http_referer' '\n                      ''$http_user_agent' '$http_x_forwarded_for'';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n    gzip on;\n    gzip_vary on;\n    gzip_proxied any;\n    gzip_comp_level 6;\n    gzip_buffers 16 8k;\n    gzip_http_version 1.1;\n    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n    # include /etc/nginx/sites-enabled/*;\n\n    # Hide nginx version token\n    server_tokens off;\n\n    # Configure buffer sizes\n    client_body_buffer_size 16k;\n    client_header_buffer_size 1k;\n    client_max_body_size 8m;\n    large_client_header_buffers 4 8k;\n\n}\n")),(0,a.kt)("h2",{id:"6-virtualconf"},"6 virtual.conf"),(0,a.kt)("p",null,"/etc/nginx/conf.d/virtual.conf"),(0,a.kt)("p",null,"Set up virtual server instances for our 2 node/express apps, Elasticsearch and Kibana"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-nginx"},"# redirect http/80 traffic to https/443 for our node apps\nserver {\n       listen         80;\n       listen    [::]:80;\n       server_name    example.de example2.de;\n       return         301 https://$server_name$request_uri;\n}\n\n# point to our first node app that is running on port 8888 and accept calls over https://example.de:443\nupstream myApp_en {\n    # point to the running node\n    server 127.0.0.1:8888;\n}\n\nserver {\n    # users using this port and domain will be directed to the node app defined above\n    # listen 80 default_server;\n    # listen [::]:80 default_server ipv6only=on;\n    listen 443 ssl http2 default_server;\n    listen [::]:443 ssl http2 default_server;\n    # If you want to run more then one node app, they either have to be assigned different web domains (server_name) or ports!\n    server_name example.de;\n\n    # Adding the SSL Certificates\n    ssl_prefer_server_ciphers on;\n    ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;\n    ssl_dhparam /etc/nginx/ssl/dhparam.pem;\n    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;\n    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;\n\n    # set the default public directory for your node\n    root /opt/myApp_en/build/public;\n\n    # Optimizing Nginx for Best Performance\n    ssl_session_cache shared:SSL:5m;\n    ssl_session_timeout 1h;\n\n    location / {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_set_header X-NginX-Proxy true;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_max_temp_file_size 0;\n        proxy_pass http://myApp_en;\n        proxy_redirect off;\n        proxy_read_timeout 240s;\n        # Authentication can be activated during development\n        # auth_basic 'Username and Password are required';\n        # the user login has to be generated\n        # auth_basic_user_file /etc/nginx/.htpasswd;\n    }\n\n    # use NGINX to cache static resources that are requested regularly\n    location ~* \\.(css|js|jpg|png|ico)$ {\n        expires 168h;\n    }\n}\n\n\n# point to our second node app that is running on port 8484 and accept calls over https://example2.de:443\nupstream myApp_de {\n    # point to the second running node\n    server 127.0.0.1:8484;\n}\n\nserver {\n    # users using this port and domain will be directed to the second node app\n    # listen 80;\n    # listen [::]:8080 ipv6only=on;\n    listen 443 ssl http2;\n    # The IPv6 address is unique - only one app can use the default port 443!\n    listen [::]:444 ssl http2;\n    server_name example2.de;\n\n    # adding the SSL Certificates\n    ssl_prefer_server_ciphers on;\n    ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;\n    ssl_dhparam /etc/nginx/ssl/dhparam.pem;\n    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;\n    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;\n\n    # set the default public directory for your second node\n    root /opt/myApp_de/build/public;\n\n    # optimizing Nginx for Best Performance\n    ssl_session_cache shared:SSL:5m;\n    ssl_session_timeout 1h;\n\n    location / {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_set_header X-NginX-Proxy true;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_max_temp_file_size 0;\n        proxy_pass http://myApp_de;\n        proxy_redirect off;\n        proxy_read_timeout 240s;\n        # auth_basic 'Username and Password are required';\n        # auth_basic_user_file /etc/nginx/.htpasswd;\n    }\n\n    # use NGINX to cache static resources that are requested regularly\n    location ~* \\.(css|js|jpg|png|ico)$ {\n        expires 168h;\n    }\n}\n\n\n# point to our Elasticsearch database that is running on port 9200 and accept calls over 8080\nupstream elasticsearch {\n    # point to the second running node\n    server 127.0.0.1:9200;\n}\n\nserver {\n    # users using this port will be directed to Elasticsearch\n    listen 8080;\n    listen [::]:8080 ipv6only=on;\n    server_name SERVER_IP_ADDRESS;\n\n    location / {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_set_header X-NginX-Proxy true;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_max_temp_file_size 0;\n        proxy_pass http://elasticsearch;\n        proxy_redirect off;\n        proxy_read_timeout 240s;\n        auth_basic 'Username and Password are required';\n        auth_basic_user_file /etc/nginx/.htpasswd;\n    }\n\n}\n\n# point to our Kibana instance that is running on port 5601 and accept calls over 8181\nserver {\n    # users using this port and will be directed to Elasticsearch/Kibana\n    listen 8181;\n    listen [::]:8181 ipv6only=on;\n\n    server_name SERVER_IP_ADDRESS;\n\n    auth_basic 'Restricted Access';\n    auth_basic_user_file /etc/nginx/.htpasswd;\n\n    location / {\n        proxy_pass http://localhost:5601;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_cache_bypass $http_upgrade;        \n    }\n\n}\n")),(0,a.kt)("h2",{id:"7-godaddy-certs"},"7 GoDaddy Certs"),(0,a.kt)("p",null,"When you ordered a wildcard certificate from goDaddy you will receive two files: Your SSL Certificate with a random name (Ex. 93rfs8dhf834hts.crt) and the GoDaddy intermediate certificate bundle (gd_bundle-g2-g1.crt). Lets install them on our server."),(0,a.kt)("h3",{id:"generate-a-csr-and-private-key"},"Generate a CSR and Private Key"),(0,a.kt)("p",null,"Create a folder to put all our ssl certificates:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"mkdir /etc/nginx/ssl\ncd /etc/nginx/ssl\n")),(0,a.kt)("p",null,"Generate our private key, called example.com.key, and a CSR, called example.com.csr:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"openssl req -newkey rsa:2048 -nodes -keyout example.com.key -out example.com.csr\n")),(0,a.kt)("p",null,"At this point, you will be prompted for several lines of information that will be included in your certificate request. The most important part is the Common Name field which should match the name that you want to use your certificate with\u200a\u2014\u200afor example, example.com, ",(0,a.kt)("a",{parentName:"p",href:"http://www.example.com"},"www.example.com"),", or (for a wildcard certificate request) ","[STAR]",".example.com."),(0,a.kt)("h3",{id:"download-your-key-from-godaddy"},"Download your key from GoDaddy"),(0,a.kt)("p",null,"The files you receive will look something like this:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"93rfs8dhf834hts.crt"),(0,a.kt)("li",{parentName:"ul"},"gd_bundle-g2-g1.crt")),(0,a.kt)("p",null,"Upload both to /etc/nginx/ssl directory and rename the first one to your domain name example.com.cst"),(0,a.kt)("h3",{id:"install-certificate-on-web-server"},"Install Certificate On Web Server"),(0,a.kt)("p",null,"You can use the following command to create a combined file from both GoDaddy files called example.com.chained.crt:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cat example.com.crt gd_bundle-g2-g1.crt > example.com.chained.crt\n")),(0,a.kt)("p",null,"And now you should change the access permission to this folder:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"cd /etc/nginx\nsudo chmod -R 600 ssl/\n")),(0,a.kt)("p",null,"To complete the configuration you have to make sure your NGINX config points to the right cert file and to the private key you generated earlier. Add the following lines inside the server block of your NGINX config:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-nginx"},"# adding the SSL Certificates\n  ssl_prefer_server_ciphers on;\n  ssl_ciphers EECDH+CHACHA20:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;\n    ssl_certificate /etc/nginx/ssl/example.com.chained.crt;\n    ssl_certificate_key /etc/nginx/ssl/example.com.key;\n")),(0,a.kt)("p",null,"Always test your configuration first:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"nginx -t\n")),(0,a.kt)("p",null,"and then reload:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"service nginx reload\n")),(0,a.kt)("h2",{id:"8-letsencrypt-and-certbot"},"8 LetsEncrypt and Certbot"),(0,a.kt)("h3",{id:"install-certbot-on-centos-7"},"Install Certbot on CentOS 7"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"yum install certbot-nginx")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Dependencies Resolved\n\n==============================================================================================\n Package                         Arch             Version                Repository      Size\n==============================================================================================\nInstalling:\n python2-certbot-nginx           noarch           0.14.1-1.el7           epel            52 k\nInstalling for dependencies:\n pyparsing                       noarch           1.5.6-9.el7            base            94 k\n\nTransaction Summary\n==============================================================================================\nInstall  1 Package (+1 Dependent package)\n\nComplete!\n")),(0,a.kt)("h3",{id:"run-certbot"},"Run Certbot"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"certbot --nginx -d wiki.instar.fr")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Saving debug log to /var/log/letsencrypt/letsencrypt.log\nEnter email address (used for urgent renewal and security notices) (Enter 'c' to\ncancel):\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},(0,a.kt)("a",{parentName:"strong",href:"mailto:myemail@email.com"},"myemail@email.com"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"-------------------------------------------------------------------------------\nPlease read the Terms of Service at\nhttps://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf. You must agree\nin order to register with the ACME server at\nhttps://acme-v01.api.letsencrypt.org/directory\n-------------------------------------------------------------------------------\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"(A)gree/(C)ancel: A")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Starting new HTTPS connection (1): supporters.eff.org\nObtaining a new certificate\nPerforming the following challenges:\ntls-sni-01 challenge for wiki.instar.fr\nWaiting for verification...\nCleaning up challenges\nDeployed Certificate to VirtualHost /etc/nginx/conf.d/virtual.conf for set(['wiki.instar.fr'])\n\nPlease choose whether HTTPS access is required or optional.\n-------------------------------------------------------------------------------\n1: Easy - Allow both HTTP and HTTPS access to these sites\n2: Secure - Make all requests redirect to secure HTTPS access\n-------------------------------------------------------------------------------\nSelect the appropriate number [1-2] then [enter] (press 'c' to cancel): 2\nThe appropriate server block is already redirecting traffic. To enable redirect anyway, uncomment the redirect lines in /etc/nginx/conf.d/virtual.conf.\n-------------------------------------------------------------------------------\nCongratulations! You have successfully enabled https://wiki.instar.fr\n-------------------------------------------------------------------------------\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"IMPORTANT NOTES:\n - Congratulations! Your certificate and chain have been saved at\n   /etc/letsencrypt/live/wiki.instar.fr/fullchain.pem. Your cert will\n   expire on 2017-12-13. To obtain a new or tweaked version of this\n   certificate in the future, simply run certbot again with the\n   'certonly' option. To non-interactively renew *all* of your\n   certificates, run 'certbot renew'\n - Your account credentials have been saved in your Certbot\n   configuration directory at /etc/letsencrypt. You should make a\n   secure backup of this folder now. This configuration directory will\n   also contain certificates and private keys obtained by Certbot so\n   making regular backups of this folder is ideal.\n")),(0,a.kt)("h3",{id:"setting-up-auto-renewal"},"Setting Up Auto Renewal"),(0,a.kt)("h4",{id:"systemd"},"Systemd"),(0,a.kt)("p",null,"Go to ",(0,a.kt)("em",{parentName:"p"},"/etc/systemd/system/")," and create the following two files"),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"certbot-nginx.service")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"[Unit]\nDescription=Renew Certbot certificates (nginx)\nAfter=network-online.target\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/certbot-2 renew --deploy-hook 'systemctl reload nginx'\n")),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"certbot-nginx.timer")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"[Unit]\nDescription=Renew Certbot certificate (nginx)\n\n[Timer]\nOnCalendar=daily\nPersistent=true\nRandomizedDelaySec=86400\n\n[Install]\nWantedBy=multi-user.target\n")),(0,a.kt)("p",null,"Now activate the service"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"$ systemctl daemon-reload\n$ systemctl start certbot-nginx.service  # to run manually\n$ systemctl enable --now certbot-nginx.timer  # to use the timer\n")),(0,a.kt)("h4",{id:"crond"},"Cron.d"),(0,a.kt)("p",null,"Add Certbot renewal to Cron.d in /etc/cron.d - we want to run it twice daily at 13:22 and 04:17:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"# Example of job definition:\n# .---------------- minute (0 - 59)\n# |  .------------- hour (0 - 23)\n# |  |  .---------- day of month (1 - 31)\n# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...\n# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat\n# |  |  |  |  |\n# *  *  *  *  * user-name command to be executed\n\n17 4 * * * /usr/bin/certbot-2 renew --quiet\n22 13 * * * /usr/bin/certbot-2 renew --quiet\n")),(0,a.kt)("h3",{id:"tls-sni-01-challenge-deactivated"},"TLS-SNI-01 challenge Deactivated"),(0,a.kt)("p",null,"If you are receiving the following error when trying to add a certificate to your domain:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"Client with the currently selected authenticator does not support any combination of challenges that will satisfy the CA.\n")),(0,a.kt)("p",null,"Follow the Instructions given ",(0,a.kt)("a",{parentName:"p",href:"https://community.letsencrypt.org/t/solution-client-with-the-currently-selected-authenticator-does-not-support-any-combination-of-challenges-that-will-satisfy-the-ca/49983"},"here")," and if you\u2019re serving files for that domain out of a directory on that server, you can run the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo certbot --authenticator webroot --webroot-path <path to served directory> --installer nginx -d <domain>\n")),(0,a.kt)("p",null,"If you\u2019re not serving files out of a directory on the server, you can temporarily stop your server while you obtain the certificate and restart it after Certbot has obtained the certificate. This would look like:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo certbot --authenticator standalone --installer nginx -d <domain> --pre-hook 'service nginx stop' --post-hook 'service nginx start'\n")),(0,a.kt)("p",null,"e.g."),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Create your virtual server conf - the given config below routes an node/express app running on localhost:7777 with a public directory in /opt/mysite-build/app :")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-nginx"},"server {\n       listen         80;\n       listen    [::]:80;\n       server_name    my.domain.com;\n       return         301 https://$server_name$request_uri;\n}\n\nupstream app_test {\n    # point to the running node\n    server 127.0.0.1:7777;\n}\n\nserver {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n    server_name my.domain.com;\n    \n    # set the default public directory for your node\n    root /opt/mysite-build/app;\n    \n    # Optimizing Nginx for Best Performance\n    ssl_session_cache shared:SSL:5m;\n    ssl_session_timeout 1h;\n    \n    location / {\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $http_host;\n        proxy_set_header X-NginX-Proxy true;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_max_temp_file_size 0;\n        proxy_pass http://wiki2_test;\n        proxy_redirect off;\n        proxy_read_timeout 240s;\n    }\n    \n    # use NGINX to cache static resources that are requested regularly\n    location ~* \\.(css|js|jpg|png|ico)$ {\n        expires 168h;\n    }\n\n}\n")),(0,a.kt)("p",null,"Test your your site by opening my.domain.com inside your browser - you should be automatically redirected to ",(0,a.kt)("a",{parentName:"p",href:"https://my.domain.com"},"https://my.domain.com")," and be given a certificate warning. Click to proceed anyway to access your site."),(0,a.kt)("p",null,"Now run:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"sudo certbot --authenticator webroot --webroot-path /opt/mysite-build/app --installer nginx -d my.domain.com\n")),(0,a.kt)("p",null,"certbot will modify your NGINX config automatically!"),(0,a.kt)("h3",{id:"troubleshooting"},"Troubleshooting"),(0,a.kt)("p",null,"You can test run the auto renewal with the following command:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"certbot renew --dry-run\n")),(0,a.kt)("p",null,"This will show you if your certificate would be renewed automatically or not. The latter looks like this:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Certbot Error",src:n(85962).Z,width:"812",height:"206"})),(0,a.kt)("p",null,"Trying to renew or repair the certificate by typing ",(0,a.kt)("inlineCode",{parentName:"p"},"certbot renew")," and choosing the problematic cert did not solve the problem - for some reason the script could not restart NGINX afterwards and caused the webserver to crash. There is a script to remove the cert:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"certbot delete\n")),(0,a.kt)("p",null,"But this did not remove the certbot entries inside the NGINX server block - causing the webserver to crash again:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ssl_certificate /etc/letsencrypt/live/wiki.instar.fr/fullchain.pem; # managed by Certbot\nssl_certificate_key /etc/letsencrypt/live/wiki.instar.fr/privkey.pem; # managed by Certbot\n")),(0,a.kt)("p",null,"After manually removing them and running certbot again to add a certificate:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"certbot --nginx\n")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Certbot: Install Certificate",src:n(43028).Z,width:"649",height:"249"})),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Certbot: Install Certificate",src:n(59097).Z,width:"691",height:"292"})),(0,a.kt)("p",null,"...everything seems to be fine now (?)"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Certbot: Install Certificate",src:n(56902).Z,width:"646",height:"178"})))}d.isMDXComponent=!0},85962:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/certbot_01-34e7d0c63624d63917d4694caa18d8fe.png"},43028:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/certbot_02-6a91f93c3b4f39408f0f33aede187e20.png"},59097:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/certbot_03-da04eda47bac02cc0133d842a5b6cfef.png"},56902:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/certbot_04-2e52742c8550e2db1b79aefd0e5bb207.png"},29677:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/photo-34139903180_fd0c397abc_o-e310c4f5ef105421603a97c4f9ce3f5c.png"}}]);