"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[11842],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>m});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(t),m=r,g=d["".concat(s,".").concat(m)]||d[m]||u[m]||i;return t?a.createElement(g,o(o({ref:n},p),{},{components:t})):a.createElement(g,o({ref:n},p))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=t[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},72807:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var a=t(87462),r=(t(67294),t(3905));const i={sidebar_position:7050,slug:"2021-04-13",title:"Setting up KVM on RedHat Enterprise Linux",authors:"mpolinowski",tags:["LINUX"]},o=void 0,l={unversionedId:"DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/index",id:"DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/index",title:"Setting up KVM on RedHat Enterprise Linux",description:"Shenzhen, China",source:"@site/docs/DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/index.md",sourceDirName:"DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux",slug:"/DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/2021-04-13",permalink:"/docs/DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/2021-04-13",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Linux/2021-04-13-installing-kvm-on-red-hat-enterprise-linux/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:7050,frontMatter:{sidebar_position:7050,slug:"2021-04-13",title:"Setting up KVM on RedHat Enterprise Linux",authors:"mpolinowski",tags:["LINUX"]},sidebar:"tutorialSidebar",previous:{title:"Installing Deb Packages on RHEL8",permalink:"/docs/DevOps/Linux/2021-04-14-using-deb-files-on-rhel8/2021-04-14"},next:{title:"Gnome3 Cheat Sheet",permalink:"/docs/DevOps/Linux/2021-04-12-gnome3-cheat-sheet/2021-04-12"}},s={},c=[{value:"Preparing RHEL",id:"preparing-rhel",level:2},{value:"Install and Enable KVM",id:"install-and-enable-kvm",level:3},{value:"Create a VM instance on KVM",id:"create-a-vm-instance-on-kvm",level:3},{value:"Create a Linux Bridge",id:"create-a-linux-bridge",level:4},{value:"Start your VM",id:"start-your-vm",level:4},{value:"Install Virtual machine Manager GUI",id:"install-virtual-machine-manager-gui",level:3}],p={toc:c};function u(e){let{components:n,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Shenzhen, China",src:t(26483).Z,width:"1500",height:"675"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#preparing-rhel"},"Preparing RHEL"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#install-and-enable-kvm"},"Install and Enable KVM")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#create-a-vm-instance-on-kvm"},"Create a VM instance on KVM"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#create-a-linux-bridge"},"Create a Linux Bridge")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#start-your-vm"},"Start your VM")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#install-virtual-machine-manager-gui"},"Install Virtual machine Manager GUI"))))),(0,r.kt)("h2",{id:"preparing-rhel"},"Preparing RHEL"),(0,r.kt)("p",null,"Check if your CPU supports virtualization:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"lscpu | grep Virtualization\n\n> Virtualization: VT-x\n")),(0,r.kt)("h3",{id:"install-and-enable-kvm"},"Install and Enable KVM"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo yum update\nsudo yum install @virt\n")),(0,r.kt)("p",null,"Verify that Kernel modules are loaded:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"$ lsmod | grep kvm\n\n> kvm_intel 315392 0\n> kvm 847872 1 kvm_intel\n> irgqbypass 16384 1 kvm\n")),(0,r.kt)("p",null,"Now we can install a few tools for virtual machine management:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo dnf -y install libvirt-devel virt-top libguestfs-tools\n")),(0,r.kt)("p",null,"By default, KVM daemon libvirtd is not started, start the service using the command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo systemctl enable --now libvirtd\nservice libvirtd status\n")),(0,r.kt)("p",null,"Open TCP port ",(0,r.kt)("inlineCode",{parentName:"p"},"5901")," if your server has a firewall set up:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --add-port=5901/tcp\nfirewall-cmd --reload\n")),(0,r.kt)("h3",{id:"create-a-vm-instance-on-kvm"},"Create a VM instance on KVM"),(0,r.kt)("p",null,"First, start by creating a network bridge to be attached to your instances. In Linux networking, a bridge is used to connect two or more network segments. It is commonly used in Virtualization to pass Virtual Machines traffic through a hypervisor network card. All guest machines connected to a network bridge will treat it transparently as a physical network interface."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Linux Bridges")," behave like a virtual network switch and any physical or virtual device can be connected to the bridge."),(0,r.kt)("h4",{id:"create-a-linux-bridge"},"Create a Linux Bridge"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo nmcli connection show\n\nNAME     UUID                                  TYPE      DEVICE\nenp3s0   27ff1bfd-3ec2-4300-bc71-06e9e9a7457c  ethernet  enp3s0\ndocker0  dc5707f4-ae30-481e-8866-d08dfe7e6400  bridge    docker0\nvirbr0   91177751-4bcf-45a5-bba9-b1ec99f44887  bridge    virbr0\n")),(0,r.kt)("p",null,"I only have one Ethernet interface ",(0,r.kt)("inlineCode",{parentName:"p"},"enp3s0"),". I will copy the configuration file and change the device type to ",(0,r.kt)("strong",{parentName:"p"},"Bridge"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo cp /etc/sysconfig/network-scripts/ifcfg-enp3s0 /etc/sysconfig/network-scripts/ifcfg-br1\n\ncat /etc/sysconfig/network-scripts/ifcfg-br1\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},"TYPE=Bridge\nDEVICE=br1\nDELAY=0\nSTP=off\nIPV4_FAILURE_FATAL=no\nIPV6INIT=no\nNAME=br1\nONBOOT=yes\nIPADDR=192.168.2.110\nPREFIX=24\nGATEWAY=192.168.2.5\nDNS1=192.168.2.5\nDNS2=8.8.8.8\nIPV6_PRIVACY=no\n")),(0,r.kt)("p",null,"Interface configuration file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo nano /etc/sysconfig/network-scripts/ifcfg-enp3s0\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},"DEVICE=enp3s0\nTYPE=Ethernet\nONBOOT=yes\nBRIDGE=br1\n")),(0,r.kt)("p",null,"Now reboot your system and check if the bridge was created:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo nmcli connection show\n\nNAME           UUID                                  TYPE      DEVICE\nbr1            2ee981ca-5ff4-4f9b-03fe-32879aa3dc85  bridge    br1\ndocker0        d25f4cc0-d675-4338-b758-455df4c8f30d  bridge    docker0\nvirbr0         c2e570e7-415b-4c86-af86-aaf9c5a1e0fc  bridge    virbr0\nSystem enp3s0  63aa2036-8665-f54d-9a92-c3035bad03f7  ethernet  enp3s0\n")),(0,r.kt)("h4",{id:"start-your-vm"},"Start your VM"),(0,r.kt)("p",null,"You an check all available operating systems with:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"osinfo-query os\n")),(0,r.kt)("p",null,"The list was outdated for me - I first checked if the latest version of ",(0,r.kt)("inlineCode",{parentName:"p"},"osinfo-db-tools")," was installed, downloaded the latest list and imported it:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'sudo yum install osinfo-db-tools\nwget -O "/tmp/osinfo-db.tar.xz" "https://releases.pagure.org/libosinfo/osinfo-db-20210621.tar.xz"\nsudo osinfo-db-import --local "/tmp/osinfo-db.tar.xz"\n')),(0,r.kt)("p",null,"After the update the list included the latest version of Operating System and I was able to create a Fedora 34 VM with the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo virt-install \\\n--name fed34 \\\n--ram 2048 \\\n--vcpus 2 \\\n--disk path=/var/lib/libvirt/images/fed34.img,size=20 \\\n--os-variant fedora34 \\\n--os-type linux \\\n--network bridge=br1 \\\n--graphics none \\\n--console pty,target_type=serial \\\n--location 'https://mirror.arizona.edu/fedora/linux/releases/34/Server/x86_64/os/' \\\n--extra-args 'console=ttyS0,115200n8 serial'\n")),(0,r.kt)("p",null,"ERROR:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'[FAILED] Failed to start Switch Root.\nWarning: /dev/root does not exist\n\nGenerating "/run/initramfs/rdsosreport.txt"\n\n\nEntering emergency mode. Exit the shell to continue.\nType "journalctl" to view system logs.\nYou might want to save "/run/initramfs/rdsosreport.txt" to a USB stick or /boot\nafter mounting them and attach it to a bug report.\n\n\nPress Enter for maintenance\n(or press Control-D to continue):\n')),(0,r.kt)("p",null,"After running into the Error message above I tried downloading the image myself and switched to CentOS 8 - ",(0,r.kt)("a",{parentName:"p",href:"http://isoredirect.centos.org/centos/8-stream/isos/x86_64/"},"Download Page"),". Make sure to move the image to a public directory like ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo virt-install \\\n--name CentOS \\\n--location=/opt/CentOS-Stream-8-x86_64-20210706-dvd1.iso \\\n--ram 2048 \\\n--vcpus 2 \\\n--disk path=/var/lib/libvirt/images/centos.img,size=20 \\\n--os-variant rhel6.0 \\\n--os-type linux \\\n--network bridge=br1 \\\n--graphics none \\\n--console pty,target_type=serial \\\n--extra-args 'console=ttyS0,115200n8 serial' \\\n--check path_in_use=off\n")),(0,r.kt)("p",null,"And this time it worked:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'Performing post-installation setup tasks\n.\nConfiguring installed system\n...................\nWriting network configuration\n.\nCreating users\nConfiguring addons\nExecuting org_fedora_oscap addon\nExecuting com_redhat_kdump addon\n..\nGenerating initramfs\n...\nRunning post-installation scripts\n.\nStoring configuration files and kickstarts\n.\nInstallation complete\n\nUse of this product is subject to the license agreement found at:\n/usr/share/redhat-release/EULA\n\nInstallation complete. Press ENTER to quit:\n\n\n...\n\n\nCentOS Stream 8\nKernel 4.18.0-315.el8.x86_64 on an x86_64\n\nActivate the web console with: systemctl enable --now cockpit.socket\n\ncentos login: myuser\nPassword: mypassword\n\ncat /etc/os-release\n\nNAME="CentOS Stream"\nVERSION="8"\nID="centos"\nID_LIKE="rhel fedora"\nVERSION_ID="8"\nPLATFORM_ID="platform:el8"\nPRETTY_NAME="CentOS Stream 8"\nANSI_COLOR="0;31"\nCPE_NAME="cpe:/o:centos:centos:8"\nHOME_URL="https://centos.org/"\nBUG_REPORT_URL="https://bugzilla.redhat.com/"\nREDHAT_SUPPORT_PRODUCT="Red Hat Enterprise Linux 8"\nREDHAT_SUPPORT_PRODUCT_VERSION="CentOS Stream"\n')),(0,r.kt)("h3",{id:"install-virtual-machine-manager-gui"},"Install Virtual machine Manager GUI"),(0,r.kt)("p",null,"If you have a Desktop Environment on your RHEL 8, you can install the virt-manager tool which allows you to manage Virtual Machines from a GUI."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo yum -y install virt-manager\n")),(0,r.kt)("p",null,"We can now use the Virtual Machine Manager to take control of our virtual environment."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"KVM and RHEL",src:t(37709).Z,width:"1084",height:"565"})),(0,r.kt)("p",null,"At this point I hit another problem - somehow my virtual machine was not connected to a network. It was not assigned an IP address after boot. I will have to dive a bit deeper into this at a later point."))}u.isMDXComponent=!0},37709:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/KVM_and_RHEL_01-133556e43f3f0c37b187b94b857ac493.png"},26483:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/photo-456tdsfggd_67gfh6dgdf4_d-def3899d6748c796fd9f6350dab6e523.jpg"}}]);