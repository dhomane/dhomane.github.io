"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[67998],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>h});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=c(a),h=r,m=u["".concat(l,".").concat(h)]||u[h]||p[h]||i;return a?n.createElement(m,o(o({ref:t},d),{},{components:a})):n.createElement(m,o({ref:t},d))}));function h(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=a[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},62026:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var n=a(87462),r=(a(67294),a(3905));const i={sidebar_position:7080,slug:"2022-02-03",title:"Elasticsearch v8, Filebeat (Docker) and NGINX",authors:"mpolinowski",tags:["LINUX","Elasticsearch"]},o=void 0,s={unversionedId:"DevOps/Elasticsearch/2022-02-03--elasticsearch-v8-data-ingestion/index",id:"DevOps/Elasticsearch/2022-02-03--elasticsearch-v8-data-ingestion/index",title:"Elasticsearch v8, Filebeat (Docker) and NGINX",description:"Shenzhen, China",source:"@site/docs/DevOps/Elasticsearch/2022-02-03--elasticsearch-v8-data-ingestion/index.md",sourceDirName:"DevOps/Elasticsearch/2022-02-03--elasticsearch-v8-data-ingestion",slug:"/DevOps/Elasticsearch/2022-02-03--elasticsearch-v8-data-ingestion/2022-02-03",permalink:"/docs/DevOps/Elasticsearch/2022-02-03--elasticsearch-v8-data-ingestion/2022-02-03",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Elasticsearch/2022-02-03--elasticsearch-v8-data-ingestion/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Elasticsearch",permalink:"/docs/tags/elasticsearch"}],version:"current",sidebarPosition:7080,frontMatter:{sidebar_position:7080,slug:"2022-02-03",title:"Elasticsearch v8, Filebeat (Docker) and NGINX",authors:"mpolinowski",tags:["LINUX","Elasticsearch"]},sidebar:"tutorialSidebar",previous:{title:"Elasticsearch & Kibana v8 Search Cheat Sheet",permalink:"/docs/DevOps/Elasticsearch/2022-02-04--kibana-v8-search-queries/2022-02-04"},next:{title:"Performing an Elasticsearch v8 Upgrade",permalink:"/docs/DevOps/Elasticsearch/2022-02-02--elasticsearch-v8-upgrade/2022-02-02"}},l={},c=[{value:"Setting Up Elasticsearch &amp; Kibana",id:"setting-up-elasticsearch--kibana",level:2},{value:"Setting up Filebeats",id:"setting-up-filebeats",level:2},{value:"Run the Filebeat Setup",id:"run-the-filebeat-setup",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Add Kibana Dashboard",id:"add-kibana-dashboard",level:3},{value:"Enable and configure data collection modules",id:"enable-and-configure-data-collection-modules",level:3},{value:"Prepare the Filebeat Container",id:"prepare-the-filebeat-container",level:4},{value:"Check the NGINX Module",id:"check-the-nginx-module",level:4},{value:"Monitor NGINX in Docker",id:"monitor-nginx-in-docker",level:3},{value:"Alternative ?",id:"alternative-",level:4},{value:"Monitor Elasticsearch in Docker",id:"monitor-elasticsearch-in-docker",level:3}],d={toc:c};function p(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,n.Z)({},d,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Shenzhen, China",src:a(49056).Z,width:"1500",height:"403"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#setting-up-elasticsearch--kibana"},"Setting Up Elasticsearch & Kibana")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#setting-up-filebeats"},"Setting up Filebeats"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#run-the-filebeat-setup"},"Run the Filebeat Setup")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#configuration"},"Configuration")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#add-kibana-dashboard"},"Add Kibana Dashboard")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#enable-and-configure-data-collection-modules"},"Enable and configure data collection modules"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#prepare-the-filebeat-container"},"Prepare the Filebeat Container")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#check-the-nginx-module"},"Check the NGINX Module")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#monitor-nginx-in-docker"},"Monitor NGINX in Docker"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#alternative-"},"Alternative ?")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#monitor-elasticsearch-in-docker"},"Monitor Elasticsearch in Docker"))))),(0,r.kt)("h2",{id:"setting-up-elasticsearch--kibana"},"Setting Up Elasticsearch & Kibana"),(0,r.kt)("p",null,"I will use the ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Elasticsearch/2022-02-02--elasticsearch-v8-upgrade/2022-02-02"},"Elasticsearch compose file from here"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'version: \'3.8\'\n\nservices:\n  elasticsearch:\n    container_name: elasticsearch\n    restart: always\n    build:\n      context: elasticsearch/\n      args:\n        ELK_VERSION: $ELK_VERSION\n    volumes:\n      - type: bind\n        source: ./elasticsearch/config/elasticsearch.yml\n        target: /usr/share/elasticsearch/config/elasticsearch.yml\n        read_only: true\n      - type: volume\n        source: elasticsearch\n        target: /usr/share/elasticsearch/data\n    ports:\n      - "9200:9200"\n      - "9300:9300"\n    environment:\n      ES_JAVA_OPTS: \'-Xms2g -Xmx2g\'\n      ELASTIC_PASSWORD: \'changeme\'\n      discovery.type: single-node\n    networks:\n      elastic:\n        ipv4_address: 172.16.239.102\n        aliases:\n          - elasticsearch\n\n  kibana:\n    container_name: kibana\n    restart: unless-stopped\n    build:\n      context: kibana/\n      args:\n        ELK_VERSION: $ELK_VERSION\n    volumes:\n      - type: bind\n        source: ./kibana/config/kibana.yml\n        target: /usr/share/kibana/config/kibana.yml\n        read_only: true\n    ports:\n      - "5601:5601"\n    networks:\n      elastic:\n        ipv4_address: 172.16.239.104\n        aliases:\n          - kibana\n    depends_on:\n      - elasticsearch\n\nnetworks:\n  elastic:\n    driver: bridge\n    driver_opts:\n      com.docker.network.enable_ipv6: "false"\n    ipam:\n      driver: default\n      config:\n        - subnet: 172.16.239.0/24\n\nvolumes:\n  elasticsearch:\n')),(0,r.kt)("p",null,"Start the service with ",(0,r.kt)("inlineCode",{parentName:"p"},"docker-compose up -d"),". Elasticsearch will start with the following configuration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'---\n## Default Elasticsearch configuration from Elasticsearch base image.\n## https://github.com/elastic/elasticsearch/blob/master/distribution/docker/src/docker/config/elasticsearch.yml\n#\ncluster.name: "docker-cluster"\n# network.host: _site_\nnetwork.host: 0.0.0.0\n\n## X-Pack settings\n## see https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-xpack.html\n#\n# xpack.license.self_generated.type: trial\nxpack.license.self_generated.type: basic\nxpack.security.enabled: true\nxpack.monitoring.collection.enabled: true\nxpack.security.authc:\n    anonymous:\n      username: anonymous_user \n      roles: search_agent\n      authz_exception: true \n\n## CORS\nhttp.cors.enabled : true\nhttp.cors.allow-origin: "*"\nhttp.cors.allow-methods: OPTIONS, HEAD, GET, POST, PUT, DELETE\nhttp.cors.allow-credentials: true\nhttp.cors.allow-headers: X-Requested-With, X-Auth-Token, Content-Type, Content-Length, Authorization, Access-Control-Allow-Headers, Accept\n')),(0,r.kt)("h2",{id:"setting-up-filebeats"},"Setting up Filebeats"),(0,r.kt)("p",null,"Start by pulling the a fresh version of Filebeat:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker pull elastic/filebeat:8.0.0\n")),(0,r.kt)("h3",{id:"run-the-filebeat-setup"},"Run the Filebeat Setup"),(0,r.kt)("p",null,"Running Filebeat with the setup command will create the index pattern and load visualizations , dashboards, and machine learning jobs. Run this command:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"Note"),": If you set up Elasticsearch according to ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Elasticsearch/2022-02-02--elasticsearch-v8-upgrade/2022-02-02"},"this guide"),", you will have a different ",(0,r.kt)("inlineCode",{parentName:"p"},"elastic")," user password - e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"ELASTIC_PASSWORD: 'a1hyme+ry1-AltBfpqxY'"),".")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'docker run \\\n-E setup.kibana.host=kibana:5601 \\\n-E output.elasticsearch.hosts=["elasticsearch:9200"] \\\n-E output.elasticsearch.username=elastic \\\n-E output.elasticsearch.password=changeme \\\nelastic/filebeat:8.0.0\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ERROR"),": This step did not work for me. I keep getting the error message ",(0,r.kt)("inlineCode",{parentName:"p"},"no matches found: output.elasticsearch.hosts=[elasticsearch:9200]"),". I already added the ",(0,r.kt)("inlineCode",{parentName:"p"},"username")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"password")," that were missing in the ",(0,r.kt)("a",{parentName:"p",href:"https://www.elastic.co/guide/en/beats/filebeat/current/running-on-docker.html#_run_the_filebeat_setup"},"official documentation"),". Is this step still necessary in version 8 since the new ",(0,r.kt)("strong",{parentName:"p"},"Datastream")," tab is automatically populated with the Filebeat data? I am missing the default Filebeat dashboard though - if there is supposed to be one with that name."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"UPDATE"),": You can manually activate the Kibana integration once you started the container - see ",(0,r.kt)("a",{parentName:"p",href:"#add-kibana-dashboard"},"Add Kibana Dashboard"),". I don't think this step is still necessary:"),(0,r.kt)("p",null,"I will create a folder:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p /opt/beats/config/\n")),(0,r.kt)("p",null,"and continue working from there."),(0,r.kt)("h3",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"When running Filebeat in a container, you need to provide access to Docker\u2019s unix socket in order for the add_docker_metadata processor to work. You can do this by mounting the socket inside the container. For example:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"docker run -v /var/run/docker.sock:/var/run/docker.sock ...")),(0,r.kt)("p",null,"To avoid privilege issues, you may also need to add --user=root to the docker run flags. Because the user must be part of the docker group in order to access /var/run/docker.sock, root access is required if Filebeat is running as non-root inside the container."),(0,r.kt)("p",null,"If Docker daemon is restarted the mounted socket will become invalid and metadata will stop working, in these situations there are two options:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Restart Filebeat every time Docker is restarted"),(0,r.kt)("li",{parentName:"ul"},"Mount the entire /var/run directory (instead of just the socket)")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'processors:\n  - add_docker_metadata:\n      host: "unix:///var/run/docker.sock"\n      #match_fields: ["system.process.cgroup.id"]\n      #match_pids: ["process.pid", "process.parent.pid"]\n      #match_source: true\n      #match_source_index: 4\n      #match_short_id: true\n      #cleanup_timeout: 60\n      #labels.dedot: false\n      # To connect to Docker over TLS you must specify a client and CA certificate.\n      #ssl:\n      #  certificate_authority: "/etc/pki/root/ca.pem"\n      #  certificate:           "/etc/pki/client/cert.pem"\n      #  key:  \n')),(0,r.kt)("p",null,"It has the following settings:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null}),(0,r.kt)("th",{parentName:"tr",align:null}))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"host"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"(Optional)")," Docker socket (UNIX or TCP socket). It uses unix:///var/run/docker.sock by default.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ssl"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"(Optional)")," SSL configuration to use when connecting to the Docker socket.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"match_fields"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"(Optional)")," A list of fields to match a container ID, at least one of them should hold a container ID to get the event enriched.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"match_pids"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"(Optional)")," A list of fields that contain process IDs. If the process is running in Docker then the  event will be enriched. The default value is ",'["process.pid", "process.parent.pid"]',".")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"match_source"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"(Optional)")," Match container ID from a log path present in the log.file.path field. Enabled by  default.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"match_short_id"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"(Optional)")," Match container short ID from a log path present in the log.file.path field. Disabled  by default. This allows to match directories names that have the first 12 characters of the container ID. For example, /var/log/containers/b7e3460e2b21/*.log.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"match_source_index"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"(Optional)")," Index in the source path split by / to look for container ID. It defaults to 4 to  match /var/lib/docker/containers/<container_id>/*.log")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"cleanup_timeout"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"(Optional)")," Time of inactivity to consider we can clean and forget metadata for a container, 60s  by default.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"labels.dedot"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("em",{parentName:"td"},"(Optional)")," Default to be false. If set to true, replace dots in labels with _.")))),(0,r.kt)("p",null,"But I think I am just going to use CLI flags to mount the docker socket as volumes. This simplifies the configuration to:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nano /opt/beats/config/filebeat.yml\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"filebeat.config:\n  modules:\n    path: ${path.config}/modules.d/*.yml # enable all modules (nginx, kafka, redis, etc)\n    reload.enabled: false\n\nfilebeat.autodiscover: # auto-discover tagged docker container\n  providers:\n    - type: docker\n      hints.enabled: true\n\nsetup:\n  kibana.host: \"http://localhost:5601\"\n  dashboards.enable: true\n\n# processors:\n# - add_cloud_metadata: ~ # for AWS, GCO, Azure etc.\n# - add_docker_metadata: ~ # add docker metadata (container id, name, image and labels)\n\noutput.elasticsearch:\n  hosts: 'http://localhost:9200'\n  username: 'elastic'\n  password: 'changeme'\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"Note"),": If you set up Elasticsearch according to ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Elasticsearch/2022-02-02--elasticsearch-v8-upgrade/2022-02-02"},"this guide"),", you will have a different ",(0,r.kt)("inlineCode",{parentName:"p"},"elastic")," user password - e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"ELASTIC_PASSWORD: 'a1hyme+ry1-AltBfpqxY'"),".")),(0,r.kt)("p",null,"The beat configuration file must belong to the ",(0,r.kt)("inlineCode",{parentName:"p"},"root")," user and all write permissions for other users must be revoked:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"chown root:root /opt/beats/config/filebeat.yml\nchmod go-w /opt/beats/config/filebeat.yml\n")),(0,r.kt)("p",null,"Now we need to bind the location of docker container directory ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/lib/docker/containers")," and our docker socket ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/run/docker.sock")," to the container:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -d \\\n  --name filebeat \\\n  --user root \\\n  --net=host \\\n  -v /opt/beats/config/filebeat.yml:/usr/share/filebeat/filebeat.yml \\\n  -v /var/lib/docker/containers:/var/lib/docker/containers:ro \\\n  -v /var/run/docker.sock:/var/run/docker.sock:ro \\\n  elastic/filebeat:8.0.0\n")),(0,r.kt)("p",null,"Check if everything started up:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'{"log.level":"info","@timestamp":"2022-02-21T04:46:17.294Z","log.origin":{"file.name":"instance/beat.go","file.line":332},"message":"Setup Beat: filebeat; Version: 8.0.0","service.name":"filebeat","ecs.version":"1.6.0"}\n{"log.level":"info","@timestamp":"2022-02-21T04:46:17.295Z","log.logger":"esclientleg","log.origin":{"file.name":"eslegclient/connection.go","file.line":105},"message":"elasticsearch url: http://localhost:9200","service.name":"filebeat","ecs.version":"1.6.0"}\n{"log.level":"info","@timestamp":"2022-02-21T04:46:17.296Z","log.logger":"publisher","log.origin":{"file.name":"pipeline/module.go","file.line":113},"message":"Beat name: nomad-minion","service.name":"filebeat","ecs.version":"1.6.0"}\n{"log.level":"info","@timestamp":"2022-02-21T04:46:17.298Z","log.origin":{"file.name":"fileset/modules.go","file.line":103},"message":"Enabled modules/filesets:  ()","service.name":"filebeat","ecs.version":"1.6.0"}\n{"log.level":"info","@timestamp":"2022-02-21T04:46:17.298Z","log.logger":"monitoring","log.origin":{"file.name":"log/log.go","file.line":142},"message":"Starting metrics logging every 30s","service.name":"filebeat","ecs.version":"1.6.0"}\n')),(0,r.kt)("h3",{id:"add-kibana-dashboard"},"Add Kibana Dashboard"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"UPDATE"),": You can already setup the dashboards using the Filebeat config with ",(0,r.kt)("inlineCode",{parentName:"p"},"setup.dashboards.enable: true")," I added this line to the configuration file above!"),(0,r.kt)("p",null,"To load the recommended index template for writing to Elasticsearch and deploy the sample dashboards for visualizing the data in Kibana, use the command that works with your system."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker exec -ti filebeat /bin/bash\n\n\n./filebeat setup --dashboards\nLoading dashboards (Kibana must be running and reachable)\nLoaded dashboards\n")),(0,r.kt)("p",null,"The Filebeat ",(0,r.kt)("strong",{parentName:"p"},"Data View")," is now listed in Kibana:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Elasticsearch v8 Filebeats",src:a(38559).Z,width:"1176",height:"595"})),(0,r.kt)("p",null,"I can see results come in in ",(0,r.kt)("strong",{parentName:"p"},"Discover"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Elasticsearch v8 Filebeats",src:a(74968).Z,width:"1432",height:"536"})),(0,r.kt)("p",null,"There are also plenty of ",(0,r.kt)("inlineCode",{parentName:"p"},"Filebeat*")," ",(0,r.kt)("strong",{parentName:"p"},"Dashboards")," loaded. But so far no interesting data to fill them with."),(0,r.kt)("h3",{id:"enable-and-configure-data-collection-modules"},"Enable and configure data collection modules"),(0,r.kt)("h4",{id:"prepare-the-filebeat-container"},"Prepare the Filebeat Container"),(0,r.kt)("p",null,"Since we are running Filebeat in Docker, of course this log path does not exist. We have to modify the command that we used to start the Docker container to mount our NGINX logs into the container. The NGINX logs might be found in the ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/log/nginx")," directory - depending on your NGINX configuration. But I just copied a few logs onto my test system ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/beats/logs"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"-v /opt/beats/logs:/var/log/nginx:ro\n")),(0,r.kt)("p",null,"And secondly, we need to mount our module configuration file. The template configuration is located inside the Filebeat container under ",(0,r.kt)("inlineCode",{parentName:"p"},"/usr/share/filebeat/modules.d/nginx.yml.disabled"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'# Module: nginx\n# Docs: https://www.elastic.co/guide/en/beats/filebeat/master/filebeat-module-nginx.html\n\n- module: nginx\n  # Access logs\n  access:\n    enabled: true\n    var.paths: ["/var/log/nginx/access.log*"]\n\n  # Error logs\n  error:\n    enabled: true\n    var.paths: [ "/var/log/nginx/error.log*" ]\n\n  # Ingress-nginx controller logs. This is disabled by default. It could be used in Kubernetes environments to parse ingress-nginx logs\n  ingress_controller:\n    enabled: false\n\n    # Set custom paths for the log files. If left empty,\n    # Filebeat will choose the paths depending on your OS.\n    #var.paths:\n')),(0,r.kt)("p",null,"save this file under ",(0,r.kt)("inlineCode",{parentName:"p"},"nginx.yml")," next to your ",(0,r.kt)("inlineCode",{parentName:"p"},"filebeat.yml")," and mount it into the ",(0,r.kt)("inlineCode",{parentName:"p"},"modules.d")," configuration folder - the complete docker command now looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -d \\\n  --name filebeat \\\n  --user root \\\n  --net=host \\\n  --restart unless-stopped \\\n  -v /opt/beats/config/filebeat.yml:/usr/share/filebeat/filebeat.yml \\\n  -v /opt/beats/config/nginx.yml:/usr/share/filebeat/modules.d/nginx.yml \\\n  -v /var/lib/docker/containers:/var/lib/docker/containers:ro \\\n  -v /var/run/docker.sock:/var/run/docker.sock:ro \\\n  -v /opt/beats/logs:/var/log/nginx:ro \\\n  elastic/filebeat:8.0.0\n")),(0,r.kt)("p",null,"Restart the container and verify that the logs and module configuration was actually mounted:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker exec -ti filebeat /bin/bash\n\n/usr/share/filebeat# ls -la /var/log/nginx/\n-rwxrwxrwx 1 root root  9634840 Feb 21 03:47 access.log\n-rwxrwxrwx 1 root root    12225 Feb 21 03:47 error.log\n\nls -la /usr/share/filebeat/modules.d | grep nginx\n-rw-r--r-- 1 root root   613 Feb 22 05:54 nginx.yml\n-rw-r--r-- 1 root root   788 Feb  3 18:06 nginx.yml.disabled\n")),(0,r.kt)("h4",{id:"check-the-nginx-module"},"Check the NGINX Module"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Verify that the NGINX modules was actually enable. To see a list of available modules, run:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker exec -ti filebeat /bin/bash\n\n\n/usr/share/filebeat# ./filebeat modules list\nEnabled:\nnginx\n\nDisabled:\nactivemq apache auditd aws awsfargate azure barracuda bluecoat cef checkpoint cisco coredns crowdstrike cyberarkpas cylance elasticsearch envoyproxy f5 fortinet gcp google_workspace haproxy ibmmq icinga iis imperva infoblox iptables juniper kafka kibana logstash microsoft misp mongodb mssql mysql mysqlenterprise nats netflow netscout nginx o365 okta oracle osquery panw pensando postgresql proofpoint rabbitmq radware redis santa snort snyk sonicwall sophos squid suricata system threatintel tomcat traefik zeek zookeeper zoom zscaler\n")),(0,r.kt)("p",null,"To manually activate or deactivate modules run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"./filebeat modules enable nginx\n")),(0,r.kt)("p",null,"To test your configuration file, change to the directory where the Filebeat binary is installed, and run Filebeat in the foreground with the following options specified:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"./filebeat test config -e\nConfig OK\n")),(0,r.kt)("p",null,"The documentation I found says that you now should run the setup command to load the available dashboards. I am not sure if this is still necessary since I already did this in the previous step. But running the command returns a ",(0,r.kt)("inlineCode",{parentName:"p"},"Loaded Ingest pipelines")," - sounds good ~"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"./filebeat setup -e\nLoaded Ingest pipelines\n")),(0,r.kt)("p",null,"I can see all the NGINX related data points in ",(0,r.kt)("strong",{parentName:"p"},"Data Views"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Elasticsearch v8 Filebeats",src:a(82810).Z,width:"1376",height:"859"})),(0,r.kt)("p",null,"Switching to the ",(0,r.kt)("strong",{parentName:"p"},"Discover")," I first cannot see anything. But I have to select a time window that matches the date in my logs - by default you only see the last 15 minutes. Drilling in I find my log data from yesterday:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Elasticsearch v8 Filebeats",src:a(26476).Z,width:"1383",height:"371"})),(0,r.kt)("p",null,"Under ",(0,r.kt)("strong",{parentName:"p"},"Dashboards")," I now open the NGINX Access & Error Log template:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Elasticsearch v8 Filebeats",src:a(81184).Z,width:"1277",height:"524"})),(0,r.kt)("p",null,"And can start analyzing my data:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Elasticsearch v8 Filebeats",src:a(38890).Z,width:"1375",height:"875"})),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Elasticsearch v8 Filebeats",src:a(39448).Z,width:"2550",height:"886"})),(0,r.kt)("h3",{id:"monitor-nginx-in-docker"},"Monitor NGINX in Docker"),(0,r.kt)("p",null,"Configure filebeat to read the StdOut und StdErr stream of your NGINX container:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'filebeat.autodiscover:\n  providers:\n    - type: docker\n      hints.enabled: true\n      templates:\n        - condition.contains:\n            docker.container.image: nginx\n          config:\n            - module: nginx\n              access.input:\n                type: docker\n                containers:\n                  ids: "${data.docker.container.id}"\n                  stream: "stdout"\n              error.input:\n                type: docker\n                containers:\n                  ids: "${data.docker.container.id}"\n                  stream: "stderr"\n')),(0,r.kt)("p",null,"Run the Filebeat container inside the same Docker network as your NGINX container:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -d \\\n  --name filebeat \\\n  --user root \\\n  --network mynetwork \\\n  --restart unless-stopped \\\n  -v /opt/beats/config/filebeat.yml:/usr/share/filebeat/filebeat.yml \\\n  -v /var/lib/docker/containers:/var/lib/docker/containers:ro \\\n  -v /var/run/docker.sock:/var/run/docker.sock:ro \\\n  elastic/filebeat:8.0.0\n")),(0,r.kt)("p",null,"Since the container is now wrapped inside the virtual Docker network, I am now seeing the ",(0,r.kt)("strong",{parentName:"p"},"Filebeat Container ID")," as ",(0,r.kt)("inlineCode",{parentName:"p"},"host.name"),". In my case ",(0,r.kt)("inlineCode",{parentName:"p"},"b803b794fcb2"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker ps\nCONTAINER ID   IMAGE\nb803b794fcb2   elastic/filebeat:8.0.0\n")),(0,r.kt)("p",null,"Which I can use to filter all log entries from this beat:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'host.name : "b803b794fcb2"\n')),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Elasticsearch v8 Filebeats",src:a(17791).Z,width:"1216",height:"556"})),(0,r.kt)("h4",{id:"alternative-"},"Alternative ?"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Untested"),": Give the filepath to your container logs:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'# # =========================== Filebeat autodiscover ============================\n\nfilebeat.autodiscover:\n  providers:\n    - type: docker\n      templates:\n        - condition:\n            contains:\n              docker.container.image:<your_label_condition>\n          config:\n            - type: container\n              paths:\n                - "/var/lib/docker/containers/${data.docker.container.id}/*.log"\n              exclude_lines: ["^\\\\s+[\\\\-`(\'.|_]"]  # drop asciiart lines\n\nfilebeat.shutdown_timeout: 5s   #optional\n\n# ------------------------------- Console Output -------------------------------\noutput.console:\n  enabled: true\n  codec.json:\n    pretty: true\n    escape_html: false  \n\nlogging.metrics.enabled: false\n')),(0,r.kt)("h3",{id:"monitor-elasticsearch-in-docker"},"Monitor Elasticsearch in Docker"),(0,r.kt)("p",null,"I can now add my Elasticsearch container to the Filebeat configuration file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'filebeat.autodiscover\n  providers:\n    - type: docker\n      hints.enabled: true\n      templates:\n        - condition.contains:\n            docker.container.image: nginx\n          config:\n            - module: nginx\n              access.input:\n                type: docker\n                containers:\n                  ids: "${data.docker.container.id}"\n                  stream: "stdout"\n              error.input:\n                type: docker\n                containers:\n                  ids: "${data.docker.container.id}"\n                  stream: "stderr"\n        - condition.contains:\n            docker.container.image: docker.elastic.co/elasticsearch/elasticsearch\n          config:\n            - module: elasticsearch\n              access.input:\n                type: docker\n                containers:\n                  ids: "${data.docker.container.id}"\n                  stream: "stdout"\n              error.input:\n                type: docker\n                containers:\n                  ids: "${data.docker.container.id}"\n                  stream: "stderr"\n')),(0,r.kt)("p",null,"Since the Elasticsearch container name is set to ",(0,r.kt)("inlineCode",{parentName:"p"},"elasticsearch")," I can now filter the Filebeat index with:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'host.name : "b803b794fcb2" and container.name : "elasticsearch"\n')),(0,r.kt)("p",null,"And see all outgoing search responses:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Elasticsearch v8 Filebeats",src:a(87528).Z,width:"1212",height:"498"})))}p.isMDXComponent=!0},38559:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Elasticsearch8_Filebeats_01-2d57922b0b28d119ec3fc314114b0ba9.png"},74968:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Elasticsearch8_Filebeats_02-e825ec315c47136e111506df001123e7.png"},82810:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Elasticsearch8_Filebeats_03-18b92378e8187a27eeca6ac9c7482024.png"},26476:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Elasticsearch8_Filebeats_04-20779b50fa72aa454a06b6e7ff2e15a9.png"},81184:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Elasticsearch8_Filebeats_05-a939bf55798a05e698241c24f6056bd0.png"},38890:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Elasticsearch8_Filebeats_06-996a5fb68f34307f07e91bb879dc7065.png"},39448:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Elasticsearch8_Filebeats_07-01d3b6eb315bfbf7c839c10b25c83bd9.png"},17791:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Elasticsearch8_Filebeats_08-ea92dcd7720dddcce30013cd8978a346.png"},87528:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Elasticsearch8_Filebeats_09-dd481960c17b095f73627015eac50a53.png"},49056:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-94d62ec3ff079da54fce88aad4901707.jpg"}}]);