"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[63702],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>h});var n=a(67294);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,i=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=p(a),h=l,k=d["".concat(s,".").concat(h)]||d[h]||u[h]||i;return a?n.createElement(k,r(r({ref:t},c),{},{components:a})):n.createElement(k,r({ref:t},c))}));function h(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var i=a.length,r=new Array(i);r[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:l,r[1]=o;for(var p=2;p<i;p++)r[p]=a[p];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},2408:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>p});var n=a(87462),l=(a(67294),a(3905));const i={sidebar_position:7030,slug:"2021-08-22",title:"Hashicorp Vault - ACL Policies",authors:"mpolinowski",tags:["Vault","Linux"]},r=void 0,o={unversionedId:"DevOps/Hashicorp/2021-08-22--hashicorp-vault-policies/index",id:"DevOps/Hashicorp/2021-08-22--hashicorp-vault-policies/index",title:"Hashicorp Vault - ACL Policies",description:"Shenzhen, China",source:"@site/docs/DevOps/Hashicorp/2021-08-22--hashicorp-vault-policies/index.md",sourceDirName:"DevOps/Hashicorp/2021-08-22--hashicorp-vault-policies",slug:"/DevOps/Hashicorp/2021-08-22--hashicorp-vault-policies/2021-08-22",permalink:"/docs/DevOps/Hashicorp/2021-08-22--hashicorp-vault-policies/2021-08-22",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-08-22--hashicorp-vault-policies/index.md",tags:[{label:"Vault",permalink:"/docs/tags/vault"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:7030,frontMatter:{sidebar_position:7030,slug:"2021-08-22",title:"Hashicorp Vault - ACL Policies",authors:"mpolinowski",tags:["Vault","Linux"]},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Vault - Rest API",permalink:"/docs/DevOps/Hashicorp/2021-08-23--hashicorp-vault-rest-api/2021-08-23"},next:{title:"Hashicorp Vault - Secrets & Tokens",permalink:"/docs/DevOps/Hashicorp/2021-08-21--hashicorp-vault-secrets-tokens/2021-08-21"}},s={},p=[{value:"Write a Policy using API",id:"write-a-policy-using-api",level:2},{value:"Write a policy",id:"write-a-policy",level:3},{value:"Create a policy",id:"create-a-policy",level:3},{value:"Display a policy",id:"display-a-policy",level:3},{value:"Apply a Policy to an Auth Token",id:"apply-a-policy-to-an-auth-token",level:2},{value:"Creating the Policy",id:"creating-the-policy",level:3},{value:"Attaching an Auth Token",id:"attaching-an-auth-token",level:3},{value:"Testing the Token",id:"testing-the-token",level:3},{value:"Vault UI",id:"vault-ui",level:2},{value:"Updating a Policy",id:"updating-a-policy",level:3}],c={toc:p};function u(e){let{components:t,...i}=e;return(0,l.kt)("wrapper",(0,n.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Shenzhen, China",src:a(16410).Z,width:"1500",height:"582"})),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#write-a-policy-using-api"},"Write a Policy using API"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#write-a-policy"},"Write a policy")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#create-a-policy"},"Create a policy")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#display-a-policy"},"Display a policy")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#apply-a-policy-to-an-auth-token"},"Apply a Policy to an Auth Token"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#creating-the-policy"},"Creating the Policy")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#attaching-an-auth-token"},"Attaching an Auth Token")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#testing-the-token"},"Testing the Token")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#vault-ui"},"Vault UI"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#updating-a-policy"},"Updating a Policy"))))),(0,l.kt)("p",null,"Every Vault operation performed through the command-line interface (CLI), API, or web UI require that the authenticated client is granted access; access defined through policies. Everything in Vault is stored at different paths, like a filesystem, and every action in Vault has a corresponding path and capability. ",(0,l.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/docs/concepts/policies#policy-syntax"},"Policies")," provide a declarative way to grant or forbid access to paths and the capabilities at each path."),(0,l.kt)("p",null,"E.g. have all the rights to add and delete secrets under the path ",(0,l.kt)("inlineCode",{parentName:"p"},"sys/auth")," and be allowed to read them:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'path "sys/auth/*" {\n  capabilities = ["create", "update", "delete", "sudo"]\n}\n\npath "sys/auth" {\n  capabilities = ["read"]\n}\n')),(0,l.kt)("h2",{id:"write-a-policy-using-api"},"Write a Policy using API"),(0,l.kt)("h3",{id:"write-a-policy"},"Write a policy"),(0,l.kt)("p",null,"An admin user must be able to:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Read system health check"),(0,l.kt)("li",{parentName:"ul"},"Create and manage ACL policies broadly across Vault"),(0,l.kt)("li",{parentName:"ul"},"Enable and manage authentication methods broadly across Vault"),(0,l.kt)("li",{parentName:"ul"},"Manage the Key-Value secrets engine enabled at secret/ path")),(0,l.kt)("p",null,"Define the ",(0,l.kt)("a",{parentName:"p",href:"https://www.vaultproject.io/docs/concepts/policies#policy-syntax"},"admin policy")," in the file named ",(0,l.kt)("inlineCode",{parentName:"p"},"admin-policy.hcl"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'tee admin-policy.hcl <<EOF\n# Read system health check\npath "sys/health"\n{\n  capabilities = ["read", "sudo"]\n}\n\n# Create and manage ACL policies broadly across Vault\n\n# List existing policies\npath "sys/policies/acl"\n{\n  capabilities = ["list"]\n}\n\n# Create and manage ACL policies\npath "sys/policies/acl/*"\n{\n  capabilities = ["create", "read", "update", "delete", "list", "sudo"]\n}\n\n# Enable and manage authentication methods broadly across Vault\n\n# Manage auth methods broadly across Vault\npath "auth/*"\n{\n  capabilities = ["create", "read", "update", "delete", "list", "sudo"]\n}\n\n# Create, update, and delete auth methods\npath "sys/auth/*"\n{\n  capabilities = ["create", "update", "delete", "sudo"]\n}\n\n# List auth methods\npath "sys/auth"\n{\n  capabilities = ["read"]\n}\n\n# Enable and manage the key/value secrets engine at `secret/` path\n\n# List, create, update, and delete key/value secrets\npath "secret/*"\n{\n  capabilities = ["create", "read", "update", "delete", "list", "sudo"]\n}\n\n# Manage secrets engines\npath "sys/mounts/*"\n{\n  capabilities = ["create", "read", "update", "delete", "list", "sudo"]\n}\n\n# List existing secrets engines.\npath "sys/mounts"\n{\n  capabilities = ["read"]\n}\nEOF\n')),(0,l.kt)("p",null,"A policy define one or more paths and a list of permitted capabilities. Most of these capabilities map to the HTTP verbs supported by the Vault API:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Capability"),(0,l.kt)("th",{parentName:"tr",align:null},"Associated HTTP verbs"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"create")),(0,l.kt)("td",{parentName:"tr",align:null},"POST/PUT")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"read")),(0,l.kt)("td",{parentName:"tr",align:null},"GET")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"update")),(0,l.kt)("td",{parentName:"tr",align:null},"POST/PUT")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"delete")),(0,l.kt)("td",{parentName:"tr",align:null},"DELETE")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"list")),(0,l.kt)("td",{parentName:"tr",align:null},"LIST")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"sudo")),(0,l.kt)("td",{parentName:"tr",align:null},"The sudo capability allows access to paths that are root-protected (Refer to the ",(0,l.kt)("a",{parentName:"td",href:"https://learn.hashicorp.com/tutorials/vault/policies?in=vault/policies#root-protected-api-endpoints"},"Root protected endpoints section"),").")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"deny")),(0,l.kt)("td",{parentName:"tr",align:null},"The deny capability disables access to the path. When combined with other capabilities it always precedence.")))),(0,l.kt)("h3",{id:"create-a-policy"},"Create a policy"),(0,l.kt)("p",null,"Create a policy named admin with the policy defined in ",(0,l.kt)("inlineCode",{parentName:"p"},"admin-policy.hcl"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"vault policy write admin admin-policy.hcl\nSuccess! Uploaded policy: admin\n")),(0,l.kt)("h3",{id:"display-a-policy"},"Display a policy"),(0,l.kt)("p",null,"List all the policies:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"vault policy list\n\nadmin\ndefault\nroot\n")),(0,l.kt)("p",null,"Read the admin policy:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"vault policy read admin\n")),(0,l.kt)("p",null,"The output displays the paths and capabilities defined for this policy."),(0,l.kt)("h2",{id:"apply-a-policy-to-an-auth-token"},"Apply a Policy to an Auth Token"),(0,l.kt)("h3",{id:"creating-the-policy"},"Creating the Policy"),(0,l.kt)("p",null,"Start by enabling a secret engine for your policy:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"vault secrets enable -path=secret/ kv\nSuccess! Enabled the kv secrets engine at: secret/\n")),(0,l.kt)("p",null,"Write the policy:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'tee test-elastic.hcl <<EOF\n# Create/Read Elastic login\npath "secret/login/elastic"\n{\n  capabilities = ["create", "read"]\n}\nEOF\n')),(0,l.kt)("p",null,"Create the policy:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"vault policy write elastic_login test-elastic.hcl\n")),(0,l.kt)("h3",{id:"attaching-an-auth-token"},"Attaching an Auth Token"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'vault token create -policy="elastic_login"\n\nKey                  Value\n---                  -----\ntoken                s.GZHF5D5zYJk1zmzxLmxivPY8\ntoken_accessor       lfJsAlfKqZEALqv2Yyw7SlNP\ntoken_duration       768h\ntoken_renewable      true\ntoken_policies       ["default" "elastic_login"]\nidentity_policies    []\npolicies             ["default" "elastic_login"]\n')),(0,l.kt)("h3",{id:"testing-the-token"},"Testing the Token"),(0,l.kt)("p",null,"Since I am logged in to Vault with my environment I first have to unset my token before I can use the new one to login with:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'unset VAULT_TOKEN\n\nvault login\n\nToken (will be hidden): s.GZHF5D5zYJk1zmzxLmxivPY8\nSuccess! You are now authenticated. The token information displayed below\nis already stored in the token helper. You do NOT need to run "vault login"\nagain. Future Vault requests will automatically use this token.\n\nKey                  Value\n---                  -----\ntoken                s.GZHF5D5zYJk1zmzxLmxivPY8\ntoken_accessor       lfJsAlfKqZEALqv2Yyw7SlNP\ntoken_duration       767h58m43s\ntoken_renewable      true\ntoken_policies       ["default" "elastic_login"]\nidentity_policies    []\npolicies             ["default" "elastic_login"]\n')),(0,l.kt)("p",null,"Verify that you have all the rights assigned to you by the policy:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"vault token capabilities secret/login/elastic\ncreate, read\n")),(0,l.kt)("p",null,"Now I am logged in with the created token and should have the right to add a secret to ",(0,l.kt)("inlineCode",{parentName:"p"},"secret/login/elastic"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'vault kv put secret/login/elastic password="Hzo3aku+S37JDzeXGUxZX+H5WE"\nSuccess! Data written to: secret/login/elastic\n')),(0,l.kt)("p",null,"And also read it:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"vault kv get secret/login/elastic\n\n====== Data ======\nKey         Value\n---         -----\npassword    Hzo3aku+S37JDzeXGUxZX+H5WE\n")),(0,l.kt)("h2",{id:"vault-ui"},"Vault UI"),(0,l.kt)("p",null,"You can also use the user interface to access the secret:"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Hashicorp Vault",src:a(3867).Z,width:"1243",height:"604"})),(0,l.kt)("h3",{id:"updating-a-policy"},"Updating a Policy"),(0,l.kt)("p",null,"Here I noticed a problem with my policy - I am allowed to read ",(0,l.kt)("inlineCode",{parentName:"p"},"secret/login/policy"),". But the UI forces me to click on ",(0,l.kt)("inlineCode",{parentName:"p"},"secret/")," then ",(0,l.kt)("inlineCode",{parentName:"p"},"secret/login/")," to get there - and I don't have access to those. I will have to update the policy accordingly:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'tee test-elastic.hcl <<EOF\n# Read everything stored under secret/\npath "secret/*" {\n  capabilities = ["read", "list"]\n}\n\n# Create/Update Elastic login\npath "secret/login/elastic"\n{\n  capabilities = ["create", "update", "read"]\n}\nEOF\n')),(0,l.kt)("p",null,"Update the policy (remember to re-login with the root token):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"vault policy write elastic_login test-elastic.hcl \nSuccess! Uploaded policy: elastic_login\n")),(0,l.kt)("p",null,"Verify:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'vault policy read elastic_login\n\n# Read everything stored under secret/\npath "secret/*" {\n  capabilities = ["read", "list"]\n}\n\n# Create/Update Elastic login\npath "secret/login/elastic"\n{\n  capabilities = ["create", "update", "read"]\n}\n')),(0,l.kt)("p",null,"And I am able to access and edit the variable:"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Hashicorp Vault",src:a(90242).Z,width:"1241",height:"299"})))}u.isMDXComponent=!0},3867:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/HashiCorp_Vault_01-02c8961d12259ab5f9fbb06030cb053f.png"},90242:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/HashiCorp_Vault_02-caca84fd686c99ffc214131464289390.png"},16410:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-55a3986e2b95d2352897e24a05d0a6a7.jpg"}}]);