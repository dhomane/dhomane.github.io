"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[25913],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>h});var a=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,o=function(e,n){if(null==e)return{};var t,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var c=a.createContext({}),l=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=l(e.components);return a.createElement(c.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,o=e.mdxType,r=e.originalType,c=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=l(t),h=o,m=u["".concat(c,".").concat(h)]||u[h]||d[h]||r;return t?a.createElement(m,s(s({ref:n},p),{},{components:t})):a.createElement(m,s({ref:n},p))}));function h(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var r=t.length,s=new Array(r);s[0]=u;var i={};for(var c in n)hasOwnProperty.call(n,c)&&(i[c]=n[c]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var l=2;l<r;l++)s[l]=t[l];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},87727:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>l});var a=t(87462),o=(t(67294),t(3905));const r={sidebar_position:3950,slug:"2022-11-24",title:"Hashicorp Nomad - Working with Consul Connect",authors:"mpolinowski",tags:["Nomad","Consul","LINUX"],description:"Use the Consul service mesh to connect a frontend with it's API backend."},s=void 0,i={unversionedId:"DevOps/Hashicorp/2022-11-24-hashicorp-consul-connect/index",id:"DevOps/Hashicorp/2022-11-24-hashicorp-consul-connect/index",title:"Hashicorp Nomad - Working with Consul Connect",description:"Use the Consul service mesh to connect a frontend with it's API backend.",source:"@site/docs/DevOps/Hashicorp/2022-11-24-hashicorp-consul-connect/index.md",sourceDirName:"DevOps/Hashicorp/2022-11-24-hashicorp-consul-connect",slug:"/DevOps/Hashicorp/2022-11-24-hashicorp-consul-connect/2022-11-24",permalink:"/docs/DevOps/Hashicorp/2022-11-24-hashicorp-consul-connect/2022-11-24",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2022-11-24-hashicorp-consul-connect/index.md",tags:[{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"Consul",permalink:"/docs/tags/consul"},{label:"LINUX",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:3950,frontMatter:{sidebar_position:3950,slug:"2022-11-24",title:"Hashicorp Nomad - Working with Consul Connect",authors:"mpolinowski",tags:["Nomad","Consul","LINUX"],description:"Use the Consul service mesh to connect a frontend with it's API backend."},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Vault - Installation 2023",permalink:"/docs/DevOps/Hashicorp/2022-12-03-hashicorp-vault-installation/2022-12-03"},next:{title:"Deploy Grav CMS with Hashicorp Nomad",permalink:"/docs/DevOps/Hashicorp/2022-11-18-hashicorp-nomad-grav/2022-11-18"}},c={},l=[{value:"Nomad Agent Consul Integration",id:"nomad-agent-consul-integration",level:2},{value:"Consul Namespace",id:"consul-namespace",level:3},{value:"Consul Service Mesh",id:"consul-service-mesh",level:2},{value:"Mesh-enabled Services",id:"mesh-enabled-services",level:2},{value:"API Service",id:"api-service",level:3},{value:"Web Frontend",id:"web-frontend",level:3}],p={toc:l};function d(e){let{components:n,...r}=e;return(0,o.kt)("wrapper",(0,a.Z)({},p,r,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Shen Zhen, China",src:t(40556).Z,width:"2230",height:"839"})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#nomad-agent-consul-integration"},"Nomad Agent Consul Integration"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#consul-namespace"},"Consul Namespace")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#consul-service-mesh"},"Consul Service Mesh")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#mesh-enabled-services"},"Mesh-enabled Services"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#api-service"},"API Service")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#web-frontend"},"Web Frontend"))))),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"Prerequisite ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/containernetworking/plugins"},"CNI Plugins")," see ",(0,o.kt)("a",{parentName:"p",href:"/docs/DevOps/Hashicorp/2022-10-23-hashicorp-consul-connect/2022-10-23"},"Hashicorp Nomad - Working with Consul Connect"),".")),(0,o.kt)("h2",{id:"nomad-agent-consul-integration"},"Nomad Agent Consul Integration"),(0,o.kt)("p",null,"In order to use Consul with Nomad, you will need to configure and install Consul on your nodes alongside Nomad. The ",(0,o.kt)("a",{parentName:"p",href:"https://developer.hashicorp.com/nomad/docs/configuration/consul"},"consul stanza")," configures the Nomad agent's (",(0,o.kt)("strong",{parentName:"p"},"Master Node"),") communication with Consul for service discovery and key-value integration. When configured, tasks can register themselves with Consul, and the Nomad cluster can automatically bootstrap itself:"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"/etc/nomad.d/server.hcl")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'# This is an example that is part of Nomad\'s internal default configuration for Consul integration.\nconsul {\n  # The address to the Consul agent.\n  address = "127.0.0.1:8500"\n  token   = "abcd1234"\n  grpc_address = "127.0.0.1:8502"\n\n  # TLS encryption\n  ssl = true\n  ca_file = "/etc/consul.d/tls/consul-agent-ca.pem"\n  cert_file = "/etc/consul.d/tls/consul-server-consul-0.pem"\n  key_file = "/etc/consul.d/tls/consul-server-consul-0-key.pem"\n  verify_ssl = true\n\n  # The service name to register the server and client with Consul.\n  server_service_name = "nomad"\n  client_service_name = "nomad-client"\n\n  # Enables automatically registering the services.\n  auto_advertise = true\n\n  # Enabling the server and client to bootstrap using Consul.\n  server_auto_join = true\n  client_auto_join = true\n}\n')),(0,o.kt)("p",null,"After updating and restarting your Nomad Master service you should be able to see all your Nomad clients and their registered services in Consul:"),(0,o.kt)("h3",{id:"consul-namespace"},"Consul Namespace"),(0,o.kt)("p",null,"Nomad requires agent:read permissions. In order to use the consul_namespace feature, Nomad will need a token generated in Consul's default namespace. That token should be created with agent:read as well as a namespace block with the other relevant permissions for running Nomad in the intended namespace. The Consul policy below shows an example policy configuration for a Nomad server:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'agent_prefix "" {\n  policy = "read"\n}\n\nnamespace "nomad-ns" {\n  acl = "write"\n\n  key_prefix "" {\n    policy = "read"\n  }\n\n  node_prefix "" {\n    policy = "read"\n  }\n\n  service_prefix "" {\n    policy = "write"\n  }\n}\n')),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad Agent Consul Integration ",src:t(17460).Z,width:"1299",height:"763"})),(0,o.kt)("h2",{id:"consul-service-mesh"},"Consul Service Mesh"),(0,o.kt)("p",null,"Consul service mesh provides service-to-service connection authorization and encryption using mutual Transport Layer Security (",(0,o.kt)("strong",{parentName:"p"},"TLS"),"). Applications can use sidecar proxies in a service mesh configuration to automatically establish TLS connections for inbound and outbound connections."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad Agent Consul Integration ",src:t(72844).Z,width:"963",height:"304"})),(0,o.kt)("p",null,"To support Consul service mesh, Nomad adds a new networking mode for jobs that enables tasks in the same task group to share their networking stack. When service mesh is enabled, Nomad will launch a proxy alongside the application in the job file. The proxy (Envoy) provides secure communication with other applications in the cluster."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"We need to enable the ",(0,o.kt)("strong",{parentName:"p"},"gRPC port")," and set ",(0,o.kt)("strong",{parentName:"p"},"connect")," to enabled by adding some additional information to our Consul client configurations:")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"/etc/consul.d/consul.hcl")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ports {\n  grpc_tls = 8502\n}\n\nconnect {\n  enabled = true\n}\n")),(0,o.kt)("p",null,"To facilitate cross-Consul datacenter requests of Connect services registered by Nomad, Consul agents will need to be configured with default anonymous ACL tokens with ACL policies of sufficient permissions to read service and node metadata pertaining to those requests."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'service_prefix "" { policy = "read" }\nnode_prefix    "" { policy = "read" }\n')),(0,o.kt)("h2",{id:"mesh-enabled-services"},"Mesh-enabled Services"),(0,o.kt)("p",null,"The following job file is an example to enable secure communication between a web dashboard and a backend counting service. The web dashboard and the counting service are managed by Nomad. The dashboard is configured to connect to the counting service via localhost on port ",(0,o.kt)("inlineCode",{parentName:"p"},"9001"),". The proxy is managed by Nomad, and handles ",(0,o.kt)("inlineCode",{parentName:"p"},"mTLS")," communication to the counting service."),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"servicemesh.tf")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'job "countdash" {\n  datacenters = ["dc1"]\n\n  group "api" {\n    network {\n      mode = "bridge"\n    }\n\n    service {\n      name = "count-api"\n      port = "9001"\n\n      connect {\n        sidecar_service {}\n      }\n    }\n\n    task "web" {\n      driver = "docker"\n\n      config {\n        image = "hashicorpdev/counter-api:v3"\n      }\n    }\n  }\n\n  group "dashboard" {\n    network {\n      mode = "bridge"\n\n      port "http" {\n        static = 9002\n        to     = 9002\n      }\n    }\n\n    service {\n      name = "count-dashboard"\n      port = "http"\n\n      connect {\n        sidecar_service {\n          proxy {\n            upstreams {\n              destination_name = "count-api"\n              local_bind_port  = 8080\n            }\n          }\n        }\n      }\n    }\n\n    task "dashboard" {\n      driver = "docker"\n\n      env {\n        COUNTING_SERVICE_URL = "http://${NOMAD_UPSTREAM_ADDR_count_api}"\n      }\n\n      config {\n        image = "hashicorpdev/counter-dashboard:v3"\n      }\n    }\n  }\n}\n')),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("strong",{parentName:"p"},"ERROR")," message: ",(0,o.kt)("inlineCode",{parentName:"p"},'WARNING: Failed to place all allocations. Task Group "api" (failed to place 1 allocation) Constraint "${attr.consul.grpc} > 0": 1 nodes excluded by filter'),".")),(0,o.kt)("p",null," Consul agents running TLS and a version greater than ",(0,o.kt)("strong",{parentName:"p"},"1.14.0")," should set the ",(0,o.kt)("inlineCode",{parentName:"p"},"grpc_tls")," configuration parameter instead of ",(0,o.kt)("inlineCode",{parentName:"p"},"grpc"),". But the error message above shows up when ",(0,o.kt)("inlineCode",{parentName:"p"},"grpc")," is not defined - the following configuration solves this issue (adding ",(0,o.kt)("inlineCode",{parentName:"p"},"grpc")," back in):"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"/etc/consul.d/consul.hcl")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ports {\n  grpc  = 8503\n  grpc_tls = 8502\n}\n\nconnect {\n  enabled = true\n}\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad Agent Consul Integration ",src:t(84188).Z,width:"1305",height:"392"})),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad Agent Consul Integration ",src:t(9593).Z,width:"1305",height:"717"})),(0,o.kt)("h3",{id:"api-service"},"API Service"),(0,o.kt)("p",null,"The API service is defined as a task group with a ",(0,o.kt)("inlineCode",{parentName:"p"},"bridge")," network. Since the API service is only accessible via Consul service mesh, it does not define any ports in its network. The service stanza enables service mesh. The port in the service stanza is the port the API service listens on. The Envoy proxy will automatically route traffic to that port inside the network namespace.:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'group "api" {\n    network {\n      mode = "bridge"\n    }\n\n    # ...\n\n    service {\n      name = "count-api"\n      port = "9001"\n\n    # ...\n\n      connect {\n        sidecar_service {}\n      }\n    }\n\n    # ...\n\n  }\n')),(0,o.kt)("h3",{id:"web-frontend"},"Web Frontend"),(0,o.kt)("p",null,"The web frontend is defined as a task group with a bridge network and a static forwarded port:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'group "dashboard" {\n  network {\n    mode = "bridge"\n\n    port "http" {\n      static = 9002\n      to     = 9002\n    }\n  }\n\n  # ...\n\n}\n')),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"to = 9002")," parameter forwards that host port to port ",(0,o.kt)("inlineCode",{parentName:"p"},"9002")," inside the network namespace. The web frontend connects to the API service via Consul service mesh. This allows you to connect to the web frontend in a browser by visiting ",(0,o.kt)("inlineCode",{parentName:"p"},"http://<host_ip>:9002")," as show below:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad Agent Consul Integration ",src:t(91352).Z,width:"1307",height:"490"})),(0,o.kt)("p",null,"The web frontend is configured to communicate with the API service with an environment variable:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'env {\n  COUNTING_SERVICE_URL = "http://${NOMAD_UPSTREAM_ADDR_count_api}"\n}\n')))}d.isMDXComponent=!0},72844:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Nomad_Consul_Connect_00-99a0f8143fbbaa571b75e3cb9b3d9dc9.png"},17460:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Nomad_Consul_Connect_01-abce6dd3be0ac5d3bc4ab6d46cd002e3.png"},84188:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Nomad_Consul_Connect_02-937bcfae28003a6320407fc3506a9a6a.png"},9593:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Nomad_Consul_Connect_03-10b7e21d28ccb460b24d8757097a6b39.png"},91352:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Nomad_Consul_Connect_04-1031f503c528a4f8cf09dc7347819bc1.png"},40556:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-6c1edb088dfea3a7d39f8eebb8e9dc23.jpg"}}]);