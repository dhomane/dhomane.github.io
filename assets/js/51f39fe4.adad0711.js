"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[41871],{3905:(e,a,t)=>{t.d(a,{Zo:()=>d,kt:()=>m});var n=t(67294);function l(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function i(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function r(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?i(Object(t),!0).forEach((function(a){l(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function s(e,a){if(null==e)return{};var t,n,l=function(e,a){if(null==e)return{};var t,n,l={},i=Object.keys(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||(l[t]=e[t]);return l}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var o=n.createContext({}),u=function(e){var a=n.useContext(o),t=a;return e&&(t="function"==typeof e?e(a):r(r({},a),e)),t},d=function(e){var a=u(e.components);return n.createElement(o.Provider,{value:a},e.children)},c={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},p=n.forwardRef((function(e,a){var t=e.components,l=e.mdxType,i=e.originalType,o=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=u(t),m=l,h=p["".concat(o,".").concat(m)]||p[m]||c[m]||i;return t?n.createElement(h,r(r({ref:a},d),{},{components:t})):n.createElement(h,r({ref:a},d))}));function m(e,a){var t=arguments,l=a&&a.mdxType;if("string"==typeof e||l){var i=t.length,r=new Array(i);r[0]=p;var s={};for(var o in a)hasOwnProperty.call(a,o)&&(s[o]=a[o]);s.originalType=e,s.mdxType="string"==typeof e?e:l,r[1]=s;for(var u=2;u<i;u++)r[u]=t[u];return n.createElement.apply(null,r)}return n.createElement.apply(null,t)}p.displayName="MDXCreateElement"},19246:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>o,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var n=t(87462),l=(t(67294),t(3905));const i={sidebar_position:9060,slug:"2020-07-28",title:"Securing Webservers - Fail2Ban Ubuntu 20.10",authors:"mpolinowski",tags:["LINUX","Security","FirewallD","fail2ban"]},r=void 0,s={unversionedId:"DevOps/Security/2020-07-28--fail2ban-ubuntu-server/index",id:"DevOps/Security/2020-07-28--fail2ban-ubuntu-server/index",title:"Securing Webservers - Fail2Ban Ubuntu 20.10",description:"TST, Hong Kong",source:"@site/docs/DevOps/Security/2020-07-28--fail2ban-ubuntu-server/index.md",sourceDirName:"DevOps/Security/2020-07-28--fail2ban-ubuntu-server",slug:"/DevOps/Security/2020-07-28--fail2ban-ubuntu-server/2020-07-28",permalink:"/docs/DevOps/Security/2020-07-28--fail2ban-ubuntu-server/2020-07-28",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Security/2020-07-28--fail2ban-ubuntu-server/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Security",permalink:"/docs/tags/security"},{label:"FirewallD",permalink:"/docs/tags/firewall-d"},{label:"fail2ban",permalink:"/docs/tags/fail-2-ban"}],version:"current",sidebarPosition:9060,frontMatter:{sidebar_position:9060,slug:"2020-07-28",title:"Securing Webservers - Fail2Ban Ubuntu 20.10",authors:"mpolinowski",tags:["LINUX","Security","FirewallD","fail2ban"]},sidebar:"tutorialSidebar",previous:{title:"Securing Webservers - Uncomplicated Firewall",permalink:"/docs/DevOps/Security/2020-07-28--uncomplicated-firewall-ufw/2020-07-28"},next:{title:"Securing Webservers - FirewallD Deployment on Ubuntu 20.04",permalink:"/docs/DevOps/Security/2020-07-27--firewalld-deployment-ubuntu/2020-07-27"}},o={},u=[{value:"Installation",id:"installation",level:2},{value:"CentOS",id:"centos",level:3},{value:"Debian",id:"debian",level:3},{value:"Ubuntu",id:"ubuntu",level:3},{value:"Configure Fail2ban",id:"configure-fail2ban",level:2},{value:"jail.local",id:"jaillocal",level:3},{value:"Email Alerts",id:"email-alerts",level:2},{value:"Enable fail2ban",id:"enable-fail2ban",level:2},{value:"failban-client commands",id:"failban-client-commands",level:3},{value:"Unbanning an IP Address",id:"unbanning-an-ip-address",level:2}],d={toc:u};function c(e){let{components:a,...i}=e;return(0,l.kt)("wrapper",(0,n.Z)({},d,i,{components:a,mdxType:"MDXLayout"}),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"TST, Hong Kong",src:t(39028).Z,width:"1500",height:"517"})),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#installation"},"Installation"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#centos"},"CentOS")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#debian"},"Debian")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#ubuntu"},"Ubuntu")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#configure-fail2ban"},"Configure Fail2ban"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#jaillocal"},"jail.local")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#email-alerts"},"Email Alerts")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#enable-fail2ban"},"Enable fail2ban"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#failban-client-commands"},"failban-client commands")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#unbanning-an-ip-address"},"Unbanning an IP Address"))),(0,l.kt)("h2",{id:"installation"},"Installation"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://www.fail2ban.org/wiki/index.php/Main_Page"},"fail2ban")," is a daemon to ban hosts that cause multiple authentication errors."),(0,l.kt)("p",null,"fail2ban will monitor the SystemD journal to look for failed authentication attempts for whichever jails have been enabled. After the number of failed attempts specified it will add a firewall rule to block that specific IP address for an amount of time configured."),(0,l.kt)("p",null,"Start by ",(0,l.kt)("a",{parentName:"p",href:"https://www.fail2ban.org/wiki/index.php/Downloads"},"installing the package")," on your system - ",(0,l.kt)("a",{parentName:"p",href:"https://packages.debian.org/stable/net/fail2ban"},"Debian"),", ",(0,l.kt)("a",{parentName:"p",href:"https://packages.ubuntu.com/search?keywords=fail2ban"},"Ubuntu")," or on Centos through EPEL."),(0,l.kt)("h3",{id:"centos"},"CentOS"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"yum update && yum install epel-release\nyum install fail2ban\nyum install sendmail\nsystemctl start fail2ban\nsystemctl enable fail2ban\nsystemctl start sendmail\nsystemctl enable sendmail\n")),(0,l.kt)("h3",{id:"debian"},"Debian"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get update && apt-get upgrade -y\napt-get install fail2ban\napt-get install sendmail-bin sendmail\n")),(0,l.kt)("h3",{id:"ubuntu"},"Ubuntu"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get update && apt-get upgrade -y\napt-get install fail2ban\napt-get install sendmail\n")),(0,l.kt)("p",null,"Allow SSH access through UFW and then enable the firewall:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"ufw allow ssh\nufw enable\n")),(0,l.kt)("h2",{id:"configure-fail2ban"},"Configure Fail2ban"),(0,l.kt)("p",null,"The jail.conf file will enable Fail2ban for SSH by default for Debian and Ubuntu, but not CentOS. All other protocols and configurations (HTTP, FTP, etc.) are commented out. If you want to change this, create a ",(0,l.kt)("inlineCode",{parentName:"p"},"jail.local")," for editing:"),(0,l.kt)("h3",{id:"jaillocal"},"jail.local"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local\n")),(0,l.kt)("p",null,"The next step is to configure a jail (a service you want to monitor and ban at whatever thresholds you\u2019ve set). By default IPs are banned for 1 hour. The best practice is to override the system defaults using ",(0,l.kt)("em",{parentName:"p"},".local files instead of directly modifying the "),".config files:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cfg"},'# nano /etc/fail2ban/jail.local\n[DEFAULT]\n# "bantime.increment" allows to use database for searching of previously banned ip\'s to increase a\n# default ban time using special formula, default it is banTime * 1, 2, 4, 8, 16, 32...\nbantime.increment = true\n# "bantime" is the number of seconds that a host is banned.\nbantime  = 1d\n\n# A host is banned if it has generated "maxretry" during the last "findtime"\n# seconds.\nfindtime  = 1h\n\n# "maxretry" is the number of failures before a host get banned.\nmaxretry = 5\n')),(0,l.kt)("p",null,"After 5 attempts within the last hour the IP will be blocked for 1 day. A wide range of services those rules can be applied to can be found at the bottom of the file, e.g.:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cfg"},'[sshd]\n\n# To use more aggressive sshd modes set filter parameter "mode" in jail.local:\n# normal (default), ddos, extra or aggressive (combines all).\n# See "tests/files/logs/sshd" or "filter.d/sshd.conf" for usage example and details.\nmode   = normal\nport    = ssh,ftps,12345\nlogpath = %(sshd_log)s\nbackend = %(sshd_backend)s\n')),(0,l.kt)("p",null,"To ignore specific IPs, add them to the ignoreip line. By default, this command will not ban the localhost. If you work from a single IP address often, it may be beneficial to add it to the ignore list:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cfg"},'# "ignoreself" specifies whether the local resp. own IP addresses should be ignored\n# (default is true). Fail2ban will not ban a host which matches such addresses.\nignoreself = true\n\n# "ignoreip" can be a list of IP addresses, CIDR masks or DNS hosts. Fail2ban\n# will not ban a host which matches an address in this list. Several addresses\n# can be defined using space (and/or comma) separator.\n#ignoreip = 127.0.0.1/8 ::1\nignoreip = 127.0.0.1/8 192.168.2.112\n')),(0,l.kt)("p",null,"If you wish to whitelist IPs only for certain jails, this can be done with the fail2ban-client command. Replace JAIL with the name of your jail, and 123.45.67.89 with the IP you wish to whitelist."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"fail2ban-client set JAIL addignoreip 123.45.67.89\n")),(0,l.kt)("p",null,"Now activate the SSH Jail to apply your rules to the SSH service by creating another file called ",(0,l.kt)("inlineCode",{parentName:"p"},"sshd.local")," - add everything in here that you want to add on top of the default settings in ",(0,l.kt)("inlineCode",{parentName:"p"},"jail.local"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# nano /etc/fail2ban/sshd.local\n[sshd]\nenabled = true\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"If using CentOS or Fedora you will need to change the backend option in ",(0,l.kt)("inlineCode",{parentName:"p"},"jail.local")," from auto to ",(0,l.kt)("strong",{parentName:"p"},"systemd"),". This is not necessary on Debian or Ubuntu, even though both use systemd as well. (Still true??)")),(0,l.kt)("h2",{id:"email-alerts"},"Email Alerts"),(0,l.kt)("p",null,"To receive email when fail2ban is triggered, adjust the email settings:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"destemail"),": The email address where you would like to receive the emails."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"sendername"),": The name under which the email shows up."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"sender"),": The email address from which Fail2ban will send emails.")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("strong",{parentName:"p"},"Note"),"\nIf unsure of what to put under sender, run the command sendmail -t ",(0,l.kt)("a",{parentName:"p",href:"mailto:user@email.com"},"user@email.com"),", replacing ",(0,l.kt)("a",{parentName:"p",href:"mailto:user@email.com"},"user@email.com")," with your email address. Check your email (including spam folders, if needed) and review the sender email. This address can be used for the above configuration.")),(0,l.kt)("p",null,"You will also need to adjust the action setting, which defines what actions occur when the threshold for ban is met. The default, %(action","_",")s, only bans the user. %(action_mw)s will ban and send an email with a WhoIs report; while %(action_mwl)s will ban and send an email with the WhoIs report and all relevant lines in the log file. This can also be changed on a jail-specific basis."),(0,l.kt)("h2",{id:"enable-fail2ban"},"Enable fail2ban"),(0,l.kt)("p",null,"Next enable and start the fail2ban service."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable --now fail2ban\nsystemctl status fail2ban\n")),(0,l.kt)("h3",{id:"failban-client-commands"},"failban-client commands"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"fail2ban-client COMMAND\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"start"),": Starts the Fail2ban server and jails."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"reload"),": Reloads Fail2ban\u2019s configuration files."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"reload")," JAIL: Replaces JAIL with the name of a Fail2ban jail; this will reload the jail."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"stop"),": Terminates the server."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"status"),": Will show the status of the server, and enable jails."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"status")," JAIL: Will show the status of the jail, including any currently-banned IPs.")),(0,l.kt)("p",null,"To check the status of fail2ban and make sure the jail is enabled enter:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"fail2ban-client status\n\nStatus\n|- Number of jail:  1\n`- Jail list:   sshd\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"fail2ban-client status sshd\nStatus for the jail: sshd\n|- Filter\n|  |- Currently failed: 8\n|  |- Total failed: 4399\n|  `- Journal matches:  _SYSTEMD_UNIT=sshd.service + _COMM=sshd\n`- Actions\n   |- Currently banned: 101\n   |- Total banned: 684\n   `- Banned IP list:   ...\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"tail -f /var/log/fail2ban.log\n")),(0,l.kt)("p",null,"Check IP address geo location and add country ban lists where necessary ",(0,l.kt)("inlineCode",{parentName:"p"},"whois ip-addrss | grep -i country"),"."),(0,l.kt)("h2",{id:"unbanning-an-ip-address"},"Unbanning an IP Address"),(0,l.kt)("p",null,'In order to remove an IP address from the banned list, parameter IPADDRESS is set to appropriate IP which needs unbanning. The name "sshd" is the name of the jail, in this case the "sshd" jail that we configured above. The following command does the job.'),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"fail2ban-client set sshd unbanip IPADDRESS\n")))}c.isMDXComponent=!0},39028:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-ec671595d585b88a85b017a7908fb619.jpg"}}]);