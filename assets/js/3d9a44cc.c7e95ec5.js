"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[57392],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>k});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),m=p(n),k=r,d=m["".concat(l,".").concat(k)]||m[k]||u[k]||s;return n?a.createElement(d,i(i({ref:t},c),{},{components:n})):a.createElement(d,i({ref:t},c))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,i=new Array(s);i[0]=m;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var p=2;p<s;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},34647:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>u,frontMatter:()=>s,metadata:()=>o,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const s={sidebar_position:9020,slug:"2019-02-01",title:"Kubernetes Traefik Ingress",authors:"mpolinowski",tags:["LINUX","Docker","Kubernetes"]},i=void 0,o={unversionedId:"DevOps/Kubernetes/2019-02-01--kubernetes-traefik-ingress/index",id:"DevOps/Kubernetes/2019-02-01--kubernetes-traefik-ingress/index",title:"Kubernetes Traefik Ingress",description:"Tanna, Vanuatu",source:"@site/docs/DevOps/Kubernetes/2019-02-01--kubernetes-traefik-ingress/index.mdx",sourceDirName:"DevOps/Kubernetes/2019-02-01--kubernetes-traefik-ingress",slug:"/DevOps/Kubernetes/2019-02-01--kubernetes-traefik-ingress/2019-02-01",permalink:"/docs/DevOps/Kubernetes/2019-02-01--kubernetes-traefik-ingress/2019-02-01",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Kubernetes/2019-02-01--kubernetes-traefik-ingress/index.mdx",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Docker",permalink:"/docs/tags/docker"},{label:"Kubernetes",permalink:"/docs/tags/kubernetes"}],version:"current",sidebarPosition:9020,frontMatter:{sidebar_position:9020,slug:"2019-02-01",title:"Kubernetes Traefik Ingress",authors:"mpolinowski",tags:["LINUX","Docker","Kubernetes"]},sidebar:"tutorialSidebar",previous:{title:"Red Hat OpenShift 3 Container Platform",permalink:"/docs/DevOps/Kubernetes/2019-03-02--installing-openshift-3-on-centos-7/2019-03-02"},next:{title:"Kubernetes the Chinese Way",permalink:"/docs/DevOps/Kubernetes/2019-01-27--kubernetes-the-chinese-way/2019-01-27"}},l={},p=[{value:"Getting Started with the Traefik Reverse Proxy",id:"getting-started-with-the-traefik-reverse-proxy",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Deploy Traefik using a Deployment or DaemonSet",id:"deploy-traefik-using-a-deployment-or-daemonset",level:2},{value:"Submitting an Ingress to the Cluster",id:"submitting-an-ingress-to-the-cluster",level:2},{value:"Path-based Routing",id:"path-based-routing",level:2},{value:"User Authentication",id:"user-authentication",level:2},{value:"Creating the Secret",id:"creating-the-secret",level:3},{value:"Add a TLS Certificate to the Ingress",id:"add-a-tls-certificate-to-the-ingress",level:2},{value:"Name-based Routing",id:"name-based-routing",level:2}],c={toc:p};function u(e){let{components:t,...s}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Tanna, Vanuatu",src:n(26182).Z,width:"1979",height:"1021"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#getting-started-with-the-traefik-reverse-proxy"},"Getting Started with the Traefik Reverse Proxy")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#prerequisites"},"Prerequisites")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#deploy-traefik-using-a-deployment-or-daemonset"},"Deploy Traefik using a Deployment or DaemonSet")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#submitting-an-ingress-to-the-cluster"},"Submitting an Ingress to the Cluster")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#path-based-routing"},"Path-based Routing")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#user-authentication"},"User Authentication"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#creating-the-secret"},"Creating the Secret")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#add-a-tls-certificate-to-the-ingress"},"Add a TLS Certificate to the Ingress")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#name-based-routing"},"Name-based Routing"))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"This article is still WIP - better check out the ",(0,r.kt)("a",{parentName:"strong",href:"/docs/DevOps/Kubernetes/2019-01-22--kubernetes-nginx-ingress/2019-01-22"},"NGINX Ingress")," instead...")),(0,r.kt)("p",null,"Before we explored the ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Kubernetes/2019-01-22--kubernetes-nginx-ingress/2019-01-22"},"NGINX Ingress")," to route traffic onto Services inside our Kubernetes Cluster. But there are a couple of options that we can choose from here:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/kubernetes/ingress-nginx/blob/master/README.md"},"Nginx")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/heptio/contour"},"Contour")," "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://www.haproxy.com/blog/haproxy_ingress_controller_for_kubernetes/"},"HAProxy"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://appscode.com/products/voyager/"},"Voyager")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://docs.traefik.io"},"Traefik"))),(0,r.kt)("h2",{id:"getting-started-with-the-traefik-reverse-proxy"},"Getting Started with the Traefik Reverse Proxy"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/containous/traefik"},"Traefik")," is a modern HTTP reverse proxy and load balancer that makes deploying microservices easy. Traefik integrates with your existing infrastructure components and configures itself automatically and dynamically. Pointing Traefik at your orchestrator - e.g. ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Kubernetes/2019-01-15--creating-a-kubernetes-cluster/2019-01-15"},"Kubernetes")," should be the only configuration step you need."),(0,r.kt)("p",null,"Traditional reverse-proxies require that you configure each route that will connect paths and subdomains to each microservice. Traefik listens to your service registry/orchestrator API (",(0,r.kt)("a",{parentName:"p",href:"https://docs.traefik.io/configuration/backends/etcd/"},"etcd")," / ",(0,r.kt)("a",{parentName:"p",href:"https://docs.traefik.io/configuration/backends/kubernetes/"},"Kubernetes"),") and instantly generates the routes so your microservices are connected to the outside world -- without further intervention from your part."),(0,r.kt)("p",null,"The example configuration files that we are working with are available in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containous/traefik/tree/v1.7/examples/k8s"},"Traefik Github repository"),"."),(0,r.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("p",null,"Kubernetes introduces ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/reference/access-authn-authz/rbac/"},"Role Based Access Control (RBAC)")," in 1.6+ to allow fine-grained control of Kubernetes resources and API."),(0,r.kt)("p",null,"If your cluster is configured with RBAC, you will need to authorize Traefik to use the Kubernetes API. There are two ways to set up the proper permission: Via ",(0,r.kt)("strong",{parentName:"p"},"namespace-specific RoleBindings")," or a single, global ",(0,r.kt)("strong",{parentName:"p"},"ClusterRoleBinding"),"."),(0,r.kt)("p",null,"RoleBindings per namespace enable to restrict granted permissions to the very namespaces only that Traefik is watching over, thereby following the least-privileges principle. This is the preferred approach if Traefik is not supposed to watch all namespaces, and the set of namespaces does not change dynamically. Otherwise, a single ",(0,r.kt)("strong",{parentName:"p"},"ClusterRoleBinding")," must be employed."),(0,r.kt)("p",null,"But for the sake of simplicity, this guide will use a ",(0,r.kt)("strong",{parentName:"p"},"ClusterRoleBinding")," with the following ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containous/traefik/blob/v1.7/examples/k8s/traefik-rbac.yaml"},"YAML file"),":"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"traefik-rbac.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'---\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: traefik-ingress-controller\nrules:\n  - apiGroups:\n      - ""\n    resources:\n      - services\n      - endpoints\n      - secrets\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n      - extensions\n    resources:\n      - ingresses\n    verbs:\n      - get\n      - list\n      - watch\n  - apiGroups:\n    - extensions\n    resources:\n    - ingresses/status\n    verbs:\n    - update\n---\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: traefik-ingress-controller\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: traefik-ingress-controller\nsubjects:\n- kind: ServiceAccount\n  name: traefik-ingress-controller\n  namespace: monitoring\n')),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Traefik Ingress for your Kubernetes Cluster",src:n(82496).Z,width:"805",height:"647"})),(0,r.kt)("p",null,"Apply the configuration with the following Kubernete command (change the URL to the local path, if you decided to store the file above locally):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f https://raw.githubusercontent.com/containous/traefik/v1.7/examples/k8s/traefik-rbac.yaml\n")),(0,r.kt)("h2",{id:"deploy-traefik-using-a-deployment-or-daemonset"},"Deploy Traefik using a Deployment or DaemonSet"),(0,r.kt)("p",null,"It is possible to use Traefik with a ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/deployment/"},"Deployment")," or a ",(0,r.kt)("a",{parentName:"p",href:"https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/"},"DaemonSet")," object, whereas both options have their own pros and cons:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The scalability can be much better when using a Deployment, because you will have a Single-Pod-per-Node model when using a DaemonSet, whereas you may need less replicas based on your environment when using a Deployment."),(0,r.kt)("li",{parentName:"ul"},"DaemonSets automatically scale to new nodes, when the nodes join the cluster, whereas Deployment pods are only scheduled on new nodes if required."),(0,r.kt)("li",{parentName:"ul"},"DaemonSets ensure that only one replica of pods run on any single node. Deployments require affinity settings if you want to ensure that two pods don't end up on the same node."),(0,r.kt)("li",{parentName:"ul"},"DaemonSets can be run with the ",(0,r.kt)("em",{parentName:"li"},"NET","_","BIND","_","SERVICE")," capability, which will allow it to bind to port 80/443/etc on each host. This will allow bypassing the kube-proxy, and reduce traffic hops. Note that this is against the Kubernetes ",(0,r.kt)("a",{parentName:"li",href:"https://kubernetes.io/docs/concepts/configuration/overview/#services"},"Best Practices Guidelines"),", and raises the potential for scheduling/scaling issues. Despite potential issues, this remains the choice for most ingress controllers.")),(0,r.kt)("p",null,"I am going to use the Deployment here - but the configuration file for the DemonSet does not look s different and can be ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containous/traefik/tree/v1.7/examples/k8s/traefik-ds.yaml"},"downloaded here"),"."),(0,r.kt)("p",null,"The Deployment objects looks like this (see below) and can be ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containous/traefik/tree/v1.7/examples/k8s/traefik-deployment.yaml"},"downloaded here"),":"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"traefik-deployment.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: traefik-ingress-controller\n  namespace: monitoring\n  \n---\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: traefik-ingress-controller\n  namespace: monitoring\n  labels:\n    k8s-app: traefik-ingress-lb\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      k8s-app: traefik-ingress-lb\n  template:\n    metadata:\n      labels:\n        k8s-app: traefik-ingress-lb\n        name: traefik-ingress-lb\n    spec:\n      serviceAccountName: traefik-ingress-controller\n      terminationGracePeriodSeconds: 60\n      containers:\n      - image: traefik\n        name: traefik-ingress-lb\n        ports:\n        - name: http\n          containerPort: 80\n          hostPort: 8080\n        - name: admin\n          containerPort: 8080\n        args:\n        - --api\n        - --kubernetes\n        - --logLevel=INFO\n        - --defaultentrypoints=http\n        - --entrypoints=Name:http Address::80\n        \n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: traefik-ingress-service\n  namespace: monitoring\nspec:\n  selector:\n    k8s-app: traefik-ingress-lb\n  ports:\n    - protocol: TCP\n      port: 80\n      name: http\n    - protocol: TCP\n      port: 8080\n      name: admin\n  externalIPs:\n    - 172.56.4.112\n")),(0,r.kt)("p",null,"To deploy Traefik to your cluster start by applying the YAML files with kubectl:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f https://raw.githubusercontent.com/containous/traefik/v1.7/examples/k8s/traefik-deployment.yaml\n")),(0,r.kt)("p",null,"You can verify that the Ingress pod was started with:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl --namespace=kube-system get pods\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Traefik Ingress for your Kubernetes Cluster",src:n(79239).Z,width:"804",height:"226"})),(0,r.kt)("h2",{id:"submitting-an-ingress-to-the-cluster"},"Submitting an Ingress to the Cluster"),(0,r.kt)("p",null,"Lets start by creating a Service and an Ingress that will expose the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containous/traefik#web-ui"},"Traefik Web UI")," (the configuration file can be ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containous/traefik/tree/v1.7/examples/k8s/ui.yaml"},"downloaded here"),"):"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ui.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"---\napiVersion: v1\nkind: Service\nmetadata:\n  name: traefik-web-ui\n  namespace: monitoring\nspec:\n  selector:\n    k8s-app: traefik-ingress-lb\n  ports:\n  - name: http\n    port: 80\n    targetPort: 8080\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: traefik-web-ui\n  namespace: monitoring\nspec:\n  rules:\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: traefik-web-ui\n          servicePort: http\n")),(0,r.kt)("p",null,"Apply the service to your cluster with:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f https://raw.githubusercontent.com/containous/traefik/v1.7/examples/k8s/ui.yaml\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"This setup assigns a host domain ",(0,r.kt)("inlineCode",{parentName:"p"},"traefik-ui.minikube")," to your cluster ingress you can add an entry in our ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/hosts")," file to route ",(0,r.kt)("inlineCode",{parentName:"p"},"traefik-ui.minikube")," to our cluster. In production you would want to add your real DNS entries here!")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Kubernetes/2019-01-22--kubernetes-nginx-ingress/2019-01-22#creating-the-load-balancing-service"},"As seen before"),", we can add the Kubernetes Master WAN IP address, e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"externalIPs: 172.56.4.112"),", to the service configuration to be able to access the service over the internet")),(0,r.kt)("p",null,"Adding these two modifications, we end up with a YAML file looking like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"---\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: traefik-web-ui\n  namespace: monitoring\nspec:\n  selector:\n    k8s-app: traefik-ingress-lb\n  ports:\n  - name: http\n    port: 80\n    targetPort: 8080\n  externalIPs:\n    - 172.56.4.112\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: traefik-web-ui\n  namespace: monitoring\nspec:\n  rules:\n  - host: traefik-ui.minikube\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: traefik-web-ui\n          servicePort: http\n")),(0,r.kt)("p",null,"When you access the URL with your browser, you should now be greeted by the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containous/traefik#web-ui"},"Traefik Dashboard"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Traefik Ingress for your Kubernetes Cluster",src:n(98134).Z,width:"796",height:"761"})),(0,r.kt)("h2",{id:"path-based-routing"},"Path-based Routing"),(0,r.kt)("p",null,"First lets start by launching the pods for three websites. ",(0,r.kt)("strong",{parentName:"p"},"Note"),": I am using 3 Node.js apps that means they are Node.js/Express.js servers that host web content on a specific port. In my case those ports are ",(0,r.kt)("inlineCode",{parentName:"p"},"7777"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"7778")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"7779"),". They were uploaded to Dockerhub and can be accessed by referencing ",(0,r.kt)("inlineCode",{parentName:"p"},"- image: your-docker-hub-account/your-docker-image-name-on-docker-hub"),":"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"app1.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"---\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: wiki-de\n  labels:\n    app: wiki-frontend\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: wiki-frontend\n  template:\n    metadata:\n      labels:\n        app: wiki-frontend\n        version: v2.1.0\n    spec:\n      containers:\n      - image: mpolinowski/my-docker-image:latest\n        imagePullPolicy: Always\n        name: wiki-de\n        ports:\n        - containerPort: 7779\n      restartPolicy: Always\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: wiki-de\nspec:\n  ports:\n  - name: http\n    targetPort: 7779\n    port: 7779\n  selector:\n    app: wiki-frontend\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"app2.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"---\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: wiki-en\n  labels:\n    app: wiki-frontend\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: wiki-frontend\n  template:\n    metadata:\n      labels:\n        app: wiki-frontend\n        version: v2.1.0\n    spec:\n      containers:\n      - image: mpolinowski/my-docker-image-en:latest\n        imagePullPolicy: Always\n        name: wiki-en\n        ports:\n        - containerPort: 7777\n      restartPolicy: Always\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: wiki-en\nspec:\n  ports:\n  - name: http\n    targetPort: 7777\n    port: 7777\n  selector:\n    app: wiki-frontend\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"app3.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"---\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: wiki-fr\n  labels:\n    app: wiki-frontend\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: wiki-frontend\n  template:\n    metadata:\n      labels:\n        app: wiki-frontend\n        version: v2.1.0\n    spec:\n      containers:\n      - image: mpolinowski/my-docker-image-fr:latest\n        imagePullPolicy: Always\n        name: wiki-frontend\n        ports:\n        - containerPort: 7778\n      restartPolicy: Always\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: wiki-fr\nspec:\n  ports:\n  - name: http\n    targetPort: 7778\n    port: 7778\n  selector:\n    app: wiki-frontend\n")),(0,r.kt)("p",null,"Now we can submit an ingress for the 3 web apps:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: wiki-frontend\n  annotations:\n    kubernetes.io/ingress.class: traefik\n    traefik.frontend.rule.type: PathPrefixStrip\nspec:\n  rules:\n  - host: my.domain.com\n    http:\n      paths:\n      - path: /de\n        backend:\n          serviceName: wiki-de\n          servicePort: http\n      - path: /en\n        backend:\n          serviceName: wiki-en\n          servicePort: http\n      - path: /fr\n        backend:\n          serviceName: wiki-fr\n          servicePort: http\n")),(0,r.kt)("h2",{id:"user-authentication"},"User Authentication"),(0,r.kt)("p",null,"It's possible to protect access to Traefik through basic authentication. See the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.traefik.io/configuration/backends/kubernetes"},"Kubernetes Ingress")," configuration page for syntactical details and restrictions."),(0,r.kt)("h3",{id:"creating-the-secret"},"Creating the Secret"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Use ",(0,r.kt)("inlineCode",{parentName:"li"},"htpasswd")," to create a file containing the username and the MD5-encoded password (on Centos you might have to install it first ",(0,r.kt)("inlineCode",{parentName:"li"},"yum install -y httpd-tools"),"). You will be prompted for a password which you will have to enter twice:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"htpasswd -c ./auth myusername\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"Now use ",(0,r.kt)("inlineCode",{parentName:"li"},"kubectl")," to create a secret in the ",(0,r.kt)("inlineCode",{parentName:"li"},"monitoring")," namespace using the file created by ",(0,r.kt)("inlineCode",{parentName:"li"},"htpasswd"),":")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl create namespace monitoring\nkubectl create secret generic mysecret --from-file auth --namespace=monitoring\n")),(0,r.kt)("p",null,"You have to swap the ",(0,r.kt)("strong",{parentName:"p"},"kube-system")," with the ",(0,r.kt)("strong",{parentName:"p"},"monitoring")," namespace in the config files (see below)"),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"Attach the following annotations to the Ingress object:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},'traefik.ingress.kubernetes.io/auth-type: "basic"')),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},'traefik.ingress.kubernetes.io/auth-secret: "mysecret"'))),(0,r.kt)("p",null,"They specify basic authentication and reference the Secret ",(0,r.kt)("inlineCode",{parentName:"p"},"mysecret")," containing the credentials."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"HOW DO YOU CONFIGURE THE THE BASIC AUTHENTICATION? WIP")),(0,r.kt)("h2",{id:"add-a-tls-certificate-to-the-ingress"},"Add a TLS Certificate to the Ingress"),(0,r.kt)("p",null,"To setup an HTTPS-protected ingress, you can leverage the TLS feature of the ingress resource:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: traefik-web-ui\n  namespace: monitoring\n  annotations:\n    traefik.ingress.kubernetes.io/auth-type: "basic"\n    traefik.ingress.kubernetes.io/auth-secret: "mysecret"\nspec:\n  rules:\n  - host: my.domain.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: traefik-web-ui\n          servicePort: https\n  tls:\n   - secretName: traefik-ui-tls-cert\n')),(0,r.kt)("p",null,"We now need to provide the TLS certificate via a Kubernetes secret in the same namespace as the ingress. The following two commands will generate a new certificate and create a secret containing the key and cert files:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=traefik-ui.minikube"\nkubectl -n kube-system create secret tls traefik-ui-tls-cert --key=tls.key --cert=tls.crt\n')),(0,r.kt)("p",null,"Since I am already using fully qualified Domain - and I have used ",(0,r.kt)("a",{parentName:"p",href:"https://certbot.eff.org/lets-encrypt/centosrhel7-other"},"Certbot")," to generate an TLS certificate - I can use those files for my domain inside the ingress. "),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Note"),": that the certificate that you generated with Certbot can be found in ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/letsencrypt/live/my.domain.com")," - where ",(0,r.kt)("em",{parentName:"p"},"my.domain.com")," is the domain you created the certificate for. Furthermore, Certbot generates a couple of ",(0,r.kt)("em",{parentName:"p"},"*.pem")," files instead of a ",(0,r.kt)("em",{parentName:"p"},"*.key")," and ",(0,r.kt)("em",{parentName:"p"},"*.crt"),". In the kubectl command above use ",(0,r.kt)("inlineCode",{parentName:"p"},"privkey.pem")," as the ",(0,r.kt)("strong",{parentName:"p"},"key")," file and ",(0,r.kt)("inlineCode",{parentName:"p"},"fullchain.pem")," as your ",(0,r.kt)("strong",{parentName:"p"},"crt")," file (see ",(0,r.kt)("a",{parentName:"p",href:"https://stackoverflow.com/questions/50389883/generate-crt-key-ssl-files-from-lets-encrypt-from-scratch"},"Stackoverflow")," for details):"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Traefik Ingress for your Kubernetes Cluster",src:n(28412).Z,width:"800",height:"158"})),(0,r.kt)("p",null,"The resulting command will look something like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl -n kube-system create secret tls traefik-ui-tls-cert --key=/etc/letsencrypt/live/my.domain.com/privkey.pem --cert=/etc/letsencrypt/live/my.domain.com/fullchain.pem\n")),(0,r.kt)("p",null,"You receive a reply ",(0,r.kt)("inlineCode",{parentName:"p"},"secret/traefik-ui-tls-cert created"),"!"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"HOW DO YOU CONFIGURE THE SERVICE FOR HTTPS? WIP")),(0,r.kt)("p",null,"You can add a TLS entrypoint by adding the following args to the container spec:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"--defaultentrypoints=http,https\n--entrypoints=Name:https Address::443 TLS\n--entrypoints=Name:http Address::80\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"traefik-deployment.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: traefik-ingress-controller\n  namespace: monitoring\n  annotations:\n    traefik.ingress.kubernetes.io/auth-type: "basic"\n    traefik.ingress.kubernetes.io/auth-secret: "mysecret"\n  \n---\nkind: Deployment\napiVersion: extensions/v1beta1\nmetadata:\n  name: traefik-ingress-controller\n  namespace: monitoring\n  annotations:\n    traefik.ingress.kubernetes.io/auth-type: "basic"\n    traefik.ingress.kubernetes.io/auth-secret: "mysecret"\n  labels:\n    k8s-app: traefik-ingress-lb\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      k8s-app: traefik-ingress-lb\n  template:\n    metadata:\n      labels:\n        k8s-app: traefik-ingress-lb\n        name: traefik-ingress-lb\n    spec:\n      serviceAccountName: traefik-ingress-controller\n      terminationGracePeriodSeconds: 60\n      containers:\n      - image: traefik\n        name: traefik-ingress-lb\n        ports:\n        - name: http\n          containerPort: 80\n          hostPort: 8080\n        - name: https\n          containerPort: 443\n          hostPort: 443\n        - name: admin\n          containerPort: 8080\n        args:\n        - --api\n        - --kubernetes\n        - --logLevel=INFO\n        - --defaultentrypoints=https,http\n        - --entrypoints=Name:https Address::443 TLS\n        - --entrypoints=Name:http Address::80\n        \n---\nkind: Service\napiVersion: v1\nmetadata:\n  name: traefik-ingress-service\n  namespace: monitoring\n  annotations:\n    traefik.ingress.kubernetes.io/auth-type: "basic"\n    traefik.ingress.kubernetes.io/auth-secret: "mysecret"\nspec:\n  selector:\n    k8s-app: traefik-ingress-lb\n  ports:\n    - protocol: TCP\n      port: 80\n      name: http\n    - protocol: TCP\n      port: 443\n      name: https\n    - protocol: TCP\n      port: 8080\n      name: admin\n  type: NodePort\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ui.yaml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'---\napiVersion: v1\nkind: Service\nmetadata:\n  name: traefik-web-ui\n  namespace: monitoring\n  annotations:\n    traefik.ingress.kubernetes.io/auth-type: "basic"\n    traefik.ingress.kubernetes.io/auth-secret: "mysecret"\nspec:\n  selector:\n    k8s-app: traefik-ingress-lb\n  ports:\n  - name: http\n    port: 80\n    targetPort: 8080\n  - name: https\n    protocol: TCP\n    port: 443\n    targetPort: 443\n  externalIPs:\n    - 172.56.4.112\n---\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: traefik-web-ui\n  namespace: monitoring\n  annotations:\n    traefik.ingress.kubernetes.io/auth-type: "basic"\n    traefik.ingress.kubernetes.io/auth-secret: "mysecret"\nspec:\n  rules:\n  - host: my.domain.com\n    http:\n      paths:\n      - path: /\n        backend:\n          serviceName: traefik-web-ui\n          servicePort: https\n  tls:\n   - secretName: traefik-ui-tls-cert\n')),(0,r.kt)("h2",{id:"name-based-routing"},"Name-based Routing"))}u.isMDXComponent=!0},82496:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/kubernetes-traefik-ingress_01-94516171af04abbc8c3ee76a128b1125.png"},79239:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/kubernetes-traefik-ingress_02-ace63b8982f3e4f6468213b4818afd18.png"},98134:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/kubernetes-traefik-ingress_03-0df32c10297d821ae9707da1fc32299e.png"},28412:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/kubernetes-traefik-ingress_04-3df3881c655aff5f96e43008621a2363.png"},26182:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/photo-34445481222_d3b67160da_o-653547e2ea32ba21f5f8ec162c1579ce.jpg"}}]);