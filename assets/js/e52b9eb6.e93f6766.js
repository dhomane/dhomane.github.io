"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[5965],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>u});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,r=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),m=c(a),u=o,k=m["".concat(s,".").concat(u)]||m[u]||d[u]||r;return a?n.createElement(k,l(l({ref:t},p),{},{components:a})):n.createElement(k,l({ref:t},p))}));function u(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=a.length,l=new Array(r);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var c=2;c<r;c++)l[c]=a[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},99399:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var n=a(87462),o=(a(67294),a(3905));const r={sidebar_position:8070,slug:"2020-06-25",title:"Salt Orchestration for Docker Containers",authors:"mpolinowski",tags:["LINUX","Salt"]},l=void 0,i={unversionedId:"DevOps/Salt/2020-06-25--salt-orchestration-for-docker-containers/index",id:"DevOps/Salt/2020-06-25--salt-orchestration-for-docker-containers/index",title:"Salt Orchestration for Docker Containers",description:"TST, Hong Kong",source:"@site/docs/DevOps/Salt/2020-06-25--salt-orchestration-for-docker-containers/index.md",sourceDirName:"DevOps/Salt/2020-06-25--salt-orchestration-for-docker-containers",slug:"/DevOps/Salt/2020-06-25--salt-orchestration-for-docker-containers/2020-06-25",permalink:"/docs/DevOps/Salt/2020-06-25--salt-orchestration-for-docker-containers/2020-06-25",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Salt/2020-06-25--salt-orchestration-for-docker-containers/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Salt",permalink:"/docs/tags/salt"}],version:"current",sidebarPosition:8070,frontMatter:{sidebar_position:8070,slug:"2020-06-25",title:"Salt Orchestration for Docker Containers",authors:"mpolinowski",tags:["LINUX","Salt"]},sidebar:"tutorialSidebar",previous:{title:"Salt",permalink:"/docs/category/salt"},next:{title:"Saltstack Refresh Course 2: Salt Mines",permalink:"/docs/DevOps/Salt/2020-06-23--saltestack-refresh-course-4-salt-mine/2020-06-23"}},s={},c=[{value:"Salty Containers",id:"salty-containers",level:2},{value:"PIP Install Docker",id:"pip-install-docker",level:3},{value:"Registry Authentication",id:"registry-authentication",level:3},{value:"Download your Image",id:"download-your-image",level:2},{value:"Download Gitlab Artifacts",id:"download-gitlab-artifacts",level:2},{value:"Cloning Gitlab Repositories",id:"cloning-gitlab-repositories",level:2},{value:"Working with Docker-Compose",id:"working-with-docker-compose",level:2}],p={toc:c};function d(e){let{components:t,...r}=e;return(0,o.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"TST, Hong Kong",src:a(70100).Z,width:"1500",height:"564"})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#salty-containers"},"Salty Containers"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#pip-install-docker"},"PIP Install Docker")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#registry-authentication"},"Registry Authentication")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#download-your-image"},"Download your Image")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#download-gitlab-artifacts"},"Download Gitlab Artifacts")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#cloning-gitlab-repositories"},"Cloning Gitlab Repositories")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#working-with-docker-compose"},"Working with Docker-Compose"))),(0,o.kt)("h2",{id:"salty-containers"},"Salty Containers"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.dockermod.html#module-salt.modules.dockermod"},"salt.modules.dockermod"))),(0,o.kt)("h3",{id:"pip-install-docker"},"PIP Install Docker"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"salt salt-minion pip.install docker\n\nsalt-minion:\n----------\npid:\n    8141\nstderr:\nstdout:\nCollecting docker\nInstalling collected packages: websocket-client, docker\nSuccessfully installed docker-4.3.1 websocket-client-0.57.0\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"salt salt-minion docker.run_container hello-world\n\nsalt-minion:\n    ----------\n    ExitCode:\n        0\n    Id:\n        7c67b9c1a64ec4d6b9c65f75f1daffbc3d495554a7f9a8de866cd37923205cff\n    Logs:\n        \n        Hello from Docker!\n        This message shows that your installation appears to be working correctly.\n        \n    Name:\n        optimistic_noyce\n    Time_Elapsed:\n        0.9424302577972412\n    Warnings:\n")),(0,o.kt)("h3",{id:"registry-authentication"},"Registry Authentication"),(0,o.kt)("p",null,"If you have previously performed a docker login from the minion, then the credentials saved in ",(0,o.kt)("inlineCode",{parentName:"p"},"~/.docker/config.json")," will be used for any actions which require authentication."),(0,o.kt)("p",null,"The configuration schema is either in YAML or JSON as follows:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yml"},"docker-registries:\n  <registry_url>:\n    username: <username>\n    password: <password>\n")),(0,o.kt)("p",null,"For example (JSON):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "auths": {\n            "my.gitlab.com:12345": {\n                    "auth": "KJSHFG*#&$()*NFKSJLNLIU#P(*%R$W)IOWFOIJHWOILTFHNSILKEJRFHNOIE"\n            }\n    },\n    "HttpHeaders": {\n            "User-Agent": "Docker-Client/19.03.12 (linux)"\n    }\n}\n')),(0,o.kt)("h2",{id:"download-your-image"},"Download your Image"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -d --network host -v /opt/docker_ingress:/etc/nginx/conf.d --name nginx nginx:stable-alpine\n\ndocker run -d --network host -v /opt/hapi-container-en/public:/wiki_en_ssr/public --name wiki_en my.gitlab.com:12345/wiki/wiki_en_container:latest\n\ndocker run -d --network host -v /opt/hapi-container-fr/public:/wiki_fr_ssr/public --name wiki_fr my.gitlab.com:12345/wiki/wiki_fr_container:latest\n\ndocker run -d --network host -v /opt/hapi-container-de/public:/wiki_de_ssr/public --name wiki_de my.gitlab.com:12345/wiki/wiki_de_container:latest\n")),(0,o.kt)("h2",{id:"download-gitlab-artifacts"},"Download Gitlab Artifacts"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://docs.saltstack.com/en/latest/topics/execution/remote_execution.html"},"remote_execution"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"salt -L salt-minion cmd.run 'ps aux | grep docker'\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'curl -L --header "PRIVATE-TOKEN: myprivatedownloadtoken" "https://my.gitlab.com/api/v4/projects/wiki%2Fwiki_en/jobs/artifacts/master/download?job=pages" >> /opt/test/artifacts.zip\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'salt -L salt-minion cmd.run \'curl -L --header "PRIVATE-TOKEN: myprivatedownloadtoken" "https://my.gitlab.com/api/v4/projects/wiki%2Fwiki_en/jobs/artifacts/master/download?job=pages" >> /opt/test/artifacts.zip\'\n\nsalt-minion:\nMinion did not return. [No response]\nThe minions may not have all finished running and any remaining minions will return upon completion. To look up the return data for this job later, run the following command:\n\nsalt-run jobs.lookup_jid 20200924131636872103\nERROR: Minions returned with non-zero exit code\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'salt -L salt-minion cmd.run \'curl -L --header "PRIVATE-TOKEN: myprivatedownloadtoken" "https://my.gitlab.com/api/v4/projects/wiki%2Fwiki_en/jobs/artifacts/master/download?job=pages" >> /opt/test/artifacts.zip\'\n\nsalt -L salt-minion cmd.run \'curl -L --header "PRIVATE-TOKEN: myprivatedownloadtoken" "https://my.gitlab.com/api/v4/projects/wiki%2Fwiki_de/jobs/artifacts/master/download?job=pages" >> /opt/test/artifacts.zip\'\n')),(0,o.kt)("h2",{id:"cloning-gitlab-repositories"},"Cloning Gitlab Repositories"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.git.html#module-salt.modules.git"},"module-salt.modules.git"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"salt salt-minion git.clone /path/to/repo_parent_dir git://github.com/saltstack/salt.git\n")),(0,o.kt)("h2",{id:"working-with-docker-compose"},"Working with Docker-Compose"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.dockercompose.html#salt.modules.dockercompose.up"},"salt.modules.dockercompose.up"))),(0,o.kt)("p",null,"This execution module requires at least version 1.4.0 of both docker-compose and Docker. docker-compose can easily be installed using pip.install:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"salt myminion pip.install docker-compose>=1.5.0\n")),(0,o.kt)("p",null,"Build image for containers in the docker-compose file, service_names is a python list, if omitted build images for all containers. Please note that at the moment the module does not allow you to upload your Dockerfile, nor any other file you could need with your docker-compose.yml, you will have to make sure the files you need are actually in the directory specified in the build keyword"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null}),(0,o.kt)("th",{parentName:"tr",align:null}))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"path"),(0,o.kt)("td",{parentName:"tr",align:null},"Path where the docker-compose file is stored on the server")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"service_names"),(0,o.kt)("td",{parentName:"tr",align:null},"If specified will pull only the image for the specified services")))),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"CLI Example"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"salt myminion dockercompose.build /path/where/docker-compose/stored\nsalt myminion dockercompose.build /path/where/docker-compose/stored '[janus]'\n\nsalt myminion dockercompose.up /path/where/docker-compose/stored\nsalt myminion dockercompose.up /path/where/docker-compose/stored '[janus]'\n")))}d.isMDXComponent=!0},70100:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-f02d8f654dbbf66b3ab127983762f988.jpg"}}]);