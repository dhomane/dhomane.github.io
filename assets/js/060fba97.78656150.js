"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[89517],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>c});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),m=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=m(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,u=o(e,["components","mdxType","originalType","parentName"]),p=m(n),c=r,h=p["".concat(l,".").concat(c)]||p[c]||d[c]||i;return n?a.createElement(h,s(s({ref:t},u),{},{components:n})):a.createElement(h,s({ref:t},u))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=p;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var m=2;m<i;m++)s[m]=n[m];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},757:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>m});var a=n(87462),r=(n(67294),n(3905));const i={sidebar_position:6060,slug:"2021-09-13",title:"PostgreSQL 14 Database Refresher :: Introduction Part II",authors:"mpolinowski",tags:["SQL","Databases"]},s=void 0,o={unversionedId:"DevOps/Provisioning/2021-09-13--postgres-refresher-part-ii/index",id:"DevOps/Provisioning/2021-09-13--postgres-refresher-part-ii/index",title:"PostgreSQL 14 Database Refresher :: Introduction Part II",description:"Shenzhen, China",source:"@site/docs/DevOps/Provisioning/2021-09-13--postgres-refresher-part-ii/index.md",sourceDirName:"DevOps/Provisioning/2021-09-13--postgres-refresher-part-ii",slug:"/DevOps/Provisioning/2021-09-13--postgres-refresher-part-ii/2021-09-13",permalink:"/docs/DevOps/Provisioning/2021-09-13--postgres-refresher-part-ii/2021-09-13",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Provisioning/2021-09-13--postgres-refresher-part-ii/index.md",tags:[{label:"SQL",permalink:"/docs/tags/sql"},{label:"Databases",permalink:"/docs/tags/databases"}],version:"current",sidebarPosition:6060,frontMatter:{sidebar_position:6060,slug:"2021-09-13",title:"PostgreSQL 14 Database Refresher :: Introduction Part II",authors:"mpolinowski",tags:["SQL","Databases"]},sidebar:"tutorialSidebar",previous:{title:"PostgreSQL 14 Database Refresher :: Working with GraphQL",permalink:"/docs/DevOps/Provisioning/2021-09-14--postgres-refresher-hasura/2021-09-14"},next:{title:"PostgreSQL 14 Database Refresher :: Introduction Part I",permalink:"/docs/DevOps/Provisioning/2021-09-13--postgres-refresher-part-i/2021-09-13"}},l={},m=[{value:"Foreign Keys",id:"foreign-keys",level:2},{value:"REFERENCES",id:"references",level:3},{value:"ON DELETE",id:"on-delete",level:3},{value:"Joins",id:"joins",level:2},{value:"INNER JOIN",id:"inner-join",level:3},{value:"NATURAL INNER JOIN",id:"natural-inner-join",level:3},{value:"Subqueries",id:"subqueries",level:2},{value:"Grouping Results",id:"grouping-results",level:2},{value:"GROUP BY",id:"group-by",level:3},{value:"Indexes",id:"indexes",level:2}],u={toc:m};function d(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Shenzhen, China",src:n(71142).Z,width:"1500",height:"392"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#foreign-keys"},"Foreign Keys"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#references"},"REFERENCES")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#on-delete"},"ON DELETE")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#joins"},"Joins"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#inner-join"},"INNER JOIN")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#natural-inner-join"},"NATURAL INNER JOIN")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#subqueries"},"Subqueries")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#grouping-results"},"Grouping Results"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#group-by"},"GROUP BY")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#indexes"},"Indexes"))),(0,r.kt)("h2",{id:"foreign-keys"},"Foreign Keys"),(0,r.kt)("h3",{id:"references"},"REFERENCES"),(0,r.kt)("p",null,"As part of the previous step I created 4 tables:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE users (\n  user_id INTEGER PRIMARY KEY GENERATED ALWAYS AS IDENTITY,\n  username VARCHAR ( 25 ) UNIQUE NOT NULL,\n  email VARCHAR ( 50 ) UNIQUE NOT NULL,\n  full_name VARCHAR ( 100 ) NOT NULL,\n  last_login TIMESTAMP,\n  created_on TIMESTAMP NOT NULL\n);\n\nCREATE TABLE boards (\n  board_id INTEGER PRIMARY KEY GENERATED ALWAYS AS IDENTITY,\n  board_name VARCHAR ( 50 ) UNIQUE NOT NULL,\n  board_description TEXT NOT NULL\n);\n\nCREATE TABLE comments (\n  comment_id INTEGER PRIMARY KEY GENERATED ALWAYS AS IDENTITY,\n  user_id INT REFERENCES users(user_id) ON DELETE CASCADE,\n  board_id INT REFERENCES boards(board_id) ON DELETE CASCADE,\n  comment TEXT NOT NULL,\n  time TIMESTAMP\n);\n\nCREATE TABLE rich_content (\n  content_id INTEGER PRIMARY KEY GENERATED ALWAYS AS IDENTITY,\n  comment_id INT REFERENCES comments(comment_id) ON DELETE CASCADE,\n  content JSONB NOT NULL\n);\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"comment")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"rich_content")," table both contain references to other tables - those are called foreign keys. Importing keys from other tables, instead of duplicating them, makes it much harder to get your data out of sync!"),(0,r.kt)("h3",{id:"on-delete"},"ON DELETE"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"user_id INT REFERENCES users(user_id) ON DELETE CASCADE,\nboard_id INT REFERENCES boards(board_id) ON DELETE CASCADE,\n")),(0,r.kt)("p",null,"You can also define a default behaviour what should be done if the key, that is imported into another table, is deleted. The default behaviour is to prevent the deletion ",(0,r.kt)("inlineCode",{parentName:"p"},"ON DELETE NO ACTION")," as long there is still data somewhere else that relies on that key - e.g. you cannot delete a user before all his postings are deleted."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"ON DELETE CASCADE")," block means that every posting of this user is deleted as well if the user is deleted inside the ",(0,r.kt)("inlineCode",{parentName:"p"},"users")," table."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ON DELETE NO ACTION"),": Deleting the user will throw an error if there is still related content."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ON DELETE CASCADE"),": Deleting the user deletes everything that is bound to his ID."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"ON DELETE SET NULL"),": Will set the username to NULL while keeping the users other data intact.")),(0,r.kt)("h2",{id:"joins"},"Joins"),(0,r.kt)("h3",{id:"inner-join"},"INNER JOIN"),(0,r.kt)("p",null,"The inner join uses the overlap of two tables to find additional, related data. Like an User ID might might have data assigned to it in several tables. You can use the ",(0,r.kt)("strong",{parentName:"p"},"INNER JOIN")," to match rows in those tables when they have the same value for ",(0,r.kt)("inlineCode",{parentName:"p"},"user_id"),"."),(0,r.kt)("p",null,"EXAMPLE: Get first 60 characters of all comments from a specific user board and project it as ",(0,r.kt)("inlineCode",{parentName:"p"},"preview"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT comment_id, user_id, LEFT(comment, 60) AS preview FROM comments WHERE board_id='39';\n\n comment_id | user_id |                           preview                            \n------------+---------+--------------------------------------------------------------\n         63 |     858 | Maecenas tristique, est et tempus semper, est quam pharetra \n        358 |     876 | Mauris enim leo, rhoncus sed, vestibulum sit amet, cursus id\n        410 |     344 | Praesent blandit. Nam nulla. Integer pede justo, lacinia ege\n        429 |     789 | Maecenas ut massa quis augue luctus tincidunt. Nulla mollis \n        463 |     925 | Phasellus sit amet erat. Nulla tempus. Vivamus in felis eu s\n        485 |     112 | Maecenas tristique, est et tempus semper, est quam pharetra \n        524 |      41 | Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Pr\n        532 |     502 | In hac habitasse platea dictumst. Morbi vestibulum, velit id\n        540 |     588 | Nullam porttitor lacus at turpis. Donec posuere metus vitae \n        545 |     587 | Praesent id massa id nisl venenatis lacinia. Aenean sit amet\n        551 |     620 | Morbi porttitor lorem id ligula. Suspendisse ornare consequa\n        972 |     998 | Aenean lectus. Pellentesque eget nunc. Donec quis orci eget \n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"comments")," table does not contain the username. We can use a ",(0,r.kt)("inlineCode",{parentName:"p"},"JOIN")," command to connect the ",(0,r.kt)("inlineCode",{parentName:"p"},"user_id")," from the ",(0,r.kt)("inlineCode",{parentName:"p"},"comments")," table with the ",(0,r.kt)("inlineCode",{parentName:"p"},"user_id")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"users")," table and read out the username where both match ",(0,r.kt)("inlineCode",{parentName:"p"},"comments.user_id = users.user_id"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  comments.comment_id, comments.user_id, users.username, time, LEFT(comment, 20) AS preview\n  FROM\n    comments\n  INNER JOIN\n    users\n  ON\n    comments.user_id = users.user_id\n  WHERE\n    board_id=39;\n\n\n comment_id | user_id |   username   |        time         |       preview        \n------------+---------+--------------+---------------------+----------------------\n        524 |      41 | klicciardo14 | 2018-07-09 15:36:28 | Lorem ipsum dolor si\n        485 |     112 | erobrose33   | 2019-08-30 02:32:38 | Maecenas tristique, \n        410 |     344 | tposse9j     | 2018-10-07 19:02:52 | Praesent blandit. Na\n        532 |     502 | dbenndx      | 2019-07-06 04:08:15 | In hac habitasse pla\n        545 |     587 | rspitaroga   | 2019-11-03 22:48:08 | Praesent id massa id\n        540 |     588 | rrandlegb    | 2020-01-21 19:52:11 | Nullam porttitor lac\n        551 |     620 | bcarlawh7    | 2020-06-11 00:37:22 | Morbi porttitor lore\n        429 |     789 | mpelllw      | 2019-05-24 14:56:49 | Maecenas ut massa qu\n         63 |     858 | uvickarnt    | 2020-07-31 04:46:40 | Maecenas tristique, \n        358 |     876 | egeffenob    | 2020-06-20 02:28:58 | Mauris enim leo, rho\n        463 |     925 | hderrickpo   | 2018-01-02 14:48:49 | Phasellus sit amet e\n        972 |     998 | imcdowallrp  | 2018-03-15 00:23:38 | Aenean lectus. Pelle\n(12 rows)\n")),(0,r.kt)("h3",{id:"natural-inner-join"},"NATURAL INNER JOIN"),(0,r.kt)("p",null,"The query can be simplified when the field has the identical name in both tables ",(0,r.kt)("inlineCode",{parentName:"p"},"user.id")," by using ",(0,r.kt)("inlineCode",{parentName:"p"},"NATURAL INNER JOIN")," instead: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  comments.comment_id, comments.user_id, users.username, time, LEFT(comment, 20) AS preview\n  FROM\n    comments\n  NATURAL INNER JOIN\n    users\n  WHERE\n    board_id=39;\n\n\n comment_id | user_id |   username   |        time         |       preview        \n------------+---------+--------------+---------------------+----------------------\n        524 |      41 | klicciardo14 | 2018-07-09 15:36:28 | Lorem ipsum dolor si\n        485 |     112 | erobrose33   | 2019-08-30 02:32:38 | Maecenas tristique, \n        410 |     344 | tposse9j     | 2018-10-07 19:02:52 | Praesent blandit. Na\n        532 |     502 | dbenndx      | 2019-07-06 04:08:15 | In hac habitasse pla\n        545 |     587 | rspitaroga   | 2019-11-03 22:48:08 | Praesent id massa id\n        540 |     588 | rrandlegb    | 2020-01-21 19:52:11 | Nullam porttitor lac\n        551 |     620 | bcarlawh7    | 2020-06-11 00:37:22 | Morbi porttitor lore\n        429 |     789 | mpelllw      | 2019-05-24 14:56:49 | Maecenas ut massa qu\n         63 |     858 | uvickarnt    | 2020-07-31 04:46:40 | Maecenas tristique, \n        358 |     876 | egeffenob    | 2020-06-20 02:28:58 | Mauris enim leo, rho\n        463 |     925 | hderrickpo   | 2018-01-02 14:48:49 | Phasellus sit amet e\n        972 |     998 | imcdowallrp  | 2018-03-15 00:23:38 | Aenean lectus. Pelle\n(12 rows)\n")),(0,r.kt)("h2",{id:"subqueries"},"Subqueries"),(0,r.kt)("p",null,"SQL allows you cascade several queries into each other. This is, basically, the long way to what ",(0,r.kt)("inlineCode",{parentName:"p"},"JOIN")," is the shortcut to."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  comment_id, user_id, LEFT(comment, 20)\n  FROM\n    comments\n  WHERE\n    user_id = (SELECT user_id from users WHERE username = 'klicciardo14');\n\n\n     comment_id | user_id |         left         \n------------+---------+----------------------\n        524 |      41 | Lorem ipsum dolor si\n(1 row)\n")),(0,r.kt)("h2",{id:"grouping-results"},"Grouping Results"),(0,r.kt)("h3",{id:"group-by"},"GROUP BY"),(0,r.kt)("p",null,"Select all the boards on your forum and find the one that has the most comments by aggregating the amounts of comments on each board."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n  boards.board_name, COUNT(comment_id) AS comment_count\nFROM\n  comments\nNATURAL INNER JOIN\n  boards\nGROUP BY\n  boards.board_name\nORDER BY\n  comment_count DESC\nLIMIT 10;\n\n\n      board_name      | comment_count \n----------------------+---------------\n Cloned               |            18\n budgetary management |            18\n open system          |            16\n Universal            |            16\n analyzer             |            15\n puppies              |            15\n Balanced             |            14\n leverage             |            14\n Seamless             |            14\n Innovative           |            13\n(10 rows)\n")),(0,r.kt)("p",null,"Count ",(0,r.kt)("inlineCode",{parentName:"p"},"comment_id")," in the ",(0,r.kt)("inlineCode",{parentName:"p"},"comments")," table and group those counts by the name of the board in which they were posted - which can be found by an inner join from the ",(0,r.kt)("inlineCode",{parentName:"p"},"boards")," table."),(0,r.kt)("h2",{id:"indexes"},"Indexes"),(0,r.kt)("p",null,"Get all the post on a specific board and order them by the time that they where published:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT comment_id, user_id, time, LEFT(comment,20) FROM comments WHERE board_id=39 ORDER BY time DESC;\n\n comment_id | user_id |        time         |         left         \n------------+---------+---------------------+----------------------\n         63 |     858 | 2020-07-31 04:46:40 | Maecenas tristique, \n        358 |     876 | 2020-06-20 02:28:58 | Mauris enim leo, rho\n        551 |     620 | 2020-06-11 00:37:22 | Morbi porttitor lore\n        540 |     588 | 2020-01-21 19:52:11 | Nullam porttitor lac\n        545 |     587 | 2019-11-03 22:48:08 | Praesent id massa id\n        485 |     112 | 2019-08-30 02:32:38 | Maecenas tristique, \n        532 |     502 | 2019-07-06 04:08:15 | In hac habitasse pla\n        429 |     789 | 2019-05-24 14:56:49 | Maecenas ut massa qu\n        410 |     344 | 2018-10-07 19:02:52 | Praesent blandit. Na\n        524 |      41 | 2018-07-09 15:36:28 | Lorem ipsum dolor si\n        972 |     998 | 2018-03-15 00:23:38 | Aenean lectus. Pelle\n        463 |     925 | 2018-01-02 14:48:49 | Phasellus sit amet e\n")),(0,r.kt)("p",null,"To check the ",(0,r.kt)("inlineCode",{parentName:"p"},"cost")," (how much time/cpu power will it take to run this query) check:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'EXPLAIN SELECT comment_id, user_id, time, LEFT(comment,20) FROM comments WHERE board_id=39 ORDER BY time DESC\n;\n\n                           QUERY PLAN                            \n-----------------------------------------------------------------\n Sort  (cost=65.75..65.78 rows=12 width=48)\n   Sort Key: "time" DESC\n   ->  Seq Scan on comments  (cost=0.00..65.53 rows=12 width=48)\n         Filter: (board_id = 39)\n(4 rows)\n')),(0,r.kt)("p",null,"The sequential scan of every single comment to see if it fits the query takes up almost all the time. You can index the table to get this demand down. In the example above it makes sense to index each comment based on it's ",(0,r.kt)("inlineCode",{parentName:"p"},"board_id")," - allowing us to pre-exclude every comment that was posted on a different board."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE INDEX ON comments (board_id);\n")),(0,r.kt)("p",null,"Re-checking the cost shows that the cost for our query was almost cut in half by now using the ",(0,r.kt)("strong",{parentName:"p"},"Bitmap Heap Scan"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'EXPLAIN SELECT comment_id, user_id, time, LEFT(comment,20) FROM comments WHERE board_id=39 ORDER BY time DESC\n;\n                                        QUERY PLAN                                         \n-------------------------------------------------------------------------------------------\n Sort  (cost=33.73..33.76 rows=12 width=48)\n   Sort Key: "time" DESC\n   ->  Bitmap Heap Scan on comments  (cost=4.37..33.51 rows=12 width=48)\n         Recheck Cond: (board_id = 39)\n         ->  Bitmap Index Scan on comments_board_id_idx  (cost=0.00..4.37 rows=12 width=0)\n               Index Cond: (board_id = 39)\n(6 rows)\n')))}d.isMDXComponent=!0},71142:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-71f2b7209f58ecc12682d4095513b1b8.jpg"}}]);