"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[35092],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>m});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var i=a.createContext({}),c=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},d=function(e){var n=c(e.components);return a.createElement(i.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=c(t),m=r,h=u["".concat(i,".").concat(m)]||u[m]||p[m]||o;return t?a.createElement(h,s(s({ref:n},d),{},{components:t})):a.createElement(h,s({ref:n},d))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,s=new Array(o);s[0]=u;var l={};for(var i in n)hasOwnProperty.call(n,i)&&(l[i]=n[i]);l.originalType=e,l.mdxType="string"==typeof e?e:r,s[1]=l;for(var c=2;c<o;c++)s[c]=t[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},59795:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var a=t(87462),r=(t(67294),t(3905));const o={sidebar_position:9010,slug:"2021-09-24",title:"Getting started with Go and React - React & REST API's",authors:"mpolinowski",tags:["SQL","Javascript","Go"]},s=void 0,l={unversionedId:"Development/Go/2021-09-24--golang-react-starter-part-iv/index",id:"Development/Go/2021-09-24--golang-react-starter-part-iv/index",title:"Getting started with Go and React - React & REST API's",description:"Shenzhen, China",source:"@site/docs/Development/Go/2021-09-24--golang-react-starter-part-iv/index.md",sourceDirName:"Development/Go/2021-09-24--golang-react-starter-part-iv",slug:"/Development/Go/2021-09-24--golang-react-starter-part-iv/2021-09-24",permalink:"/docs/Development/Go/2021-09-24--golang-react-starter-part-iv/2021-09-24",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Development/Go/2021-09-24--golang-react-starter-part-iv/index.md",tags:[{label:"SQL",permalink:"/docs/tags/sql"},{label:"Javascript",permalink:"/docs/tags/javascript"},{label:"Go",permalink:"/docs/tags/go"}],version:"current",sidebarPosition:9010,frontMatter:{sidebar_position:9010,slug:"2021-09-24",title:"Getting started with Go and React - React & REST API's",authors:"mpolinowski",tags:["SQL","Javascript","Go"]},sidebar:"tutorialSidebar",previous:{title:"goFTP",permalink:"/docs/Development/Go/2021-10-08--goftp/2021-10-08"},next:{title:"Getting started with Go and React - PostgreSQL",permalink:"/docs/Development/Go/2021-09-23--golang-react-starter-part-iii/2021-09-23"}},i={},c=[{value:"Go CORS Middleware",id:"go-cors-middleware",level:2},{value:"React Frontend",id:"react-frontend",level:2},{value:"Display Camera List",id:"display-camera-list",level:3},{value:"Error Handling",id:"error-handling",level:3},{value:"Display Single Camera Details",id:"display-single-camera-details",level:3},{value:"Display all Camera Locations",id:"display-all-camera-locations",level:3},{value:"Backend",id:"backend",level:4},{value:"Frontend",id:"frontend",level:4},{value:"Display all Cameras from a Location",id:"display-all-cameras-from-a-location",level:3},{value:"Backend",id:"backend-1",level:4},{value:"Frontend",id:"frontend-1",level:4}],d={toc:c};function p(e){let{components:n,...o}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,o,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Shenzhen, China",src:t(18710).Z,width:"1500",height:"441"})),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Creating an REST API backend in Go and connecting it to a React.js frontend.")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#"},"Part I - Webservice, Routing and Status Log")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#"},"Part II - API Routes")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#"},"Part III - PostgreSQL")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#"},"Part III - React & REST API's"))),(0,r.kt)("p",null,"I want to prototype a Go backend for a ",(0,r.kt)("strong",{parentName:"p"},"Weather Cam")," tool. The backend should hold all the information related to all cameras and serve them on different routes. The backend then needs to be connected to a React.js frontend that displays the JSON data that is being served as well as to allow to add / delete cameras."),(0,r.kt)("h2",{id:"go-cors-middleware"},"Go CORS Middleware"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Access to fetch at 'http://localhost:4000/v1/cameras' from origin 'http://localhost:3000' has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource. If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.")),(0,r.kt)("p",null,"To be able to connect our React frontend with the Go backend, we first need to take care of our CORS header. Since the applications are running on different ports they will be interpreted as different webpages by our browsers - and the API will be blocked by default. We need a middleware that adds a allow all origins header to every request:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"./src/api/middleware.go")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'package main\n\nimport "net/http"\n\nfunc (app *application) enableCORS(next http.Handler) http.Handler {\n    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n        w.Header().Set("Access-Control-Allow-Origin", "*")\n\n        next.ServeHTTP(w, r)\n    })\n}\n')),(0,r.kt)("p",null,"The middleware just needs to be wrapped around our routes:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"//BEFORE\nfunc (app *application) routes() *httprouter.Router {\n    ...\n    return router\n}\n//AFTER\nfunc (app *application) routes() http.Handler {\n    ...\n    return app.enableCORS(router)\n}\n")),(0,r.kt)("h2",{id:"react-frontend"},"React Frontend"),(0,r.kt)("h3",{id:"display-camera-list"},"Display Camera List"),(0,r.kt)("p",null,"So far we hardcoded a list of cameras to our React component in:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"src/components/cameras.jsx")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'state= {cameras: []}\n\ncomponentDidMount() {\n        this.setState({\n            cameras: [\n                {id: 1, name: "A Camera", location: "Somewhere"},\n                {id: 2, name: "B Camera", location: "Nowhere"},\n                {id: 3, name: "C Camera", location: "Knowhere"}\n            ]\n        })\n    }\n')),(0,r.kt)("p",null,"Here we now need to add our API request list:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'state= {\n    cameras: [],\n    isLoaded: false,\n}\n\ncomponentDidMount() {\n        fetch("http://localhost:4000/v1/cameras")\n            .then((response) => response.json())\n            .then((json) => {\n                this.setState(\n                    cameras: json.cameras,\n                    isLoaded: true\n                )\n            })\n    }\n')),(0,r.kt)("p",null,"To render the response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"render() {\n        const { cameras, isLoaded } = this.state;\n\n        if (!isLoaded) {\n            return <p>Loading ...</p>\n        } else {\n        return (\n            <>\n                <h2>Cameras</h2>\n\n                <ul>\n                    {cameras.map( (m) => (\n                        <li key={m.id}>\n                            <Link to={`/cameras/${m.id}`}>{m.name}</Link>\n                        </li>\n                    ))}\n                </ul>\n            </>\n        )\n    }}\n")),(0,r.kt)("p",null,"Go and visit the frontend ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:3000/#/cameras")," - it should now render the list of cameras defined in our Postgres database!"),(0,r.kt)("h3",{id:"error-handling"},"Error Handling"),(0,r.kt)("p",null,"So far we have a variable called ",(0,r.kt)("inlineCode",{parentName:"p"},"isLoaded"),' that is set to true once we get the JSON response from our API. We are using an IF statement to replace a "Loading..." paragraph with the actual data once this happens. But we still need to handle the case that our API returns something that is not the correct response:'),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"./src/components/cameras.jsx")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export default class Cameras extends Component {\n  state = {\n    cameras: [],\n    isLoaded: false,\n    // Add state for error handling\n    error: null,\n  }\n\n  componentDidMount() {\n    fetch('http://localhost:4000/v1/cameras')\n      // .then((response) => response.json())\n      // Replace above with error handler\n      .then((response) => {\n        // Debugging: Print status code to console\n        // console.log(\"API Response Status Code: \", response.status)\n        if (response.status !== '200') {\n          let err = Error\n          err.message = 'Invalid API Response Code: ' + response.status\n          this.setState({ error: err })\n        }\n        return response.json()\n      })\n      .then((json) => {\n        this.setState(\n          {\n            cameras: json.cameras,\n            isLoaded: true,\n          },\n          // If status code is not 200 export error instead\n          (error) => {\n            this.setState({\n              isLoaded: true,\n              error,\n            })\n          }\n        )\n      })\n  }\n\n  render() {\n    const { cameras, isLoaded, error } = this.state\n    // Print error if error is not null\n    if (error) {\n      return <div>Error: {error.message}</div>\n      // Or print `Loading...` until JSON response\n    } else if (!isLoaded) {\n      return <p>Loading ...</p>\n      // Once it is loaded print response\n    } else {\n      return (\n        <>\n          <h2>Cameras</h2>\n\n          <ul>\n            {cameras.map((m) => (\n              <li key={m.id}>\n                <Link to={`/cameras/${m.id}`}>{m.name}</Link>\n              </li>\n            ))}\n          </ul>\n        </>\n      )\n    }\n  }\n}\n")),(0,r.kt)("h3",{id:"display-single-camera-details"},"Display Single Camera Details"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"./src/components/camera.jsx")),(0,r.kt)("p",null,"For the camera detail page we can recycle most of this code:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export default class Camera extends Component {\n  state = {\n    camera: [],\n    isLoaded: false,\n    error: null,\n  }\n\n  componentDidMount() {\n    fetch('http://localhost:4000/v1/camera/' + this.props.match.params.id)\n      // .then((response) => response.json())\n      // Replace above with error handler\n      .then((response) => {\n        // Debugging: Print status code to console\n        // console.log(\"API Response Status Code: \", response.status)\n        if (response.status !== '200') {\n          let err = Error\n          err.message = 'Invalid API Response Code: ' + response.status\n          this.setState({ error: err })\n        }\n        return response.json()\n      })\n      .then((json) => {\n        this.setState(\n          {\n            camera: json.camera,\n            isLoaded: true,\n          },\n          // If status code is not 200 export error instead\n          (error) => {\n            this.setState({\n              isLoaded: true,\n              error,\n            })\n          }\n        )\n      })\n  }\n\n  render() {\n    const { camera, isLoaded, error } = this.state\n    // Print error if error is not null\n    if (error) {\n      return <div>Error: {error.message}</div>\n      // Or print `Loading...` until JSON response\n    } else if (!isLoaded) {\n      return <p>Loading ...</p>\n      // Once it is loaded print response\n    } else {\n      return (\n        <>\n          <h2>Camera Details</h2>\n\n          <table className=\"table table-compact table-striped mt-3\">\n            <thead>\n              <tr>\n                <td>\n                  <strong>Name|Rating:</strong>\n                </td>\n                <td>\n                  {camera.name} |{' '}\n                  <span className=\"badge bg-primary\">{camera.rating}</span>\n                </td>\n              </tr>\n            </thead>\n            <tbody>\n              <tr>\n                <td>\n                  <strong>ID|CID|LID:</strong>\n                </td>\n                <td>\n                  {camera.id} | {camera.location[0].cid} |{' '}\n                  {camera.location[0].lid}{' '}\n                </td>\n              </tr>\n              <tr>\n                <td>\n                  <strong>Location:</strong>\n                </td>\n                <td>{camera.location[0].location}</td>\n              </tr>\n              <tr>\n                <td>\n                  <strong>Model|Lense|Resolution:</strong>\n                </td>\n                <td>\n                  {camera.location[0].model} | {camera.location[0].lense} |{' '}\n                  {camera.location[0].res}\n                </td>\n              </tr>\n              <tr>\n                <td>\n                  <strong>Address:</strong>\n                </td>\n                <td>{camera.ip}</td>\n              </tr>\n              <tr>\n                <td>\n                  <strong>Login:</strong>\n                </td>\n                <td>\n                  {camera.usr} | {camera.pass}\n                </td>\n              </tr>\n              <tr>\n                <td>\n                  <strong>Installed|Inspected:</strong>\n                </td>\n                <td>\n                  {camera.installed} <br /> {camera.inspected}\n                </td>\n              </tr>\n            </tbody>\n          </table>\n        </>\n      )\n    }\n  }\n}\n")),(0,r.kt)("h3",{id:"display-all-camera-locations"},"Display all Camera Locations"),(0,r.kt)("h4",{id:"backend"},"Backend"),(0,r.kt)("p",null,"Displaying camera locations is pretty much the same as displaying all cameras:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"./src/components/locations.jsx")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},'export default class Locations extends Component {\n  state = {\n    locations: [],\n    isLoaded: false,\n    error: null,\n  }\n\n  componentDidMount() {\n    fetch(\'http://localhost:4000/v1/locations/\')\n      .then((response) => {\n        // Debugging: Print status code to console\n        // console.log("API Response Status Code: ", response.status)\n        if (response.status !== 200) {\n          let err = Error\n          err.message = \'Invalid API Response Code: \' + response.status\n          this.setState({ error: err })\n        }\n        return response.json()\n      })\n      .then((json) => {\n        // Debugging: Print locations to console\n        // console.log("Locations JSON: ", json.locations)\n        this.setState(\n          {\n            locations: json.locations,\n            isLoaded: true,\n          },\n          // Debugging: Print locations State to console\n          // () => {console.log("Locations State: ", this.state.locations)},\n          // If status code is not 200 export error instead\n          (error) => {\n            this.setState({\n              isLoaded: true,\n              error,\n            })\n          }\n        )\n      })\n  }\n\n  render() {\n    const { locations, isLoaded, error } = this.state\n    // Print error if error is not null\n    if (error) {\n      return <div>Error: {error.message}</div>\n      // Or print `Loading...` until JSON response\n    } else if (!isLoaded) {\n      return <p>Loading ...</p>\n      // Once it is loaded print response\n    } else {\n      return (\n        <>\n          <h2>Locations</h2>\n          <ul>\n            {locations.map((m) => (\n              <li key={m.id}>\n                <Link to={`/location/${m.id}`}>{m.location}</Link>\n              </li>\n            ))}\n          </ul>\n        </>\n      )\n    }\n  }\n}\n')),(0,r.kt)("p",null,"But we now have to add the backend to handle the location URL. The SQL queries are defined in:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"./go_backend/models/gocamDB.go")),(0,r.kt)("p",null,"Here we need to add the following SQL query:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT id, location, cid, lid, created, updated FROM camera_locations ORDER BY lid;\n\n id |   location    |     cid     |   lid   |          created           |          updated\n----+---------------+-------------+---------+----------------------------+----------------------------\n  1 | Mountain View | INSTAR-0001 | HK-0001 | 2021-09-19 03:03:19.534528 | 2021-10-21 03:03:19.534528\n  2 | Harbour East  | INSTAR-0002 | HK-0001 | 2021-09-28 03:03:19.534528 | 2021-10-21 03:03:19.534528\n  3 | Harbour West  | INSTAR-0003 | HK-0001 | 2021-09-08 03:03:19.534528 | 2021-10-21 03:03:19.534528\n  4 | Beachfront    | INSTAR-0001 | HK-0002 | 2021-10-09 03:03:19.534528 | 2021-10-21 03:03:19.534528\n  5 | Downtown      | INSTAR-0005 | HK-0003 | 2021-08-28 03:03:19.534528 | 2021-10-21 03:03:19.534528\n  6 | Central Park  | INSTAR-0001 | HK-0003 | 2021-03-22 03:03:19.534528 | 2021-10-21 03:03:19.534528\n  7 | Terminal      | INSTAR-0002 | HK-0003 | 2021-09-18 03:03:19.534528 | 2021-10-21 03:03:19.534528\n  8 | Skyline       | INSTAR-0003 | HK-0003 | 2021-08-17 03:03:19.534528 | 2021-10-21 03:03:19.534528\n  9 | Plaza         | INSTAR-0004 | HK-0003 | 2021-09-06 03:03:19.534528 | 2021-10-21 03:03:19.534528\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"func (m *DBModel) LocationsAll() ( []*Location, error) {\n    ctx, cancel := context.WithTimeout(context.Background(), 3*time.Second)\n    defer cancel()\n\n    query := `SELECT id, location, cid, lid, created, updated FROM camera_locations ORDER BY lid`\n\n    rows, err := m.DB.QueryContext(ctx, query)\n    if err != nil {\n        return nil, err\n    }\n    defer rows.Close()\n\n    var locations []*Location\n\n    for rows.Next() {\n        var l Location\n        err := rows.Scan(\n            &l.ID,\n            &l.LocationName,\n            &l.CameraID,\n            &l.LocationID,\n            &l.Created,\n            &l.Updated,\n        )\n        if err != nil {\n            return nil, err\n        }\n\n        locations = append(locations, &l)\n    }\n\n    return locations, nil\n\n}\n")),(0,r.kt)("p",null,"To be able to use this model we now have to add a handler that takes care of the SQL request when the URL is called by our React App:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"go_backend/src/api/cameraHandler.go")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'func (app *application) getAllLocations(w http.ResponseWriter, r *http.Request) {\n    locations, err := app.models.DB.LocationsAll()\n    if err != nil {\n        app.errorJSON(w, err)\n        return\n    }\n\n    err = app.writeJSON(w, http.StatusOK, locations, "locations")\n    if err != nil {\n        app.errorJSON(w, err)\n        return\n    }\n}\n')),(0,r.kt)("p",null,"Now we can provide a route that uses the handler:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"go_backend/src/api/routes.go")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'func (app *application) routes() http.Handler {\n    router := httprouter.New()\n    // Route for status check handled by statusHandler\n    router.HandlerFunc(http.MethodGet, "/status", app.statusHandler)\n    // Routes for camera API check handled by cameraHandler\n    router.HandlerFunc(http.MethodGet, "/v1/camera/:id", app.getOneCamera)\n    router.HandlerFunc(http.MethodGet, "/v1/cameras", app.getAllCameras)\n    router.HandlerFunc(http.MethodGet, "/v1/locations", app.getAllLocations)\n\n    return app.enableCORS(router)\n}\n')),(0,r.kt)("h4",{id:"frontend"},"Frontend"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"export default class Cameras extends Component {\n  state = {\n    cameras: [],\n    isLoaded: false,\n    // Add state for error handling\n    error: null,\n  }\n\n  componentDidMount() {\n    fetch('http://localhost:4000/v1/cameras')\n      // .then((response) => response.json())\n      // Replace above with error handler\n      .then((response) => {\n        // Debugging: Print status code to console\n        // console.log(\"API Response Status Code: \", response.status)\n        if (response.status !== '200') {\n          let err = Error\n          err.message = 'Invalid API Response Code: ' + response.status\n          this.setState({ error: err })\n        }\n        return response.json()\n      })\n      .then((json) => {\n        this.setState(\n          {\n            cameras: json.cameras,\n            isLoaded: true,\n          },\n          // If status code is not 200 export error instead\n          (error) => {\n            this.setState({\n              isLoaded: true,\n              error,\n            })\n          }\n        )\n      })\n  }\n\n  render() {\n    const { cameras, isLoaded, error } = this.state\n    // Print error if error is not null\n    if (error) {\n      return <div>Error: {error.message}</div>\n      // Or print `Loading...` until JSON response\n    } else if (!isLoaded) {\n      return <p>Loading ...</p>\n      // Once it is loaded print response\n    } else {\n      return (\n        <>\n          <h2>Cameras</h2>\n\n          <ul>\n            {cameras.map((m) => (\n              <li key={m.id}>\n                <Link to={`/cameras/${m.id}`}>{m.name}</Link>\n              </li>\n            ))}\n          </ul>\n        </>\n      )\n    }\n  }\n}\n")),(0,r.kt)("h3",{id:"display-all-cameras-from-a-location"},"Display all Cameras from a Location"),(0,r.kt)("h4",{id:"backend-1"},"Backend"),(0,r.kt)("p",null,"Now that we have a list of locations with installed cameras we now need to add a component that displays all cameras from a selected location. Our backend already has a function that returns all cameras. We can modify this function to filter the results by the field location:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"go_backend/models/gocamDB.go")),(0,r.kt)("p",null,"He we are using the following SQL query to get all cameras:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT id, name, usr, pass, ip, updated, created, rating FROM camera ORDER BY created DESC;\n\n id |     name      |  usr  |  pass  |       ip        |          updated           |          created           | rating\n----+---------------+-------+--------+-----------------+----------------------------+----------------------------+--------\n  9 | Plaza         | admin | instar | 192.168.178.249 | 2021-10-22 03:32:09.828103 | 2021-10-15 03:32:09.828103 |      1\n  4 | Beachfront    | admin | instar | 192.168.2.117   | 2021-10-22 03:32:09.828103 | 2021-09-20 03:32:09.828103 |      2\n  1 | Mountain View | admin | instar | 192.168.2.10    | 2021-10-22 03:32:09.828103 | 2021-06-21 03:32:09.828103 |      3\n  2 | Harbour East  | admin | instar | 192.168.2.19    | 2021-10-22 03:32:09.828103 | 2021-06-01 03:32:09.828103 |      5\n  3 | Harbour West  | admin | instar | 192.168.2.24    | 2021-10-22 03:32:09.828103 | 2021-05-19 03:32:09.828103 |      3\n  7 | Terminal      | admin | instar | 192.168.178.52  | 2021-10-22 03:32:09.828103 | 2021-03-23 03:32:09.828103 |      2\n  8 | Skyline       | admin | instar | 192.168.178.67  | 2021-10-22 03:32:09.828103 | 2021-03-02 03:32:09.828103 |      5\n  6 | Central Park  | admin | instar | 192.168.178.42  | 2021-10-22 03:32:09.828103 | 2020-08-13 03:32:09.828103 |      2\n  5 | Downtown      | admin | instar | 192.168.178.70  | 2021-10-22 03:32:09.828103 | 2020-07-12 03:32:09.828103 |      4\n")),(0,r.kt)("p",null,"We need combine this with a query over the ",(0,r.kt)("inlineCode",{parentName:"p"},"camera_location")," table and filter by location ID:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT camera_locations.id, camera_locations.location, camera_locations.cid, camera_locations.lid FROM camera_locations;\n\n id |   location    |     cid     |   lid\n----+---------------+-------------+---------\n  1 | Mountain View | INSTAR-0001 | HK-0001\n  2 | Harbour East  | INSTAR-0002 | HK-0001\n  3 | Harbour West  | INSTAR-0003 | HK-0001\n  4 | Beachfront    | INSTAR-0001 | HK-0002\n  5 | Downtown      | INSTAR-0005 | HK-0003\n  6 | Central Park  | INSTAR-0001 | HK-0003\n  7 | Terminal      | INSTAR-0002 | HK-0003\n  8 | Skyline       | INSTAR-0003 | HK-0003\n  9 | Plaza         | INSTAR-0004 | HK-0003\n")),(0,r.kt)("p",null,"E.g. filter for location ID ",(0,r.kt)("inlineCode",{parentName:"p"},"HK-0001"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT id, name, usr, pass, ip, updated, created, rating FROM camera WHERE id IN (SELECT camera_locations.id FROM camera_locations WHERE camera_locations.lid = 'HK-0001' ) ORDER BY created DESC;\n")),(0,r.kt)("p",null,"In our DBModel this looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// Return all cameras\n// EDIT: add location ID as variable filter to All()\nfunc(m *DBModel) All(locationID ...string) ([]*Camera, error) {\n    ctx, cancel := context.WithTimeout(context.Background(), 3*time.Second)\n    defer cancel()\n\n    // Create variable to be able to filter by given locationID if provided\n    where := ""\n    // If locationID is provided set variable to filter query\n    if len(locationID) > 0 {\n        where = fmt.Sprintf("WHERE id IN (SELECT camera_locations.id FROM camera_locations WHERE camera_locations.lid = \'%s\')", locationID[0])\n    }\n\n    // SQL query to get all cameras\n    // EDIT: if where is defined filter by given lid\n    query := fmt.Sprintf(`SELECT id, name, usr, pass, ip, updated, created, rating FROM camera %s ORDER BY created DESC`, where)\n\n  ...\n')),(0,r.kt)("p",null,"This now handles both cases - where a location is provided it will filter by it and without a location it will insert an empty string and return cameras of all locations (just like before). All that is needed now is another function handler for the filter case:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"./go_backend/src/api/cameraHandler.go")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'func (app *application) getCamerasByLocation(w http.ResponseWriter, r *http.Request) {\n\n    params := httprouter.ParamsFromContext(r.Context())\n\n    locationID := params.ByName("lid")\n\n    cameras, err := app.models.DB.All(locationID)\n    if err != nil {\n        app.errorJSON(w, err)\n        return\n    }\n\n    err = app.writeJSON(w, http.StatusOK, cameras, "cameras")\n    if err != nil {\n        app.errorJSON(w, err)\n        return\n    }\n}\n')),(0,r.kt)("p",null,"And this handler has to be added to it's route:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"go_backend/src/api/routes.go")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'func (app *application) routes() http.Handler {\n    router := httprouter.New()\n    // Route for status check handled by statusHandler\n    router.HandlerFunc(http.MethodGet, "/status", app.statusHandler)\n    // Routes for camera API check handled by cameraHandler\n    router.HandlerFunc(http.MethodGet, "/v1/camera/:id", app.getOneCamera)\n    router.HandlerFunc(http.MethodGet, "/v1/cameras", app.getAllCameras)\n    router.HandlerFunc(http.MethodGet, "/v1/cameras/:lid", app.getCamerasByLocation)\n    router.HandlerFunc(http.MethodGet, "/v1/locations", app.getAllLocations)\n\n    return app.enableCORS(router)\n}\n')),(0,r.kt)("h4",{id:"frontend-1"},"Frontend"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"./src/components/location.jsx")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"export default class CameraLocation extends Component {\n  state = {\n    cameras: [],\n    isLoaded: false,\n    error: null,\n  }\n\n  componentDidMount() {\n    fetch('http://localhost:4000/v1/cameras/' + this.props.match.params.lid)\n      // .then((response) => response.json())\n      // Replace above with error handler\n      .then((response) => {\n        // Debugging: Print status code to console\n        // console.log(\"API Response Status Code: \", response.status)\n        if (response.status !== '200') {\n          let err = Error\n          err.message = 'Invalid API Response Code: ' + response.status\n          this.setState({ error: err })\n        }\n        return response.json()\n      })\n      .then((json) => {\n        this.setState(\n          {\n            cameras: json.cameras,\n            isLoaded: true,\n          },\n          // If status code is not 200 export error instead\n          (error) => {\n            this.setState({\n              isLoaded: true,\n              error,\n            })\n          }\n        )\n      })\n  }\n\n  render() {\n    let { cameras, isLoaded, error } = this.state\n    // If given location has no cameras set variable to empty array\n    if (!cameras) {\n      cameras = []\n    }\n    // Print error if error is not null\n    if (error) {\n      return <div>Error: {error.message}</div>\n      // Or print `Loading...` until JSON response\n    } else if (!isLoaded) {\n      return <p>Loading ...</p>\n      // Once it is loaded print response\n    } else {\n      return (\n        <>\n          <h2>\n            Location ID:{' '}\n            {this.props.location.pathname.split('/').pop().split(';')[0]}\n          </h2>\n\n          <ul>\n            {cameras.map((m) => (\n              <li key={m.id}>\n                <Link to={`/cameras/${m.id}`}>{m.name}</Link>\n              </li>\n            ))}\n          </ul>\n        </>\n      )\n    }\n  }\n}\n")),(0,r.kt)("p",null,"Adding a route for the component:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"./src/components/content.jsx")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"import CameraList from './cameras'\nimport Camera from './camera'\nimport LocationList from './locations'\nimport Location from './location'\n\n...\n\n<Switch>\n  <Route path=\"/cameras/:id\" component={Camera} />\n  <Route path=\"/locations/:lid\" component={Location} />\n  <Route exact path=\"/cameras\">\n    <CameraList />\n  </Route>\n  <Route exact path=\"/locations\">\n    <LocationList />\n  </Route>\n  ...\n</Switch>\n")))}p.isMDXComponent=!0},18710:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-f4a66dcdd4723b20f63751871edc4e36.jpg"}}]);