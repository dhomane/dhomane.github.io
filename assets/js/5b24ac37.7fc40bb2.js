"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[11117],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),h=d(n),m=o,u=h["".concat(l,".").concat(m)]||h[m]||c[m]||i;return n?a.createElement(u,r(r({ref:t},p),{},{components:n})):a.createElement(u,r({ref:t},p))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=h;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,r[1]=s;for(var d=2;d<i;d++)r[d]=n[d];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},24791:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>d});var a=n(87462),o=(n(67294),n(3905));const i={sidebar_position:5050,slug:"2022-05-25",title:"App Deployment with Hashicorp Nomad from Gitlab",authors:"mpolinowski",tags:["Nomad","Consul","LINUX"]},r=void 0,s={unversionedId:"DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/index",id:"DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/index",title:"App Deployment with Hashicorp Nomad from Gitlab",description:"Shen Zhen, China",source:"@site/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/index.md",sourceDirName:"DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab",slug:"/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/2022-05-25",permalink:"/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/2022-05-25",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/index.md",tags:[{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"Consul",permalink:"/docs/tags/consul"},{label:"LINUX",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:5050,frontMatter:{sidebar_position:5050,slug:"2022-05-25",title:"App Deployment with Hashicorp Nomad from Gitlab",authors:"mpolinowski",tags:["Nomad","Consul","LINUX"]},sidebar:"tutorialSidebar",previous:{title:"App Deployment with Hashicorp Nomad from Gitlab Part Deux",permalink:"/docs/DevOps/Hashicorp/2022-05-26-hashicorp-nomad-with-gitlab-part-2/2022-05-26"},next:{title:"Hashicorp Nomad for NGINX Web Proxies",permalink:"/docs/DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx/2022-05-24"}},l={},d=[{value:"Deploy Applications from the Gitlab Docker Registry",id:"deploy-applications-from-the-gitlab-docker-registry",level:2},{value:"Add a Healthcheck",id:"add-a-healthcheck",level:3},{value:"Updating Applications",id:"updating-applications",level:3},{value:"Adding a Loadbalancer / App Ingress",id:"adding-a-loadbalancer--app-ingress",level:3},{value:"Use Git to Download Artifacts",id:"use-git-to-download-artifacts",level:2},{value:"Preparation",id:"preparation",level:3},{value:"Create your SSH Key",id:"create-your-ssh-key",level:4},{value:"Configuring Gitlab",id:"configuring-gitlab",level:4},{value:"Test the Connection",id:"test-the-connection",level:4},{value:"Create a Nomad Job",id:"create-a-nomad-job",level:3}],p={toc:d};function c(e){let{components:t,...i}=e;return(0,o.kt)("wrapper",(0,a.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Shen Zhen, China",src:n(60857).Z,width:"2230",height:"839"})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#deploy-applications-from-the-gitlab-docker-registry"},"Deploy Applications from the Gitlab Docker Registry"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#add-a-healthcheck"},"Add a Healthcheck")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#updating-applications"},"Updating Applications")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#adding-a-loadbalancer--app-ingress"},"Adding a Loadbalancer / App Ingress")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#use-git-to-download-artifacts"},"Use Git to Download Artifacts"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#preparation"},"Preparation"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#create-your-ssh-key"},"Create your SSH Key")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#configuring-gitlab"},"Configuring Gitlab")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#test-the-connection"},"Test the Connection")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#create-a-nomad-job"},"Create a Nomad Job"))))),(0,o.kt)("h2",{id:"deploy-applications-from-the-gitlab-docker-registry"},"Deploy Applications from the Gitlab Docker Registry"),(0,o.kt)("p",null,"I want to download a Docker image from a private ",(0,o.kt)("a",{parentName:"p",href:"/docs/DevOps/GitOps/2020-08-03--gitlab-as-docker-registry/2020-08-03"},"Gitlab Docker Registry")," and run the container on a dynamic port forwarded to a static port on the inside of the container providing a web frontend:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'job "wiki_de" {\n    datacenters = ["instaryun"]\n\n    group "wiki_de" {\n    count = 1\n        \n        network {\n            mode = "host"\n            port "http" {\n                to = "1234"\n            }\n        }\n\n        task "container" {\n            driver = "docker"\n\n            config {\n                image = "mygitlab.mydomain.com:12345/wiki/wiki_de_mdx"\n                ports = ["http"]\n\n        auth {\n          username = "mynomaduserongitlab"\n          password = "acomplicatedpassword"\n        }\n            }\n        }\n    }\n}\n')),(0,o.kt)("p",null,"This time I want to use the Nomad web frontend to plan and execute the job:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad &amp; Gitlab",src:n(64792).Z,width:"1264",height:"777"})),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad &amp; Gitlab",src:n(91010).Z,width:"1008",height:"436"})),(0,o.kt)("p",null,"After clicking on execute I find the UI a bit lacking - you get feedback if something went wrong. But there is no progress or error log. So let's check the CLI:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nomad job status wiki_de\n\nDeployed\nTask Group  Desired  Placed  Healthy  Unhealthy  Progress Deadline\nwiki_de     1        1       0        0          2022-06-12T11:23:40+02:00\n\nAllocations\nID        Node ID   Task Group  Version  Desired  Status   Created   Modified\na98b7e7d  005f708b  wiki_de     0        run      running  1m5s ago  1s ago\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nomad alloc-status a98b7e7d\n\nRecent Events:\nTime                       Type        Description\n2022-06-12T11:14:45+02:00  Started     Task started by client\n2022-06-12T11:13:41+02:00  Driver      Downloading image\n2022-06-12T11:13:41+02:00  Task Setup  Building Task Directory\n2022-06-12T11:13:40+02:00  Received    Task received by client\n")),(0,o.kt)("p",null,"Everything seemed to have worked. Checking the UI confirms that the allocation was successful:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Nomad &amp; Gitlab",src:n(54954).Z,width:"1005",height:"615"})),(0,o.kt)("p",null,"Checking the docker process tells me that the port allocation is in place as well:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"docker ps\nCONTAINER ID        PORTS\nca5e75497442        my.minion.ip:24372->1234/tcp, my.minion.ip:24372->1234/udp\n")),(0,o.kt)("p",null,"I am able to access my web frontend by running ",(0,o.kt)("inlineCode",{parentName:"p"},"curl http://my.minion.ip:24372"),"."),(0,o.kt)("h3",{id:"add-a-healthcheck"},"Add a Healthcheck"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://www.nomadproject.io/docs/job-specification/service"},"Job Specification / Service")),(0,o.kt)("p",null,"The health check initially failed since - even though I am running the container on my host network - I am still assigning a random port to it and forward it to my HTTP port inside the container:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'network {\n  mode = "host"\n  port "http" {\n    to = "1234"\n  }\n}\n')),(0,o.kt)("p",null,"This means that Consul is trying to connect on to the HTTP frontend on this random port instead - that, unfortunately, leads to nothing and makes the health check fail:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Gitlab CI with Nomad",src:n(504).Z,width:"917",height:"515"})),(0,o.kt)("p",null,"I initially left this part in because I plan to use the Consul service discovery to handle routing automatically. But it seems for now I have to add a static port to continue. This is going to cause an issue later on when trying to update the application:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'Scheduler dry-run:\n- WARNING: Failed to place all allocations.\n  Task Group "docker" (failed to place 1 allocation):\n    * Resources exhausted on 1 nodes\n    * Dimension "network: reserved port collision http=1234" exhausted on 1 nodes\n')),(0,o.kt)("p",null,"So I first have to manually stop the running allocation and then plan/run the job to update the application..."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'network {\n    mode = "host"\n    port "http" {\n        static = "1234"\n    }\n}\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'job "wiki_en" {\n      datacenters = ["wiki_search"]\n    type = "service"\n\n    group "docker" {\n    count = 1\n        \n    network {\n        mode = "host"\n        port "http" {\n            static = "1234"\n        }\n      }\n\n    service {\n        name = "wikiEN"\n        port = "http"\n        tags = [\n            "frontend",\n            "urlprefix-/en/"\n        ]\n\n        check {\n            name     = "HTTP Health"\n            path     = "/"\n            type     = "http"\n            protocol = "http"\n            interval = "10s"\n            timeout  = "2s"\n        }\n    }\n\n    task "wiki_en_container" {\n        driver = "docker"\n\n        config {\n            image = "mygitlab.mydomain.com:12345/wiki/wiki_de_mdx"\n            ports = ["http"]\n            network_mode = "host"\n\n            auth {\n              username = "mynomaduserongitlab"\n              password = "acomplicatedpassword"\n            }\n          }\n        }\n    }\n}\n')),(0,o.kt)("p",null,"This application provides a web frontend on port ",(0,o.kt)("inlineCode",{parentName:"p"},"1234"),". The health check now registers a service with Consul that will check every 10s if the web frontend is available. Once the health check fails Nomad will be triggered to fullfill the requirement of having at least one healthy instance of this app running. We now have a self-healing app! Nice!"),(0,o.kt)("p",null,"But before I run it - let's define some update parameter for the application."),(0,o.kt)("h3",{id:"updating-applications"},"Updating Applications"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://www.nomadproject.io/docs/job-specification/service"},"Job Specification / Update")),(0,o.kt)("p",null,"The Update block below will make sure that only 1 instance of the app is running at a time. It would be better to have count higher than one and a load-balancing service in place - but there are space restraints. So I accept some potential downtime."),(0,o.kt)("p",null,"The update service makes sure that the application passes the health-check for at least ",(0,o.kt)("inlineCode",{parentName:"p"},"10s")," and rolls the application back to the old version if the health-check fails for ",(0,o.kt)("inlineCode",{parentName:"p"},"2min"),". Once the application is deemed healthy the canary deployment will be promoted to stable."),(0,o.kt)("p",null,"To make sure that Nomad always pulls the latest Docker image - this job only going to be used after a new image was committed - you can add the ",(0,o.kt)("a",{parentName:"p",href:"https://www.nomadproject.io/docs/drivers/docker#force_pull"},"force-pull")," option:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'job "wiki_en" {\n      datacenters = ["wiki_search"]\n    type = "service"\n\n    group "docker" {\n    count = 1\n        \n    network {\n        mode = "host"\n        port "http" {\n            static = "1234"\n        }\n      }\n\n    update {\n      max_parallel = 1\n      min_healthy_time  = "10s"\n      healthy_deadline  = "2m"\n      progress_deadline = "5m"\n      auto_revert = true\n      auto_promote = true\n      canary = 1\n    }\n\n    service {\n        name = "wikiEN"\n        port = "http"\n        tags = [\n            "frontend",\n            "urlprefix-/en/"\n        ]\n\n        check {\n            name     = "HTTP Health"\n            path     = "/"\n            type     = "http"\n            protocol = "http"\n            interval = "10s"\n            timeout  = "2s"\n        }\n    }\n\n    task "wiki_en_container" {\n        driver = "docker"\n\n        config {\n            image = "mygitlab.mydomain.com:12345/wiki/wiki_de_mdx"\n            ports = ["http"]\n            network_mode = "host"\n            force_pull = true\n\n            auth {\n              username = "mynomaduserongitlab"\n              password = "acomplicatedpassword"\n            }\n          }\n        }\n    }\n}\n')),(0,o.kt)("p",null,"Starting the job I can now see the canary deployment and job promotion once the Consul health check is successful:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Gitlab CI with Nomad",src:n(86876).Z,width:"944",height:"244"})),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Gitlab CI with Nomad",src:n(44931).Z,width:"917",height:"653"})),(0,o.kt)("h3",{id:"adding-a-loadbalancer--app-ingress"},"Adding a Loadbalancer / App Ingress"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"/docs/DevOps/Hashicorp/2022-05-26-hashicorp-nomad-with-gitlab-part-2/2022-05-26"},"see Part II")),(0,o.kt)("h2",{id:"use-git-to-download-artifacts"},"Use Git to Download Artifacts"),(0,o.kt)("h3",{id:"preparation"},"Preparation"),(0,o.kt)("h4",{id:"create-your-ssh-key"},"Create your SSH Key"),(0,o.kt)("p",null,"First we need to create the private and public SSH key on the ",(0,o.kt)("strong",{parentName:"p"},"Nomad Minion")," node:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keygen -t rsa -b 4096 -f /etc/nomad.d/.ssh/id_rsa\n")),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"I realized afterwards that the Nomad process is executed by the ",(0,o.kt)("inlineCode",{parentName:"p"},"root")," user on each minion. Only the master node uses the ",(0,o.kt)("inlineCode",{parentName:"p"},"nomad")," user. This means this key could be placed in the root home dir. But I am going to add a default SSH config parameter that will make sure that this key is used - no matter where it is placed. And having everything neatly placed inside the ",(0,o.kt)("inlineCode",{parentName:"p"},"nomad.d")," dir is maybe not a bad idea. This might even be source controlled and used in provisioning new instances of each Nomad Minion.")),(0,o.kt)("p",null,"This will create the RSA and RSA public key - place them inside your Nomad users home directory. If you used the following command before to create the user ",(0,o.kt)("inlineCode",{parentName:"p"},"useradd --system --home /etc/nomad.d --shell /bin/false nomad")," this directory will be ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/nomad.d"),":"),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"id_rsa")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"-----BEGIN OPENSSH PRIVATE KEY-----\nbYWQ=fDSAFe4 ... 5sdgfdDFSfszgf\n-----END OPENSSH PRIVATE KEY-----\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"id_rsa.pub")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-rsa AA ... 7+lU= myuser@Nomad\n")),(0,o.kt)("p",null,"Make sure those files can be used by the Nomad user ",(0,o.kt)("inlineCode",{parentName:"p"},"chown nomad:nomad /etc/nomad.d/*"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"chmod 400 /etc/nomad.d/.ssh/id_rsa\n\nls -la /etc/nomad.d/.ssh\n\ntotal 16\ndrwxr-xr-x 2 root  root  4096 Jun  8 12:18 .\ndrwxr-xr-x 4 nomad nomad 4096 Jun  8 12:18 ..\n-r-------- 7 nomad nomad 3.2K Jun 13 07:23 id_rsa\n-rw-r--r-- 7 nomad nomad  744 Jun 13 07:23 id_rsa.pub\n")),(0,o.kt)("p",null,"Make sure that the Nomad user's known hosts file is populated:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ssh-keyscan my.gitlab.address.com | sudo tee -a /etc/nomad.d/.ssh/known_hosts\n")),(0,o.kt)("p",null,"Make sure that SSH uses the correct public key when connecting to your Gitlab server by adding the following configuration:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/ssh/ssh_config\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"Host my.gitlab.address.com\n   Preferredauthentications publickey\n   IdentityFile /etc/nomad.d/.ssh/id_rsa\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"ssh -T git@my.gitlab.address.com\nWelcome to GitLab, @nomaduser!\n")),(0,o.kt)("h4",{id:"configuring-gitlab"},"Configuring Gitlab"),(0,o.kt)("p",null,"Create a Nomad User in Gitlab and add the Public key:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Gitlab CI with Nomad",src:n(21141).Z,width:"1221",height:"646"})),(0,o.kt)("h4",{id:"test-the-connection"},"Test the Connection"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"runuser -u nomad -- mkdir /etc/nomad.d/test\ncd /etc/nomad.d/test\nrunuser -u nomad -- git clone git@my.gitlab.address.com/group/repo.git\n")),(0,o.kt)("p",null,"The repository should be downloaded into your ",(0,o.kt)("inlineCode",{parentName:"p"},"test")," directory without having to type in a password - then you are good to go!"),(0,o.kt)("h3",{id:"create-a-nomad-job"},"Create a Nomad Job"),(0,o.kt)("p",null,"For testing I am going to download some HTML code from a private Gitlab repository and execute a small terminal Node.js web server called ",(0,o.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/httpster"},"httpster")," to serve those files:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"httpster -p 8080 -d /home/somedir/public_html\n")),(0,o.kt)("p",null,"So now we can plan and run our Nomad job from the Nomad UI:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-js"},'job "web_front" {\n  datacenters = ["kundensysteme"]\n\n  group "web" {\n\n    task "httpster" {\n      driver = "exec"\n\n      config {\n        command = "httpster"\n        args = ["-p", "8080", "-d", "${NOMAD_TASK_DIR}/html"]\n      }\n\n      artifact {\n        source      = "git::git@my.gitlab.address.com/group/repo.git"\n        destination = "${NOMAD_TASK_DIR}/html"\n        options {\n          sshkey = "${base64encode(file(pathexpand("~/.ssh/id_rsa")))}"\n          depth = 1\n        }\n      }\n\n      resources {\n        cpu    = 128\n        memory = 128\n      }\n    }\n  }\n}\n')),(0,o.kt)("p",null,"But it seems that you cannot access the ",(0,o.kt)("a",{parentName:"p",href:"https://discuss.hashicorp.com/t/call-to-function-pathexpand-failed-filesystem-function-disabled/30995"},"servers filesystem")," when using the Nomad webUI:"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("strong",{parentName:"p"},"Parse Error"),':\ninput.hcl:18,41-52: Error in function call; Call to function "pathexpand" failed: filesystem function disabled. input.hcl:18,20-72: Unsuitable value type; Unsuitable value: value must be known')),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Gitlab CI with Nomad",src:n(33276).Z,width:"1009",height:"772"})),(0,o.kt)("p",null,"So let's create this job file on our Nomad master and execute it using the Nomad CLI:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'nomad plan test_artifacts.nomad                                                                                      \n+/- Job: "web_front"\n+/- Stop: "true" => "false"\n+/- Task Group: "web" (1 create)\n  +/- Task: "httpster" (forces create/destroy update)\n    +/- Artifact {\n          GetterMode:            "any"\n          GetterOptions[sshkey]: "ADgfdt...tf325sd"\n          GetterSource:          "git::ssh://git@my.gitlab.address.com/group/repo.git"\n          RelativeDest:          "local/html"\n        }\n\nScheduler dry-run:\n- All tasks successfully allocated.\n\nTo submit the job with version verification run:\n\nnomad job run -check-index 8150 test_artifacts.nomad\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'nomad job run -check-index 8150 test_artifacts.nomad\n\n==> 2022-06-13T08:24:57+02:00: Monitoring evaluation "19cbcc30"\n    2022-06-13T08:24:57+02:00: Evaluation triggered by job "web_front"\n==> 2022-06-13T08:24:58+02:00: Monitoring evaluation "19cbcc30"\n    2022-06-13T08:24:58+02:00: Evaluation within deployment: "cb210d05"\n    2022-06-13T08:24:58+02:00: Allocation "ab8494c7" created: node "005f708b", group "web"\n    2022-06-13T08:24:58+02:00: Evaluation status changed: "pending" -> "complete"\n==> 2022-06-13T08:24:58+02:00: Evaluation "19cbcc30" finished with status "complete"\n==> 2022-06-13T08:24:58+02:00: Monitoring deployment "cb210d05"\n  \u2713 Deployment "cb210d05" successful\n    \n    2022-06-13T08:25:14+02:00\n    ID          = cb210d05\n    Job ID      = web_front\n    Job Version = 9\n    Status      = successful\n    Description = Deployment completed successfully\n    \n    Deployed\n    Task Group  Desired  Placed  Healthy  Unhealthy  Progress Deadline\n    web         1        1       1        0          2022-06-13T08:35:12+02:00\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nomad job status web_front\n\nDeployed\nTask Group  Desired  Placed  Healthy  Unhealthy  Progress Deadline\nweb         1        1       0        0          2022-06-13T07:15:19+02:00\n\nAllocations\nID        Node ID   Task Group  Version  Desired  Status    Created     Modified\n11526379  005f708b  web         1        run      pending   7s ago      4s ago\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'nomad alloc-status a6323ccc\n\nTask "httpster" is "running"\nTask Resources\nCPU        Memory          Disk     Addresses\n0/128 MHz  13 MiB/128 MiB  300 MiB  \n\nRecent Events:\nTime                       Type                   Description\n2022-06-13T08:25:02+02:00  Started                Task started by client\n2022-06-13T08:25:01+02:00  Downloading Artifacts  Client is downloading artifacts\n2022-06-13T08:24:58+02:00  Task Setup             Building Task Directory\n2022-06-13T08:24:58+02:00  Received               Task received by client\n')),(0,o.kt)("p",null,"I can verify that the web server is running:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"netstat -tlnp\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name\ntcp6       0      0 :::8080                 :::*                    LISTEN      7002/node\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"curl localhost:8080\n<!DOCTYPE html>\n<html>\n  <head>\n    <meta charset='utf-8'>\n\n    ...\n\n")),(0,o.kt)("p",null,"It works!"))}c.isMDXComponent=!0},64792:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Gitlab_CI_with_Nomad_01-c7c13dba915ead792f9618238d8b17f2.png"},91010:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Gitlab_CI_with_Nomad_02-09854662304c0ba9eb7ccb0230187f79.png"},54954:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Gitlab_CI_with_Nomad_03-86a495d684bd0f12f7de3b1ca88ce382.png"},21141:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Gitlab_CI_with_Nomad_04-6c73c147e43a6e9d386b0b11a04da5fb.png"},33276:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Gitlab_CI_with_Nomad_05-1fd0f49135a65752b1bfa7e652879961.png"},504:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Gitlab_CI_with_Nomad_06-22d1ded82c984ab4eb8643798cff8bb0.png"},86876:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Gitlab_CI_with_Nomad_07-828676621659533b7460794c186049c1.png"},44931:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Gitlab_CI_with_Nomad_08-c942127691667ad6d3ef0b9e4da5dc1c.png"},60857:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-6c1edb088dfea3a7d39f8eebb8e9dc23.jpg"}}]);