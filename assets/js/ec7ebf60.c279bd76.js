"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[51256],{3905:(e,a,t)=>{t.d(a,{Zo:()=>c,kt:()=>u});var n=t(67294);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function i(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function o(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?i(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function p(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)t=i[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=n.createContext({}),s=function(e){var a=n.useContext(l),t=a;return e&&(t="function"==typeof e?e(a):o(o({},a),e)),t},c=function(e){var a=s(e.components);return n.createElement(l.Provider,{value:a},e.children)},d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},g=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),g=s(t),u=r,m=g["".concat(l,".").concat(u)]||g[u]||d[u]||i;return t?n.createElement(m,o(o({ref:a},c),{},{components:t})):n.createElement(m,o({ref:a},c))}));function u(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=g;var p={};for(var l in a)hasOwnProperty.call(a,l)&&(p[l]=a[l]);p.originalType=e,p.mdxType="string"==typeof e?e:r,o[1]=p;for(var s=2;s<i;s++)o[s]=t[s];return n.createElement.apply(null,o)}return n.createElement.apply(null,t)}g.displayName="MDXCreateElement"},11589:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>p,toc:()=>s});var n=t(87462),r=(t(67294),t(3905));const i={sidebar_position:9070,slug:"2021-11-01",title:"spaCy NER on Arch Linux",authors:"mpolinowski",tags:["Machine Learning","Python"]},o=void 0,p={unversionedId:"IoT-and-Machine-Learning/ML/2021-11-01--spacy_natural_language_processing/index",id:"IoT-and-Machine-Learning/ML/2021-11-01--spacy_natural_language_processing/index",title:"spaCy NER on Arch Linux",description:"Victoria Harbour, Hongkong",source:"@site/docs/IoT-and-Machine-Learning/ML/2021-11-01--spacy_natural_language_processing/index.md",sourceDirName:"IoT-and-Machine-Learning/ML/2021-11-01--spacy_natural_language_processing",slug:"/IoT-and-Machine-Learning/ML/2021-11-01--spacy_natural_language_processing/2021-11-01",permalink:"/docs/IoT-and-Machine-Learning/ML/2021-11-01--spacy_natural_language_processing/2021-11-01",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IoT-and-Machine-Learning/ML/2021-11-01--spacy_natural_language_processing/index.md",tags:[{label:"Machine Learning",permalink:"/docs/tags/machine-learning"},{label:"Python",permalink:"/docs/tags/python"}],version:"current",sidebarPosition:9070,frontMatter:{sidebar_position:9070,slug:"2021-11-01",title:"spaCy NER on Arch Linux",authors:"mpolinowski",tags:["Machine Learning","Python"]},sidebar:"tutorialSidebar",previous:{title:"spaCy NER Predictions",permalink:"/docs/IoT-and-Machine-Learning/ML/2021-11-02--spacy_ner_predictions/2021-11-02"},next:{title:"Introduction to Keras",permalink:"/docs/IoT-and-Machine-Learning/ML/2019-04-01--introduction-to-keras/2019-04-01"}},l={},s=[{value:"Project Setup",id:"project-setup",level:2},{value:"Data Preprocessing",id:"data-preprocessing",level:2},{value:"Data Formating",id:"data-formating",level:3},{value:"Data Extraction",id:"data-extraction",level:3},{value:"Text Cleaning",id:"text-cleaning",level:3},{value:"spaCy",id:"spacy",level:2},{value:"The spaCy Data Format",id:"the-spacy-data-format",level:3},{value:"Group Entities",id:"group-entities",level:4},{value:"Remove all O Tags",id:"remove-all-o-tags",level:4},{value:"List of Entities",id:"list-of-entities",level:4},{value:"Data Splitting - Test &amp; Training",id:"data-splitting---test--training",level:4},{value:"Spacy Base Configuration",id:"spacy-base-configuration",level:3},{value:"Data Preprocessing",id:"data-preprocessing-1",level:4},{value:"NER Model Training",id:"ner-model-training",level:4}],c={toc:s};function d(e){let{components:a,...i}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,i,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Victoria Harbour, Hongkong",src:t(20705).Z,width:"1500",height:"663"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/IoT-and-Machine-Learning/ML/2021-10-31--tesseract_ocr_arch_linux/2021-10-31"},"Part I - Tesseract OCR on Arch Linux")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/IoT-and-Machine-Learning/ML/2021-11-01--spacy_natural_language_processing/2021-11-01"},"Part II - spaCy NER on Arch Linux")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/IoT-and-Machine-Learning/ML/2021-11-02--spacy_ner_predictions/2021-11-02"},"Part III - spaCy NER Predictions"))),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/explosion/spaCy"},"spaCy")," is an open-source software library for advanced natural language processing, written in the programming languages Python."),(0,r.kt)("p",null,"spaCy also supports deep learning workflows that allow connecting statistical models trained by popular machine learning libraries like TensorFlow, PyTorch or MXNet through its own machine learning library Thinc. Using Thinc as its backend, spaCy features convolutional neural network models for part-of-speech tagging, dependency parsing, text categorization and ",(0,r.kt)("strong",{parentName:"p"},"named entity recognition")," (",(0,r.kt)("inlineCode",{parentName:"p"},"NER"),")."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#project-setup"},"Project Setup")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#data-preprocessing"},"Data Preprocessing"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#data-formating"},"Data Formating")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#data-extraction"},"Data Extraction")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#text-cleaning"},"Text Cleaning")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#spacy"},"spaCy"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#the-spacy-data-format"},"The spaCy Data Format"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#group-entities"},"Group Entities")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#remove-all-o-tags"},"Remove all O Tags")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#list-of-entities"},"List of Entities")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#data-splitting---test--training"},"Data Splitting - Test & Training")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#spacy-base-configuration"},"Spacy Base Configuration"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#data-preprocessing-1"},"Data Preprocessing")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#ner-model-training"},"NER Model Training"))))))),(0,r.kt)("h2",{id:"project-setup"},"Project Setup"),(0,r.kt)("p",null,"I am going to re-use the virtual environment created for Tesseract earlier:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p /opt/Python/pyOCR\npython -m venv .env\n")),(0,r.kt)("p",null,"You can re-enter the environment with:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"source .env/bin/activate\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"spaCy",src:t(88004).Z,width:"1101",height:"762"})),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"pip install -U spacy\npython -m spacy download en_core_web_sm\n")),(0,r.kt)("h2",{id:"data-preprocessing"},"Data Preprocessing"),(0,r.kt)("h3",{id:"data-formating"},"Data Formating"),(0,r.kt)("p",null,"Tou use the data I extracted from my name card collection in spaCy I first need to re-format it. I first start by creating a TSV (Tab-separated) file from the CSV (Comma-separated) data. In LibreOffice you can simply open the CSV file, select that it is Comma separated and then save it with the ",(0,r.kt)("inlineCode",{parentName:"p"},"{Tab}"),' as delimiter option - in MS Office there is an option called "Text (tab delimited) that does the same. But there are also ',(0,r.kt)("a",{parentName:"p",href:"https://onlinecsvtools.com/convert-csv-to-tsv"},"Online Converters")," available. This will change the format from:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-log"},"card_46.jpg,Mike,B-NAME\ncard_46.jpg,Polinowski,I-NAME\ncard_46.jpg,Business,B-DES\ncard_46.jpg,Card,I-DES\ncard_46.jpg,Designer,I-DES\n")),(0,r.kt)("p",null,"Into this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-log"},"card_46.jpg Mike    B-NAME\ncard_46.jpg Polinowski  I-NAME\ncard_46.jpg Business    B-DES\ncard_46.jpg Card    I-DES\ncard_46.jpg Designer    I-DES\n")),(0,r.kt)("p",null,'Create a new Jupyter notebook "03_Data_Preprocessing":'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"jupyter notebook\n")),(0,r.kt)("h3",{id:"data-extraction"},"Data Extraction"),(0,r.kt)("p",null,"I can now open and read the TSV file and start working with it in Pandas:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"import numpy as np\nimport pandas as pd\nimport string\nimport re\n\nwith open('businessCardsTab.csv', mode='r',encoding='utf8',errors='ignore') as f:\n    text = f.read()\n")),(0,r.kt)("p",null,"Run a ",(0,r.kt)("inlineCode",{parentName:"p"},"print(text)")," to verify that everything is working. You can also read the RAW input by running just ",(0,r.kt)("inlineCode",{parentName:"p"},"text")," - here you can see that every tab is symbolized by a ",(0,r.kt)("inlineCode",{parentName:"p"},"\\t")," and a new line by ",(0,r.kt)("inlineCode",{parentName:"p"},"\\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Mike\\tB-NAME\\ncard_46.jpg\\tPolinowski\\tI-NAME\\ncard_46.jpg\\tBusiness\\tB-DES\\ncard_46.jpg\\tCard\\tI-DES\\ncard_46.jpg\\tDesigner\\tI-DES\\n\n")),(0,r.kt)("p",null,"Now I can clean up the text using those delimiters:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"text.split('\\n')\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"['\\ufeffid\\ttext\\ttag',\n...\n  'card_46.jpg\\tMike\\tB-NAME',\n  'card_46.jpg\\tPolinowski\\tI-NAME',\n  'card_46.jpg\\tBusiness\\tB-DES',\n  'card_46.jpg\\tCard\\tI-DES',\n  'card_46.jpg\\tDesigner\\tI-DES',\n ...]\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"data = list(map(lambda x:x.split('\\t'),text.split('\\n')))\n")),(0,r.kt)("p",null,"Print ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," to verify:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"[['\\ufeffid', 'text', 'ttag'],\n...\n  ['card_46.jpg', 'Mike', 'B-NAME'],\n  ['card_46.jpg', 'Polinowski', 'I-NAME'],\n  ['card_46.jpg', 'Business', 'B-DES'],\n  ['card_46.jpg', 'Card', 'I-DES'],\n  ['card_46.jpg', 'Designer', 'I-DES'],\n ...]\n")),(0,r.kt)("p",null,"Write data into a Pandas dataframe:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"df = pd.DataFrame(data[1:],columns=data[0])\n")),(0,r.kt)("p",null,"Take data from line ",(0,r.kt)("inlineCode",{parentName:"p"},"1")," to end of file and use the first element ",(0,r.kt)("inlineCode",{parentName:"p"},"0")," as column headers:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"spaCy NER",src:t(27056).Z,width:"1137",height:"531"})),(0,r.kt)("h3",{id:"text-cleaning"},"Text Cleaning"),(0,r.kt)("p",null,"Removing white spaces and punctuation characters using the ",(0,r.kt)("strong",{parentName:"p"},"String library"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"string.whitespace\n' \\t\\n\\r\\x0b\\x0c'\n")),(0,r.kt)("p",null,"I can remove all of the above as provided by ",(0,r.kt)("inlineCode",{parentName:"p"},"whitespace"),". But we I need to retain a few of the special characters provided by ",(0,r.kt)("inlineCode",{parentName:"p"},"punctuation")," - e.g. the forward-slash, underscore, the @ symbol, etc.:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"string.punctuation\n'!\"#$%&\\'()*+,-./:;<=>?@[\\\\]^_`{|}~'\n")),(0,r.kt)("p",null,"So I can define:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"whitespace = string.whitespace\npunctuation = '!#$%&\\'()*+:;<=>?[\\\\]^`{|}~'\n")),(0,r.kt)("p",null,"Now we can search for these within our data and replace every occurrence with an ",(0,r.kt)("em",{parentName:"p"},"nothing")," ",(0,r.kt)("inlineCode",{parentName:"p"},"''"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"tableWhitespace = str.maketrans('','',whitespace)\ntablePunctuation = str.maketrans('','',punctuation)\n\ndef cleanText(txt):\n    text = str(txt)\n    text = text.lower()\n    removeWhitespace = text.translate(tableWhitespace)\n    removePunctuation = removeWhitespace.translate(tablePunctuation)\n    \n    return str(removePunctuation)\n")),(0,r.kt)("p",null,"We can apply the ",(0,r.kt)("inlineCode",{parentName:"p"},"cleanText")," function on our text dataframe:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"df['text'] = df['text'].apply(cleanText)\n")),(0,r.kt)("p",null,"Additionally we can drop all missing values:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"dataClean = df.query(\"text != '' \")\ndataClean.dropna(inplace=True)\n")),(0,r.kt)("p",null,"Verify that the cleaning worked with ",(0,r.kt)("inlineCode",{parentName:"p"},"dataClean.head(10)"),":"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"spaCy NER",src:t(26827).Z,width:"1061",height:"340"})),(0,r.kt)("h2",{id:"spacy"},"spaCy"),(0,r.kt)("h3",{id:"the-spacy-data-format"},"The spaCy Data Format"),(0,r.kt)("h4",{id:"group-entities"},"Group Entities"),(0,r.kt)("p",null,"We now need to prepare our data so that we can train our spaCy model with it. For this we first group every card into an entity by ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," - where ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," is the JPG name:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"group = dataClean.groupby(by='id')\n")),(0,r.kt)("p",null,"Verify that it was successful by printing:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"group.groups.keys()\ndict_keys(['card_01.jpg', 'card_02.jpg', 'card_03.jpg', 'card_04.jpg', 'card_05.jpg', 'card_06.jpg', 'card_07.jpg', 'card_08.jpg', 'card_09.jpg', 'card_10.jpg', 'card_11.jpg', 'card_12.jpg', 'card_13.jpg', 'card_14.jpg', 'card_16.jpg', 'card_17.jpg', 'card_18.jpg', 'card_20.jpg', 'card_22.jpg', 'card_25.jpg', 'card_26.jpg', 'card_27.jpg', 'card_28.jpg', 'card_29.jpg', 'card_31.jpg', 'card_32.jpg', 'card_33.jpg', 'card_34.jpg', 'card_35.jpg', 'card_36.jpg', 'card_37.jpg', 'card_38.jpg', 'card_39.jpg', 'card_41.jpg', 'card_43.jpg', 'card_44.jpg', 'card_45.jpg', 'card_46.jpg', 'card_50.jpg', 'card_52.jpg', 'card_57.jpg', 'card_58.jpg', 'card_59.jpg', 'card_60.jpg', 'card_62.jpg', 'card_63.jpg', 'card_65.jpg', 'card_66.jpg', 'card_67.jpg', 'card_68.jpg', 'card_69.jpg', 'card_70.jpg', 'card_71.jpg', 'card_72.jpg', 'card_79.jpg'])\n")),(0,r.kt)("p",null,"To get all the information from one name card, e.g. ",(0,r.kt)("inlineCode",{parentName:"p"},"card_46.jpg"),", run:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"group.get_group('card_46.jpg')\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"spaCy NER",src:t(23787).Z,width:"1070",height:"529"})),(0,r.kt)("p",null,"For the training we will need the values for ",(0,r.kt)("inlineCode",{parentName:"p"},"text")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"tag"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"group.get_group('card_46.jpg')[['text', 'tag']].values\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"array([['mike', 'B-NAME'],\n       ['polinowski', 'I-NAME'],\n       ['business', 'B-DES'],\n       ['card', 'I-DES'],\n       ['designer', 'I-DES'],\n       ['987-4575-9567', 'B-PHONE'],\n       ['8365-9686-6997', 'B-PHONE'],\n       ['building', 'O'],\n       ['4', 'O'],\n       ['room', 'O'],\n       ['748', 'O'],\n       ['business', 'O'],\n       ['plaza', 'O'],\n       ['mong', 'O'],\n       ['kok', 'O'],\n       ['hongkong', 'O'],\n       ['lookmum@iamdoingphotoshop.com', 'B-EMAIL']], dtype=object)\n")),(0,r.kt)("p",null,"We can write this array into a variable:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"grouparray = group.get_group('card_46.jpg')[['text', 'tag']].values\ncontent = ''\nannotations = {'entities': []}\nstart = 0\nend = 0\n\nfor text, tag in grouparray:\n  print(text,tag)\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"mike B-NAME\npolinowski I-NAME\nbusiness B-DES\ncard I-DES\ndesigner I-DES\n987-4575-9567 B-PHONE\n8365-9686-6997 B-PHONE\nbuilding O\n4 O\nroom O\n748 O\nbusiness O\nplaza O\nmong O\nkok O\nhongkong O\nlookmum@iamdoingphotoshop.com B-EMAIL\n")),(0,r.kt)("h4",{id:"remove-all-o-tags"},"Remove all O Tags"),(0,r.kt)("p",null,"We can write this result into a string and strip all lines that are tagged with ",(0,r.kt)("inlineCode",{parentName:"p"},"O"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"grouparray = group.get_group('card_46.jpg')[['text', 'tag']].values\ncontent = ''\nannotations = {'entities': []}\nstart = 0\nend = 0\n\nfor text, tag in grouparray:\n  text = str(text)\n  stringLength = len(text) + 1 # 1 x space after each word\n\n  start = end\n  end = start + stringLength\n\n  if tag != 'O':\n    annot = (start,end-1,tag)\n    annotations['entities'].append(annot)\n\n  content = content + text + ' '\n")),(0,r.kt)("p",null,"This now took our content:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"content\n'mike polinowski business card designer 987-4575-9567 8365-9686-6997 building 4 room 748 business plaza mong kok hongkong lookmum@iamdoingphotoshop.com '\n")),(0,r.kt)("p",null,"And turned it into this annotation that allows us to target the information we need:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"annotations\n{'entities': [(0, 4, 'B-NAME'),\n  (5, 15, 'I-NAME'),\n  (16, 24, 'B-DES'),\n  (25, 29, 'I-DES'),\n  (30, 38, 'I-DES'),\n  (39, 52, 'B-PHONE'),\n  (53, 67, 'B-PHONE'),\n  (121, 150, 'B-EMAIL')]}\n")),(0,r.kt)("h4",{id:"list-of-entities"},"List of Entities"),(0,r.kt)("p",null,"To be able to create these for all our cards we need to create a variable that holds all our name cards by ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," - this is what we already had above:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"cards = group.groups.keys()\n")),(0,r.kt)("p",null,"We can use this to wrap our code into a FOR loop over all cards and append all ",(0,r.kt)("inlineCode",{parentName:"p"},"content")," + ",(0,r.kt)("inlineCode",{parentName:"p"},"annotations")," for each card to an list ",(0,r.kt)("inlineCode",{parentName:"p"},"cardData")," which is then concatenated into the ",(0,r.kt)("inlineCode",{parentName:"p"},"allCardsData")," list:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"allCardsData = []\nfor card in cards:\n  cardData = []\n  grouparray = group.get_group(card)[['text', 'tag']].values\n  content = ''\n  annotations = {'entities': []}\n  start = 0\n  end = 0\n\n  for text, tag in grouparray:\n    text = str(text)\n    stringLength = len(text) + 1 # 1 x space after each word\n\n    start = end\n    end = start + stringLength\n\n    if tag != 'O':\n      annot = (start,end-1,tag)\n      annotations['entities'].append(annot)\n\n    content = content + text + ' '\n\n  cardData = (content, annotations)\n  allCardsData.append(cardData)\n")),(0,r.kt)("p",null,"Run ",(0,r.kt)("inlineCode",{parentName:"p"},"allCardsData")," to get a complete list for all entities (name card ",(0,r.kt)("inlineCode",{parentName:"p"},"content")," + ",(0,r.kt)("inlineCode",{parentName:"p"},"annotations"),"). This is now the so called ",(0,r.kt)("strong",{parentName:"p"},"spaCy Format")," - the way the spaCy library consumes it's trainings data in."),(0,r.kt)("h4",{id:"data-splitting---test--training"},"Data Splitting - Test & Training"),(0,r.kt)("p",null,"We can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"random")," library to make a random selection of entities to split them into a stack for trainings and test data:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"import random\nrandom.shuffle(allCardsData)\n")),(0,r.kt)("p",null,"Currently I have a stack of 55 cards in total - you can check your stack with ",(0,r.kt)("inlineCode",{parentName:"p"},"len(allCardsData)"),". I will now split this stack into 90:10 ratio:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"TrainData = allCardsData[:50]\nTestData = allCardsData[50:]\n")),(0,r.kt)("p",null,"Create a directory ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," inside the apps work directory and save this data inside your folder using the ",(0,r.kt)("inlineCode",{parentName:"p"},"pickle")," library:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"import pickle\npickle.dump(TrainData,open('./data/TrainData.pickle',mode='wb'))\npickle.dump(TestData,open('./data/TestData.pickle',mode='wb'))\n")),(0,r.kt)("h3",{id:"spacy-base-configuration"},"Spacy Base Configuration"),(0,r.kt)("p",null,"Go to ",(0,r.kt)("a",{parentName:"p",href:"https://spacy.io/usage/training"},"Training Pipelines & Models")," and generate/download your spaCy configuration template:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"spaCy NER",src:t(51082).Z,width:"909",height:"703"})),(0,r.kt)("p",null,"After saving the starter config to a file ",(0,r.kt)("inlineCode",{parentName:"p"},"base_config.cfg"),", use the ",(0,r.kt)("inlineCode",{parentName:"p"},"init fill-config")," command to fill in the remaining defaults. Training configs should always be complete and without hidden defaults, to keep your experiments reproducible:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python -m spacy init fill-config ./base_config.cfg ./config.cfg\n\u2714 Auto-filled config with all values\n\u2714 Saved config\nconfig.cfg\n")),(0,r.kt)("h4",{id:"data-preprocessing-1"},"Data Preprocessing"),(0,r.kt)("p",null,"Here\u2019s ",(0,r.kt)("a",{parentName:"p",href:"https://spacy.io/usage/training#training-data"},"an example")," of creating a ",(0,r.kt)("inlineCode",{parentName:"p"},".spacy")," file from our NER annotations - modified to use the pickle files created above:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},"import spacy\nfrom spacy.tokens import DocBin\nimport pickle\n\nnlp = spacy.blank(\"en\")\n\ntraining_data = pickle.load(open('./data/TrainData.pickle', 'rb'))\ntesting_data = pickle.load(open('./data/TestData.pickle', 'rb'))\n\n# Create training data file in spaCy format\ndb = DocBin()\nfor text, annotations in training_data:\n    doc = nlp(text)\n    ents = []\n    for start, end, label in annotations['entities']:\n        span = doc.char_span(start, end, label=label)\n        ents.append(span)\n    doc.ents = ents\n    db.add(doc)\ndb.to_disk(\"./data/train.spacy\")\n\n# Create testing data file in spaCy format\ndb_test = DocBin()\nfor text, annotations in testing_data:\n    doc = nlp(text)\n    ents = []\n    for start, end, label in annotations['entities']:\n        span = doc.char_span(start, end, label=label)\n        ents.append(span)\n    doc.ents = ents\n    db.add(doc)\ndb_test.to_disk(\"./data/test.spacy\")\n")),(0,r.kt)("p",null,"Run the Python script from the terminal:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python ./preprocess.py\n")),(0,r.kt)("p",null,"And the spaCy files will be created in your ",(0,r.kt)("inlineCode",{parentName:"p"},"data")," directory:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ll ./data                                                                                              \ue0b2 \u2714 \ntotal 40\n\n1394 Dec 12 21:06 TestData.pickle\n106 Dec 13 12:48 test.spacy\n12070 Dec 12 21:06 TrainData.pickle\n9545 Dec 13 12:48 train.spacy\n")),(0,r.kt)("h4",{id:"ner-model-training"},"NER Model Training"),(0,r.kt)("p",null,"Start by creating an output directory for the model training:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir ./output\n")),(0,r.kt)("p",null,"Now I can add my data and run a training with the configuration file: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"python -m spacy train ./config.cfg  --output ./output --paths.train ./data/train.spacy --paths.dev ./data/test.spacy\n\n\u2139 Saving to output directory: output\n\u2139 Using CPU\n\n=========================== Initializing pipeline ===========================\n[2021-12-13 12:55:39,208] [INFO] Set up nlp object from config\n[2021-12-13 12:55:39,214] [INFO] Pipeline: ['tok2vec', 'ner']\n[2021-12-13 12:55:39,217] [INFO] Created vocabulary\n[2021-12-13 12:55:39,218] [INFO] Finished initializing nlp object\n[2021-12-13 12:55:39,321] [INFO] Initialized pipeline components: ['tok2vec', 'ner']\n\u2714 Initialized pipeline\n\n============================= Training pipeline =============================\n\u2139 Pipeline: ['tok2vec', 'ner']\n\u2139 Initial learn rate: 0.001\nE    #       LOSS TOK2VEC  LOSS NER  ENTS_F  ENTS_P  ENTS_R  SCORE \n---  ------  ------------  --------  ------  ------  ------  ------\n  0       0          0.00     69.86    0.00    0.00    0.00    0.00\n 22     200        199.17   4224.89    0.00    0.00    0.00    0.00\n 50     400         87.29    138.64    0.00    0.00    0.00    0.00\n 84     600         41.00     68.52    0.00    0.00    0.00    0.00\n125     800         53.87     82.38    0.00    0.00    0.00    0.00\n175    1000         76.95    104.00    0.00    0.00    0.00    0.00\n240    1200         95.89    121.85    0.00    0.00    0.00    0.00\n310    1400         65.92    113.03    0.00    0.00    0.00    0.00\n410    1600         76.39    146.28    0.00    0.00    0.00    0.00\n\u2714 Saved pipeline to output directory\noutput/model-last\n")),(0,r.kt)("p",null,"The models were successfully created inside the ",(0,r.kt)("inlineCode",{parentName:"p"},"output")," directory!"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ll ./output\ntotal 16\n\n4096 Dec 13 12:55 model-best\n4096 Dec 13 12:55 model-last\n")))}d.isMDXComponent=!0},20705:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-4f747fa38245d3c618169ab90d8c3f77.jpg"},27056:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/spaCy_01-af4e2d04bd3c31edd41657da1d1a3e81.png"},26827:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/spaCy_02-30873604eb690ea005efa08989d49bb6.png"},23787:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/spaCy_03-e30c82dc91a12a25fe7dab5a37d9a337.png"},51082:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/spaCy_0x-8e5ab73f3e816dfd54e38b2f33181a4d.png"},88004:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/spaCy_installation-b060ae507962d3a27dd65dc56e94fec2.png"}}]);