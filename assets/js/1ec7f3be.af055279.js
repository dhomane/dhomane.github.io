"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[49611],{3905:(e,n,t)=>{t.d(n,{Zo:()=>l,kt:()=>h});var o=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,o,r=function(e,n){if(null==e)return{};var t,o,r={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=o.createContext({}),c=function(e){var n=o.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},l=function(e){var n=c(e.components);return o.createElement(p.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},u=o.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,p=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),u=c(t),h=r,m=u["".concat(p,".").concat(h)]||u[h]||d[h]||a;return t?o.createElement(m,s(s({ref:n},l),{},{components:t})):o.createElement(m,s({ref:n},l))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,s=new Array(a);s[0]=u;var i={};for(var p in n)hasOwnProperty.call(n,p)&&(i[p]=n[p]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var c=2;c<a;c++)s[c]=t[c];return o.createElement.apply(null,s)}return o.createElement.apply(null,t)}u.displayName="MDXCreateElement"},94555:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>s,default:()=>d,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var o=t(87462),r=(t(67294),t(3905));const a={sidebar_position:5060,slug:"2022-05-24",title:"Hashicorp Nomad for NGINX Web Proxies",description:"",authors:"mpolinowski",tags:["Nomad","LINUX","NGINX"]},s=void 0,i={unversionedId:"DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx/index",id:"DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx/index",title:"Hashicorp Nomad for NGINX Web Proxies",description:"",source:"@site/docs/DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx/index.md",sourceDirName:"DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx",slug:"/DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx/2022-05-24",permalink:"/docs/DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx/2022-05-24",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2022-05-24-hashicorp-nomad-with-nginx/index.md",tags:[{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"LINUX",permalink:"/docs/tags/linux"},{label:"NGINX",permalink:"/docs/tags/nginx"}],version:"current",sidebarPosition:5060,frontMatter:{sidebar_position:5060,slug:"2022-05-24",title:"Hashicorp Nomad for NGINX Web Proxies",description:"",authors:"mpolinowski",tags:["Nomad","LINUX","NGINX"]},sidebar:"tutorialSidebar",previous:{title:"App Deployment with Hashicorp Nomad from Gitlab",permalink:"/docs/DevOps/Hashicorp/2022-05-25-hashicorp-nomad-with-gitlab/2022-05-25"},next:{title:"Hashicorp Nomad with Consul II - The Reckoning",permalink:"/docs/DevOps/Hashicorp/2022-05-22-hashicorp-dojo-nomad-consul-part-2/2022-05-22"}},p={},c=[{value:"Configure NGINX Reverse Proxy for the Nomad / Consul Web UI",id:"configure-nginx-reverse-proxy-for-the-nomad--consul-web-ui",level:2},{value:"Security",id:"security",level:3},{value:"Restricting Access with HTTP Basic Authentication",id:"restricting-access-with-http-basic-authentication",level:4},{value:"Test Run",id:"test-run",level:3},{value:"Create a Nomad Job to set up the NGINX Proxy",id:"create-a-nomad-job-to-set-up-the-nginx-proxy",level:2}],l={toc:c};function d(e){let{components:n,...a}=e;return(0,r.kt)("wrapper",(0,o.Z)({},l,a,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Shen Zhen, China",src:t(19487).Z,width:"2230",height:"839"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#configure-nginx-reverse-proxy-for-the-nomad--consul-web-ui"},"Configure NGINX Reverse Proxy for the Nomad / Consul Web UI"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#security"},"Security"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#restricting-access-with-http-basic-authentication"},"Restricting Access with HTTP Basic Authentication")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#test-run"},"Test Run")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#create-a-nomad-job-to-set-up-the-nginx-proxy"},"Create a Nomad Job to set up the NGINX Proxy"))),(0,r.kt)("p",null,"NGINX can be used to reverse proxy web services and balance load across multiple instances of the same service. A reverse proxy has the added benefits of enabling multiple web services to share a single, memorable domain and authentication to view internal systems."),(0,r.kt)("h2",{id:"configure-nginx-reverse-proxy-for-the-nomad--consul-web-ui"},"Configure NGINX Reverse Proxy for the Nomad / Consul Web UI"),(0,r.kt)("p",null,"To ensure every feature in the Nomad UI remains fully functional, you must properly configure your reverse proxy to meet Nomad's specific networking requirements."),(0,r.kt)("p",null,"Create a basic NGINX configuration file to reverse proxy the Web UI. It is important to name the NGINX configuration file ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/ingress/nginx.conf")," otherwise the file will not bind correctly:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-conf"},'# /opt/ingress/nginx.conf\nevents {}\n\nhttp {\n  # Since WebSockets are stateful connections but Nomad has multiple\n  # server nodes, an upstream with ip_hash declared is required to ensure\n  # that connections are always proxied to the same server node when possible.\n  upstream nomad {\n    ip_hash;\n    server localhost:4646;\n  }\n  upstream consul {\n    server localhost:8501;\n  }\n  server {\n    listen 8080;\n    server_name 0.0.0.0;\n    location / {\n      proxy_pass https://nomad;\n      proxy_ssl_server_name on;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      # Nomad blocking queries will remain open for a default of 5 minutes.\n      # Increase the proxy timeout to accommodate this timeout with an\n      # additional grace period.\n      proxy_read_timeout 310s;\n      # Nomad log streaming uses streaming HTTP requests. In order to\n      # synchronously stream logs from Nomad to NGINX to the browser\n      # proxy buffering needs to be turned off.\n      proxy_buffering off;\n      # The Upgrade and Connection headers are used to establish\n      # a WebSockets connection.\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection "upgrade";\n\n      # The default Origin header will be the proxy address, which\n      # will be rejected by Nomad. It must be rewritten to be the\n      # host address instead.\n      proxy_set_header Origin "${scheme}://${proxy_host}";\n    }\n  }\n  server {\n    listen 8081;\n    server_name 0.0.0.0;\n    location / {\n      proxy_pass https://consul;\n      proxy_ssl_server_name on;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_read_timeout 310s;\n      proxy_buffering off;\n    }\n  }\n}\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"Note")," that this takes the ",(0,r.kt)("strong",{parentName:"p"},"HTTPS")," connection from the Nomad (and Consul) and forwards it using ",(0,r.kt)("strong",{parentName:"p"},"HTTP"),". You basically downgrade attacking yourself. ",(0,r.kt)("em",{parentName:"p"},"TODO")," need to add ",(0,r.kt)("a",{parentName:"p",href:"https://nginx.org/en/docs/http/ngx_http_ssl_module.html"},"TLS to NGINX"),"!")),(0,r.kt)("h3",{id:"security"},"Security"),(0,r.kt)("h4",{id:"restricting-access-with-http-basic-authentication"},"Restricting Access with HTTP Basic Authentication"),(0,r.kt)("p",null,"You can restrict access to your website or some parts of it by implementing a username/password authentication. Usernames and passwords are taken from a file created and populated by a password file creation tool, for example such as ",(0,r.kt)("inlineCode",{parentName:"p"},"apt install apache2-utils")," (Debian, Ubuntu) or ",(0,r.kt)("inlineCode",{parentName:"p"},"yum install httpd-tools")," (RHEL/CentOS/Oracle Linux)."),(0,r.kt)("p",null,"Run the ",(0,r.kt)("inlineCode",{parentName:"p"},"htpasswd")," utility with the ",(0,r.kt)("inlineCode",{parentName:"p"},"-c")," flag (to create a new file), the file pathname as the first argument, and the username as the second argument:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"htpasswd -c /opt/ingress/.htpasswd myuser\n")),(0,r.kt)("p",null,"We can limit access to the whole website with basic authentication by adding ",(0,r.kt)("inlineCode",{parentName:"p"},"auth_basic")," to the server block but still make some website areas public by specifying ",(0,r.kt)("inlineCode",{parentName:"p"},"auth_basic off;")," in specific location blocks. Or just add ",(0,r.kt)("inlineCode",{parentName:"p"},"auth_basic")," to every location block you want to lock down:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-conf"},'# /opt/ingress/nginx.conf\nevents {}\n\nhttp {\n  upstream nomad {\n    ip_hash;\n    server localhost:4646;\n  }\n  upstream consul {\n    server localhost:8501;\n  }\n  server {\n    listen 8080;\n    server_name 0.0.0.0;\n    auth_basic "Administrator\u2019s Area";\n    auth_basic_user_file /etc/nginx/.htpasswd; \n    location / {\n      proxy_pass https://nomad;\n      proxy_ssl_server_name on;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_read_timeout 310s;\n      proxy_buffering off;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection "upgrade";\n      proxy_set_header Origin "${scheme}://${proxy_host}";\n    }\n  }\n  server {\n    listen 8081;\n    server_name 0.0.0.0;\n    auth_basic "Administrator\u2019s Area";\n    auth_basic_user_file /etc/nginx/.htpasswd; \n    location / {\n      proxy_pass https://consul;\n      proxy_ssl_server_name on;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_read_timeout 310s;\n      proxy_buffering off;\n    }\n  }\n}\n')),(0,r.kt)("h3",{id:"test-run"},"Test Run"),(0,r.kt)("p",null,"Next in a new terminal session, start NGINX in Docker using this configuration file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker run --name ingress \\\n    --rm \\\n    --network host \\\n    --mount type=bind,source=/opt/ingress/nginx.conf,target=/etc/nginx/nginx.conf \\\n    --mount type=bind,source=/opt/ingress/.htpasswd,target=/etc/nginx/.htpasswd \\\n    nginx:1.23.0-alpine\n")),(0,r.kt)("p",null,"The Nomad UI is now being proxied on your server IP with port ",(0,r.kt)("inlineCode",{parentName:"p"},"8080")," and Consul's UI on port ",(0,r.kt)("inlineCode",{parentName:"p"},"8081")," - use your user login to access them:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Hashicorp Nomad for NGINX Web Proxies",src:t(17838).Z,width:"1193",height:"460"})),(0,r.kt)("h2",{id:"create-a-nomad-job-to-set-up-the-nginx-proxy"},"Create a Nomad Job to set up the NGINX Proxy"),(0,r.kt)("p",null,"I thought that I could now use Nomad to deploy the web proxy on the Nomad Master server. But apparently this is not the way... (why can't you reach out to master servers?). Anyway, as a proof of concept I will now spawn two web services on one of the minion servers on ports ",(0,r.kt)("inlineCode",{parentName:"p"},"44555")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"55444")," and use Nomad to provide the web proxy for those services:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"/etc/nomad.d/jobs/nginx_ingress.nomad")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'locals {\n  ports = [\n    {\n      port_label = "nomad"\n      port       = 8080\n    },\n    {\n      port_label = "consul"\n      port       = 8081\n    }\n  ]\n}\n\njob "nginx" {\n  datacenters = ["dc1"]\n\n  group "nginx" {\n    count = 1\n\n    network {\n      mode = "host"\n      dynamic "port" {\n        for_each = local.ports\n        labels   = [port.value.port_label]\n\n        content {\n          to = port.value.port\n        }\n      }\n    }\n\n    service {\n      name = "nginx"\n    }\n\n    task "nginx" {\n      driver = "docker"\n\n      config {\n        network_mode = "host"\n        image = "nginx:1.23.0-alpine"\n        ports = ["nomad","consul"]\n        volumes = [\n          "local/conf/nginx.conf:/etc/nginx/nginx.conf",\n          "local/conf/.htpasswd:/etc/nginx/conf.d/.htpasswd",\n        ]\n      }\n\n      template {\n        data = <<EOF\nevents {}\n\nhttp {\n  upstream nomad {\n    ip_hash;\n    server localhost:55444;\n  }\n  upstream consul {\n    server localhost:44555;\n  }\n  server {\n    listen 8080;\n    server_name 0.0.0.0;\n    auth_basic "Administrator\u2019s Area";\n    auth_basic_user_file /etc/nginx/conf.d/.htpasswd; \n    location / {\n      proxy_pass http://nomad;\n      proxy_ssl_server_name on;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_read_timeout 310s;\n      proxy_buffering off;\n      proxy_set_header Upgrade $http_upgrade;\n      proxy_set_header Connection "upgrade";\n      proxy_set_header Origin "${scheme}://${proxy_host}";\n    }\n  }\n  server {\n    listen 8081;\n    server_name 0.0.0.0;\n    auth_basic "Administrator\u2019s Area";\n    auth_basic_user_file /etc/nginx/conf.d/.htpasswd; \n    location / {\n      proxy_pass http://consul;\n      proxy_ssl_server_name on;\n      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n      proxy_read_timeout 310s;\n      proxy_buffering off;\n    }\n  }\n}\nEOF\n\n        destination   = "local/conf/nginx.conf"\n        change_mode   = "signal"\n        change_signal = "SIGHUP"\n      }\n\n      template {\n        data = <<EOF\nmyuser:%dsFdsfg4a$#@cch#$%IvNykKW3d/\nEOF\n\n        destination   = "local/conf/.htpasswd"\n        change_mode   = "signal"\n        change_signal = "SIGHUP"\n      }\n    }\n  }\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'nomad plan /etc/nomad.d/jobs/nginx_ingress.nomad                                                        \n+ Job: "nginx"\n+ Task Group: "nginx" (1 create)\n  + Task: "nginx" (forces create)\n\nScheduler dry-run:\n- All tasks successfully allocated.\n\nJob Modify Index: 34024\nTo submit the job with version verification run:\n\nnomad job run -check-index 34024 /etc/nomad.d/jobs/nginx_ingress.nomad\n')),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Hashicorp Nomad for NGINX Web Proxies",src:t(80389).Z,width:"1078",height:"365"})),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nomad status nginx                                                                                                   \nID            = nginx\nName          = nginx\nSubmit Date   = 2022-07-09T10:03:46+02:00\n\nAllocations\nID        Node ID   Task Group  Version  Desired  Status   Created     Modified\nc92a039c  005f708b  nginx       4        run      running  20s ago     6s ago\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nomad alloc logs c92a039c                                                                                            \n/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration\n/docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/\n/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh\n10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf\n10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 in /etc/nginx/conf.d/default.conf\n/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh\n/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh\n/docker-entrypoint.sh: Configuration complete; ready for start up\n")),(0,r.kt)("p",null,"I now have both my web services on port ",(0,r.kt)("inlineCode",{parentName:"p"},"55444")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"44555")," proxied through ports ",(0,r.kt)("inlineCode",{parentName:"p"},"8080")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"8081")," with the user login provided in ",(0,r.kt)("inlineCode",{parentName:"p"},".htpasswd")))}d.isMDXComponent=!0},80389:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/NGINX_Proxy_with_Nomad_01-631c46d53490a33884cb513ad349abc9.png"},17838:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/Nomad_NGINX_Proxy_01-c341567ab8160b5616e0c199caee019b.png"},19487:(e,n,t)=>{t.d(n,{Z:()=>o});const o=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-6c1edb088dfea3a7d39f8eebb8e9dc23.jpg"}}]);