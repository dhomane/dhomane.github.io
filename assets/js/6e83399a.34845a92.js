"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[35412],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>m});var n=a(67294);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var o=n.createContext({}),p=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,r=e.originalType,o=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(a),m=l,k=u["".concat(o,".").concat(m)]||u[m]||d[m]||r;return a?n.createElement(k,i(i({ref:t},c),{},{components:a})):n.createElement(k,i({ref:t},c))}));function m(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var r=a.length,i=new Array(r);i[0]=u;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:l,i[1]=s;for(var p=2;p<r;p++)i[p]=a[p];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},42965:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var n=a(87462),l=(a(67294),a(3905));const r={sidebar_position:9070,slug:"2020-07-27",title:"Securing Webservers - FirewallD Deployment on Ubuntu 20.04",authors:"mpolinowski",tags:["LINUX","Security","FirewallD","fail2ban"]},i=void 0,s={unversionedId:"DevOps/Security/2020-07-27--firewalld-deployment-ubuntu/index",id:"DevOps/Security/2020-07-27--firewalld-deployment-ubuntu/index",title:"Securing Webservers - FirewallD Deployment on Ubuntu 20.04",description:"TST, Hong Kong",source:"@site/docs/DevOps/Security/2020-07-27--firewalld-deployment-ubuntu/index.md",sourceDirName:"DevOps/Security/2020-07-27--firewalld-deployment-ubuntu",slug:"/DevOps/Security/2020-07-27--firewalld-deployment-ubuntu/2020-07-27",permalink:"/docs/DevOps/Security/2020-07-27--firewalld-deployment-ubuntu/2020-07-27",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Security/2020-07-27--firewalld-deployment-ubuntu/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Security",permalink:"/docs/tags/security"},{label:"FirewallD",permalink:"/docs/tags/firewall-d"},{label:"fail2ban",permalink:"/docs/tags/fail-2-ban"}],version:"current",sidebarPosition:9070,frontMatter:{sidebar_position:9070,slug:"2020-07-27",title:"Securing Webservers - FirewallD Deployment on Ubuntu 20.04",authors:"mpolinowski",tags:["LINUX","Security","FirewallD","fail2ban"]},sidebar:"tutorialSidebar",previous:{title:"Securing Webservers - Fail2Ban Ubuntu 20.10",permalink:"/docs/DevOps/Security/2020-07-28--fail2ban-ubuntu-server/2020-07-28"},next:{title:"Securing Webservers - FirewallD Deployment on Debian 9",permalink:"/docs/DevOps/Security/2020-07-27--firewalld-deployment-debian/2020-07-27"}},o={},p=[{value:"Installation",id:"installation",level:2},{value:"Setup",id:"setup",level:2},{value:"Services",id:"services",level:3},{value:"Ports",id:"ports",level:3},{value:"Docker",id:"docker",level:4},{value:"Enable FirewallD",id:"enable-firewalld",level:2},{value:"Prevent Bruteforce SSH attacks",id:"prevent-bruteforce-ssh-attacks",level:3},{value:"Create a Blacklist",id:"create-a-blacklist",level:3},{value:"Block and Enable ICMP",id:"block-and-enable-icmp",level:3},{value:"Lockdown Rules",id:"lockdown-rules",level:3},{value:"How to Reset when things go Wrong",id:"how-to-reset-when-things-go-wrong",level:3},{value:"fail2ban-firewalld",id:"fail2ban-firewalld",level:3},{value:"fail2ban",id:"fail2ban",level:2},{value:"Unbanning an IP Address",id:"unbanning-an-ip-address",level:3},{value:"Blacklisting Script and Configuration",id:"blacklisting-script-and-configuration",level:2}],c={toc:p};function d(e){let{components:t,...r}=e;return(0,l.kt)("wrapper",(0,n.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"TST, Hong Kong",src:a(71150).Z,width:"1500",height:"517"})),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#installation"},"Installation")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#setup"},"Setup"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#services"},"Services")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#ports"},"Ports"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#docker"},"Docker")))))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#enable-firewalld"},"Enable FirewallD"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#prevent-bruteforce-ssh-attacks"},"Prevent Bruteforce SSH attacks")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#create-a-blacklist"},"Create a Blacklist")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#block-and-enable-icmp"},"Block and Enable ICMP")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#lockdown-rules"},"Lockdown Rules")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#how-to-reset-when-things-go-wrong"},"How to Reset when things go Wrong")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#fail2ban-firewalld"},"fail2ban-firewalld")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#fail2ban"},"fail2ban"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#unbanning-an-ip-address"},"Unbanning an IP Address")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#blacklisting-script-and-configuration"},"Blacklisting Script and Configuration"))),(0,l.kt)("h2",{id:"installation"},"Installation"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get remove ufw\napt-get install firewall-applet\n")),(0,l.kt)("h2",{id:"setup"},"Setup"),(0,l.kt)("p",null,"Before enabling your firewall you need to check what ports are in use on your server:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"netstat -lntup\n")),(0,l.kt)("p",null,"This will list all processes that are actively listening on ports on your system:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"Active Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           PID/Program name\ntcp        0      0 127.0.0.53:53           621/systemd-resolve\ntcp        0      0 0.0.0.0:22              689/sshd: /usr/sbin\ntcp6       0      0 :::22                   689/sshd: /usr/sbin\ntcp6       0      0 :::443                  1045/docker-proxy\ntcp6       0      0 :::10050                4130/docker-proxy\ntcp6       0      0 :::2222                 1078/docker-proxy\ntcp6       0      0 :::8080                 1099/docker-proxy\ntcp6       0      0 :::80                   1065/docker-proxy\n")),(0,l.kt)("p",null,"You can also run ",(0,l.kt)("inlineCode",{parentName:"p"},"netstat -ltup")," to get a list where known ports are named by the service that usually occupies them - in case you don't know what a certain port is doing in this list:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"Active Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           PID/Program name\ntcp        0      0 localhost:domain        621/systemd-resolve\ntcp        0      0 0.0.0.0:ssh             689/sshd: /usr/sbin\ntcp6       0      0 [::]:ssh                689/sshd: /usr/sbin\ntcp6       0      0 [::]:https              1045/docker-proxy\ntcp6       0      0 [::]:zabbix-agent       4130/docker-proxy\ntcp6       0      0 [::]:2222               1078/docker-proxy\ntcp6       0      0 [::]:http-alt           1099/docker-proxy\ntcp6       0      0 [::]:http               1065/docker-proxy\n")),(0,l.kt)("h3",{id:"services"},"Services"),(0,l.kt)("p",null,"FirewallD offers service presets that you can use to allow all necessary traffic for those services to work correctly:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --get-services\n\nRH-Satellite-6 amanda-client amanda-k5-client amqp amqps apcupsd audit bacula bacula-client bb bgp bitcoin bitcoin-rpc bitcoin-testnet bitcoin-testnet-rpc bittorrent-lsd ceph ceph-mon cfengine cockpit condor-collector ctdb dhcp dhcpv6 dhcpv6-client distcc dns dns-over-tls docker-registry docker-swarm dropbox-lansync elasticsearch etcd-client etcd-server finger freeipa-4 freeipa-ldap freeipa-ldaps freeipa-replication freeipa-trust ftp ganglia-client ganglia-master git grafana gre high-availability http https imap imaps ipp ipp-client ipsec irc ircs iscsi-target isns jenkins kadmin kdeconnect kerberos kibana klogin kpasswd kprop kshell kube-apiserver ldap ldaps libvirt libvirt-tls lightning-network llmnr managesieve matrix mdns memcache minidlna mongodb mosh mountd mqtt mqtt-tls ms-wbt mssql murmur mysql nfs nfs3 nmea-0183 nrpe ntp nut openvpn ovirt-imageio ovirt-storageconsole ovirt-vmconsole plex pmcd pmproxy pmwebapi pmwebapis pop3 pop3s postgresql privoxy prometheus proxy-dhcp ptp pulseaudio puppetmaster quassel radius rdp redis redis-sentinel rpc-bind rsh rsyncd rtsp salt-master samba samba-client samba-dc sane sip sips slp smtp smtp-submission smtps snmp snmptrap spideroak-lansync spotify-sync squid ssdp ssh steam-streaming svdrp svn syncthing syncthing-gui synergy syslog syslog-tls telnet tentacle tftp tftp-client tile38 tinc tor-socks transmission-client upnp-client vdsm vnc-server wbem-http wbem-https wsman wsmans xdmcp xmpp-bosh xmpp-client xmpp-local xmpp-server zabbix-agent zabbix-server\n")),(0,l.kt)("p",null,"You can find out what ports are opened by a service inside the definition files in ",(0,l.kt)("inlineCode",{parentName:"p"},"/usr/lib/firewalld/services/")," - e.g.:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-xml"},'cat /usr/lib/firewalld/services/zabbix-server.xml\n\n<?xml version="1.0" encoding="utf-8"?>\n<service>\n  <short>Zabbix Server</short>\n  <description>Zabbix is a mature and effortless enterprise-class open source monitoring solution for network monitoring and application monitoring of millions of metrics.</description>\n  <port protocol="tcp" port="10051"/>\n</service>\n')),(0,l.kt)("p",null,"We can add all releavant service presets with:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --zone=public --add-service=ssh\nfirewall-cmd --permanent --zone=public --add-service=git\nfirewall-cmd --permanent --zone=public --add-service=http\nfirewall-cmd --permanent --zone=public --add-service=https\n")),(0,l.kt)("h3",{id:"ports"},"Ports"),(0,l.kt)("p",null,"To add specialized ports run:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --zone=public --add-port=2222/tcp\nfirewall-cmd --permanent --zone=public --add-port=8080/tcp\nfirewall-cmd --permanent --zone=public --add-port=4505-4506/tcp\nfirewall-cmd --reload\n")),(0,l.kt)("h4",{id:"docker"},"Docker"),(0,l.kt)("p",null,"To actively reject traffic to a specific port:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'firewall-cmd --permanent --add-rich-rule=\'rule family=ipv4 port port="9200" protocol="tcp" reject\'\nfirewall-cmd --reload\n')),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"BUT")," Docker will override this! Make sure to bind all ports that you don't want to be open to the internet to localhost!"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"Example")," ",(0,l.kt)("inlineCode",{parentName:"p"},"docker-compose.yml"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yml"},"ports:\n  - '127.0.0.1:9200:9200'\n  - '127.0.0.1:9300:9300'\n")),(0,l.kt)("h2",{id:"enable-firewalld"},"Enable FirewallD"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable --now firewalld\nsystemctl status firewalld\n")),(0,l.kt)("p",null,"Verify that everything is set up correctly:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --zone=public --list-all\n\npublic\n  target: default\n  icmp-block-inversion: no\n  interfaces:\n  sources:\n  services: dhcpv6-client git http https salt-master ssh zabbix-agent zabbix-server\n  ports: 2222/tcp 8080/tcp\n  protocols:\n  masquerade: no\n  forward-ports:\n  source-ports:\n  icmp-blocks:\n  rich rules:\n")),(0,l.kt)("h3",{id:"prevent-bruteforce-ssh-attacks"},"Prevent Bruteforce SSH attacks"),(0,l.kt)("p",null,"Reject new incoming ipv4 connections when more than 2 attempts per minute are made. It will also log a message about this:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'firewall-cmd --add-rich-rule=\'rule family="ipv4" service name="ssh" log prefix="SSH Bruteforce:" level="warning" limit value="2/m" accept limit value="2/m"\' --permanent\n')),(0,l.kt)("p",null,"If you have both ipv4 and ipv6 configured you\u2019ll probably want the more generic version:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'firewall-cmd --add-rich-rule=\'rule service name="ssh" log prefix="SSH Bruteforce:" level="warning" limit value="2/m" accept limit value="2/m"\' --permanent\n')),(0,l.kt)("h3",{id:"create-a-blacklist"},"Create a Blacklist"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --new-ipset=blacklist --type=hash:net --option=family=inet --option=hashsize=4096 --option=maxelem=200000\n")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"\u2013permanent")," = use to make changes to the permanent configuration"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"\u2013new-ipset")," = name of the new IP/net blacklist"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"\u2013type"),' = storage hash type, "net" is for subnets, while "ip" for individual ip addresses'),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"\u2013option=family")," = IPv4 or IPv6 network, inet is for IPv4"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"\u2013option=hashsize")," = the initial hash size of the list"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"\u2013option=maxelem")," = max number of elements")),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://www.ipdeny.com/ipblocks/"},"Download net blocks"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"wget https://www.ipdeny.com/ipblocks/data/aggregated/ru-aggregated.zone\n")),(0,l.kt)("p",null,"Populate the blacklist:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --ipset=blacklist --add-entries-from-file=./ru-aggregated.zone\n")),(0,l.kt)("p",null,"To add individual IP addresses or net blocks by yourself:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --ipset=blacklist --add-entry=4.46.116.112\nfirewall-cmd --ipset=blacklist --add-entry=4.46.116.112\n")),(0,l.kt)("p",null,"Redirect the blacklist to the drop zone"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --zone=drop --add-source=ipset:blacklist\nfirewall-cmd --reload\n")),(0,l.kt)("h3",{id:"block-and-enable-icmp"},"Block and Enable ICMP"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --zone=public --query-icmp-block=echo-reply\n")),(0,l.kt)("p",null,'If you get "no", that means there isn\u2019t any icmp block applied, let\u2019s enable (block) icmp.'),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --zone=public --add-icmp-block=echo-reply\n")),(0,l.kt)("h3",{id:"lockdown-rules"},"Lockdown Rules"),(0,l.kt)("p",null,"It\u2019s possible to change the firewalld rules by any local applications, which have the root privileges. To avoid making changes to firewalld rules, we have to put a lock-down in \u2018firewalld.conf\u2018 file. This mostly used to protect the firewalld from any unwanted rules changes by any applications."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/firewalld/firewalld.conf\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cfg"},"Lockdown=yes\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --reload\nfirewall-cmd --query-lockdown\n")),(0,l.kt)("p",null,"To On/Off lockdown mode, use the following combination."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --lockdown-on\nfirewall-cmd --lockdown-off\n")),(0,l.kt)("h3",{id:"how-to-reset-when-things-go-wrong"},"How to Reset when things go Wrong"),(0,l.kt)("p",null,"Delete your Zone Settings:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"rm -rf /etc/firewalld/zones\n")),(0,l.kt)("p",null,"Using the below set of commands you will set accept rule for all types of connections."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -P INPUT ACCEPT\niptables -P OUTPUT ACCEPT\niptables -P FORWARD ACCEPT\n")),(0,l.kt)("p",null,"This will confirm, iptables gonna accept all requests for all types of connections."),(0,l.kt)("p",null,"Using below set of commands, delete your currently configured rules from iptables."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -F INPUT\niptables -F OUTPUT\niptables -F FORWARD\n")),(0,l.kt)("p",null,"Or you can do it in single command:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"iptables -F\n")),(0,l.kt)("p",null,"That\u2019s it! Your iptables are reset to default settings i.e. accept all!"),(0,l.kt)("h3",{id:"fail2ban-firewalld"},"fail2ban-firewalld"),(0,l.kt)("p",null,"Configure ",(0,l.kt)("a",{parentName:"p",href:"https://fedoraproject.org/wiki/Fail2ban_with_FirewallD#fail2ban-firewalld"},"fail2ban")," (",(0,l.kt)("strong",{parentName:"p"},"see below"),") to block hosts via firewalld."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get update && apt-get upgrade -y\napt-get install fail2ban\n")),(0,l.kt)("h2",{id:"fail2ban"},"fail2ban"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://www.fail2ban.org/wiki/index.php/Main_Page"},"fail2ban")," is a daemon to ban hosts that cause multiple authentication errors."),(0,l.kt)("p",null,"fail2ban will monitor the SystemD journal to look for failed authentication attempts for whichever jails have been enabled. After the number of failed attempts specified it will add a firewall rule to block that specific IP address for an amount of time configured."),(0,l.kt)("p",null,"Start by ",(0,l.kt)("a",{parentName:"p",href:"https://www.fail2ban.org/wiki/index.php/Downloads"},"installing the package")," on your system - ",(0,l.kt)("a",{parentName:"p",href:"https://packages.debian.org/stable/net/fail2ban"},"Debian"),", ",(0,l.kt)("a",{parentName:"p",href:"https://packages.ubuntu.com/search?keywords=fail2ban"},"Ubuntu")," or on Centos through EPEL."),(0,l.kt)("p",null,"The jail.conf file will enable Fail2ban for SSH by default for Debian and Ubuntu, but not CentOS. All other protocols and configurations (HTTP, FTP, etc.) are commented out. If you want to change this, create a jail.local for editing:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local\n")),(0,l.kt)("p",null,"Once installed the next step is to configure a jail (a service you want to monitor and ban at whatever thresholds you\u2019ve set). By default IPs are banned for 1 hour. The best practice is to override the system defaults using ",(0,l.kt)("em",{parentName:"p"},".local files instead of directly modifying the "),".config files:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cfg"},'# cat /etc/fail2ban/jail.local\n[DEFAULT]\n# "bantime" is the number of seconds that a host is banned.\nbantime  = 1d\n\n# A host is banned if it has generated "maxretry" during the last "findtime"\n# seconds.\nfindtime  = 1h\n\n# "maxretry" is the number of failures before a host get banned.\nmaxretry = 5\n')),(0,l.kt)("p",null,"After 5 attempts within the last hour the IP will be blocked for 1 day."),(0,l.kt)("p",null,"The next step is to configure a jail. In this tutorial sshd is shown but the steps are more or less the same for other services. Create a configuration file inside ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/fail2ban/jail.d"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# cat /etc/fail2ban/jail.d/sshd.local\n[sshd]\nenabled = true\n")),(0,l.kt)("p",null,"Next enable and start the fail2ban service."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable --now fail2ban\nsystemctl status fail2ban\n")),(0,l.kt)("p",null,"to check the status of fail2ban and make sure the jail is enabled enter:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"fail2ban-client status\n\nStatus\n|- Number of jail:  1\n`- Jail list:   sshd\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"fail2ban-client status sshd\nStatus for the jail: sshd\n|- Filter\n|  |- Currently failed: 8\n|  |- Total failed: 4399\n|  `- Journal matches:  _SYSTEMD_UNIT=sshd.service + _COMM=sshd\n`- Actions\n   |- Currently banned: 101\n   |- Total banned: 684\n   `- Banned IP list:   ...\n")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"tail -f /var/log/fail2ban.log\n")),(0,l.kt)("p",null,"Check IP address geo location and add country ban lists where necessary ",(0,l.kt)("inlineCode",{parentName:"p"},"whois ip-addrss | grep -i country"),"."),(0,l.kt)("h3",{id:"unbanning-an-ip-address"},"Unbanning an IP Address"),(0,l.kt)("p",null,'In order to remove an IP address from the banned list, parameter IPADDRESS is set to appropriate IP which needs unbanning. The name "sshd" is the name of the jail, in this case the "sshd" jail that we configured above. The following command does the job.'),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"fail2ban-client set sshd unbanip IPADDRESS\n")),(0,l.kt)("h2",{id:"blacklisting-script-and-configuration"},"Blacklisting Script and Configuration"),(0,l.kt)("p",null,"The ",(0,l.kt)("a",{parentName:"p",href:"https://fedoramagazine.org/protect-your-system-with-fail2ban-and-firewalld-blacklists/"},"following script")," to automate the process as much as possible:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n# Based on the below article\n# https://www.linode.com/community/questions/11143/top-tip-firewalld-and-ipset-country-blacklist\n\n# Source the blacklisted countries from the configuration file\n. /etc/blacklist-by-country\n\n# Create a temporary working directory\nipdeny_tmp_dir=$(mktemp -d -t blacklist-XXXXXXXXXX)\npushd $ipdeny_tmp_dir\n\n# Download the latest network addresses by country file\ncurl -LO http://www.ipdeny.com/ipblocks/data/countries/all-zones.tar.gz\ntar xf all-zones.tar.gz\n\n# For updates, remove the ipset blacklist and recreate\nif firewall-cmd -q --zone=drop --query-source=ipset:blacklist; then\n    firewall-cmd -q --permanent --delete-ipset=blacklist\nfi\n\n# Create the ipset blacklist which accepts both IP addresses and networks\nfirewall-cmd -q --permanent --new-ipset=blacklist --type=hash:net \\\n    --option=family=inet --option=hashsize=4096 --option=maxelem=200000 \\\n    --set-description="An ipset list of networks or ips to be dropped."\n\n# Add the address ranges by country per ipdeny.com to the blacklist\nfor country in $countries; do\n    firewall-cmd -q --permanent --ipset=blacklist \\\n        --add-entries-from-file=./$country.zone && \\\n        echo "Added $country to blacklist ipset."\ndone\n\n# Block individual IPs if the configuration file exists and is not empty\nif [ -s "/etc/blacklist-by-ip" ]; then\n    echo "Adding IPs blacklists."\n    firewall-cmd -q --permanent --ipset=blacklist \\\n        --add-entries-from-file=/etc/blacklist-by-ip && \\\n        echo "Added IPs to blacklist ipset."\nfi\n\n# Add the blacklist ipset to the drop zone if not already setup\nif firewall-cmd -q --zone=drop --query-source=ipset:blacklist; then\n    echo "Blacklist already in firewalld drop zone."\nelse\n    echo "Adding ipset blacklist to firewalld drop zone."\n    firewall-cmd --permanent --zone=drop --add-source=ipset:blacklist\nfi\n\nfirewall-cmd -q --reload\n\npopd\nrm -rf $ipdeny_tmp_dir\n')),(0,l.kt)("p",null,"This should be installed to ",(0,l.kt)("inlineCode",{parentName:"p"},"/usr/local/sbin")," and don\u2019t forget to make it executable!"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"chmod +x /usr/local/sbin/firewalld-blacklist\n")),(0,l.kt)("p",null,"Then create a configure file: ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/blacklist-by-country"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'# Which countries should be blocked?\n# Use the two letter designation separated by a space.\ncountries=""\n')),(0,l.kt)("p",null,"And another configuration file ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/blacklist-by-ip"),", which is just one IP per line without any additional formatting."),(0,l.kt)("p",null,"For this example 10 random countries were selected from the ipdeny zones:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"# ls | shuf -n 10 | sed \"s/\\.zone//g\" | tr '\\n' ' '\nnl ee ie pk is sv na om gp bn\n")),(0,l.kt)("p",null,"Now as long as at least one country has been added to the config file it\u2019s ready to run!"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"firewalld-blacklist\nfirewall-cmd --info-zone=drop\nfirewall-cmd --info-ipset=blacklist | less\n")),(0,l.kt)("p",null,"See also - auto blacklist updates: ",(0,l.kt)("a",{parentName:"p",href:"https://pagure.io/firewalld-blacklist/tree/master"},"https://pagure.io/firewalld-blacklist/tree/master")),(0,l.kt)("p",null,"download the service file and timer to ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/systemd/system/")," and enable the timer:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl daemon-reload\nsystemctl enable --now firewalld-blacklist.timer\n")))}d.isMDXComponent=!0},71150:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-ec671595d585b88a85b017a7908fb619.jpg"}}]);