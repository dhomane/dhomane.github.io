"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[1508],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>c});var n=a(67294);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var o=n.createContext({}),p=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},u=function(e){var t=p(e.components);return n.createElement(o.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,s=e.originalType,o=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),d=p(a),c=l,k=d["".concat(o,".").concat(c)]||d[c]||m[c]||s;return a?n.createElement(k,r(r({ref:t},u),{},{components:a})):n.createElement(k,r({ref:t},u))}));function c(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var s=a.length,r=new Array(s);r[0]=d;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i.mdxType="string"==typeof e?e:l,r[1]=i;for(var p=2;p<s;p++)r[p]=a[p];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},27810:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>r,default:()=>m,frontMatter:()=>s,metadata:()=>i,toc:()=>p});var n=a(87462),l=(a(67294),a(3905));const s={sidebar_position:9010,slug:"2020-06-23",title:"Saltstack Refresh Course 1: Setup",authors:"mpolinowski",tags:["LINUX","Salt"]},r=void 0,i={unversionedId:"DevOps/Salt/2020-06-23--saltestack-refresh-course-1-setup/index",id:"DevOps/Salt/2020-06-23--saltestack-refresh-course-1-setup/index",title:"Saltstack Refresh Course 1: Setup",description:"Shenzhen, China",source:"@site/docs/DevOps/Salt/2020-06-23--saltestack-refresh-course-1-setup/index.md",sourceDirName:"DevOps/Salt/2020-06-23--saltestack-refresh-course-1-setup",slug:"/DevOps/Salt/2020-06-23--saltestack-refresh-course-1-setup/2020-06-23",permalink:"/docs/DevOps/Salt/2020-06-23--saltestack-refresh-course-1-setup/2020-06-23",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Salt/2020-06-23--saltestack-refresh-course-1-setup/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Salt",permalink:"/docs/tags/salt"}],version:"current",sidebarPosition:9010,frontMatter:{sidebar_position:9010,slug:"2020-06-23",title:"Saltstack Refresh Course 1: Setup",authors:"mpolinowski",tags:["LINUX","Salt"]},sidebar:"tutorialSidebar",previous:{title:"Saltstack Refresh Course 2: Salt State",permalink:"/docs/DevOps/Salt/2020-06-23--saltestack-refresh-course-2-salt-state/2020-06-23"},next:{title:"NGINX Salt State",permalink:"/docs/DevOps/Salt/2020-06-22--salt-nginx-state/2020-06-22"}},o={},p=[{value:"Installing Salt",id:"installing-salt",level:2},{value:"Setting up Salt (Manually)",id:"setting-up-salt-manually",level:2},{value:"Salt Command Line Interface",id:"salt-command-line-interface",level:2},{value:"manage.up",id:"manageup",level:3},{value:"cmd.run",id:"cmdrun",level:3},{value:"Execution Modules",id:"execution-modules",level:3},{value:"test.ping",id:"testping",level:4},{value:"user.add",id:"useradd",level:4},{value:"file.append",id:"fileappend",level:4},{value:"aptpkg / yumpkg",id:"aptpkg--yumpkg",level:4},{value:"Salt Grains, Pillars and SaltUtil",id:"salt-grains-pillars-and-saltutil",level:2}],u={toc:p};function m(e){let{components:t,...s}=e;return(0,l.kt)("wrapper",(0,n.Z)({},u,s,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Shenzhen, China",src:a(58909).Z,width:"1500",height:"520"})),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#installing-salt"},"Installing Salt")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#setting-up-salt-manually"},"Setting up Salt (Manually)")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#salt-command-line-interface"},"Salt Command Line Interface"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#manageup"},"manage.up")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#cmdrun"},"cmd.run")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#execution-modules"},"Execution Modules"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#testping"},"test.ping")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#useradd"},"user.add")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#fileappend"},"file.append")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#aptpkg--yumpkg"},"aptpkg / yumpkg")))))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#salt-grains-pillars-and-saltutil"},"Salt Grains, Pillars and SaltUtil"))),(0,l.kt)("h2",{id:"installing-salt"},"Installing Salt"),(0,l.kt)("p",null,"Installing Salt from a bash file:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n# Install pip\ncurl https://bootstrap.pypa.io/get-pip.py | python\n\n# Install Salt\n/usr/local/bin/pip install salt\n\n# Configure Salt\nmkdir -p /etc/salt/minion.d/\necho "master: <My Master IP"> /etc/salt/minion.d/master.conf\necho "<My Minion ID>" > /etc/salt/minion_id\n\n# Run salt\n/usr/local/bin/salt-minion -d\n')),(0,l.kt)("h2",{id:"setting-up-salt-manually"},"Setting up Salt (Manually)"),(0,l.kt)("p",null,"Start by defining the Root directory for your ",(0,l.kt)("strong",{parentName:"p"},"Salt Master")," configuration files:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/salt/master.d/roots.conf\n")),(0,l.kt)("p",null,"We are going to collect all our configuration files in the default ",(0,l.kt)("inlineCode",{parentName:"p"},"mkdir -p /srv/salt/base")," directory:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yml"},"file_roots:\n  base:\n    - /srv/salt/base\n")),(0,l.kt)("p",null,"Now we need to tell our ",(0,l.kt)("strong",{parentName:"p"},"Salt Minion")," where to find the master server:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/salt/minion.d/master.conf\n")),(0,l.kt)("p",null,"In my case the master is running on the same server but I will still use the local IP:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"master: 192.168.2.110\n")),(0,l.kt)("p",null,"We can now start the ",(0,l.kt)("strong",{parentName:"p"},"Salt Minion")," daemon and check the minion key with the following commands:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt-minion -d\nsalt-key\n")),(0,l.kt)("p",null,"Your minion should have send a connection request with a identifying key. Your master should have this key listed under ",(0,l.kt)("em",{parentName:"p"},"Unaccepted Keys"),". Since the key is not very readable we first want to change it. To do this we can first stop the minion process:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl stop salt-minion\nsystemctl status salt-minion\n")),(0,l.kt)("p",null,"You can delete the old key with ",(0,l.kt)("inlineCode",{parentName:"p"},"salt-key -d 'old-key'"),". You can replace the key with something sensible, e.g. ",(0,l.kt)("inlineCode",{parentName:"p"},"salt-master_minion"),". For this we first have to find out the Master public key:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt-key --finger-all\n\nLocal Keys:\nmaster.pem:  f1:d3:52:eb:f4:...\nmaster.pub:  64:12:61:93:3e:...\n")),(0,l.kt)("p",null,"And then add both the key and the desired Minion ID to our ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/salt/minion.d/master.conf")," file:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-cfg"},"# Set the location of the salt master server. If the master server cannot be\n# resolved, then the minion will fail to start.\nmaster: 192.168.2.110\n\n# Fingerprint of the master public key to validate the identity of your Salt master\n# before the initial key exchange. The master fingerprint can be found by running\n# \"salt-key -f master.pub\" on the Salt master.\nmaster_finger: '64:12:61:93:3e:...'\n\n# Explicitly declare the id for this minion to use, if left commented the id\n# will be the hostname as returned by the python call: socket.getfqdn()\n# Since salt uses detached ids it is possible to run multiple minions on the\n# same machine but with different ids, this can be useful for salt compute\n# clusters.\nid: salt-master_minion\n")),(0,l.kt)("p",null,"Now restart the minion with:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start salt-minion\nsystemctl status salt-minion\n")),(0,l.kt)("p",null,"If we re-run the key command we will now see our Minion key listed with the new name (below I added another server - so now I have the ",(0,l.kt)("inlineCode",{parentName:"p"},"master_minion")," and a regular ",(0,l.kt)("inlineCode",{parentName:"p"},"minion")," waiting for approval):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt-key\n\nAccepted Keys:\nDenied Keys:\nUnaccepted Keys:\nsalt-master_minion\nsalt-minion\n")),(0,l.kt)("p",null,"I can accept them with the following command:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt-key -a salt-*\n")),(0,l.kt)("h2",{id:"salt-command-line-interface"},"Salt Command Line Interface"),(0,l.kt)("h3",{id:"manageup"},"manage.up"),(0,l.kt)("p",null,"We can now verify that all minions are up and ready:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt-run manage.up\n\n- salt-master_minion\n- salt-minion\n")),(0,l.kt)("h3",{id:"cmdrun"},"cmd.run"),(0,l.kt)("p",null,"We can also execute commands directly on our minions:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt salt-minion cmd.run 'ls -lah /etc'\nsalt salt-minion cmd.run 'uptime'\nsalt salt-master_minion cmd.run 'hostname'\n")),(0,l.kt)("h3",{id:"execution-modules"},"Execution Modules"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://docs.saltstack.com/en/latest/ref/modules/all/index.html"},"Salt Module Reference")),(0,l.kt)("h4",{id:"testping"},"test.ping"),(0,l.kt)("p",null,"Module for running arbitrary tests"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.test.html#module-salt.modules.test"},"test")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt 'salt-*' test.ping\nsalt-master_minion:\n    True\nsalt-minion:\n    True\n")),(0,l.kt)("h4",{id:"useradd"},"user.add"),(0,l.kt)("p",null,"Manage users with the useradd command"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.useradd.html#module-salt.modules.useradd"},"useradd")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt 'salt-minion' user.add 'zabbix'\n\nsalt-minion:\n    True\n")),(0,l.kt)("p",null,"You can verify that the user was added on your Minion with ",(0,l.kt)("inlineCode",{parentName:"p"},"cat /etc/passwd"),". You can ",(0,l.kt)("inlineCode",{parentName:"p"},"delete")," the user (and ",(0,l.kt)("inlineCode",{parentName:"p"},"remove")," the home directory) with:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt 'salt-minion' user.delete zabbix remove=True force=True\n")),(0,l.kt)("h4",{id:"fileappend"},"file.append"),(0,l.kt)("p",null,"Manage information about regular files, directories, and special files on the minion, set/read user, group, mode, and data."),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.file.html#module-salt.modules.file"},"file")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt 'salt-minion' file.append /root/test 'Salty Dayz, Sailors'\n\nsalt-minion:\n    Wrote 1 lines to \"/root/test\"\n")),(0,l.kt)("h4",{id:"aptpkg--yumpkg"},"aptpkg / yumpkg"),(0,l.kt)("p",null,"Support for APT (Advanced Packaging Tool)"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.aptpkg.html#module-salt.modules.aptpkg"},"aptpkg")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt '*' pkg.install git\n")),(0,l.kt)("h2",{id:"salt-grains-pillars-and-saltutil"},"Salt Grains, Pillars and SaltUtil"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("strong",{parentName:"p"},"Grains")," return system variables")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt salt-minion grains.items\n\nsalt-minion:\n    ----------\n    apps:\n        ----------\n        port:\n            7777\n    biosreleasedate:\n        07/31/2018\n    biosversion:\n        0407\n    cpu_model:\n        Intel(R) Core(TM) i3-8130U CPU @ 2.20GHz\n    cpuarch:\n        x86_64\n    dns:\n        ----------\n        domain:\n        ip4_nameservers:\n            - 127.0.0.53\n        ip6_nameservers:\n        nameservers:\n            - 127.0.0.53\n        options:\n            - edns0\n        search:\n            - workgroup\n        sortlist:\n    domain:\n    fqdn:\n        salt-minion\n    fqdn_ip4:\n        - 127.0.1.1\n    fqdn_ip6:\n    fqdns:\n        - registry.salt-minion\n        - salt-minion\n\n...\n")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("strong",{parentName:"p"},"Pillars")," should be used to store secrets (SSH logins, api keys, etc.). Those information are stored on the master server and only securely transferred to the minion server that needs the information. Pillar data has to be synced using the ",(0,l.kt)("strong",{parentName:"p"},"SaltUtil")," accordingly.")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"salt salt-minion saltutil.pillar_refresh\nsalt-minion:\n    True\n\nsalt salt-minion saltutil.sync_all\nsalt-minion:\n    ----------\n    beacons:\n    clouds:\n    engines:\n    executors:\n    grains:\n    log_handlers:\n    matchers:\n    modules:\n    output:\n    proxymodules:\n    renderers:\n    returners:\n    sdb:\n    serializers:\n    states:\n    thorium:\n    utils:\n")))}m.isMDXComponent=!0},58909:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-2215e4912b7f3d1beed1d8b83bac94aa.jpg"}}]);