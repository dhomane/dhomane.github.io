"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[69550],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>u});var n=a(67294);function l(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){l(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,l=function(e,t){if(null==e)return{};var a,n,l={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(l[a]=e[a]);return l}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(l[a]=e[a])}return l}var o=n.createContext({}),c=function(e){var t=n.useContext(o),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(o.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,l=e.mdxType,r=e.originalType,o=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),h=c(a),u=l,g=h["".concat(o,".").concat(u)]||h[u]||d[u]||r;return a?n.createElement(g,s(s({ref:t},p),{},{components:a})):n.createElement(g,s({ref:t},p))}));function u(e,t){var a=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var r=a.length,s=new Array(r);s[0]=h;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i.mdxType="string"==typeof e?e:l,s[1]=i;for(var c=2;c<r;c++)s[c]=a[c];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},26440:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>s,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var n=a(87462),l=(a(67294),a(3905));const r={sidebar_position:9060,slug:"2019-09-12",title:"Magento 2 and Elasticsearch",authors:"mpolinowski",tags:["LINUX","Elasticsearch","Magento"]},s=void 0,i={unversionedId:"Development/Magento/2019-09-12--magento-and-elasticsearch/index",id:"Development/Magento/2019-09-12--magento-and-elasticsearch/index",title:"Magento 2 and Elasticsearch",description:"Patan, Nepal",source:"@site/docs/Development/Magento/2019-09-12--magento-and-elasticsearch/index.mdx",sourceDirName:"Development/Magento/2019-09-12--magento-and-elasticsearch",slug:"/Development/Magento/2019-09-12--magento-and-elasticsearch/2019-09-12",permalink:"/docs/Development/Magento/2019-09-12--magento-and-elasticsearch/2019-09-12",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Development/Magento/2019-09-12--magento-and-elasticsearch/index.mdx",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Elasticsearch",permalink:"/docs/tags/elasticsearch"},{label:"Magento",permalink:"/docs/tags/magento"}],version:"current",sidebarPosition:9060,frontMatter:{sidebar_position:9060,slug:"2019-09-12",title:"Magento 2 and Elasticsearch",authors:"mpolinowski",tags:["LINUX","Elasticsearch","Magento"]},sidebar:"tutorialSidebar",previous:{title:"Magento 2 and Varnish 6",permalink:"/docs/Development/Magento/2019-09-13--magento-and-varnish/2019-09-13"},next:{title:"Magento 2 Installation with NGINX on Debian Buster",permalink:"/docs/Development/Magento/2019-09-11--magento-on-debian-with-nginx/2019-09-11"}},o={},c=[{value:"Install prerequisites and Elasticsearch",id:"install-prerequisites-and-elasticsearch",level:2},{value:"Installing OpenJDK 8",id:"installing-openjdk-8",level:3},{value:"Install Elasticsearch 6.x",id:"install-elasticsearch-6x",level:3},{value:"Configure NGINX and Elasticsearch",id:"configure-nginx-and-elasticsearch",level:2},{value:"Set up NGINX as a proxy",id:"set-up-nginx-as-a-proxy",level:3},{value:"Configure Elasticsearch within Magento",id:"configure-elasticsearch-within-magento",level:3},{value:"Reindexing catalog search and refreshing the full page cache",id:"reindexing-catalog-search-and-refreshing-the-full-page-cache",level:3}],p={toc:c};function d(e){let{components:t,...r}=e;return(0,l.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Patan, Nepal",src:a(21764).Z,width:"1500",height:"691"})),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#install-prerequisites-and-elasticsearch"},"Install prerequisites and Elasticsearch"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#installing-openjdk-8"},"Installing OpenJDK 8")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#install-elasticsearch-6x"},"Install Elasticsearch 6.x")))),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#configure-nginx-and-elasticsearch"},"Configure NGINX and Elasticsearch"),(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#set-up-nginx-as-a-proxy"},"Set up NGINX as a proxy")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#configure-elasticsearch-within-magento"},"Configure Elasticsearch within Magento")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"#reindexing-catalog-search-and-refreshing-the-full-page-cache"},"Reindexing catalog search and refreshing the full page cache"))))),(0,l.kt)("h2",{id:"install-prerequisites-and-elasticsearch"},"Install prerequisites and Elasticsearch"),(0,l.kt)("h3",{id:"installing-openjdk-8"},"Installing OpenJDK 8"),(0,l.kt)("p",null,"Start by verifying that Java hasn't been installed yet on your system:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"java -version\n-bash: java: command not found\n")),(0,l.kt)("p",null,"Java LTS version 8 is not available in the official Debian Buster repositories. You can still install it by enabling the AdoptOpenJDK repository which provides prebuilt OpenJDK packages (",(0,l.kt)("a",{parentName:"p",href:"https://stackoverflow.com/questions/57031649/how-to-install-openjdk-8-jdk-on-debian-10-buster"},"check alternatives"),"):"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"apt update\napt install apt-transport-https ca-certificates wget dirmngr gnupg software-properties-common\n")),(0,l.kt)("p",null,"Import the repository\u2019s GPG key using the following wget command:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"wget -qO - https://adoptopenjdk.jfrog.io/adoptopenjdk/api/gpg/key/public | sudo apt-key add -\n")),(0,l.kt)("p",null,"Add the AdoptOpenJDK APT repository to your system:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo add-apt-repository --yes https://adoptopenjdk.jfrog.io/adoptopenjdk/deb/\n")),(0,l.kt)("p",null,"Once the repository is enabled, update apt sources and install Java 8 using the following commands:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo apt update\nsudo apt install adoptopenjdk-8-hotspot\n")),(0,l.kt)("p",null,"Finally, verify the installation by checking the Java version. The output should look something like this::"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'java -version\nopenjdk version "1.8.0_232"\nOpenJDK Runtime Environment (AdoptOpenJDK)(build 1.8.0_232-b09)\nOpenJDK 64-Bit Server VM (AdoptOpenJDK)(build 25.232-b09, mixed mode)\n')),(0,l.kt)("h3",{id:"install-elasticsearch-6x"},"Install Elasticsearch 6.x"),(0,l.kt)("p",null,"Download and install the public signing key:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -\n")),(0,l.kt)("p",null,"Save the repository definition to ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/apt/sources.list.d/elastic-6.x.list"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'echo "deb https://artifacts.elastic.co/packages/6.x/apt stable main" | sudo tee -a /etc/apt/sources.list.d/elastic-6.x.list\n')),(0,l.kt)("p",null,"You can install the Elasticsearch Debian package with:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"apt update && sudo apt install elasticsearch\n")),(0,l.kt)("p",null,"To configure Elasticsearch to start automatically when the system boots up, run the following commands:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"sudo /bin/systemctl daemon-reload\nsudo /bin/systemctl enable elasticsearch.service\n")),(0,l.kt)("p",null,"Elasticsearch can be started and stopped as follows:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl start elasticsearch.service\nsystemctl stop elasticsearch.service\n")),(0,l.kt)("p",null,"These commands provide no feedback as to whether Elasticsearch was started successfully or not. Instead, this information will be written in the log files located in /var/log/elasticsearch/. You can also check the service status:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl status elasticsearch.service\n\u25cf elasticsearch.service - Elasticsearch\n   Loaded: loaded (/lib/systemd/system/elasticsearch.service; enabled; vendor preset: enabled)\n   Active: active (running) since Mon 2020-01-13 07:47:05 CET; 8s ago\n     Docs: http://www.elastic.co\n Main PID: 30088 (java)\n    Tasks: 30 (limit: 4915)\n   Memory: 1.2G\n   CGroup: /system.slice/elasticsearch.service\n           \u251c\u250030088 /bin/java -Xms1g -Xmx1g -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccup           \u2514\u250030180 /usr/share/elasticsearch/modules/x-pack-ml/platform/linux-x86_64/bin/controller\n\nJan 13 07:47:05 Magento2 systemd[1]: Started Elasticsearch.\n")),(0,l.kt)("p",null,"You can now access Elasticsearch by:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},'url -X GET "localhost:9200/?pretty"\n\n{\n  "name" : "NPsrvIo",\n  "cluster_name" : "elasticsearch",\n  "cluster_uuid" : "aCUd90SnRCynWMZCw-AAhg",\n  "version" : {\n    "number" : "6.8.6",\n    "build_flavor" : "default",\n    "build_type" : "deb",\n    "build_hash" : "3d9f765",\n    "build_date" : "2019-12-13T17:11:52.013738Z",\n    "build_snapshot" : false,\n    "lucene_version" : "7.7.2",\n    "minimum_wire_compatibility_version" : "5.6.0",\n    "minimum_index_compatibility_version" : "5.0.0"\n  },\n  "tagline" : "You Know, for Search"\n}\n')),(0,l.kt)("p",null,"Elasticsearch is configured to only be accessible from localhost:"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Magento2 and Elasticsearch",src:a(49108).Z,width:"928",height:"731"})),(0,l.kt)("p",null,"You can change this in the ",(0,l.kt)("strong",{parentName:"p"},"Network Section")," of ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/elasticsearch/elasticsearch.yml"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-yml"},"# ---------------------------------- Network -----------------------------------\n#\n# Set the bind address to a specific IP (IPv4 or IPv6):\n#\n#network.host: 192.168.0.1\n#\n# Set a custom port for HTTP:\n#\n#http.port: 9200\n#\n# For more information, consult the network module documentation.\n")),(0,l.kt)("p",null,"By default the ",(0,l.kt)("inlineCode",{parentName:"p"},"network.host")," is set to ",(0,l.kt)("inlineCode",{parentName:"p"},"127.0.0.1")," - setting it to ",(0,l.kt)("inlineCode",{parentName:"p"},"0.0.0.0")," will open Elasticsearch up to all your network interfaces. But be aware that Elasticsearch 6 does not have a free User Authentication pre-installed!"),(0,l.kt)("h2",{id:"configure-nginx-and-elasticsearch"},"Configure NGINX and Elasticsearch"),(0,l.kt)("h3",{id:"set-up-nginx-as-a-proxy"},"Set up NGINX as a proxy"),(0,l.kt)("p",null,"Create a new file ",(0,l.kt)("inlineCode",{parentName:"p"},"/etc/nginx/sites-available/elasticsearch.conf")," with the following content:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n   listen 8080;\n   location /_cluster/health {\n      proxy_pass http://localhost:9200/_cluster/health;\n   }\n}\n")),(0,l.kt)("p",null,"Symlink the configuration file into ",(0,l.kt)("inlineCode",{parentName:"p"},"site-enabled")," and restart NGINX:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"ln -s /etc/nginx/sites-available/elasticsearch.conf /etc/nginx/sites-enabled\nnginx -t\nservice nginx restart\n")),(0,l.kt)("p",null,"Verify the proxy works by entering the following command ",(0,l.kt)("inlineCode",{parentName:"p"},"netstat -plnt")," and try opening the URL inside your browser ",(0,l.kt)("inlineCode",{parentName:"p"},"http://your-server.de:8080/_cluster/health")," :"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Magento2 and Elasticsearch",src:a(30203).Z,width:"925",height:"800"})),(0,l.kt)("p",null,"We now have Magento 2.3.3 running on Port 80 and our health check for Elasticsearch on Port 8080 - both available on all network interfaces ",(0,l.kt)("inlineCode",{parentName:"p"},"0.0.0.0"),". While the Elasticsearch API Ports 9200/9300 are securely bound to ",(0,l.kt)("inlineCode",{parentName:"p"},"127.0.0.1")," and cannot be accessed from the internet."),(0,l.kt)("h3",{id:"configure-elasticsearch-within-magento"},"Configure Elasticsearch within Magento"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Log in to the Magento Admin as an administrator."),(0,l.kt)("li",{parentName:"ol"},"Click ",(0,l.kt)("strong",{parentName:"li"},"Stores")," > ",(0,l.kt)("strong",{parentName:"li"},"Configuration")," > ",(0,l.kt)("strong",{parentName:"li"},"Catalog")," > ",(0,l.kt)("strong",{parentName:"li"},"Catalog Search"),"."),(0,l.kt)("li",{parentName:"ol"},"From the Search Engine list, select the correct Elasticsearch version as the following figure shows.")),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Magento2 and Elasticsearch",src:a(85817).Z,width:"1038",height:"743"})),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"th"},"Option")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"th"},"Description")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"Elasticsearch Server Hostname")),(0,l.kt)("td",{parentName:"tr",align:null},"Enter the fully qualified hostname or IP address of the machine running Elasticsearch - as we are running Elasticsearch locally, we can use ",(0,l.kt)("inlineCode",{parentName:"td"},"localhost"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"Elasticsearch Server Port")),(0,l.kt)("td",{parentName:"tr",align:null},"Enter the Elasticsearch web server proxy port - for us ",(0,l.kt)("inlineCode",{parentName:"td"},"9200"))),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"Elasticsearch Index Prefix")),(0,l.kt)("td",{parentName:"tr",align:null},"Enter the Elasticsearch index prefix. If you use a single Elasticsearch instance for more than one Magento installation")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("strong",{parentName:"td"},"Enable Elasticsearch HTTP Auth")),(0,l.kt)("td",{parentName:"tr",align:null},"Click Yes only if you enabled authentication for your Elasticsearch server - we did not.")))),(0,l.kt)("ol",{start:4},(0,l.kt)("li",{parentName:"ol"},"Click Test Connection.")),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Magento2 and Elasticsearch",src:a(7007).Z,width:"953",height:"498"})),(0,l.kt)("h3",{id:"reindexing-catalog-search-and-refreshing-the-full-page-cache"},"Reindexing catalog search and refreshing the full page cache"),(0,l.kt)("p",null,"After you change Magento\u2019s Elasticsearch configuration, you must reindex the catalog search index and refresh the full page cache using the Admin or command line."),(0,l.kt)("p",null,"To refresh the cache using the Admin:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"In the Admin, click System > Cache Management."),(0,l.kt)("li",{parentName:"ol"},"Select the checkbox next to Page Cache."),(0,l.kt)("li",{parentName:"ol"},"From the Actions list in the upper right, click Refresh."),(0,l.kt)("li",{parentName:"ol"},"Flush the Magento Cache")),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Magento2 and Elasticsearch",src:a(70922).Z,width:"935",height:"889"})),(0,l.kt)("p",null,"Enter the following command to reindex the catalog search index only:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"bin/magento indexer:reindex catalogsearch_fulltext\n")),(0,l.kt)("p",null,"Enter the following command to reindex all indexers:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-bash"},"bin/magento indexer:reindex\n")),(0,l.kt)("p",null,"Wait until reindexing completes."),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"Magento2 and Elasticsearch",src:a(48526).Z,width:"926",height:"319"})))}d.isMDXComponent=!0},49108:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/magento_elasticsearch_01-1cf244a58bd28a20f9eff361675ce027.png"},30203:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/magento_elasticsearch_02-26553f8d17ec343842253750dd3f1a2b.png"},85817:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/magento_elasticsearch_03-2f146c22eea71ebf4cb713752a2d3090.png"},7007:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/magento_elasticsearch_04-e60a9fe734c062444e062b0cef7c680d.png"},70922:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/magento_elasticsearch_05-042da145fc030444c690d758ad417394.png"},48526:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/magento_elasticsearch_06-bd20d28bf852a5d2029089959abc5ed9.png"},21764:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/photo-kt456d_645dhfh6dgjkhg4_d-d7a7d3a232e2a500e45f12b8ea1d8d4c.jpg"}}]);