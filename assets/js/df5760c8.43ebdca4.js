"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[28077],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>d});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=p(n),d=o,h=m["".concat(s,".").concat(d)]||m[d]||u[d]||i;return n?a.createElement(h,r(r({ref:t},c),{},{components:n})):a.createElement(h,r({ref:t},c))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var p=2;p<i;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},25927:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>p});var a=n(87462),o=(n(67294),n(3905));const i={sidebar_position:8020,slug:"2019-02-07",title:"MotionEye Video Surveillance",authors:"mpolinowski",tags:["IoT","Smarthome"]},r=void 0,l={unversionedId:"IoT-and-Machine-Learning/Home_Automation/2019-02-07--motioneye-on-debian/index",id:"IoT-and-Machine-Learning/Home_Automation/2019-02-07--motioneye-on-debian/index",title:"MotionEye Video Surveillance",description:"Harbin, China",source:"@site/docs/IoT-and-Machine-Learning/Home_Automation/2019-02-07--motioneye-on-debian/index.mdx",sourceDirName:"IoT-and-Machine-Learning/Home_Automation/2019-02-07--motioneye-on-debian",slug:"/IoT-and-Machine-Learning/Home_Automation/2019-02-07--motioneye-on-debian/2019-02-07",permalink:"/docs/IoT-and-Machine-Learning/Home_Automation/2019-02-07--motioneye-on-debian/2019-02-07",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IoT-and-Machine-Learning/Home_Automation/2019-02-07--motioneye-on-debian/index.mdx",tags:[{label:"IoT",permalink:"/docs/tags/io-t"},{label:"Smarthome",permalink:"/docs/tags/smarthome"}],version:"current",sidebarPosition:8020,frontMatter:{sidebar_position:8020,slug:"2019-02-07",title:"MotionEye Video Surveillance",authors:"mpolinowski",tags:["IoT","Smarthome"]},sidebar:"tutorialSidebar",previous:{title:"Home Assistant, OpenHAB, Node-RED, ioBroker, MotionEye Containerized",permalink:"/docs/IoT-and-Machine-Learning/Home_Automation/2019-09-27--home-assistant-podman-centos8/2019-09-27"},next:{title:"Installing MotionEye on CentOS8 with Podman",permalink:"/docs/IoT-and-Machine-Learning/Home_Automation/2019-09-24--motioneye-podman-centos8/2019-09-24"}},s={},p=[{value:"Debian Installation",id:"debian-installation",level:2},{value:"SSH Access",id:"ssh-access",level:3},{value:"Set a static IP Address",id:"set-a-static-ip-address",level:3},{value:"motionEye Installation",id:"motioneye-installation",level:2},{value:"Adding your IP Camera",id:"adding-your-ip-camera",level:2},{value:"Enabling Actions",id:"enabling-actions",level:3},{value:"HTTP Request Example",id:"http-request-example",level:4},{value:"Alarm - Full HD Models",id:"alarm---full-hd-models",level:5},{value:"Alarm - VGA Models",id:"alarm---vga-models",level:5},{value:"PTZ - Full HD Models",id:"ptz---full-hd-models",level:5},{value:"Preset Positions - Full HD Models",id:"preset-positions---full-hd-models",level:5},{value:"Configuring MotionEye",id:"configuring-motioneye",level:2},{value:"Accessing MotionEye over HTTPS",id:"accessing-motioneye-over-https",level:2},{value:"Installation of FirewallD on Debian",id:"installation-of-firewalld-on-debian",level:3},{value:"Installation of NGINX on Debian",id:"installation-of-nginx-on-debian",level:3},{value:"Set up a Virtual Host for MotionEye",id:"set-up-a-virtual-host-for-motioneye",level:4},{value:"Create the SSL Certificate",id:"create-the-ssl-certificate",level:4},{value:"Configure Nginx to Use SSL",id:"configure-nginx-to-use-ssl",level:4},{value:"Adjust the Nginx Configuration to Use SSL",id:"adjust-the-nginx-configuration-to-use-ssl",level:5}],c={toc:p};function u(e){let{components:t,...i}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Harbin, China",src:n(16277).Z,width:"5303",height:"3092"})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#debian-installation"},"Debian Installation"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#ssh-access"},"SSH Access")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#set-a-static-ip-address"},"Set a static IP Address")))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#motioneye-installation"},"motionEye Installation")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#adding-your-ip-camera"},"Adding your IP Camera"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#enabling-actions"},"Enabling Actions"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#http-request-example"},"HTTP Request Example"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#alarm---full-hd-models"},"Alarm - Full HD Models")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#alarm---vga-models"},"Alarm - VGA Models")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#ptz---full-hd-models"},"PTZ - Full HD Models")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#preset-positions---full-hd-models"},"Preset Positions - Full HD Models")))))))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#configuring-motioneye"},"Configuring MotionEye")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#accessing-motioneye-over-https"},"Accessing MotionEye over HTTPS"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#installation-of-firewalld-on-debian"},"Installation of FirewallD on Debian")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#installation-of-nginx-on-debian"},"Installation of NGINX on Debian"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#set-up-a-virtual-host-for-motioneye"},"Set up a Virtual Host for MotionEye")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#create-the-ssl-certificate"},"Create the SSL Certificate")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#configure-nginx-to-use-ssl"},"Configure Nginx to Use SSL"),(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"#adjust-the-nginx-configuration-to-use-ssl"},"Adjust the Nginx Configuration to Use SSL"))))))))),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://motion-project.github.io"},"Motion")," is a highly configurable program that monitors video signals from many types of cameras (Network cameras via HTTP, RTSP and RTMP). Set it up to monitor your INSTAR IP camera, watch birds, check in on your pet, create timelapse videos and more."),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/ccrisan/motioneye/wiki"},"motionEye")," is a web frontend for the motion daemon, written in Python."),(0,o.kt)("p",null,"We are going to install both on a regular Intel Core machine - like an ",(0,o.kt)("a",{parentName:"p",href:"https://www.intel.com/content/www/us/en/products/boards-kits/nuc/kits.html"},"Intel NUC"),", ",(0,o.kt)("a",{parentName:"p",href:"https://www.asus.com/Mini-PCs/Mini-PC-PN60/"},"Asus P-Series")," or ",(0,o.kt)("a",{parentName:"p",href:"https://www.gigabyte.com/Mini-PcBarebone/BRIX"},"Gigabyte Brix"),". This decision was made due to the high CPU demands of working with 1080p video."),(0,o.kt)("p",null,"But we already wrote a tutorial on how to install ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.instar.com/en/Advanced_User/IOBroker_on_Raspberry_Pi/motionEye/#installation-of-motioneye"},"motionEye on a Raspberry Pi")," in case that this amount of processing power is sufficient for your use case."),(0,o.kt)("h2",{id:"debian-installation"},"Debian Installation"),(0,o.kt)("p",null,"We choose to install ",(0,o.kt)("strong",{parentName:"p"},"Debian 9 Linux")," on our mini PC - you can check the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/ccrisan/motioneye/wiki/Installation"},"motionEye Wiki")," for more Linux flavours. To create the installation USB stick we ",(0,o.kt)("a",{parentName:"p",href:"https://www.debian.org/CD/netinst/"},"downloaded the minimal amd64 image")," and used the tool ",(0,o.kt)("strong",{parentName:"p"},"Etcher")," to prepare the USB stick. We used the same approach to prepare a SD card with the openHABian image - you can just ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.instar.com/en/Advanced_User/openHABian_on_Raspberry_Pi/#install-openhabian-on-a-raspberry-pi"},"follow the steps from that tutorial"),". Once the USB stick is ready, deactivate secure boot in your mini PC's BIOS and boot from the stick. We are not going to need a desktop environment. But ",(0,o.kt)("strong",{parentName:"p"},"make sure that you install the SSH service")," - as we are going to use the SSH service to set up the Debian server."),(0,o.kt)("h3",{id:"ssh-access"},"SSH Access"),(0,o.kt)("p",null,"To enable SSH login for a root user on Debian Linux system you need to first configure SSH server. Open ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/ssh/sshd_config")," and change the following line:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"FROM:\nPermitRootLogin without-password\nTO:\nPermitRootLogin yes\n")),(0,o.kt)("p",null,"Once you made the above change restart your SSH server:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"# /etc/init.d/ssh restart\n[ ok ] Restarting ssh (via systemctl): ssh.service.\n")),(0,o.kt)("p",null,"From now on you will be able to ssh login as a root:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ ssh root@192.168.2.111\nroot@192.168.2.111's password: \n\nThe programs included with the Debian GNU/Linux system are free software;\nthe exact distribution terms for each program are described in the\nindividual files in /usr/share/doc/*/copyright.\n\nDebian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent\npermitted by applicable law.\n")),(0,o.kt)("h3",{id:"set-a-static-ip-address"},"Set a static IP Address"),(0,o.kt)("p",null,"By default, you will find the following configuration within the ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/network/interfaces")," network config file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"source /etc/network/interfaces.d/*\n\n# The loopback network interface\nauto lo\niface lo inet loopback\n\n# The primary network interface\nallow-hotplug eth0\niface eth0 inet static\n      address 192.168.2.111\n      netmask 255.255.255.0\n      gateway 192.168.2.1\n")),(0,o.kt)("div",{class:"dangerbox"},(0,o.kt)("h3",null,"Be aware:"),(0,o.kt)("p",null,"In newer versions of Debian the Ethernet interface will not be called ",(0,o.kt)("strong",null,"eth0")," anymore. The file contains the line ",(0,o.kt)("code",null,"iface eth0 inet dhcp")," before you set it from ",(0,o.kt)("strong",null,"dhcp")," to ",(0,o.kt)("strong",null,"static")," - the identification between ",(0,o.kt)("strong",null,"iface")," and ",(0,o.kt)("strong",null,"inet")," is the id of your ethernet interface (don't change it to eth0!).")),(0,o.kt)("p",null,"To configure a static DNS edit ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/resolv.conf")," file, and include the IP address of your preferred nameserver eg:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"nameserver 8.8.8.8\n")),(0,o.kt)("br",null),(0,o.kt)("br",null),(0,o.kt)("h2",{id:"motioneye-installation"},"motionEye Installation"),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"All commands require root; use sudo before each command or become root using su.")),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Install motion, ffmpeg and v4l-utils:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"}," apt-get install motion ffmpeg v4l-utils\n")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Install the dependencies from the repositories:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get install python-pip python-dev python-setuptools curl libssl-dev libcurl4-openssl-dev libjpeg-dev libz-dev\n")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},"Install motioneye, which will automatically pull Python dependencies (tornado, jinja2, pillow and pycurl):")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"pip install motioneye\n")),(0,o.kt)("ol",{start:4},(0,o.kt)("li",{parentName:"ol"},"Prepare the configuration directory:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"}," mkdir -p /etc/motioneye\n cp /usr/local/share/motioneye/extra/motioneye.conf.sample /etc/motioneye/motioneye.conf\n")),(0,o.kt)("ol",{start:5},(0,o.kt)("li",{parentName:"ol"},"Prepare the media directory:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"}," mkdir -p /var/lib/motioneye\n")),(0,o.kt)("ol",{start:6},(0,o.kt)("li",{parentName:"ol"},"Add an init script, configure it to run at startup and start the motionEye server:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"  cp /usr/local/share/motioneye/extra/motioneye.systemd-unit-local /etc/systemd/system/motioneye.service\n  systemctl daemon-reload\n  systemctl enable motioneye\n  systemctl start motioneye\n")),(0,o.kt)("ol",{start:7},(0,o.kt)("li",{parentName:"ol"},"To upgrade to the newest version of motioneye, after it has been released, just issue:")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"pip install motioneye --upgrade\nsystemctl restart motioneye\n")),(0,o.kt)("br",null),(0,o.kt)("br",null),(0,o.kt)("h2",{id:"adding-your-ip-camera"},"Adding your IP Camera"),(0,o.kt)("p",null,"Open the MotionEye Interface with your web browsers by typing in your Raspberry Pi's IP address followed by the Port 8765 - e.g. ",(0,o.kt)("inlineCode",{parentName:"p"},"http://192.168.2.115:8765"),". The default login is ",(0,o.kt)("strong",{parentName:"p"},"admin")," ",(0,o.kt)("strong",{parentName:"p"},"without a password"),". We already covered how ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.instar.com/en/Advanced_User/IOBroker_on_Raspberry_Pi/motionEye/#adding-your-ip-camera"},"to add JPG, MJPEG and RTSP cameras")," earlier. Follow the instructions there and add all your INSTAR VGA, HD and Full HD cameras."),(0,o.kt)("p",null,"We now want to go a step further and add buttons to control the basic camera functions. MotionEye offers a list of ",(0,o.kt)("strong",{parentName:"p"},"Action Buttons")," that we can use with our camera's ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.instar.com/en/Advanced_User/CGI_Commands/"},"CGI commands"),". They automatically map to Shell Scripts that we have to put into the ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/motioneye")," directory. The following actions are defined:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"lock"),(0,o.kt)("li",{parentName:"ul"},"unlock"),(0,o.kt)("li",{parentName:"ul"},"light_on"),(0,o.kt)("li",{parentName:"ul"},"light_off"),(0,o.kt)("li",{parentName:"ul"},"alarm_on"),(0,o.kt)("li",{parentName:"ul"},"alarm_off"),(0,o.kt)("li",{parentName:"ul"},"up"),(0,o.kt)("li",{parentName:"ul"},"right"),(0,o.kt)("li",{parentName:"ul"},"down"),(0,o.kt)("li",{parentName:"ul"},"left"),(0,o.kt)("li",{parentName:"ul"},"zoom_in"),(0,o.kt)("li",{parentName:"ul"},"zoom_out"),(0,o.kt)("li",{parentName:"ul"},"preset1 to preset9")),(0,o.kt)("p",null,"While the available actions are limited to the above set, the commands executed can be practically anything. We will choose to execute HTTP GET commands to send ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.instar.com/en/Advanced_User/CGI_Commands/"},"CGI commands")," to our cameras."),(0,o.kt)("h3",{id:"enabling-actions"},"Enabling Actions"),(0,o.kt)("p",null,"motionEye will look inside its configuration folder ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/motioneye")," for executable files named ","[action]","_","[cameraid]",", where action is one of the available actions (listed above) and cameraid is the id of the camera on top of which the action button will be displayed."),(0,o.kt)("p",null,"For example, on a setup using the default configuration, the presence of the executable file ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/motioneye/alarm_on_1")," tells motionEye to show an alarm bell button for the camera number one. The file will be executed upon pressing the button. Buttons will have distinctive icons that correspond to the name of the action."),(0,o.kt)("h4",{id:"http-request-example"},"HTTP Request Example"),(0,o.kt)("p",null,'Let\'s say that you want to issue an HTTP request to your INSTAR IP camera when you click the "turn alarm on" button of your first camera (with id 1). Create the following bash script and make it executable:'),(0,o.kt)("h5",{id:"alarm---full-hd-models"},"Alarm - Full HD Models"),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(93366).Z,width:"730",height:"300"})),(0,o.kt)("hr",null),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"touch /etc/motioneye/alarm_on_1\nchmod +x /etc/motioneye/alarm_on_1\nnano /etc/motioneye/alarm_on_1\n")),(0,o.kt)("p",null,"Then type in (or paste) the following contents, save and exit nano (Ctrl-O, Enter, Ctrl-X):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.113/param.cgi?cmd=setscheduleex&-ename=md&-week0=PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP&-week1=PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP&-week2=PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP&-week3=PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP&-week4=PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP&-week5=PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP&-week6=PPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(46581).Z,width:"730",height:"159"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"We will use the ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.instar.comhttps://wiki.instar.com/en/1080p_Series_CGI_List/Alarm_Menu/Schedule/"},"Alarm Schedule CGI Command")," for an INSTAR Full HD Camera in this example - but the URL can be set to any ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.instar.comhttps://wiki.instar.com/en/Advanced_User/CGI_Commands/"},"CGI command")," that you need!"),(0,o.kt)("p",null,"Note that the command activates the motion alarm detection of your camera 24/7. If you are already using a alarm schedule that deactivates your camera alarm during certain times - just replace some of those ",(0,o.kt)("strong",{parentName:"p"},"P"),"'s with ",(0,o.kt)("strong",{parentName:"p"},"N"),"'s to reflect your personal schedule and set MotionEye up to switch between ",(0,o.kt)("strong",{parentName:"p"},"Alarm Always ON")," / ",(0,o.kt)("strong",{parentName:"p"},"Your Alarm Schedule"),"."),(0,o.kt)("p",null,"To switch the alarm off we repeat those steps for:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"touch /etc/motioneye/alarm_off_1\nchmod +x /etc/motioneye/alarm_off_1\nnano /etc/motioneye/alarm_off_1\n")),(0,o.kt)("p",null,"Then type in (or paste) the following contents, save and exit nano (Ctrl-O, Enter, Ctrl-X):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.113/param.cgi?cmd=setscheduleex&-ename=md&-week0=NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN&-week1=NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN&-week2=NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN&-week3=NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN&-week4=NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN&-week5=NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN&-week6=NNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNNN"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("p",null,"Reload the MotionEye interface - the buttons should now be visible in the camera 1 view port (you might have to click onto the video are once to have them appear). If the buttons are not displayed, make sure that you made the shell scripts executable."),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(94563).Z,width:"730",height:"643"})),(0,o.kt)("hr",null),(0,o.kt)("h5",{id:"alarm---vga-models"},"Alarm - VGA Models"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"touch /etc/motioneye/alarm_on_3\nchmod +x /etc/motioneye/alarm_on_3\nnano /etc/motioneye/alarm_on_3\n")),(0,o.kt)("p",null,"Then type in (or paste) the following contents, save and exit nano (Ctrl-O, Enter, Ctrl-X):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.117/set_alarm.cgi?motion_armed=1"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"touch /etc/motioneye/alarm_off_3\nchmod +x /etc/motioneye/alarm_off_3\nnano /etc/motioneye/alarm_off_3\n")),(0,o.kt)("p",null,"Then type in (or paste) the following contents, save and exit nano (Ctrl-O, Enter, Ctrl-X):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.117/set_alarm.cgi?motion_armed=0"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("h5",{id:"ptz---full-hd-models"},"PTZ - Full HD Models"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"touch /etc/motioneye/left_2 /etc/motioneye/right_2 /etc/motioneye/down_2 /etc/motioneye/up_2\nchmod +x /etc/motioneye/left_2 /etc/motioneye/right_2 /etc/motioneye/down_2 /etc/motioneye/up_2\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"STEP LEFT")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"left_2")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.116/ptzctrl.cgi?-step=&-act=left"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"STEP RIGHT")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"right_2")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.116/ptzctrl.cgi?-step=&-act=right"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"STEP DOWN")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"down_2")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.116/ptzctrl.cgi?-step=&-act=down"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"STEP UP")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"up_2")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.116/ptzctrl.cgi?-step=&-act=up"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("h5",{id:"preset-positions---full-hd-models"},"Preset Positions - Full HD Models"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"touch /etc/motioneye/preset1_2 /etc/motioneye/preset2_2\nchmod +x /etc/motioneye/preset1_2 /etc/motioneye/preset2_2\n")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Go to Preset 1")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"preset1_2")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.116/param.cgi?cmd=preset&-act=goto&-number=0"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"Go to Preset 2")),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"preset2_2")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'#!/bin/bash\n\nURL="http://admin:instar@192.168.2.116/param.cgi?cmd=preset&-act=goto&-number=1"\nMETHOD="GET"\nTIMEOUT="5"\ncurl -X $METHOD --connect-timeout $TIMEOUT "$URL" > /dev/null\n')),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(39570).Z,width:"730",height:"627"})),(0,o.kt)("hr",null),(0,o.kt)("br",null),(0,o.kt)("br",null),(0,o.kt)("h2",{id:"configuring-motioneye"},"Configuring MotionEye"),(0,o.kt)("p",null,"Open the side menu and select the camera you want to edit from the drop down menu ",(0,o.kt)("inlineCode",{parentName:"p"},"1")," - activate the ",(0,o.kt)("strong",{parentName:"p"},"Advanced Settings")," ",(0,o.kt)("inlineCode",{parentName:"p"},"2"),". Let's go through a few interesting menus that MotionEye offers:"),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(66476).Z,width:"730",height:"499"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"3")," MotionEye gives you both a administrator and a regular user account. You should add a password for the admin account here. The regular user will not have access to this part of the menu."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"4")," We setup MotionEye to grab the 1080p RTSP stream from our camera. Here you can scale down the resolution - to save storage and - of particulate interest if you are using a Raspberry Pi to run MotionEye - to reduce the demand on your CPU. The framerate here is set to 2fps by default - which means that you end up with very choppy video. It again depends on your CPU and the amount of cameras you want to add if you might be able to go higher. You can also rotate your video image in 90 degree increments."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"5")," Set an upper and lower detection threshold for the integrated motion detection. How much percent of the image has to change to register as an alarm? And do you want to discard the alarm, when more than a set percentage of the image changes - as it will probably just be a light that turned on and does not interest you."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"6")," Do you have a constant movement in the background of your image that keeps triggering the alarm? Use the mask feature to have MotionEye learn which part of the image it should not use for the motion detection."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"7")," Have MotionEye draw a box around the change it detects inside the frame - this is useful to debug false alerts. Also looks really fancy."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"8")," The Email notification is self-explanatory - the fields are identical to ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.instar.com/Web_User_Interface/720p_Series/Alarm/SMTP_Server/"},"SMTP server configuration")," of an INSTAR IP camera. More interesting is the web hook function below that is identical the ",(0,o.kt)("a",{parentName:"p",href:"https://wiki.instar.com/Web_User_Interface/1080p_Series/Alarm/Alarm_Server/"},"Alarmserver")," of your INSTAR camera."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"9")," Make sure to set the video recording to ",(0,o.kt)("strong",{parentName:"p"},"h.264 (.mp4)")," if you want to display the recorded video in the MotionEye user interface! Otherwise you can use the ",(0,o.kt)("strong",{parentName:"p"},"HEVC (.mp4)")," to apply the highly effective h.265 compression and make your videos as small as possible."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"10")," Choose between a continuous recording and a recording triggered by motion detection. Alarm videos will continue to record as long as the motion continues. It makes sense to limit the maximum file size - this will create more small videos instead of one huge one that is hard to handle. You can also choose to automatically delete files again after a set time."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"11")," Upload your alarm videos to an ",(0,o.kt)("strong",{parentName:"p"},"FTP")," or ",(0,o.kt)("strong",{parentName:"p"},"SFTP Server"),". Or mirror them to ",(0,o.kt)("strong",{parentName:"p"},"Dropbox")," or ",(0,o.kt)("strong",{parentName:"p"},"Google Drive"),"."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"12")," MotionEye re-streams all your camera's video streams in a browser compatible format."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"13")," A photo camera icon will appear in the camera viewport when you activate the ",(0,o.kt)("strong",{parentName:"p"},"Manual Capture"),", allowing you to take a quick snapshot."),(0,o.kt)("br",null),(0,o.kt)("br",null),(0,o.kt)("h2",{id:"accessing-motioneye-over-https"},"Accessing MotionEye over HTTPS"),(0,o.kt)("p",null,"If you want to access the MotionEye interface over the internet, it necessary to first protect your server. In the following we want to do two things:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Close all unnecessary ports with a firewall"),(0,o.kt)("li",{parentName:"ol"},"Install a web proxy that enables us to add SSL encryption")),(0,o.kt)("p",null,"We are going to use ",(0,o.kt)("a",{parentName:"p",href:"https://firewalld.org"},"FirewallD")," as firewall and ",(0,o.kt)("a",{parentName:"p",href:"http://nginx.org/"},"NGINX")," as web proxy. Running behind the Nginx webserver (using Nginx as a reverse proxy) can be useful when:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"you want to use HTTPS with motionEye"),(0,o.kt)("li",{parentName:"ul"},"you want to serve multiple websites (including motionEye) on the same webserver (accessible at the same IP address over port 80)"),(0,o.kt)("li",{parentName:"ul"},"you want to take advantage of various Nginx modules (such as rate limiting or HTTP authentication)")),(0,o.kt)("h3",{id:"installation-of-firewalld-on-debian"},"Installation of FirewallD on Debian"),(0,o.kt)("p",null,"Install FirewallD by running the following commands:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get update\napt-get install firewalld\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(61660).Z,width:"730",height:"466"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"To open the default ",(0,o.kt)("strong",{parentName:"p"},"http")," and ",(0,o.kt)("strong",{parentName:"p"},"https ports")," run the following commands:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --zone=public --add-service=https --add-service=http\nfirewall-cmd --reload\nfirewall-cmd --list-all\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(75611).Z,width:"730",height:"520"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"If you now try to access the MotionEye interface on port ",(0,o.kt)("strong",{parentName:"p"},"8765")," you will see that it is going to timeout - as the request will be blocked by FirewallD. We can temporarily open all ports that MotionEye uses - in my case this is the main UI port 8765 and the streaming ports for three cameras ",(0,o.kt)("strong",{parentName:"p"},"8081"),", ",(0,o.kt)("strong",{parentName:"p"},"8082"),", ",(0,o.kt)("strong",{parentName:"p"},"8083"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --zone=public --add-port=8765/tcp --add-port=8081-8083/tcp\nfirewall-cmd --reload\nfirewall-cmd --list-all\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(89922).Z,width:"730",height:"246"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"You should now be able to access the MotionEye interface again - ",(0,o.kt)("strong",{parentName:"p"},"be aware")," that this command did not use the ",(0,o.kt)("strong",{parentName:"p"},"--permanent")," flag. That means, when you restart your server, or reload the firewall, those rules will be discarded."),(0,o.kt)("h3",{id:"installation-of-nginx-on-debian"},"Installation of NGINX on Debian"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"apt-get install nginx\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(66128).Z,width:"730",height:"276"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"At the end of the installation process, Debian 9 starts Nginx. The web server should already be up and running. We can check with the systemd init system to make sure the service is running by typing:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl status nginx\n")),(0,o.kt)("p",null,"When you have your server's IP address, enter it into your browser's address bar. You should see the default Nginx landing page:"),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(74285).Z,width:"730",height:"536"})),(0,o.kt)("hr",null),(0,o.kt)("h4",{id:"set-up-a-virtual-host-for-motioneye"},"Set up a Virtual Host for MotionEye"),(0,o.kt)("p",null,"Here's the content of a sample virtual host file that normally goes to ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/nginx/sites-enabled/motioneye.local"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"touch /etc/nginx/sites-enabled/motioneye.local\nnano /etc/nginx/sites-enabled/motioneye.local\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(9613).Z,width:"730",height:"136"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},"motioneye.local")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"server {\n    listen 80;\n    listen [::]:80;\n    location /dashboard/ {\n        proxy_pass            http://127.0.0.1:8765/;\n        proxy_read_timeout    1800;\n        proxy_connect_timeout 1800;\n        access_log off;\n    }\n}\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(99486).Z,width:"730",height:"235"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Make sure that your NGINX configuration passes the test and reload the service:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"nginx -t\nservice nginx reload\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(8898).Z,width:"730",height:"146"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Your MotionEye UI will be available at ",(0,o.kt)("inlineCode",{parentName:"p"},"http://192.168.2.111/dashboard/"),"  (",(0,o.kt)("strong",{parentName:"p"},"this has to be changed to the IP address of your MotionEye server!"),"). It's important to note the trailing slashes at location /dashboard/ and at ",(0,o.kt)("inlineCode",{parentName:"p"},"http://127.0.0.1:8765/"),". They make sure paths are correctly passed around when forwarding the HTTP requests to motionEye."),(0,o.kt)("h4",{id:"create-the-ssl-certificate"},"Create the SSL Certificate"),(0,o.kt)("p",null,"We can create a self-signed key and certificate pair with OpenSSL in a single command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt\n")),(0,o.kt)("p",null,"These options will create both a key file and a certificate. We will be asked a few questions about our server in order to embed the information correctly in the certificate."),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(96408).Z,width:"730",height:"334"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Both of the files you created will be placed in the appropriate subdirectories of the ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/ssl")," directory."),(0,o.kt)("p",null,"While we are using OpenSSL, we should also create a strong Diffie-Hellman group, which is used in negotiating ",(0,o.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Forward_secrecy"},"Perfect Forward Secrecy")," with clients."),(0,o.kt)("p",null,"We can do this by typing:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048\n")),(0,o.kt)("p",null,"This may take a few minutes, but when it's done you will have a strong DH group at ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/ssl/certs/dhparam.pem")," that we can use in our configuration."),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(5806).Z,width:"730",height:"65"})),(0,o.kt)("hr",null),(0,o.kt)("h4",{id:"configure-nginx-to-use-ssl"},"Configure Nginx to Use SSL"),(0,o.kt)("p",null,"We have created our key and certificate files under the /etc/ssl directory. Now we just need to modify our Nginx configuration to take advantage of these."),(0,o.kt)("p",null,"We will make a few adjustments to our configuration:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"We will create a configuration snippet containing our SSL key and certificate file locations."),(0,o.kt)("li",{parentName:"ul"},"We will create a configuration snippet containing strong SSL settings that can be used with any certificates in the future."),(0,o.kt)("li",{parentName:"ul"},"We will adjust our Nginx server blocks to handle SSL requests and use the two snippets above.")),(0,o.kt)("p",null,"First, let's create a new Nginx configuration snippet in the ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/nginx/snippets")," directory:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/nginx/snippets/self-signed.conf\n")),(0,o.kt)("p",null,"Within this file, we just need to set the ssl_certificate directive to our certificate file and the ssl_certificate_key to the associated key. In our case, this will look like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;\nssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(69889).Z,width:"730",height:"67"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Next, we will create another snippet that will define some SSL settings. This will set Nginx up with a strong SSL cipher suite and enable some advanced features that will help keep our server secure."),(0,o.kt)("p",null,"The parameters we will set can be reused in future Nginx configurations, so we will give the file a generic name:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/nginx/snippets/ssl-params.conf\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(90775).Z,width:"729",height:"348"})),(0,o.kt)("hr",null),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'# from https://cipherli.st/\n# and https://raymii.org/s/tutorials/Strong_SSL_Security_On_nginx.html\n\nssl_protocols TLSv1 TLSv1.1 TLSv1.2;\nssl_prefer_server_ciphers on;\nssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";\nssl_ecdh_curve secp384r1;\nssl_session_cache shared:SSL:10m;\nssl_session_tickets off;\nssl_stapling on;\nssl_stapling_verify on;\nresolver 8.8.8.8 8.8.4.4 valid=300s;\nresolver_timeout 5s;\n# Disable preloading HSTS for now.  You can use the commented out header line that includes\n# the "preload" directive if you understand the implications.\n#add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";\nadd_header Strict-Transport-Security "max-age=63072000; includeSubdomains";\nadd_header X-Frame-Options DENY;\nadd_header X-Content-Type-Options nosniff;\n\nssl_dhparam /etc/ssl/certs/dhparam.pem;\n')),(0,o.kt)("p",null,"Because we are using a self-signed certificate, the SSL stapling will not be used. Nginx will simply output a warning, disable stapling for our self-signed cert, and continue to operate correctly."),(0,o.kt)("h5",{id:"adjust-the-nginx-configuration-to-use-ssl"},"Adjust the Nginx Configuration to Use SSL"),(0,o.kt)("p",null,"Now that we have our snippets, we can adjust our Nginx configuration to enable SSL."),(0,o.kt)("p",null,"In this guide we are using the default server block file in the ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/nginx/sites-available")," directory. If you are using a different server block file, substitute its name in the below commands. Before we go any further, let's back up our current server block file:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bak\n")),(0,o.kt)("p",null,"Now, open the server block file to make adjustments:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/nginx/sites-available/default\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(53886).Z,width:"729",height:"166"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"We will be modifying this configuration so that unencrypted HTTP requests are automatically redirected to encrypted HTTPS. This offers the best security for our sites. If you want to allow both HTTP and HTTPS traffic, use the alternative configuration that follows."),(0,o.kt)("p",null,"Next, we need to start a new server block directly below to contain the remaining configuration. We can uncomment the two listen directives that use port 443. We can add http2 to these lines in order to enable HTTP/2 within this block. Afterwards, we just need to include the two snippet files we set up:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"server {\n    listen 80 default_server;\n  listen [::]:80 default_server;\n    return 301 https://$server_name$request_uri;\n\n    # SSL configuration\n    #\n    listen 443 ssl http2 default_server;\n    listen [::]:443 ssl http2 default_server;\n    include snippets/self-signed.conf;\n    include snippets/ssl-params.conf;\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(54284).Z,width:"729",height:"227"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Now we have to add the SSL configuration to our MotionEye server block in ",(0,o.kt)("inlineCode",{parentName:"p"},"/etc/nginx/sites-enabled/motioneye.local"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"server {\n    listen 80;\n    return 301 https://$server_name$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n      server_name 192.168.2.111;\n    include snippets/self-signed.conf;\n    include snippets/ssl-params.conf;\n    location /dashboard/ {\n        proxy_pass            http://127.0.0.1:8765/;\n        proxy_read_timeout    1800;\n        proxy_connect_timeout 1800;\n        access_log off;\n    }\n}\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(31843).Z,width:"729",height:"298"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Now we can restart Nginx to implement our new changes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"nginx -t\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(58697).Z,width:"729",height:"91"})),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Notice the warning in the beginning. As noted earlier, this particular setting throws a warning since our self-signed certificate can't use SSL stapling. This is expected and our server can still encrypt connections correctly."),(0,o.kt)("p",null,"If your output matches the above, your configuration file has no syntax errors. We can safely restart Nginx to implement our changes:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"service nginx reload\n")),(0,o.kt)("hr",null),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Motion Eye and INSTAR IP Cameras",src:n(79858).Z,width:"729",height:"739"})),(0,o.kt)("hr",null))}u.isMDXComponent=!0},93366:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_01-2ef3d11dea681592167fe43562afea72.png"},46581:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_02-c9af19c0f59cc5e8b51bd775deafccdd.png"},94563:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_03-e3275d1df48fd90a9c7d77e8caf7c031.png"},39570:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_04-284b2093d5287b5b640b72b1fe381ba7.png"},66476:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_05-025d153220e55531531f9b7ca9cc1fda.png"},61660:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_06-853eadd60662433b2bc2d3a366b6eb4c.png"},75611:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_07-83aeb93a2e034108f2721894b5f7b268.png"},89922:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_08-683982aa3c364aa25c8d3ddf744c4add.png"},66128:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_09-8501195767f1b078092aa1ef7c59bcfd.png"},74285:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_10-3333e07524e156bf7b542ec5d2a273dc.png"},9613:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_11-52612918717ccba9452ffc1453a4c414.png"},99486:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_12-0be261d5cbed393caf0c8370e803dcae.png"},8898:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_13-836d754431e09df86f4172a7feccb25e.png"},96408:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_14-2e0aed01e16364ad6e71c2746a3d2bc9.png"},5806:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_15-65244637501641313c0c7f50fba3a366.png"},69889:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_16-743d8289117d689cfc8ee600748a5e13.png"},90775:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_17-37689f215645406d98acec5a980dbbae.png"},53886:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_18-b1267f18ebb5dfd9a59459c4482545bc.png"},54284:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_19-f6a741f094b4b35df73c371325974d86.png"},31843:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_20-f02a5cb5b48617b7e2e388b761eb5a24.png"},58697:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_21-97138db8ac70975e84f71336af35fb21.png"},79858:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/MotionEye_22-02737fbe32fbf5c8edf74e810f4634d8.png"},16277:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/photo-kt456d_645dhfh6dgjkhg4_d-991af9173d13acdebb7b20fc1ae00add.jpg"}}]);