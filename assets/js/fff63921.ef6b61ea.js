"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[11826],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>d});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=c(n),d=r,h=m["".concat(s,".").concat(d)]||m[d]||u[d]||o;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},84701:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var a=n(87462),r=(n(67294),n(3905));const o={sidebar_position:6e3,slug:"2022-10-29",title:"WebRTC Introduction - Realtime Chat",authors:"mpolinowski",tags:["Javascript","WebRTC"],description:"Establishing a bidirectional Websocket connection."},i=void 0,l={unversionedId:"Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat/index",id:"Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat/index",title:"WebRTC Introduction - Realtime Chat",description:"Establishing a bidirectional Websocket connection.",source:"@site/docs/Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat/index.md",sourceDirName:"Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat",slug:"/Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat/2022-10-29",permalink:"/docs/Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat/2022-10-29",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat/index.md",tags:[{label:"Javascript",permalink:"/docs/tags/javascript"},{label:"WebRTC",permalink:"/docs/tags/web-rtc"}],version:"current",sidebarPosition:6e3,frontMatter:{sidebar_position:6e3,slug:"2022-10-29",title:"WebRTC Introduction - Realtime Chat",authors:"mpolinowski",tags:["Javascript","WebRTC"],description:"Establishing a bidirectional Websocket connection."},sidebar:"tutorialSidebar",previous:{title:"WebRTC Introduction - Client Side Signalling",permalink:"/docs/Development/Javascript/2022-10-30-webrtc-introduction-video-chat-part1/2022-10-30"},next:{title:"Docusaurus Introduction",permalink:"/docs/Development/Javascript/2022-07-01-docusaurus-introduction/2022-07-01"}},s={},c=[{value:"WebRTC",id:"webrtc",level:2},{value:"Protocols",id:"protocols",level:3},{value:"SDP",id:"sdp",level:4},{value:"ICE",id:"ice",level:4},{value:"RTP &amp; RTCP",id:"rtp--rtcp",level:4},{value:"SCTP",id:"sctp",level:4},{value:"DTLS &amp; SRTP",id:"dtls--srtp",level:4},{value:"Bi-Directional Communication - Websocket Signalling",id:"bi-directional-communication---websocket-signalling",level:2}],p={toc:c};function u(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Shenzhen, China",src:n(38202).Z,width:"2208",height:"757"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#webrtc"},"WebRTC"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#protocols"},"Protocols"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#sdp"},"SDP")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#ice"},"ICE")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#rtp--rtcp"},"RTP \\& RTCP")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#sctp"},"SCTP")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#dtls--srtp"},"DTLS \\& SRTP")))))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#bi-directional-communication---websocket-signalling"},"Bi-Directional Communication - Websocket Signalling"))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"WIP")," "),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/Development/Javascript/2022-10-29-webrtc-introduction-realtime-chat/2022-10-29"},"WebRTC Introduction - Websockets")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/Development/Javascript/2022-10-30-webrtc-introduction-video-chat-part1/2022-10-30"},"WebRTC Introduction - Client Side Signalling")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/docs/Development/Javascript/2022-11-10-webrtc-introduction-video-chat-part2/2022-11-10"},"WebRTC Introduction - Interactive Connectivity Establishment"))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Resources:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com"},"WebRTC for the Curious")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://web.dev/webrtc-basics/#toc-rtcpeerconnection"},"WebRTC Basics")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtc.github.io/samples/src/content/peerconnection/munge-sdp/"},"WebRTC Sample"))),(0,r.kt)("h2",{id:"webrtc"},"WebRTC"),(0,r.kt)("p",null,"With ",(0,r.kt)("a",{parentName:"p",href:"https://webrtc.org/"},"WebRTC"),", you can add real-time communication capabilities to your application that works on top of an open standard. It supports video, voice, and generic data to be sent between peers, allowing developers to build powerful voice- and video-communication solutions."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Signalling Server"),": For signaling intend and to negotiate the connection parameter."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"STUN Server"),": Provides a tool for hosts to discover the presence of a network address translator, and to discover the mapped Internet Protocol (",(0,r.kt)("strong",{parentName:"li"},"IP"),") address and port number. "),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"TURN Server"),": ",(0,r.kt)("a",{parentName:"li",href:"https://webrtc.org/getting-started/turn-server"},"Traversal Using Relay NAT")," - Server required for relaying the traffic between peers, since a direct socket is often not possible between the clients.")),(0,r.kt)("h3",{id:"protocols"},"Protocols"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/02-signaling/"},"Signalling"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/02-signaling/#what-is-the-session-description-protocol-sdp"},"SDP"),": Session Description Protocol"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/03-connecting/"},"Connecting"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/03-connecting/#ice"},"ICE"),": Interactive Connectivity Establishment"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/06-media-communication"},"Media Communication"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/06-media-communication/#rtp"},"RTP"),": Real-time Transport Protocol"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/07-data-communication/#stream-control-transmission-protocol"},"SCTP"),": Stream Control Transmission Protocol"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/06-media-communication/#rtcp"},"RTCP"),": Real-time Transport Control Protocol"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/04-securing/"},"Security"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/04-securing/#dtls"},"DTLS"),": Datagram Transport Layer Security"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://webrtcforthecurious.com/docs/04-securing/#srtp"},"SRTP"),": Secure Real-time Transport Protocol")))),(0,r.kt)("h4",{id:"sdp"},"SDP"),(0,r.kt)("p",null,"Signaling is the initial bootstrapping that makes a call possible. After these values are exchanged, the WebRTC agents can communicate directly with each other. WebRTC uses an existing protocol called the Session Description Protocol. Via this protocol, the two WebRTC Agents will share all the state required to establish a connection."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("inlineCode",{parentName:"p"},"key = value"))),(0,r.kt)("p",null,"With the following keys:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"v"),": Version, should be equal to ",(0,r.kt)("inlineCode",{parentName:"li"},"0"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"o"),": Origin, contains a unique ID useful for renegotiations."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"s"),": Session Name, should be equal to ",(0,r.kt)("inlineCode",{parentName:"li"},"-"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"t"),": Timing, should be equal to ",(0,r.kt)("inlineCode",{parentName:"li"},"0 0"),"."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"m"),": Media Description (",(0,r.kt)("inlineCode",{parentName:"li"},"m=<media> <port> <proto> <fmt>")," ...)."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"a"),": Attribute, a free text field. This is the most common line in WebRTC."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"c"),": Connection Data, should be equal to ",(0,r.kt)("inlineCode",{parentName:"li"},"IN IP4 0.0.0.0"),".")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Full Example"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"v=0\no=- 0 0 IN IP4 127.0.0.1\ns=-\nc=IN IP4 127.0.0.1\nt=0 0\nm=audio 4000 RTP/AVP 111\na=rtpmap:111 OPUS/48000/2\nm=video 4002 RTP/AVP 96\na=rtpmap:96 VP8/90000\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"v"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"o"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"s"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"c"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"t")," are defined, but they do not affect the WebRTC session."),(0,r.kt)("li",{parentName:"ul"},"You have two Media Descriptions. One of type audio and one of type video.")),(0,r.kt)("h4",{id:"ice"},"ICE"),(0,r.kt)("p",null,"ICE (",(0,r.kt)("em",{parentName:"p"},"Interactive Connectivity Establishment"),") is how WebRTC connects two Agents. ICE is a protocol for establishing connectivity. It determines all the possible routes between the two peers and then ensures you stay connected. This is where STUN and TURN come into play with ICE. These addresses can be your local IP Address plus a port, NAT mapping, or Relayed Transport Address. Each side gathers all the addresses they want to use, exchanges them, and then attempts to connect."),(0,r.kt)("h4",{id:"rtp--rtcp"},"RTP & RTCP"),(0,r.kt)("p",null,"WebRTC allows you to send and receive an unlimited amount of audio and video streams. You can add and remove these streams at anytime during a call."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"RTP")," (",(0,r.kt)("em",{parentName:"p"},"Real-time Transport Protocol"),") is the protocol that carries the media. It was designed to allow for real-time delivery of video. RTP gives you streams, so you can run multiple media feeds over one connection. It also gives you the timing and ordering information you need to feed a media pipeline."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"RTCP")," (",(0,r.kt)("em",{parentName:"p"},"RTP Control Protocol"),") is the protocol that communicates metadata about the call. This is used to communicate statistics about the call. It is also used to handle packet loss and to implement congestion control. It gives you the bi-directional communication necessary to respond to changing network conditions."),(0,r.kt)("h4",{id:"sctp"},"SCTP"),(0,r.kt)("p",null,"WebRTC uses the ",(0,r.kt)("em",{parentName:"p"},"Stream Control Transmission Protocol")," (",(0,r.kt)("strong",{parentName:"p"},"SCTP"),") which is a transport layer protocol that was intended as an alternative to ",(0,r.kt)("em",{parentName:"p"},"TCP")," or ",(0,r.kt)("em",{parentName:"p"},"UDP"),". SCTP gives you streams and each stream can be configured independently. SCTP is the real power behind WebRTC data channels. It provides all these features of the data channel:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Multiplexing"),(0,r.kt)("li",{parentName:"ul"},"Reliable delivery using a TCP-like retransmission mechanism"),(0,r.kt)("li",{parentName:"ul"},"Partial-reliability options"),(0,r.kt)("li",{parentName:"ul"},"Congestion Avoidance"),(0,r.kt)("li",{parentName:"ul"},"Flow Control")),(0,r.kt)("h4",{id:"dtls--srtp"},"DTLS & SRTP"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Every WebRTC connection is authenticated and encrypted.")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"DTLS")," (",(0,r.kt)("em",{parentName:"p"},"Datagram Transport Layer Security"),") allows two peers to establish secure communication with no pre-existing configuration. For a DTLS Client and a Server to communicate, they need to agree on a cipher and the key. They determine these values by doing a DTLS handshake. During the handshake, the messages are in plaintext. When a DTLS Client/Server has exchanged enough details to start encrypting it sends a Change Cipher Spec. After this message, each subsequent message will be encrypted."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"SRTP")," (",(0,r.kt)("em",{parentName:"p"},"Secure Real-time Transport Protocol"),") is a protocol designed specifically for encrypting RTP packets. To start an SRTP session you specify your keys and cipher. Unlike DTLS it has no handshake mechanism. All the configuration and keys were generated during the DTLS handshake."),(0,r.kt)("h2",{id:"bi-directional-communication---websocket-signalling"},"Bi-Directional Communication - Websocket Signalling"),(0,r.kt)("p",null,"Establishing a bidirectional link between two clients -> Express & ",(0,r.kt)("a",{parentName:"p",href:"https://socket.io/get-started/chat"},"Socket.io"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'const express = require("express");\nconst socket = require("socket.io");\n\nconst port = 8888\n\nvar app = express();\n\nvar server = app.listen(port, function () {\n    console.log(\'INFO :: Webserver is running on ::  http://localhost:\' + port)\n});\n\napp.use(express.static("public"));\n\nvar upgradedServer = socket(server);\n\nupgradedServer.on("connection", function (socket) {\n  console.log("INFO :: Websocket connection established :: ", socket.id);\n});\n')),(0,r.kt)("p",null,"And add the following to your web client to establish a bidirectional websocket connection"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-html"},'<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.3/socket.io.js" integrity="sha512-iWPnCISAd/J+ZacwV2mbNLCaPGRrRo5OS81lKTVPtRg1wGTC20Cfmp5Us5RcbLv42QLdbAWl0MI57yox5VecQg==" crossorigin="anonymous" referrerpolicy="no-referrer"><\/script>\n<script src="./chat.js"><\/script>\n')),(0,r.kt)("p",null,"With ",(0,r.kt)("inlineCode",{parentName:"p"},"chat.js"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'let socket = io.connect("http://localhost:8888");\n')),(0,r.kt)("p",null,"Starting the web server with ",(0,r.kt)("inlineCode",{parentName:"p"},"node index.js"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"npm start\n\n> webrtc-intro@1.0.0 start\n> node index.js\n\nINFO :: Webserver is running on ::  http://localhost:8888\nINFO :: Websocket connection established ::  g96wjUg0JtWL71FoAAAB\n")),(0,r.kt)("p",null,"We can now get the HTML elements in ",(0,r.kt)("inlineCode",{parentName:"p"},"chat.js")," and send their values to our backend to trigger a broadcast function when a new message arrives:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"var username = document.getElementById(\"username\")\nvar output = document.getElementById(\"output\")\nvar message = document.getElementById(\"message\")\nvar button = document.getElementById(\"send\")\n\nbutton.addEventListener('click', function() {\n    socket.emit('sendMessage', {\n        'message': message.value,\n        'username': username.value\n    })\n})\n\nsocket.on('broadcastMessage', function(data) {\n    output.innerHTML += '<p><strong>' + data.username + ': </strong>' + data.message + '</p>'\n})\n")),(0,r.kt)("p",null,"The Express server then has to broadcast those values to every chat client:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'upgradedServer.on("connection", function (socket) {\n  socket.on("sendMessage", function (data) {\n    upgradedServer.emit("broadcastMessage", data);\n  });\n\n  console.log("INFO :: Websocket connection established :: ", socket.id);\n});\n')),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"WebRTC Introduction",src:n(97595).Z,width:"961",height:"724"})))}u.isMDXComponent=!0},38202:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-e38404fdf0e14587f660e537829bfab5.jpg"},97595:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/websockets-intro_01-51264c407fe7c7ed81b705fd2b35d6c1.png"}}]);