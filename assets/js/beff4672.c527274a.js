"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[86380],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>m});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var i=a.createContext({}),c=function(e){var n=a.useContext(i),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=c(e.components);return a.createElement(i.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,i=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(t),m=r,k=d["".concat(i,".").concat(m)]||d[m]||p[m]||l;return t?a.createElement(k,o(o({ref:n},u),{},{components:t})):a.createElement(k,o({ref:n},u))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,o=new Array(l);o[0]=d;var s={};for(var i in n)hasOwnProperty.call(n,i)&&(s[i]=n[i]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<l;c++)o[c]=t[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},14754:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>c});var a=t(87462),r=(t(67294),t(3905));const l={sidebar_position:6060,slug:"2021-10-11",title:"Hashicorp Consul in Production",authors:"mpolinowski",tags:["Consul"]},o=void 0,s={unversionedId:"DevOps/Hashicorp/2021-10-11--hashicorp-consul-in-production/index",id:"DevOps/Hashicorp/2021-10-11--hashicorp-consul-in-production/index",title:"Hashicorp Consul in Production",description:"Shenzhen, China",source:"@site/docs/DevOps/Hashicorp/2021-10-11--hashicorp-consul-in-production/index.md",sourceDirName:"DevOps/Hashicorp/2021-10-11--hashicorp-consul-in-production",slug:"/DevOps/Hashicorp/2021-10-11--hashicorp-consul-in-production/2021-10-11",permalink:"/docs/DevOps/Hashicorp/2021-10-11--hashicorp-consul-in-production/2021-10-11",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-10-11--hashicorp-consul-in-production/index.md",tags:[{label:"Consul",permalink:"/docs/tags/consul"}],version:"current",sidebarPosition:6060,frontMatter:{sidebar_position:6060,slug:"2021-10-11",title:"Hashicorp Consul in Production",authors:"mpolinowski",tags:["Consul"]},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Nomad Refresher",permalink:"/docs/DevOps/Hashicorp/2022-05-15-hashicorp-nomad-refresher/2022-05-15"},next:{title:"Hashicorp Nomad in Production",permalink:"/docs/DevOps/Hashicorp/2021-10-10--hashicorp-nomad-in-production/2021-10-10"}},i={},c=[{value:"Installation",id:"installation",level:2},{value:"Security Credentials",id:"security-credentials",level:2},{value:"Gossip Encryption Key",id:"gossip-encryption-key",level:3},{value:"Generate TLS certificates for RPC encryption",id:"generate-tls-certificates-for-rpc-encryption",level:3},{value:"Configure Consul",id:"configure-consul",level:2},{value:"Masters",id:"masters",level:3},{value:"Minions",id:"minions",level:3},{value:"Ports",id:"ports",level:2},{value:"Run as a Service",id:"run-as-a-service",level:2},{value:"Setup Consul environment variables",id:"setup-consul-environment-variables",level:2},{value:"Enable Consul ACLs",id:"enable-consul-acls",level:2},{value:"Consul UI",id:"consul-ui",level:2}],u={toc:c};function p(e){let{components:n,...l}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,l,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Shenzhen, China",src:t(35328).Z,width:"1500",height:"355"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#installation"},"Installation")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#security-credentials"},"Security Credentials"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#gossip-encryption-key"},"Gossip Encryption Key")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#generate-tls-certificates-for-rpc-encryption"},"Generate TLS certificates for RPC encryption")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#configure-consul"},"Configure Consul"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#masters"},"Masters")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#minions"},"Minions")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#ports"},"Ports")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#run-as-a-service"},"Run as a Service")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#setup-consul-environment-variables"},"Setup Consul environment variables")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#enable-consul-acls"},"Enable Consul ACLs")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#consul-ui"},"Consul UI"))),(0,r.kt)("h2",{id:"installation"},"Installation"),(0,r.kt)("p",null,"To install the precompiled binary, ",(0,r.kt)("a",{parentName:"p",href:"https://www.consul.io/downloads"},"download the appropriate package")," for your system."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"wget https://releases.hashicorp.com/consul/1.10.3/consul_1.10.3_linux_amd64.zip\nwget https://releases.hashicorp.com/consul/1.10.3/consul_1.10.3_SHA256SUMS\n")),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"SHA256SUMS")," shows me the corresponding check sum for this file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"50afd45daaffd3af5ab67b03ff616117eca9961014ca0ef25ed2aaa27a7be698  consul_1.10.3_linux_amd64.zip\n")),(0,r.kt)("p",null,"The following command has to give you the same sum - if you downloaded the correct version of the file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sha256sum consul_1.10.3_linux_amd64.zip\n50afd45daaffd3af5ab67b03ff616117eca9961014ca0ef25ed2aaa27a7be698  consul_1.10.3_linux_amd64.zip\n")),(0,r.kt)("p",null,"Now that we know that the zip container has not been tempered with we can unzip it to a place that is in our system PATH:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"echo $PATH\n\n/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"unzip ./consul_1.10.3_linux_amd64.zip\nrm ./consul_1.10.3_linux_amd64.zip\nmv consul /usr/bin/consul\n")),(0,r.kt)("p",null,"Verify that it is working:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"consul -v\nConsul v1.10.3\nRevision c976ffd2d\n")),(0,r.kt)("p",null,"The consul command features opt-in autocompletion for flags, subcommands, and arguments (where supported). Enable autocompletion:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"consul -autocomplete-install\ncomplete -C /usr/bin/consul consul\n")),(0,r.kt)("p",null,"Create a unique, non-privileged system user to run Consul and create its data directory:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"useradd --system --home /etc/consul.d --shell /bin/false consul\nmkdir --parents /opt/consul\nchown --recursive consul:consul /opt/consul\n")),(0,r.kt)("h2",{id:"security-credentials"},"Security Credentials"),(0,r.kt)("h3",{id:"gossip-encryption-key"},"Gossip Encryption Key"),(0,r.kt)("p",null,"Gossip is encrypted with a symmetric key, since gossip between nodes is done over UDP. All agents must have the same encryption key. You can create the encryption key via the Consul CLI even though no Consul agents are running yet. Generate the encryption key:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"consul keygen\nqDOPBEr+/oUVeOFQOnVypxwDaHzLrD+lvjo5vCEBbZ0=\n")),(0,r.kt)("p",null,"You will need to add the newly generated key to the encrypt option in the server configuration on all Consul agents. Save your key in a safe location. You will need to reference the key throughout the installation."),(0,r.kt)("h3",{id:"generate-tls-certificates-for-rpc-encryption"},"Generate TLS certificates for RPC encryption"),(0,r.kt)("p",null,"Start by creating the CA on your admin instance, using the Consul CLI:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /opt/consul/certs\ncd /opt/consul/certs\nconsul tls ca create\n")),(0,r.kt)("p",null,"Next create a set of certificates, one for each Consul agent. You will need to select a name for your primary datacenter now, so that the certificates are named properly. First, for your Consul servers, use the following command to create a certificate for each server:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"consul tls cert create -server -dc my_dc\n")),(0,r.kt)("p",null,"Use the following command with the -client flag to create client certificates. The file name increments automatically:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"consul tls cert create -client -dc my_dc\n")),(0,r.kt)("p",null,"Now we need to copy the certificates to all master (server) and minion (client) servers into the ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/consul.d/")," directory:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /etc/consul.d\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Masters")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"consul-agent-ca.pem")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"my_dc-server-consul-0-key.pem")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"my_dc-server-consul-0.pem"))),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Minions")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"consul-agent-ca.pem")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"my_dc-client-consul-0-key.pem")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"my_dc-client-consul-0.pem"))),(0,r.kt)("h2",{id:"configure-consul"},"Configure Consul"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"touch /etc/consul.d/consul.hcl\nchown --recursive consul:consul /etc/consul.d\nchmod 640 /etc/consul.d/consul.hcl\nnano /etc/consul.d/consul.hcl\n")),(0,r.kt)("h3",{id:"masters"},"Masters"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"/etc/consul.d/consul.hcl")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'datacenter = "my_dc"\nnode_name = "consul-server"\nclient_addr = "0.0.0.0"\nbind_addr = "172.217.160.110"\nadvertise_addr = "172.217.160.110"\nserver    = true\nbootstrap = true\nui_config {\n  enabled = true\n}\ndata_dir   = "/opt/consul"\nlog_level  = "INFO"\naddresses {\n  http = "0.0.0.0"\n}\nports {\n  https = 8501\n}\nconnect {\n  enabled = true\n}\nkey_file = "/etc/consul.d/my_dc-server-consul-0-key.pem"\ncert_file = "/etc/consul.d/my_dc-server-consul-0.pem"\nca_file = "/etc/consul.d/consul-agent-ca.pem"\nencrypt = "qDOPBEr+/oUVeOFQOnVypxwDaHzLrD+lvjo5vCEBbZ0="\nverify_incoming = true\nverify_outgoing = true\nverify_server_hostname = true\nretry_join = ["157.240.7.35"]\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"WARNING")," The ",(0,r.kt)("inlineCode",{parentName:"p"},"join")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"retry_join")," is a required parameter for the systemd process to complete successfully and send its notify signal on LAN join.")),(0,r.kt)("h3",{id:"minions"},"Minions"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"/etc/consul.d/consul.hcl")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'datacenter = "my_dc"\nnode_name = "consul-minion"\nbind_addr = "157.240.7.35"\nadvertise_addr = "157.240.7.35"\nserver    = false\nui_config {\n  enabled = false\n}\ndata_dir   = "/opt/consul"\nlog_level  = "INFO"\naddresses {\n  http = "0.0.0.0"\n}\nports {\n  https = 8501\n}\nconnect {\n  enabled = true\n}\nkey_file = "/etc/consul.d/my_dc-client-consul-0-key.pem"\ncert_file = "/etc/consul.d/my_dc-client-consul-0.pem"\nca_file = "/etc/consul.d/consul-agent-ca.pem"\nencrypt = "qDOPBEr+/oUVeOFQOnVypxwDaHzLrD+lvjo5vCEBbZ0="\nverify_incoming = true\nverify_outgoing = true\nverify_server_hostname = true\n')),(0,r.kt)("h2",{id:"ports"},"Ports"),(0,r.kt)("p",null,"Consul requires up to 6 different ports to work properly, some on TCP, UDP, or both protocols. Below we document the requirements for each port:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Use"),(0,r.kt)("th",{parentName:"tr",align:null},"Default Ports"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"DNS: The DNS server (TCP and UDP)"),(0,r.kt)("td",{parentName:"tr",align:null},"8600")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"HTTP: The HTTP API (TCP Only)"),(0,r.kt)("td",{parentName:"tr",align:null},"8500")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"HTTPS: The HTTPs API"),(0,r.kt)("td",{parentName:"tr",align:null},"disabled (8501)","*")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"gRPC: The gRPC API"),(0,r.kt)("td",{parentName:"tr",align:null},"disabled (8502)","*")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"LAN Serf: The Serf LAN port (TCP and UDP)"),(0,r.kt)("td",{parentName:"tr",align:null},"8301")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Wan Serf: The Serf WAN port (TCP and UDP)"),(0,r.kt)("td",{parentName:"tr",align:null},"8302")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"server: Server RPC address (TCP Only)"),(0,r.kt)("td",{parentName:"tr",align:null},"8300")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Sidecar Proxy Min: Inclusive min port number to use for automatically assigned sidecar service registrations."),(0,r.kt)("td",{parentName:"tr",align:null},"21000")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Sidecar Proxy Max: Inclusive max port number to use for automatically assigned sidecar service registrations."),(0,r.kt)("td",{parentName:"tr",align:null},"21255")))),(0,r.kt)("p",null,"*","For HTTPS and gRPC the ports specified in the table are recommendations."),(0,r.kt)("p",null,"Those ports are used for:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"DNS Interface")," Used to resolve DNS queries."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"HTTP API")," This is used by clients to talk to the HTTP API."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"HTTPS API (Optional)")," Is off by default, but port 8501 is a convention used by various tools as the default."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"gRPC API (Optional)")," Currently gRPC is only used to expose the xDS API to Envoy proxies. It is off by default, but port 8502 is a convention used by various tools as the default. Defaults to 8502 in -dev mode."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Serf LAN")," This is used to handle gossip in the LAN. Required by all agents."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Serf WAN")," This is used by servers to gossip over the WAN, to other servers. As of Consul 0.8 the WAN join flooding feature requires the Serf WAN port (TCP/UDP) to be listening on both WAN and LAN interfaces."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Server RPC")," This is used by servers to handle incoming requests from other agents.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --permanent --zone=public --add-port=8301/tcp --add-port=8301/udp --add-port=8302/tcp --add-port=8302/udp\nfirewall-cmd --reload\nfirewall-cmd --zone=public --list-all\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ufw allow 8301\nufw allow 8302\nufw reload\nufw status\n")),(0,r.kt)("h2",{id:"run-as-a-service"},"Run as a Service"),(0,r.kt)("p",null,"Create a Consul service file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nano /usr/lib/systemd/system/consul.service\n")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"or ",(0,r.kt)("inlineCode",{parentName:"em"},"/usr/lib/systemd/user/consul.service"))),(0,r.kt)("p",null,"Add this configuration to the Consul service file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'[Unit]\nDescription="HashiCorp Consul"\nDocumentation=https://www.consul.io/\nRequires=network-online.target\nAfter=network-online.target\nConditionFileNotEmpty=/etc/consul.d/consul.hcl\n\n[Service]\nType=notify\nUser=consul\nGroup=consul\nExecStart=/usr/bin/consul agent -config-dir=/etc/consul.d/\nExecReload=/bin/kill --signal HUP $MAINPID\nKillMode=process\nKillSignal=SIGTERM\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\n')),(0,r.kt)("p",null,"Check that your configuration file is valid, with the Consul CLI validate command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"consul validate /etc/consul.d/consul.hcl\n\nbootstrap = true: do not enable unless necessary\nConfiguration is valid!\n")),(0,r.kt)("p",null,"Enable and start Consul using the systemctl command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable --now  consul\nservice consul status\n")),(0,r.kt)("h2",{id:"setup-consul-environment-variables"},"Setup Consul environment variables"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Masters")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"export CONSUL_CACERT=/etc/consul.d/consul-agent-ca.pem\nexport CONSUL_CLIENT_CERT=/etc/consul.d/my_dc-server-consul-0.pem\nexport CONSUL_CLIENT_KEY=/etc/consul.d/my_dc-server-consul-0-key.pem\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Minions")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"export CONSUL_CACERT=/etc/consul.d/consul-agent-ca.pem\nexport CONSUL_CLIENT_CERT=/etc/consul.d/my_dc-client-consul-0.pem\nexport CONSUL_CLIENT_KEY=/etc/consul.d/my_dc-client-consul-0-key.pem\n")),(0,r.kt)("h2",{id:"enable-consul-acls"},"Enable Consul ACLs"),(0,r.kt)("p",null,'Add the ACL configuration to the consul.hcl configuration file and choose a default policy of "allow" (allow all traffic unless explicitly denied) or "deny" (deny all traffic unless explicitly allowed).'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'acl = {\n  enabled = true\n  default_policy = "allow"\n  enable_token_persistence = true\n}\nperformance {\n  raft_multiplier = 1\n}\n')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"raft_multiplier")," - An integer multiplier used by Consul servers to scale key Raft timing parameters. Setting this to a value of 1 will configure Raft to its highest-performance mode, equivalent to the default timing of Consul prior to 0.7, and is recommended for production Consul servers.")),(0,r.kt)("p",null,"Generate the bootstrap token from your master server:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"consul acl bootstrap\n")),(0,r.kt)("p",null,"This will return the Consul bootstrap token. You will need the SecretID for all subsequent Consul API requests (including CLI and UI). Ensure that you save the SecretID."),(0,r.kt)("p",null,"Set ",(0,r.kt)("strong",{parentName:"p"},"CONSUL_MGMT_TOKEN")," env variable:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'export CONSUL_HTTP_TOKEN="<Token SecretID from previous step>"\nexport CONSUL_MGMT_TOKEN="<Token SecretID from previous step>"\n')),(0,r.kt)("p",null,"Create a node policy file with write access for nodes related actions and read access for service related actions:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /etc/consul.d/policies\nnano /etc/consul.d/policies/node-policy.hcl\n")),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"node-policy.hcl")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'agent_prefix "" {\n  policy = "write"\n}\nnode_prefix "" {\n  policy = "write"\n}\nservice_prefix "" {\n  policy = "read"\n}\nsession_prefix "" {\n  policy = "read"\n}\n')),(0,r.kt)("p",null,"Generate the Consul node ACL policy with the newly created policy file:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cd /etc/consul.d/policies\n\nconsul acl policy create \\\n  -token=${CONSUL_MGMT_TOKEN} \\\n  -name node-policy \\\n  -rules @node-policy.hcl\n\nID:           secret\nName:         node-policy\nDescription:\nDatacenters:\nRules:\nagent_prefix "" {\n  policy = "write"\n}\nnode_prefix "" {\n  policy = "write"\n}\nservice_prefix "" {\n  policy = "read"\n}\nsession_prefix "" {\n  policy = "read"\n}\n')),(0,r.kt)("p",null,"Create the node token with the newly created policy:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'consul acl token create \\\n  -token=${CONSUL_MGMT_TOKEN} \\\n  -description "node token" \\\n  -policy-name node-policy\n\nAccessorID:       secret\nSecretID:         secret\nDescription:      node token\nLocal:            false\nCreate Time:      2021-10-25 07:28:39.420612336 +0200 CEST\nPolicies:\n   secret - node-policy\n')),(0,r.kt)("p",null,"On all Consul Servers add the node token."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'consul acl set-agent-token \\\n  -token="<Management Token SecretID>" \\\n  agent "<Node Token SecretID>"\n\nACL token "agent" set successfully\n')),(0,r.kt)("h2",{id:"consul-ui"},"Consul UI"),(0,r.kt)("p",null,"I did not forward the HTTP port, but I can still test the Nomad UI by tunnelling the user interface through SSH onto your local server:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ssh myuser@my-server-ip -p ssh-port -L8500:localhost:8500\n")),(0,r.kt)("p",null,"Access the ",(0,r.kt)("strong",{parentName:"p"},"Nodes")," tab and you should see both the Master and Minion server connected:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"http://localhost:8500/ui/my_dc/nodes\n")))}p.isMDXComponent=!0},35328:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-886bf7aab4c3160277fc1a129600b944.jpg"}}]);