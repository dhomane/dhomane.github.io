"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[48350],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>k});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(n),k=r,m=u["".concat(l,".").concat(k)]||u[k]||c[k]||o;return n?a.createElement(m,i(i({ref:t},d),{},{components:n})):a.createElement(m,i({ref:t},d))}));function k(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},92591:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const o={sidebar_position:8070,slug:"2021-05-02",title:"Ansible Tower Practical Examples",authors:"mpolinowski",tags:["LINUX"]},i=void 0,s={unversionedId:"DevOps/Ansible/2021-05-02-ansible-tower-examples/index",id:"DevOps/Ansible/2021-05-02-ansible-tower-examples/index",title:"Ansible Tower Practical Examples",description:"Guangzhou, China",source:"@site/docs/DevOps/Ansible/2021-05-02-ansible-tower-examples/index.md",sourceDirName:"DevOps/Ansible/2021-05-02-ansible-tower-examples",slug:"/DevOps/Ansible/2021-05-02-ansible-tower-examples/2021-05-02",permalink:"/docs/DevOps/Ansible/2021-05-02-ansible-tower-examples/2021-05-02",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Ansible/2021-05-02-ansible-tower-examples/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:8070,frontMatter:{sidebar_position:8070,slug:"2021-05-02",title:"Ansible Tower Practical Examples",authors:"mpolinowski",tags:["LINUX"]},sidebar:"tutorialSidebar",previous:{title:"Ansible",permalink:"/docs/category/ansible"},next:{title:"Ansible Tower Workflow Templates",permalink:"/docs/DevOps/Ansible/2021-05-01-ansible-tower-workflow-templates/2021-05-01"}},l={},p=[{value:"Updating a Discourse Forum",id:"updating-a-discourse-forum",level:2},{value:"Create an Inventory",id:"create-an-inventory",level:3},{value:"Adding Server Credentials",id:"adding-server-credentials",level:3},{value:"Adding the Project",id:"adding-the-project",level:3},{value:"Adding the Job Template",id:"adding-the-job-template",level:3},{value:"Adding a Workflow",id:"adding-a-workflow",level:3},{value:"Working with Docker Container",id:"working-with-docker-container",level:2},{value:"Installing Docker",id:"installing-docker",level:3},{value:"Running Containers",id:"running-containers",level:3},{value:"Setup Certbot",id:"setup-certbot",level:2},{value:"Setting Up Elasticsearch",id:"setting-up-elasticsearch",level:2},{value:"Installation",id:"installation",level:3},{value:"Cert Renewal",id:"cert-renewal",level:3},{value:"Adding a server to Zabbix Monitor",id:"adding-a-server-to-zabbix-monitor",level:2}],d={toc:p};function c(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Guangzhou, China",src:n(18484).Z,width:"1500",height:"598"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#updating-a-discourse-forum"},"Updating a Discourse Forum"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#create-an-inventory"},"Create an Inventory")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#adding-server-credentials"},"Adding Server Credentials")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#adding-the-project"},"Adding the Project")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#adding-the-job-template"},"Adding the Job Template")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#adding-a-workflow"},"Adding a Workflow")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#working-with-docker-container"},"Working with Docker Container"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#installing-docker"},"Installing Docker")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#running-containers"},"Running Containers")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#setup-certbot"},"Setup Certbot")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#setting-up-elasticsearch"},"Setting Up Elasticsearch"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#installation"},"Installation")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#cert-renewal"},"Cert Renewal")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#adding-a-server-to-zabbix-monitor"},"Adding a server to Zabbix Monitor"))),(0,r.kt)("p",null,"I now set up Ansible Tower and want to integrate it into my CI Pipelines. Here are a couple of Tasks that I previously started by SSH'ing into those servers or by manually starting Ansible Plays. Let's see how I can add them to the Tower UI."),(0,r.kt)("h2",{id:"updating-a-discourse-forum"},"Updating a Discourse Forum"),(0,r.kt)("p",null,"To update our Forum I have to:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"login to the respective server"),(0,r.kt)("li",{parentName:"ol"},"change to the directory that holds the source code"),(0,r.kt)("li",{parentName:"ol"},"git pull the latest updates"),(0,r.kt)("li",{parentName:"ol"},"rebuild the app using the Discourse CLI")),(0,r.kt)("p",null,"Let's automate this!"),(0,r.kt)("h3",{id:"create-an-inventory"},"Create an Inventory"),(0,r.kt)("p",null,"In the Tower UI click on ",(0,r.kt)("strong",{parentName:"p"},"Resources")," / ",(0,r.kt)("strong",{parentName:"p"},"Inventories")," and switch to the ",(0,r.kt)("strong",{parentName:"p"},"Hosts")," tab. Click on ",(0,r.kt)("strong",{parentName:"p"},"Add")," and add your Server IP address and SSH port:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"---\nansible_host: 112.11.1.221\nansible_port: 12345\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(58631).Z,width:"1289",height:"688"})),(0,r.kt)("p",null,"Save the ",(0,r.kt)("strong",{parentName:"p"},"Host")," and ",(0,r.kt)("strong",{parentName:"p"},"Inventory"),"."),(0,r.kt)("h3",{id:"adding-server-credentials"},"Adding Server Credentials"),(0,r.kt)("p",null,"In the Tower UI click on ",(0,r.kt)("strong",{parentName:"p"},"Resources")," / ",(0,r.kt)("strong",{parentName:"p"},"Credentials")," and click on ",(0,r.kt)("strong",{parentName:"p"},"Add"),". Choose ",(0,r.kt)("strong",{parentName:"p"},"Machine")," as credential type and add your server SSH username and password:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(3341).Z,width:"1274",height:"557"})),(0,r.kt)("p",null,"Save your settings."),(0,r.kt)("h3",{id:"adding-the-project"},"Adding the Project"),(0,r.kt)("p",null,"Before actually adding the Project we need a second ",(0,r.kt)("strong",{parentName:"p"},"Credential")," that allows us to download the Ansible Playbook from a private Gitlab server. For this, create a user in Gitlab (or on Github, in Subversion, etc.) that has access to the repositories you want to use. Back in the Tower UI ",(0,r.kt)("strong",{parentName:"p"},"Resources")," / ",(0,r.kt)("strong",{parentName:"p"},"Credentials")," and click on ",(0,r.kt)("strong",{parentName:"p"},"Add"),". This time choose ",(0,r.kt)("strong",{parentName:"p"},"Source Control")," as ",(0,r.kt)("strong",{parentName:"p"},"Credential Type")," and add your Gitlab username and password:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(40601).Z,width:"1273",height:"778"})),(0,r.kt)("p",null,"Make sure to ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Ansible/2021-04-29-ansible-tower-setup/2021-04-29#creating-a-githubgitlab-scm-project"},"add your SSH Key")," in the field at the bottom of the form!"),(0,r.kt)("p",null,"Save your settings and switch to the ",(0,r.kt)("strong",{parentName:"p"},"Resources")," / ",(0,r.kt)("strong",{parentName:"p"},"Projects")," menu. Click on ",(0,r.kt)("strong",{parentName:"p"},"Add")," to add your project:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(53911).Z,width:"1269",height:"654"})),(0,r.kt)("p",null,"Choose your ",(0,r.kt)("strong",{parentName:"p"},"Source Control Credential Type")," - for Gitlab that is ",(0,r.kt)("strong",{parentName:"p"},"Git")," - and add the HTTPS URL to the repository that holds your Ansibel Playbook. To be able to clone the repository add the Gitlab user you just created, as ",(0,r.kt)("strong",{parentName:"p"},"Source Control Credential"),"."),(0,r.kt)("p",null,"The repository holds a single file:"),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"forumDE_rebuild_discourse.yml")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"---\n- hosts: ForumDE-Discourse\n  gather_facts: no\n\n  vars:\n    ansible_python_interpreter: /bin/python3\n\n  tasks:\n  \n  - name: Pull latest Release & Update the Discourse Forum\n    ansible.builtin.shell:\n      cmd: git pull && ./launcher rebuild app\n      chdir: /opt/discourse/\n\n")),(0,r.kt)("p",null,"This play does everything I listed as requirement above."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"Note"),": I ran into a couple of issues with Ansible refusing to run on my minion server. The solution was to make Python3 the default version of Python on my minion and adding the path to the Python3 binary to my play.")),(0,r.kt)("p",null,"Save the project and back on the Projects overview page click click on ",(0,r.kt)("strong",{parentName:"p"},"Sync")," to have Ansible Tower download your Playbook from Gitlab."),(0,r.kt)("h3",{id:"adding-the-job-template"},"Adding the Job Template"),(0,r.kt)("p",null,"Go to ",(0,r.kt)("strong",{parentName:"p"},"Resources")," / ",(0,r.kt)("strong",{parentName:"p"},"Template")," and click on ",(0,r.kt)("strong",{parentName:"p"},"Add")," to add a ",(0,r.kt)("strong",{parentName:"p"},"Job")," template. Now here everything we did before comes to together:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Add your Inventory"),(0,r.kt)("li",{parentName:"ol"},"Add your Project"),(0,r.kt)("li",{parentName:"ol"},"Choose the Play (Ansible Tower will list all the valid plays that it can find in your Playbook)"),(0,r.kt)("li",{parentName:"ol"},"Add your Server Credentials")),(0,r.kt)("p",null,"As job type I choose ",(0,r.kt)("strong",{parentName:"p"},"Check")," and ticked ",(0,r.kt)("strong",{parentName:"p"},"Prompt on Launch"),". This way I can first do a dry run and on the second go choose ",(0,r.kt)("strong",{parentName:"p"},"Run")," instead. And while we are at it - save your settings and go back to ",(0,r.kt)("strong",{parentName:"p"},"Templates"),". Your Job will be listed here. Click on launch and choose to either ",(0,r.kt)("em",{parentName:"p"},"dry run")," or ",(0,r.kt)("em",{parentName:"p"},"run"),". See if everything is working."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(79898).Z,width:"1267",height:"591"})),(0,r.kt)("h3",{id:"adding-a-workflow"},"Adding a Workflow"),(0,r.kt)("p",null,"Now I am ready to wrap things up into a workflow - this works just like a ",(0,r.kt)("strong",{parentName:"p"},"Job Template")," but allows you to connect a bunch of jobs into a chain of nodes with some ",(0,r.kt)("inlineCode",{parentName:"p"},"if-this-then-that")," logic - if you wish."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(71274).Z,width:"1260",height:"521"})),(0,r.kt)("p",null,"Go to ",(0,r.kt)("strong",{parentName:"p"},"Resources")," / ",(0,r.kt)("strong",{parentName:"p"},"Template")," and click on ",(0,r.kt)("strong",{parentName:"p"},"Add")," to add a ",(0,r.kt)("strong",{parentName:"p"},"Workflow")," template. Just add the ",(0,r.kt)("strong",{parentName:"p"},"Inventory")," you are working from and hit ",(0,r.kt)("strong",{parentName:"p"},"Save"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(35502).Z,width:"1284",height:"284"})),(0,r.kt)("p",null,"This now opens the ",(0,r.kt)("strong",{parentName:"p"},"Visualizer")," where I am going to add two nodes:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Update the Playbook we are working with"),(0,r.kt)("li",{parentName:"ol"},"Run the Ansible Play")),(0,r.kt)("p",null,"For the first choose ",(0,r.kt)("strong",{parentName:"p"},"Project Sync")," and choose the project from the list below. This will make sure that we are always using the latest playbook that was committed to the repository: "),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(20925).Z,width:"1106",height:"512"})),(0,r.kt)("p",null,"And the second is a ",(0,r.kt)("strong",{parentName:"p"},"Job Template")," node where you have to select the job we created:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(38182).Z,width:"1091",height:"310"})),(0,r.kt)("h2",{id:"working-with-docker-container"},"Working with Docker Container"),(0,r.kt)("h3",{id:"installing-docker"},"Installing Docker"),(0,r.kt)("p",null,"Now without so much details - the steps are identical to the example above. To work with Docker on our host we first have to make sure that Docker is set up. I am doing this using ",(0,r.kt)("strong",{parentName:"p"},"Ansible Roles"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"- hosts: Wiki_Virtual\n  gather_facts: yes\n\n  vars:\n    ansible_python_interpreter: /bin/python3\n    pip_install_packages:\n      - name: docker\n      - name: setuptools\n      - name: docker-compose\n\n  roles:\n    - geerlingguy.pip\n    - geerlingguy.docker\n")),(0,r.kt)("p",null,"To be able to use roles create a ",(0,r.kt)("strong",{parentName:"p"},"roles")," folder in your Playbook repository and add the folders inside for your roles - e.g. :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"- roles\n  - geerlingguy.pip\n  - geerlingguy.docker\n- install-docker-playbook.yml\n")),(0,r.kt)("p",null,"And ",(0,r.kt)("inlineCode",{parentName:"p"},"git clone")," the source code of those roles into their corresponding folders:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/geerlingguy/ansible-role-pip"},"ansible-role-pip")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://github.com/geerlingguy/ansible-role-docker"},"ansible-role-docker"))),(0,r.kt)("p",null,"When you now run ",(0,r.kt)("inlineCode",{parentName:"p"},"install-docker-playbook.yml")," those roles will be found by Ansible. Now go to the steps above until you have a job template that uses this playbook. Run the playbook in Ansible Tower to install Docker and Docker-Compose on your minion server."),(0,r.kt)("h3",{id:"running-containers"},"Running Containers"),(0,r.kt)("p",null,"I now want to add my Docker App to an existing Docker Cluster - ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/NGINX/2021-02-22-nginx-docker-ingress/2021-02-22"},"as described in an earlier Tutorial")),(0,r.kt)("p",null,"The playbook downloads the latest Version of the Docker image, kills the running container (in case that we are updating our app) and then spawns a new container based on the latest image:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'---\n- hosts: Wiki_Virtual\n  gather_facts: no\n\n  vars:\n    ansible_python_interpreter: /bin/python3\n\n  tasks:\n\n    - name: Include vault for registry login\n      include_vars:\n        file: vault.yml\n\n    - name: Log into Docker Registry and force re-authorization\n      docker_login:\n        registry: my.gitlab.com\n        username: "{{ username }}"\n        password: "{{ password }}"\n        reauthorize: yes\n\n    - name: Download the latest Wiki build images\n      shell: docker pull my.gitlab.com:12345/wiki/{{ item }}\n      with_items:\n        - wiki_en_mdx\n  \n    - name: Remove the EN Wiki Container\n      docker_container:\n        name: wiki_en\n        state: absent\n  \n    - name: Rebuild the EN Wiki Container\n      docker_container:\n        name: wiki_en\n        image: my.gitlab.com:12345/wiki/wiki_en_mdx\n        state: started\n        restart_policy: unless-stopped\n        networks:\n          - name: wikinet\n        networks_cli_compatible: yes\n\n')),(0,r.kt)("p",null,"The new part here is the use of an ",(0,r.kt)("strong",{parentName:"p"},"Ansible Vault")," to get our Docker Registry login. I ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Ansible/2020-11-21--ansible-modules-and-roles/2020-11-21#ansible-vault"},"already showed how to create this vault"),". Add your username and password there and add the vault to your Playbook repository."),(0,r.kt)("p",null,"We now need to add the ",(0,r.kt)("strong",{parentName:"p"},"Vault Credentials")," to Ansible Tower. For this create a new ",(0,r.kt)("strong",{parentName:"p"},"Credential"),", choose ",(0,r.kt)("strong",{parentName:"p"},"Credential Type")," ",(0,r.kt)("strong",{parentName:"p"},"Vault")," and add your vault password."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(5956).Z,width:"1287",height:"565"})),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"Job Template")," that uses this Playbook now needs two credentials - the minion SSH login and the vault password. Otherwise, it is identical to the example earlier:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Ansible Tower Practical Examples",src:n(86728).Z,width:"1272",height:"590"})),(0,r.kt)("p",null,"Test run the job. Then create the workflow. Just as before."),(0,r.kt)("h2",{id:"setup-certbot"},"Setup Certbot"),(0,r.kt)("p",null,"This is pretty much the same as setting up Docker using a ready-made Ansible role (s. above):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"---\n- hosts: Wiki_Virtual    \n\n  vars:\n    ansible_python_interpreter: /bin/python3\n    certbot_admin_email: m.polinowski@instar.com\n    certbot_create_if_missing: true\n    certbot_create_standalone_stop_services:\n      - docker\n    certbot_certs:\n      - domains:\n          - my.first.domain.com\n          - my.second.domain.com\n          - my.third.domain.com\n\n  roles:\n    - geerlingguy.certbot\n\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"Note"),": My NGINX Ingress runs inside a Docker container. That is why I need Certbot to restart the Docker process so that NGINX starts using the new certs after an update. Otherwise, just restart whatever service is using the certificate.")),(0,r.kt)("h2",{id:"setting-up-elasticsearch"},"Setting Up Elasticsearch"),(0,r.kt)("p",null,"I am using a ",(0,r.kt)("strong",{parentName:"p"},"Docker Compose")," ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Elasticsearch/2019-09-08--elasticsearch_7-5_docker/2019-09-08"},"file that I store on Gitlab to run Elasticsearch"),". Again I am using an ",(0,r.kt)("strong",{parentName:"p"},"Ansible Vault")," file to log in to Gitlab and pull the latest version of this file to ",(0,r.kt)("inlineCode",{parentName:"p"},"/opt/wiki_elk"),". After that I execute this file with Docker Compose:"),(0,r.kt)("h3",{id:"installation"},"Installation"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"---\n- hosts: Wiki_Virtual\n  gather_facts: no\n\n  vars:\n    ansible_python_interpreter: /bin/python3\n    \n  tasks:\n\n    - name: Include vault for registry login\n      include_vars:\n        file: vault.yml\n\n    - name: Get updated files from git repository \n      git: \n        repo: https://{{ username | urlencode }}:{{ password | urlencode }}@my.gitlab.com/wiki/wiki_elk.git\n        clone: yes\n        force: yes\n        update: yes\n        dest: /opt/wiki_elk\n\n    - name: Start the Elasticsearch services\n      docker_compose:\n        project_src: /opt/wiki_elk\n\n")),(0,r.kt)("h3",{id:"cert-renewal"},"Cert Renewal"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'---\n- hosts: Wiki_Virtual \n  gather_facts: no\n\n  vars:\n    ansible_python_interpreter: /bin/python3\n    \n  tasks:\n\n    - name: Run Certbot Renew and Restart Docker\n      shell: certbot renew --pre-hook "service docker stop" --post-hook "service docker start"\n')),(0,r.kt)("h2",{id:"adding-a-server-to-zabbix-monitor"},"Adding a server to Zabbix Monitor"),(0,r.kt)("p",null,"I am using the software ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Zabbix/2020-07-17--zabbix-website-monitor/2020-07-17#discourse-forum"},"Zabbix to Monitor my Servers"),". With the following script I am able to ",(0,r.kt)("a",{parentName:"p",href:"/docs/DevOps/Zabbix/2020-07-16--zabbix-agent/2020-07-16"},"setup the Zabbix Agent on my minion servers"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},'---\n- hosts: Wiki_Virtual\n  gather_facts: no\n\n  vars:\n    ansible_python_interpreter: /bin/python3\n\n  tasks:\n  \n    - name: Create directory for Zabbix Keyfile\n      file:\n        path: /opt/zabbix\n        state: directory\n        mode: \'0755\'\n\n    - name: Check if Zabbix Keyfile is already present\n      stat:\n        path: /opt/zabbix/agent_tls.psk\n      register: check_key_result\n\n    - name: Create Zabbix Keyfile\n      shell: openssl rand -hex 32 > agent_tls.psk\n      args:\n        chdir: /opt/zabbix/\n      when: not check_key_result.stat.exists\n        \n    - name: Read Zabbix Keyfile\n      shell: cat /opt/zabbix/agent_tls.psk\n      register: zabbix_key\n    \n    - name: Print Zabbix Keyfile\n      debug: var=zabbix_key\n\n    - name: Installing Zabbix Agent 2\n      docker_container:\n        name: zabbix-agent2\n        image: zabbix/zabbix-agent2:latest\n        pull: yes\n        restart: yes\n        networks:\n          - name: wikinet\n        networks_cli_compatible: yes\n        privileged: yes\n        state: started\n        restart_policy: unless-stopped\n        ports:\n          - "10050:10050"\n        volumes:\n          - /opt/zabbix:/var/lib/zabbix/enc\n        env:\n            ZBX_HOSTNAME: <Set a Name you want to use to add this Server to Zabbix>\n            ZBX_SERVER_HOST: <IP Address of the Zabbix Master Server>\n            ZBX_SERVER_PORT: <Set the Zabbix Active Server Port>\n            ZBX_TLSCONNECT: "psk"\n            ZBX_TLSACCEPT: "psk"\n            ZBX_TLSPSKIDENTITY: <Set a Name you want to use to add this Server to Zabbix>\n            ZBX_TLSPSKFILE: "agent_tls.psk"\n\n')))}c.isMDXComponent=!0},58631:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_01-227ccd2891b5920cd204afbe321506ec.png"},3341:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_02-ee7f3c240d40427b472e4472024c3ae1.png"},40601:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_03-3612a159ea43fb76363b9db4e40ba4f9.png"},53911:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_04-cee2c274e3f6e7df864176a3bac45e8e.png"},79898:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_05-dfe1133dd99e6cb6af9eb848348cd9ba.png"},71274:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_06-4513e5a964e41fa4399cfa018c3a1c51.png"},35502:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_07-dbb64553937e45d04f3ac4599af030c2.png"},20925:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_08-ead7e87a1657a9d243ec0b0444cfffde.png"},38182:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_09-a26e9d553cd8c23d33a45a236dc3e37e.png"},5956:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_10-e3301af6a22071b8f275e9d88fb2c0ac.png"},86728:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/Ansible_Tower_Workflows_11-92b243ec82ef4507c505ac36867cb9a5.png"},18484:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/photo-456tdsfggd_67gfh6dgdf4_d-c013cf2b1291840bc1143c6e5e73b4b0.jpg"}}]);