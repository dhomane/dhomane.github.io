"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[93002],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>d});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),c=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=c(n),d=a,k=m["".concat(l,".").concat(d)]||m[d]||p[d]||i;return n?o.createElement(k,r(r({ref:t},u),{},{components:n})):o.createElement(k,r({ref:t},u))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,r=new Array(i);r[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var c=2;c<i;c++)r[c]=n[c];return o.createElement.apply(null,r)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},54152:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var o=n(87462),a=(n(67294),n(3905));const i={sidebar_position:9e3,slug:"2022-02-01",title:"Mosquitto v2 MQTT Broker on Debian Bullseye",authors:"mpolinowski",tags:["LINUX","Smarthome","MQTT"]},r=void 0,s={unversionedId:"IoT-and-Machine-Learning/MQTT/2022-02-01--mosquitto-2-broker/index",id:"IoT-and-Machine-Learning/MQTT/2022-02-01--mosquitto-2-broker/index",title:"Mosquitto v2 MQTT Broker on Debian Bullseye",description:"TST, Hong Kong",source:"@site/docs/IoT-and-Machine-Learning/MQTT/2022-02-01--mosquitto-2-broker/index.md",sourceDirName:"IoT-and-Machine-Learning/MQTT/2022-02-01--mosquitto-2-broker",slug:"/IoT-and-Machine-Learning/MQTT/2022-02-01--mosquitto-2-broker/2022-02-01",permalink:"/docs/IoT-and-Machine-Learning/MQTT/2022-02-01--mosquitto-2-broker/2022-02-01",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/IoT-and-Machine-Learning/MQTT/2022-02-01--mosquitto-2-broker/index.md",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Smarthome",permalink:"/docs/tags/smarthome"},{label:"MQTT",permalink:"/docs/tags/mqtt"}],version:"current",sidebarPosition:9e3,frontMatter:{sidebar_position:9e3,slug:"2022-02-01",title:"Mosquitto v2 MQTT Broker on Debian Bullseye",authors:"mpolinowski",tags:["LINUX","Smarthome","MQTT"]},sidebar:"tutorialSidebar",previous:{title:"MQTT Clients",permalink:"/docs/IoT-and-Machine-Learning/MQTT/2022-03-26--mqtt-clients/2022-03-26"},next:{title:"Go Paho MQTT Client",permalink:"/docs/IoT-and-Machine-Learning/MQTT/2021-09-12--golang-paho-mqtt/2021-09-12"}},l={},c=[{value:"Install Mosquitto on Debian Bullseye",id:"install-mosquitto-on-debian-bullseye",level:2},{value:"Configure Mosquitto",id:"configure-mosquitto",level:2},{value:"Verify that the Broker is working",id:"verify-that-the-broker-is-working",level:2},{value:"Mosquitto CLI Tools",id:"mosquitto-cli-tools",level:3},{value:"Connecting Clients",id:"connecting-clients",level:3},{value:"Websockets",id:"websockets",level:2},{value:"MQTT Explorer",id:"mqtt-explorer",level:3},{value:"MQTT.js Web Client",id:"mqttjs-web-client",level:3},{value:"Mosquitto Webserver",id:"mosquitto-webserver",level:2},{value:"Adding Encryption",id:"adding-encryption",level:2},{value:"Creating Self-Signed Certificates",id:"creating-self-signed-certificates",level:3},{value:"CA Certificates",id:"ca-certificates",level:4},{value:"Server Certificates",id:"server-certificates",level:4},{value:"Mosquitto Server Configuration",id:"mosquitto-server-configuration",level:4},{value:"Testing the Connection",id:"testing-the-connection",level:4},{value:"Client Certificates",id:"client-certificates",level:4},{value:"Creating a client certificate",id:"creating-a-client-certificate",level:4},{value:"Update the Mosquitto Server Configuration",id:"update-the-mosquitto-server-configuration",level:4},{value:"Testing the Connection",id:"testing-the-connection-1",level:4},{value:"Connect your INSTAR IP Camera",id:"connect-your-instar-ip-camera",level:2}],u={toc:c};function p(e){let{components:t,...i}=e;return(0,a.kt)("wrapper",(0,o.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"TST, Hong Kong",src:n(56801).Z,width:"2385",height:"978"})),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#install-mosquitto-on-debian-bullseye"},"Install Mosquitto on Debian Bullseye")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#configure-mosquitto"},"Configure Mosquitto")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#verify-that-the-broker-is-working"},"Verify that the Broker is working"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#mosquitto-cli-tools"},"Mosquitto CLI Tools")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#connecting-clients"},"Connecting Clients")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#websockets"},"Websockets"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#mqtt-explorer"},"MQTT Explorer")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#mqttjs-web-client"},"MQTT.js Web Client")))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#mosquitto-webserver"},"Mosquitto Webserver")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#adding-encryption"},"Adding Encryption"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#creating-self-signed-certificates"},"Creating Self-Signed Certificates"),(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#ca-certificates"},"CA Certificates")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#server-certificates"},"Server Certificates")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#mosquitto-server-configuration"},"Mosquitto Server Configuration")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#testing-the-connection"},"Testing the Connection")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#client-certificates"},"Client Certificates")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#creating-a-client-certificate"},"Creating a client certificate")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#update-the-mosquitto-server-configuration"},"Update the Mosquitto Server Configuration")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#testing-the-connection-1"},"Testing the Connection")))))),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"#connect-your-instar-ip-camera"},"Connect your INSTAR IP Camera"))),(0,a.kt)("p",null,"Mosquitto is a message broker that implements the MQTT protocol. Mosquitto is an open-source project developed by Eclipse. MQTT protocol uses a publish/subscribe model. Client can publish message to a broker and other clients can subscribe to the topic of that message. A broker is a central component that receives all messages from the clients and then publishes the messages to all subscribed clients."),(0,a.kt)("h2",{id:"install-mosquitto-on-debian-bullseye"},"Install Mosquitto on Debian Bullseye"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Check ",(0,a.kt)("a",{parentName:"p",href:"/docs/IoT-and-Machine-Learning/MQTT/2022-03-27--build-mosquitto-from-source/2022-03-27"},"Building Eclipse Mosquitto v2 from Source")," for building the broker from it's source code under Arch Linux.")),(0,a.kt)("p",null,"Add the Mosquitto repository:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"wget http://repo.mosquitto.org/debian/mosquitto-repo.gpg.key\nsudo apt-key add mosquitto-repo.gpg.key\ncd /etc/apt/sources.list.d/\nwget http://repo.mosquitto.org/debian/mosquitto-bullseye.list\n")),(0,a.kt)("p",null,"Install Mosquitto broker:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"apt update\napt install mosquitto\n")),(0,a.kt)("p",null,"Check Mosquitto version:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mosquitto -h | grep version\nmosquitto version 2.0.14\n")),(0,a.kt)("p",null,"Check if Mosquitto service is running:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"service mosquitto status                                                                                              \n\u25cf mosquitto.service - Mosquitto MQTT Broker\n     Loaded: loaded (/lib/systemd/system/mosquitto.service; enabled; vendor preset: enabled)\n     Active: active (running) since Sat 2022-02-05 14:06:50 HKT; 25min ago\n       Docs: man:mosquitto.conf(5)\n             man:mosquitto(8)\n    Process: 574 ExecStartPre=/bin/mkdir -m 740 -p /var/log/mosquitto (code=exited, status=0/SUCCESS)\n    Process: 586 ExecStartPre=/bin/chown mosquitto /var/log/mosquitto (code=exited, status=0/SUCCESS)\n    Process: 593 ExecStartPre=/bin/mkdir -m 740 -p /run/mosquitto (code=exited, status=0/SUCCESS)\n    Process: 598 ExecStartPre=/bin/chown mosquitto /run/mosquitto (code=exited, status=0/SUCCESS)\n   Main PID: 599 (mosquitto)\n      Tasks: 1 (limit: 9357)\n     Memory: 3.6M\n        CPU: 1.184s\n     CGroup: /system.slice/mosquitto.service\n             \u2514\u2500599 /usr/sbin/mosquitto -c /etc/mosquitto/mosquitto.conf\n\nFeb 05 14:06:49 nomad-minion systemd[1]: Starting Mosquitto MQTT Broker...\nFeb 05 14:06:50 nomad-minion mosquitto[599]: 1644041210: Loading config file /etc/mosquitto/conf.d/custom.conf\nFeb 05 14:06:50 nomad-minion systemd[1]: Started Mosquitto MQTT Broker.\n")),(0,a.kt)("p",null,"Here I can see that the Mosquitto binary was installed in ",(0,a.kt)("inlineCode",{parentName:"p"},"/usr/sbin")," and it is being started with a default configuration file in ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/mosquitto/mosquitto.conf"),"."),(0,a.kt)("h2",{id:"configure-mosquitto"},"Configure Mosquitto"),(0,a.kt)("p",null,"Mosquitto installs 5 further tools that we can use with our broker:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"ls -la /usr/bin | grep mosquitto\n-rwxr-xr-x  1 root root        60448 Jun  9  2021 mosquitto_ctrl\n-rwxr-xr-x  1 root root        31456 Jun  9  2021 mosquitto_passwd\n-rwxr-xr-x  1 root root        60296 Jun  9  2021 mosquitto_pub\n-rwxr-xr-x  1 root root        64608 Jun  9  2021 mosquitto_rr\n-rwxr-xr-x  1 root root        64608 Jun  9  2021 mosquitto_sub\n")),(0,a.kt)("p",null,"Password file can be created using ",(0,a.kt)("inlineCode",{parentName:"p"},"mosquitto_passwd")," tool:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mosquitto_passwd -c /etc/mosquitto/password_file admin\nPassword: instar\nReenter password: instar\n")),(0,a.kt)("p",null,"First argument is path to a file, second argument is username. The ",(0,a.kt)("inlineCode",{parentName:"p"},"-c")," option means that new password file will be created. Run the following command and enter a password for the user."),(0,a.kt)("p",null,"Next, open Mosquitto configuration file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cat /etc/mosquitto/mosquitto.conf\n# Place your local configuration in /etc/mosquitto/conf.d/\n#\n# A full description of the configuration file is at\n# /usr/share/doc/mosquitto/examples/mosquitto.conf.example\n\npid_file /run/mosquitto/mosquitto.pid\n\npersistence true\npersistence_location /var/lib/mosquitto/\n\nlog_dest file /var/log/mosquitto/mosquitto.log\n\ninclude_dir /etc/mosquitto/conf.d\n")),(0,a.kt)("p",null,'Here I can see that the "actual" configuration file, the one that I need to edit, must be located in ',(0,a.kt)("inlineCode",{parentName:"p"},"/etc/mosquitto/conf.d"),". So let's take a look:"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"/etc/mosquitto/conf.d/custom.conf")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"# =================================================================\n# General configuration\n# =================================================================\n# per_listener_settings false\n# allow_zero_length_clientid true\nauto_id_prefix zeroid-\n# check_retain_source true\n#max_inflight_bytes 0\n#max_inflight_messages 20\n#max_keepalive 65535\n#max_packet_size 0\n#max_queued_bytes 0\n#max_qos 2\n#max_queued_messages 1000\n#memory_limit 0\n#message_size_limit 0\npersistent_client_expiration 7d\n# pid_file /var/run/mosquitto/mosquitto.pid\nqueue_qos0_messages true\n#retain_available true\n#set_tcp_nodelay false\n#sys_interval 10\n#upgrade_outgoing_qos false\n#user mosquitto\n# =================================================================\n# Listeners\n# =================================================================\nlistener 1883\nprotocol mqtt\nlistener 1885\nprotocol websockets\n#socket_domain\n#bind_interface\n#http_dir\n#max_connections -1\n#mount_point\n#use_username_as_clientid\n#websockets_headers_size\n# -----------------------------------------------------------------\n# Certificate based SSL/TLS support\n# -----------------------------------------------------------------\n#certfile\n#keyfile\n#ciphers\n#ciphers_tls1.3\n#crlfile\n#dhparamfile\n#require_certificate false\n#cafile\n#capath\n#use_identity_as_username false\n# -----------------------------------------------------------------\n# Pre-shared-key based SSL/TLS support\n# -----------------------------------------------------------------\n#psk_hint\n#ciphers\n#use_identity_as_username false\n# =================================================================\n# Persistence\n# =================================================================\n#autosave_interval 1800\n#autosave_on_changes false\n#persistence false\n#persistence_file mosquitto.db\n#persistence_location\n# =================================================================\n# Logging\n# =================================================================\n#log_dest stderr\nlog_type error\nlog_type warning\nlog_type notice\nlog_type information\nconnection_messages true\n#log_facility\nlog_timestamp true\nlog_timestamp_format %Y-%m-%dT%H:%M:%S\n#websockets_log_level 0\n# =================================================================\n# Security\n# =================================================================\n#clientid_prefixes\nallow_anonymous false\n# -----------------------------------------------------------------\n# Default authentication and topic access control\n# -----------------------------------------------------------------\npassword_file /etc/mosquitto/passwordfile\nacl_file /etc/mosquitto/acl.file\n# -----------------------------------------------------------------\n# External authentication and topic access plugin options\n# -----------------------------------------------------------------\n# auth_plugin\n# auth_opt_db_host\n# auth_opt_db_port\n# auth_opt_db_username\n# auth_opt_db_password\n# =================================================================\n# Bridges\n# =================================================================\n#connection <name>\n#address <host>[:<port>] [<host>[:<port>]]\n#topic <topic> [[[out | in | both] qos-level] local-prefix remote-prefix]\n#bridge_bind_address\n#bridge_attempt_unsubscribe true\n#bridge_protocol_version mqttv311\n#idle_timeout 60\n#keepalive_interval 60\n#local_clientid\n#notifications true\n#notification_topic\n#remote_clientid\n#remote_password\n#remote_username\n# restart_timeout 20\n# restart_timeout 10 30\n#restart_timeout 5 30\n#round_robin false\n#start_type automatic\n#threshold 10\n#try_private true\n#bridge_outgoing_retain true\n#bridge_max_packet_size 0\n# -----------------------------------------------------------------\n# Certificate based SSL/TLS support\n# -----------------------------------------------------------------\n#bridge_cafile\n#bridge_capath\n#bridge_alpn\n#bridge_insecure false\n#bridge_certfile\n#bridge_keyfile\n# -----------------------------------------------------------------\n# PSK based SSL/TLS support\n# -----------------------------------------------------------------\n#bridge_identity\n#bridge_psk\n# =================================================================\n# External config files\n# =================================================================\n#include_dir\n")),(0,a.kt)("p",null,"Make changes as needed and restart the Mosquitto service with:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"service mosquitto restart && service mosquitto status\n")),(0,a.kt)("h2",{id:"verify-that-the-broker-is-working"},"Verify that the Broker is working"),(0,a.kt)("h3",{id:"mosquitto-cli-tools"},"Mosquitto CLI Tools"),(0,a.kt)("p",null,"Verify that the broker is working using the Mosquitto subscription and publication tools:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mosquitto_sub  -h localhost -p 1883 -u admin -P instar -v -t '$SYS/broker/uptime'\n$SYS/broker/uptime 1089 seconds\n$SYS/broker/uptime 1100 seconds\n$SYS/broker/uptime 1111 seconds\n")),(0,a.kt)("p",null,"Subscribing to ",(0,a.kt)("inlineCode",{parentName:"p"},"$SYS/broker/uptime")," will give you the broker uptime in an 10s interval (interval can be adjusted in the mosquitto config)."),(0,a.kt)("h3",{id:"connecting-clients"},"Connecting Clients"),(0,a.kt)("p",null,"And to something more exciting - I will connect an INSTAR IP camera:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(26822).Z,width:"1133",height:"714"})),(0,a.kt)("p",null,"And send an update to switch the ",(0,a.kt)("em",{parentName:"p"},"privacy area 1")," on and off again using the command topic:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mosquitto_pub -h 192.168.2.111 -p 1883 -u admin -P instar -t 'cameras/117/multimedia/privacy/region1/enable' -m '{\"val\":\"1\"}' -d\nClient (null) sending CONNECT\nClient (null) received CONNACK (0)\nClient (null) sending PUBLISH (d0, q0, r0, m1, 'cameras/117/multimedia/privacy/region1/enable', ... (11 bytes))\nClient (null) sending DISCONNECT\n\nmosquitto_pub -h 192.168.2.111 -p 1883 -u admin -P instar -t 'cameras/117/multimedia/privacy/region1/enable' -m '{\"val\":\"0\"}' -d\nClient (null) sending CONNECT\nClient (null) received CONNACK (0)\nClient (null) sending PUBLISH (d0, q0, r0, m1, 'cameras/117/multimedia/privacy/region1/enable', ... (11 bytes))\nClient (null) sending DISCONNECT\n")),(0,a.kt)("p",null,"Subscribing to the status topic I can see that the command was executed as expected:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'mosquitto_sub -h localhost -p 1883 -u admin -P instar -v -t \'cameras/117/status/multimedia/privacy/region1/enable\'    \ncameras/117/status/multimedia/privacy/region1/enable {"val":"1"}\ncameras/117/status/multimedia/privacy/region1/enable {"val":"0"}\n')),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(97501).Z,width:"1020",height:"736"})),(0,a.kt)("h2",{id:"websockets"},"Websockets"),(0,a.kt)("h3",{id:"mqtt-explorer"},"MQTT Explorer"),(0,a.kt)("p",null,"So far I have been using the configured default listener on port ",(0,a.kt)("inlineCode",{parentName:"p"},"1885")," using the ",(0,a.kt)("strong",{parentName:"p"},"MQTT")," protocol. But I added an additional listener on port ",(0,a.kt)("inlineCode",{parentName:"p"},"8885")," that requires a websocket connection:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"# =================================================================\n# Listeners\n# =================================================================\nlistener 1883\nprotocol mqtt\nlistener 1885\nprotocol websockets\n")),(0,a.kt)("p",null,"In the ",(0,a.kt)("a",{parentName:"p",href:"https://mqtt-explorer.com/"},"MQTT Explorer")," you can switch the used protocol to ",(0,a.kt)("inlineCode",{parentName:"p"},"ws")," to test the service:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(36336).Z,width:"1016",height:"734"})),(0,a.kt)("h3",{id:"mqttjs-web-client"},"MQTT.js Web Client"),(0,a.kt)("p",null,"Using a ",(0,a.kt)("a",{parentName:"p",href:"/docs/Development/Javascript/2021-06-04--mqtt-dashboard-react/2021-06-04"},"MQTT.js React Dashboard")," to connect to the WS service:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"import React, { useState, Fragment } from 'react';\nimport './App.css';\n\nvar mqtt = require('mqtt');\nvar options = {\n    protocol: 'ws',\n    username: 'admin',\n    password: 'instar',\n    // clientId uniquely identifies client\n    // choose any string you wish\n    clientId: 'mqttjs_' + Math.random().toString(16).substr(2, 8),\n};\nvar client  = mqtt.connect('ws://192.168.2.111:1885', options);\n\n// Get Broker Uptime MQTT topic\nclient.subscribe('$SYS/broker/uptime');\n\nfunction App() {\n  var note;\n  client.on('message', function (topic, message) {\n    note = message.toString();\n    // Updates React state with message \n    setMsg(note);\n    console.log(note);\n    client.end();\n    });\n\n  // Sets default React state \n  const [msg, setMsg] = useState(<Fragment><em>connecting...</em></Fragment>);\n\n  return (\n    <div className=\"App\">\n      <header className=\"App-header\">\n        <h1>Mosquitto Broker</h1>\n        <p>Uptime: {msg}</p>\n      </header>\n    </div>\n  );\n}\n\nexport default App;\n")),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(68892).Z,width:"1184",height:"883"})),(0,a.kt)("h2",{id:"mosquitto-webserver"},"Mosquitto Webserver"),(0,a.kt)("p",null,"When a listener is using the websockets protocol, it is possible to serve http data as well. Set ",(0,a.kt)("inlineCode",{parentName:"p"},"http_dir")," to a directory which contains the files you wish to serve. If this option is not specified, then no normal http connections will be possible. Let's add this third listener to the configuration file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-conf"},"# =================================================================\n# Listeners\n# =================================================================\nlistener 1883\nprotocol mqtt\nlistener 1885\nprotocol websockets\nlistener 8080\nprotocol websockets\nhttp_dir /opt/mqtt-tree\n")),(0,a.kt)("p",null,"I am going to use this ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/mpolinowski/d3-MQTT-Topic-Tree"},"D3 Tree")," from ",(0,a.kt)("inlineCode",{parentName:"p"},"@hardillb")," and download to ",(0,a.kt)("inlineCode",{parentName:"p"},"/opt/mqtt-tree"),". All I need to add the the ",(0,a.kt)("inlineCode",{parentName:"p"},"./index.html")," file is the Mosquitto WS URL, Port and the broker login to display a tree view of all registered topics:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"var options = {\n  // host: location.hostname,\n  // port: parseInt(location.port),\n  host: '192.168.2.111',\n  port: 1885,\n  clientID: \"web\" + new Date().getTime(),\n  connectOpts: {\n    userName: 'admin',\n    password: 'instar',\n    // useSSL: true,\n    keepAliveInterval: 30,\n    timeout: 10,\n    cleanSession: false,\n    onSuccess: onConnect,\n    onFailure: onFailure\n  }\n}\n")),(0,a.kt)("p",null,"Restart the Mosquitto service and visit the broker IP on port ",(0,a.kt)("inlineCode",{parentName:"p"},"8080")," with your web browser:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(7146).Z,width:"929",height:"713"})),(0,a.kt)("h2",{id:"adding-encryption"},"Adding Encryption"),(0,a.kt)("h3",{id:"creating-self-signed-certificates"},"Creating Self-Signed Certificates"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Client Requirements")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"A CA (certificate authority) certificate of the CA that has signed the server certificate on the Mosquitto Broker.")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Broker Requirements")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"CA certificate of the CA that has signed the server certificate on the Mosquitto Broker."),(0,a.kt)("li",{parentName:"ul"},"CA certificated server certificate."),(0,a.kt)("li",{parentName:"ul"},"Server Private key for decryption.")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl version\nOpenSSL 1.1.1l  24 Aug 2021\n")),(0,a.kt)("p",null,"Mosquitto already creates a directory for self-signed certificates - if it does not exists create it with:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p /etc/mosquitto/certs\nchown mosquitto:mosquitto /etc/mosquitto/certs\n")),(0,a.kt)("h4",{id:"ca-certificates"},"CA Certificates"),(0,a.kt)("p",null,"m"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"cd /etc/mosquitto/certs\nopenssl genrsa -out ca.key 4096\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Important"),": The FQDN must not be the same as the ",(0,a.kt)("strong",{parentName:"p"},"server FQDN"),", otherwise you might end up with SSL errors. On a local network using a AVM Fritzbox router every device receives both a hostname - for example my Mosquitto server identifies as ",(0,a.kt)("inlineCode",{parentName:"p"},"debian11")," - and a domain name hostname + ",(0,a.kt)("inlineCode",{parentName:"p"},".fritz.box"),". So, for example, I am able to access the Mosquitto webserver via ",(0,a.kt)("inlineCode",{parentName:"p"},"http://debian11.fritz.box:8080/"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl req -new -x509 -days 1825 -key ca.key -out ca.crt\n\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter '.', the field will be left blank.\n-----\nCountry Name (2 letter code) [AU]:\nState or Province Name (full name) [Some-State]:\nLocality Name (eg, city) []:\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:INSTAR\nOrganizational Unit Name (eg, section) []:\nCommon Name (e.g. server FQDN or YOUR name) []:debian11.fritz.box\nEmail Address []:\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chown mosquitto:mosquitto ca.{crt,key}\n")),(0,a.kt)("h4",{id:"server-certificates"},"Server Certificates"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl genrsa -out server.key 4096\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Important"),": Here the FQDN must be the ",(0,a.kt)("strong",{parentName:"p"},"hostname"),", otherwise you might end up with SSL errors. As mentioned above my server can be reached via the hostname ",(0,a.kt)("inlineCode",{parentName:"p"},"debian11")," - I can test this by visiting the mosquitto webserver ",(0,a.kt)("inlineCode",{parentName:"p"},"http://debian11:8080/"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl req -new -out server.csr -key server.key\n\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter '.', the field will be left blank.\n-----\nCountry Name (2 letter code) [AU]:\nState or Province Name (full name) [Some-State]:\nLocality Name (eg, city) []:\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:INSTAR\nOrganizational Unit Name (eg, section) []:\nCommon Name (e.g. server FQDN or YOUR name) []:debian11\nEmail Address []:\n\nPlease enter the following 'extra' attributes\nto be sent with your certificate request\nA challenge password []:\nAn optional company name []:\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 1825\n\nSignature ok\nsubject=C = AU, ST = Some-State, O = INSTAR, CN = debian11\nGetting CA Private Key\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chown mosquitto:mosquitto server.{csr,key,crt}\n")),(0,a.kt)("p",null,"The ",(0,a.kt)("inlineCode",{parentName:"p"},"certs")," directory should now contain the following files:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"-rw-r--r-- 1 mosquitto mosquitto 1956 Feb 16 20:31 ca.crt\n-rw------- 1 mosquitto mosquitto 3243 Feb 16 20:30 ca.key\n-rw-r--r-- 1 root      root        41 Feb 16 20:37 ca.srl\n-rw-r--r-- 1 mosquitto mosquitto 1834 Feb 16 20:37 server.crt\n-rw-r--r-- 1 mosquitto mosquitto 1659 Feb 16 20:37 server.csr\n-rw------- 1 mosquitto mosquitto 3243 Feb 16 20:34 server.key\n")),(0,a.kt)("h4",{id:"mosquitto-server-configuration"},"Mosquitto Server Configuration"),(0,a.kt)("p",null,"Add the following configuration to ",(0,a.kt)("inlineCode",{parentName:"p"},"/etc/mosquitto/conf.d/custom.conf"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yml"},"# -----------------------------------------------------------------\n# Certificate based SSL/TLS support\n# -----------------------------------------------------------------\nlistener 8883\ntls_version tlsv1.2\ncafile /etc/mosquitto/certs/ca.crt\ncertfile /etc/mosquitto/certs/server.crt\nkeyfile /etc/mosquitto/certs/server.key\n")),(0,a.kt)("p",null,"Then restart the service:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"service mosquitto restart && service mosquitto status\n")),(0,a.kt)("h4",{id:"testing-the-connection"},"Testing the Connection"),(0,a.kt)("p",null,"All you need to establish a server connection is the ",(0,a.kt)("inlineCode",{parentName:"p"},"ca.crt")," file on your client machine. Then you can try to subscribe to the last-will topic of your camera and should receive it's online status:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'mosquitto_sub -h debian11 -t \'cameras/117/status/connection\' -p 8883 --insecure --cafile ca.crt --tls-version tlsv1.2 -u admin -P instar -v\n\ncameras/117/status/connection {"val":"online"}\ncameras/117/status/connection {"val":"offline"}\ncameras/117/status/connection {"val":"online"}\n')),(0,a.kt)("p",null,"Or with the ",(0,a.kt)("strong",{parentName:"p"},"MQTT Explorer"),":"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(26894).Z,width:"1014",height:"640"})),(0,a.kt)("p",null,"Add the ",(0,a.kt)("inlineCode",{parentName:"p"},"ca.crt")," file here:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(48799).Z,width:"1007",height:"460"})),(0,a.kt)("h4",{id:"client-certificates"},"Client Certificates"),(0,a.kt)("p",null,"For more security, you can add client certificates, which need to be signed by the server."),(0,a.kt)("h4",{id:"creating-a-client-certificate"},"Creating a client certificate"),(0,a.kt)("p",null,"Generate client certificates for the MQTT clients. ",(0,a.kt)("strong",{parentName:"p"},"Important"),": Don\u2019t use the server name as FQDN:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl genrsa -out client.key 4096\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl req -out client.csr -key client.key -new\n\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\nWhat you are about to enter is what is called a Distinguished Name or a DN.\nThere are quite a few fields but you can leave some blank\nFor some fields there will be a default value,\nIf you enter '.', the field will be left blank.\n-----\nCountry Name (2 letter code) [AU]:\nState or Province Name (full name) [Some-State]:\nLocality Name (eg, city) []:\nOrganization Name (eg, company) [Internet Widgits Pty Ltd]:INSTAR\nOrganizational Unit Name (eg, section) []:\nCommon Name (e.g. server FQDN or YOUR name) []:mqtt.client\nEmail Address []:\n\nPlease enter the following 'extra' attributes\nto be sent with your certificate request\nA challenge password []:\nAn optional company name []:\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"openssl x509 -req -in client.csr -CA ca.crt --CAkey ca.key --CAcreateserial -out client.crt -days 1825\n\nSignature ok\nsubject=C = AU, ST = Some-State, O = INSTAR, CN = mqtt.client\nGetting CA Private Key\n")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"chown mosquitto:mosquitto client.{csr,crt,key}\n")),(0,a.kt)("p",null,"Restart the Mosquitto server:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"service mosquitto restart && service mosquitto status\n")),(0,a.kt)("h4",{id:"update-the-mosquitto-server-configuration"},"Update the Mosquitto Server Configuration"),(0,a.kt)("p",null,"To enforce the usage of client certificates, you will need to add ",(0,a.kt)("inlineCode",{parentName:"p"},"require_certificate true")," to your listener configuration:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-yml"},"# -----------------------------------------------------------------\n# Certificate based SSL/TLS support\n# -----------------------------------------------------------------\nlistener 8883\ntls_version tlsv1.2\ncafile /etc/mosquitto/certs/ca.crt\ncertfile /etc/mosquitto/certs/server.crt\nkeyfile /etc/mosquitto/certs/server.key\nrequire_certificate true\n")),(0,a.kt)("h4",{id:"testing-the-connection-1"},"Testing the Connection"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},'mosquitto_sub -h debian11 -t \'cameras/117/status/connection\' -p 8883 --insecure --cafile ca.crt --cert client.crt --key client.key --tls-version tlsv1.2 -u admin -P instar -v\n\ncameras/117/status/connection {"val":"online"}\n')),(0,a.kt)("p",null,"For the MQTT Explorer upload the Client Key and Cert:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(25883).Z,width:"1019",height:"571"})),(0,a.kt)("h2",{id:"connect-your-instar-ip-camera"},"Connect your INSTAR IP Camera"),(0,a.kt)("p",null,"To connect your INSTAR camera you first have to do 2 things:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Combine the ",(0,a.kt)("inlineCode",{parentName:"li"},"client.key")," and ",(0,a.kt)("inlineCode",{parentName:"li"},"client.crt")," into a single file called ",(0,a.kt)("inlineCode",{parentName:"li"},"client.pem"),":")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"-----BEGIN RSA PRIVATE KEY-----\nMIIJKAIBAAKCAgEAorc0ouM2Uh0pBlZ5IbCSonwOACUCPQ+FqWjhRl5FbAAke2iK\n\n...\n\nl6hxaLG33DoTvYoEbjBEmLtsBAz4sdnTGi2z6HOYfMsqGjMehPJmr2XH/kA=\n-----END RSA PRIVATE KEY-----\n-----BEGIN CERTIFICATE-----\nMIIFIDCCAwgCFHLf6A9ycbmW6ExF+DBGE3T3qhFAMA0GCSqGSIb3DQEBCwUAMFAx\n\n...\n\nCVSpxYNxMG6gIpeIFrTogygOfdc=\n-----END CERTIFICATE-----\n")),(0,a.kt)("ol",{start:2},(0,a.kt)("li",{parentName:"ol"},"Take the ",(0,a.kt)("inlineCode",{parentName:"li"},"ca.crt")," and save it as ",(0,a.kt)("inlineCode",{parentName:"li"},"ca.pem"),".")),(0,a.kt)("p",null,"Now open your camera's SSL Cert menu, add the ",(0,a.kt)("inlineCode",{parentName:"p"},"client.pem")," as your custom certificate and enable it:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(41358).Z,width:"948",height:"854"})),(0,a.kt)("p",null,"And secondly add the ",(0,a.kt)("inlineCode",{parentName:"p"},"ca.pem")," to the Custom CA Store of your camera:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(57051).Z,width:"1063",height:"525"})),(0,a.kt)("p",null,"Configure the client to use your MQTT brokers ",(0,a.kt)("strong",{parentName:"p"},"Hostname")," instead of it's local IP to be able to activate the ",(0,a.kt)("strong",{parentName:"p"},"Verify Certificate")," option:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Mosquitto2 MQTT Broker",src:n(1078).Z,width:"947",height:"767"})),(0,a.kt)("p",null,"Start your MQTT client and check the ",(0,a.kt)("inlineCode",{parentName:"p"},"http://debian11/tmpfs/mqtt-log")," - you should see it connect on port ",(0,a.kt)("inlineCode",{parentName:"p"},"8883")," using ",(0,a.kt)("strong",{parentName:"p"},"TLS"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"2022-2-18 4:11:11: [Info] Config: Version 2\n2022-2-18 4:11:11: [Info] Config: Units loaded: 283\n2022-2-18 4:11:11: [Info] Config: Memory required: 40749\n2022-2-18 4:11:11: [Info] Authenticate with Mqtt-Broker\n2022-2-18 4:11:11: [Info] Activate TLS\n2022-2-18 4:11:11: [Info] Connect to Mqtt-Broker debian11 on port 8883...\n2022-2-18 4:11:11: [Info] Synchronize Cgi-Server with Mqtt-Broker\n2022-2-18 4:11:11: [Info] Mqtt listen thread has been started.\n2022-2-18 4:11:11: [Info] Synchronize Cgi-Server with Mqtt-Broker\n2022-2-18 4:11:12: [Info] Adapter connected!\n")))}p.isMDXComponent=!0},26822:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_01-5ae8f61bf9ebcd9af6fad332db059338.png"},97501:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_02-09a6355ecc5ebebc65ee7216a34b483c.png"},36336:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_03-80d58d8c03492fe75d935556dd1ff3fb.png"},68892:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_04-c2a81f5b204350f8144843088eedfe96.png"},7146:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_05-0fb5a1b5a2b1e93e1b1400b0d83a9bf4.png"},26894:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_06-d9a6501da366813cfae1dbec80dbb4ba.png"},48799:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_07-48662b02209b8dd16d92d48521f56778.png"},25883:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_08-0dad0d164bdec7d1fcec4b1112dadab6.png"},41358:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_09-e913aafe3d5b36029890eba777843163.png"},57051:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_10-af28ed2051bcea94db91923e43b70d4e.png"},1078:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/Mosquitto2_Broker_11-5100e12de27ee21cc284f18cee3e24e7.png"},56801:(e,t,n)=>{n.d(t,{Z:()=>o});const o=n.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-027d6cb82627f4093030484d7bfca6fd.jpg"}}]);