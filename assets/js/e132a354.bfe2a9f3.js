"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[47722],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>u});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(a),u=r,h=d["".concat(s,".").concat(u)]||d[u]||m[u]||i;return a?n.createElement(h,o(o({ref:t},p),{},{components:a})):n.createElement(h,o({ref:t},p))}));function u(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=a[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},50218:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var n=a(87462),r=(a(67294),a(3905));const i={sidebar_position:8090,slug:"2021-08-02",title:"Hashicorp Nomad Refresher - Security",authors:"mpolinowski",tags:["Nomad","Linux"]},o=void 0,l={unversionedId:"DevOps/Hashicorp/2021-08-02--hashicorp-nomad-security/index",id:"DevOps/Hashicorp/2021-08-02--hashicorp-nomad-security/index",title:"Hashicorp Nomad Refresher - Security",description:"Shenzhen, China",source:"@site/docs/DevOps/Hashicorp/2021-08-02--hashicorp-nomad-security/index.md",sourceDirName:"DevOps/Hashicorp/2021-08-02--hashicorp-nomad-security",slug:"/DevOps/Hashicorp/2021-08-02--hashicorp-nomad-security/2021-08-02",permalink:"/docs/DevOps/Hashicorp/2021-08-02--hashicorp-nomad-security/2021-08-02",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/DevOps/Hashicorp/2021-08-02--hashicorp-nomad-security/index.md",tags:[{label:"Nomad",permalink:"/docs/tags/nomad"},{label:"Linux",permalink:"/docs/tags/linux"}],version:"current",sidebarPosition:8090,frontMatter:{sidebar_position:8090,slug:"2021-08-02",title:"Hashicorp Nomad Refresher - Security",authors:"mpolinowski",tags:["Nomad","Linux"]},sidebar:"tutorialSidebar",previous:{title:"Hashicorp Nomad Refresher - Jobs",permalink:"/docs/DevOps/Hashicorp/2021-08-03--hashicorp-nomad-jobs/2021-08-03"},next:{title:"Hashicorp Nomad Refresher - Installation",permalink:"/docs/DevOps/Hashicorp/2021-08-01--hashicorp-nomad-refresher/2021-08-01"}},s={},c=[{value:"Secure Access to the Nomad GUI",id:"secure-access-to-the-nomad-gui",level:2},{value:"SSH Tunnel",id:"ssh-tunnel",level:3},{value:"Gossip Encryption",id:"gossip-encryption",level:2},{value:"mTLS Transport Encryptions",id:"mtls-transport-encryptions",level:2},{value:"Installing CFSSL",id:"installing-cfssl",level:3},{value:"Generating the TLS Keys",id:"generating-the-tls-keys",level:3},{value:"Generate a certificate for the Nomad server",id:"generate-a-certificate-for-the-nomad-server",level:4},{value:"Generate a certificate for the Nomad client",id:"generate-a-certificate-for-the-nomad-client",level:4},{value:"Generate a certificate for the CLI",id:"generate-a-certificate-for-the-cli",level:4},{value:"Master Server Configuration",id:"master-server-configuration",level:4},{value:"Minion Server Configuration",id:"minion-server-configuration",level:4},{value:"Configuring Nomad",id:"configuring-nomad",level:3},{value:"Master Server",id:"master-server",level:4},{value:"Minion Server",id:"minion-server",level:4},{value:"System Environment",id:"system-environment",level:4},{value:"Browser Configuration",id:"browser-configuration",level:3}],p={toc:c};function m(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,n.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Shenzhen, China",src:a(4202).Z,width:"1500",height:"466"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#secure-access-to-the-nomad-gui"},"Secure Access to the Nomad GUI"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#ssh-tunnel"},"SSH Tunnel")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#gossip-encryption"},"Gossip Encryption")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#mtls-transport-encryptions"},"mTLS Transport Encryptions"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#installing-cfssl"},"Installing CFSSL")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#generating-the-tls-keys"},"Generating the TLS Keys"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#generate-a-certificate-for-the-nomad-server"},"Generate a certificate for the Nomad server")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#generate-a-certificate-for-the-nomad-client"},"Generate a certificate for the Nomad client")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#generate-a-certificate-for-the-cli"},"Generate a certificate for the CLI")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#master-server-configuration"},"Master Server Configuration")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#minion-server-configuration"},"Minion Server Configuration")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#configuring-nomad"},"Configuring Nomad"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#master-server"},"Master Server")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#minion-server"},"Minion Server")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#system-environment"},"System Environment")))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#browser-configuration"},"Browser Configuration"))))),(0,r.kt)("h2",{id:"secure-access-to-the-nomad-gui"},"Secure Access to the Nomad GUI"),(0,r.kt)("h3",{id:"ssh-tunnel"},"SSH Tunnel"),(0,r.kt)("p",null,"In the previous step I opened the port ",(0,r.kt)("inlineCode",{parentName:"p"},"4646")," on both my master and minion server which gave me access to the Nomad UI. Another - and much more secure - way to access the UI is to tunnel the HTTP port through SSH. On my Windows PC I simply have to type in the following command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ssh myuser@192.168.2.110 -L4646:localhost:4646\n")),(0,r.kt)("p",null,"And now I am able to access the UI via ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost")," instead of the IP address of my RHEL8 Nomad master server:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Hashicorp Nomad",src:a(7444).Z,width:"979",height:"490"})),(0,r.kt)("p",null,"We can now close the corresponding ports on our servers:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"firewall-cmd --remove-port=4646/tcp\nfirewall-cmd --reload\nfirewall-cmd --list-ports\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ufw delete allow 4646:4647/tcp\nufw allow 4647/tcp\nufw reload\nufw status verbose\n")),(0,r.kt)("h2",{id:"gossip-encryption"},"Gossip Encryption"),(0,r.kt)("p",null,"Nomad server's ",(0,r.kt)("a",{parentName:"p",href:"https://learn.hashicorp.com/tutorials/nomad/security-gossip-encryption"},"gossip protocol")," that is used to communicate membership and liveness information can be encrypted with symmetric keys. Enabling gossip encryption requires you to set an encryption key when starting the Nomad server."),(0,r.kt)("p",null,"Create an encryption key to encrypt the communication between Nomad agents (alternatively, you can also use ",(0,r.kt)("inlineCode",{parentName:"p"},"openssl rand -base64 32"),"):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nomad operator keygen\n\n4kRkFQfcc3LU0BazP1ca+z==\n")),(0,r.kt)("p",null,"This key has to be added to the Nomad server configuration to ",(0,r.kt)("a",{parentName:"p",href:"https://learn.hashicorp.com/tutorials/nomad/security-gossip-encryption"},"enable the Gossip encryption"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/nomad.d/server.hcl\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'server {\n  enabled = true\n  bootstrap_expect = 1\n  encrypt = "4kRkFQfcc3LU0BazP1ca+z=="\n}\n')),(0,r.kt)("p",null,"You can perform a rolling restart of the Nomad process on each of your server nodes to enable encryption. Restart your servers one at a time in order to maintain a quorum of nodes on one side or the other of this soft partition."),(0,r.kt)("p",null,"Once all of the nodes have been restarted all gossip traffic will be encrypted between all of your server nodes."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart nomad\nsystemctl status nomad\n")),(0,r.kt)("h2",{id:"mtls-transport-encryptions"},"mTLS Transport Encryptions"),(0,r.kt)("p",null,"The first step to configuring ",(0,r.kt)("a",{parentName:"p",href:"https://learn.hashicorp.com/tutorials/nomad/security-enable-tls?in=nomad/transport-security"},"TLS for Nomad")," is generating certificates. In order to prevent unauthorized cluster access, Nomad requires all certificates be signed by the same Certificate Authority (CA). This should be a private CA and not a public one like Let's Encrypt as any certificate signed by this CA will be allowed to communicate with the cluster."),(0,r.kt)("h3",{id:"installing-cfssl"},"Installing CFSSL"),(0,r.kt)("p",null,"You can generate a private CA certificate and key with ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cloudflare/cfssl"},"Cloudflare cfssl"),". Download the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/cloudflare/cfssl/releases"},"latest release")," with ",(0,r.kt)("inlineCode",{parentName:"p"},"wget"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"wget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssl_1.6.0_linux_amd64 -O cfssl\nwget https://github.com/cloudflare/cfssl/releases/download/v1.6.0/cfssljson_1.6.0_linux_amd64 -O cfssljson\n\nchmod +x cfssljson cfssl\nmv cfssl* /usr/local/bin\n")),(0,r.kt)("p",null,"Verify that it is working:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cfssl version\n\nVersion: 1.6.0\nRuntime: go1.12.12\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cfssljson -version\n\nVersion: 1.6.0\nRuntime: go1.12.12\n")),(0,r.kt)("h3",{id:"generating-the-tls-keys"},"Generating the TLS Keys"),(0,r.kt)("p",null,"Generate the CA's private key and certificate:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir nomad_certs && cd nomad_certs\ncfssl print-defaults csr | cfssl gencert -initca - | cfssljson -bare nomad-ca\n")),(0,r.kt)("p",null,"Nomad certificates are signed with their region and role such as:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"client.global.nomad")," for a client node in the global region"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"server.us-west.nomad")," for a server node in the us-west region")),(0,r.kt)("p",null,"To create certificates for the client and server in the cluster use the following configuration file as ",(0,r.kt)("a",{parentName:"p",href:"https://raw.githubusercontent.com/hashicorp/nomad/master/demo/vagrant/cfssl.json"},"cfssl.json")," to increase the default certificate expiration time:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "signing": {\n    "default": {\n      "expiry": "87600h",\n      "usages": ["signing", "key encipherment", "server auth", "client auth"]\n    }\n  }\n}\n')),(0,r.kt)("h4",{id:"generate-a-certificate-for-the-nomad-server"},"Generate a certificate for the Nomad server"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"echo '{}' | cfssl gencert -ca=nomad-ca.pem -ca-key=nomad-ca-key.pem -config=cfssl.json \\\n    -hostname=\"server.global.nomad,localhost,127.0.0.1\" - | cfssljson -bare server\n")),(0,r.kt)("h4",{id:"generate-a-certificate-for-the-nomad-client"},"Generate a certificate for the Nomad client"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"echo '{}' | cfssl gencert -ca=nomad-ca.pem -ca-key=nomad-ca-key.pem -config=cfssl.json \\\n    -hostname=\"client.global.nomad,localhost,127.0.0.1\" - | cfssljson -bare client\n")),(0,r.kt)("h4",{id:"generate-a-certificate-for-the-cli"},"Generate a certificate for the CLI"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"echo '{}' | cfssl gencert -ca=nomad-ca.pem -ca-key=nomad-ca-key.pem -profile=client \\\n    - | cfssljson -bare cli\n")),(0,r.kt)("p",null,"You should now have the following files:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cfssl.json")," - cfssl configuration."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nomad-ca.csr")," - CA signing request."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nomad-ca-key.pem")," - CA private key. Keep safe."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"nomad-ca.pem")," - CA public certificate."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cli.csr")," - Nomad CLI certificate signing request."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cli-key.pem")," - Nomad CLI private key."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"cli.pem")," - Nomad CLI certificate."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"client.csr")," - Nomad client node certificate signing request for the global region."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"client-key"),".pem - Nomad client node private key for the global region."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"client.pem")," - Nomad client node public certificate for the global region."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"server.csr")," - Nomad server node certificate signing request for the global region."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"server-key"),".pem - Nomad server node private key for the global region."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"server.pem")," - Nomad server node public certificate for the global region.")),(0,r.kt)("p",null,"Each Nomad node should have:"),(0,r.kt)("h4",{id:"master-server-configuration"},"Master Server Configuration"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The appropriate key ",(0,r.kt)("inlineCode",{parentName:"li"},"server-key.pem")),(0,r.kt)("li",{parentName:"ul"},"And certificate ",(0,r.kt)("inlineCode",{parentName:"li"},"server.pem")," file"),(0,r.kt)("li",{parentName:"ul"},"In addition each node needs the CA's public certificate (",(0,r.kt)("inlineCode",{parentName:"li"},"nomad-ca.pem"),").")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /etc/nomad.d/certs\nsudo cp server-key.pem /etc/nomad.d/certs\nsudo cp server.pem /etc/nomad.d/certs\nsudo cp nomad-ca.pem /etc/nomad.d/certs\n")),(0,r.kt)("h4",{id:"minion-server-configuration"},"Minion Server Configuration"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The appropriate key ",(0,r.kt)("inlineCode",{parentName:"li"},"client-key.pem")),(0,r.kt)("li",{parentName:"ul"},"And certificate ",(0,r.kt)("inlineCode",{parentName:"li"},"client.pem")," file"),(0,r.kt)("li",{parentName:"ul"},"In addition each node needs the CA's public certificate (",(0,r.kt)("inlineCode",{parentName:"li"},"nomad-ca.pem"),").")),(0,r.kt)("p",null,"Create the same directory and choose you favourite way to copy in the client certs from your master server:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir /etc/nomad.d/certs\n")),(0,r.kt)("h3",{id:"configuring-nomad"},"Configuring Nomad"),(0,r.kt)("p",null,"Now we need to add the certificates to our server config:"),(0,r.kt)("h4",{id:"master-server"},"Master Server"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/nomad.d/server.hcl\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'# Require TLS\ntls {\n  http = true\n  rpc  = true\n\n  ca_file   = "/etc/nomad.d/certs/nomad-ca.pem"\n  cert_file = "/etc/nomad.d/certs/server.pem"\n  key_file  = "/etc/nomad.d/certs/server-key.pem"\n\n  verify_server_hostname = true\n  verify_https_client    = true\n}\n')),(0,r.kt)("p",null,"These two settings are important for ensuring all of Nomad's ",(0,r.kt)("strong",{parentName:"p"},"mTLS")," security properties are met. If ",(0,r.kt)("inlineCode",{parentName:"p"},"verify_server_hostname")," is set to ",(0,r.kt)("inlineCode",{parentName:"p"},"false")," the node's certificate will be checked to ensure it is signed by the same CA, but its role and region will not be verified. This means any service with a certificate signed by same CA as Nomad can act as a client or server of any region."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"verify_https_client")," requires HTTP API clients to present a certificate signed by the same CA as Nomad's certificate. It may be disabled to allow HTTP API clients (e.g. ",(0,r.kt)("strong",{parentName:"p"},"Nomad CLI"),", ",(0,r.kt)("strong",{parentName:"p"},"Consul"),", or ",(0,r.kt)("strong",{parentName:"p"},"curl"),") to communicate with the HTTPS API without presenting a client-side certificate. If ",(0,r.kt)("inlineCode",{parentName:"p"},"verify_https_client")," is enabled only HTTP API clients presenting a certificate signed by the same CA as Nomad's certificate are allowed to access Nomad."),(0,r.kt)("h4",{id:"minion-server"},"Minion Server"),(0,r.kt)("p",null,"The Nomad client configuration is similar to the server configuration. The biggest difference is in the certificate and key used for configuration:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/nomad.d/client.hcl\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'tls {\n  http = true\n  rpc  = true\n\n  ca_file   = "/etc/nomad.d/certs/nomad-ca.pem"\n  cert_file = "/etc/nomad.d/certs/client.pem"\n  key_file  = "/etc/nomad.d/certs/client-key.pem"\n\n  verify_server_hostname = true\n  verify_https_client    = true\n}\n')),(0,r.kt)("p",null,"Once all of the nodes have been configured restart the Nomad service everywhere:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl restart nomad\nsystemctl status nomad\n")),(0,r.kt)("h4",{id:"system-environment"},"System Environment"),(0,r.kt)("p",null,"Try to send a CLI command with TLS encryption:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd ~/nomad_certs\n\nnomad server members -ca-cert=nomad-ca.pem -client-cert=cli.pem -client-key=cli-key.pem -addr=https://127.0.0.1:4646\n\nName                    Address        Port  Status  Leader  Protocol  Build  Datacenter  Region\nlinux.fritz.box.global  192.168.2.110  4648  alive   true    2         1.1.3  instaryun   global\n")),(0,r.kt)("p",null,"This process can be cumbersome to type each time, so the Nomad CLI also searches environment variables for default values. Use the following commands to set environment variables in your shell (",(0,r.kt)("inlineCode",{parentName:"p"},"nano ~/.bash_profile")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"nano ~/.zshrc"),")."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"NOMAD_ADDR")," is the URL of the Nomad agent and sets the default for ",(0,r.kt)("inlineCode",{parentName:"li"},"-addr"),":")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},"export NOMAD_ADDR=https://127.0.0.1:4646\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"NOMAD_CACERT")," is the location of your CA certificate and sets the default for ",(0,r.kt)("inlineCode",{parentName:"li"},"-ca-cert"),":")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},"export NOMAD_CACERT=~/nomad_certs/nomad-ca.pem\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"NOMAD_CLIENT_CERT")," is the location of your CLI certificate and sets the default for ",(0,r.kt)("inlineCode",{parentName:"li"},"-client-cert"),":")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},"export NOMAD_CLIENT_CERT=~/nomad_certs/cli.pem\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"NOMAD_CLIENT_KEY")," is the location of your CLI key and sets the default for ",(0,r.kt)("inlineCode",{parentName:"li"},"-client-key"),":")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},"export NOMAD_CLIENT_KEY=~/nomad_certs/cli-key.pem\n")),(0,r.kt)("p",null,"After these environment variables are correctly configured and the configuration file ",(0,r.kt)("inlineCode",{parentName:"p"},"source ~/.bash_profile")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"source ~/.zshrc"),", the CLI will respond as expected:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nomad server members\n\nName                    Address        Port  Status  Leader  Protocol  Build  Datacenter  Region\nlinux.fritz.box.global  192.168.2.110  4648  alive   true    2         1.1.3  instaryun   global\n")),(0,r.kt)("p",null,"Repeat those steps with all your servers."),(0,r.kt)("h3",{id:"browser-configuration"},"Browser Configuration"),(0,r.kt)("p",null,"When I try to connect to the Nomad UI I am now forced to use HTTPS:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Client sent an HTTP request to an HTTPS server.\n")),(0,r.kt)("p",null,"And when I try to use HTTPS it refuses my certificate:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"ERR_BAD_SSL_CLIENT_AUTH_CERT\n")),(0,r.kt)("p",null,"I can now use the CLI certificate to generate an ",(0,r.kt)("inlineCode",{parentName:"p"},".pfx")," file that I will have to import to my browser to be allowed back onto the Nomad UI. Make sure you are inside the directory where you generated the certificates and run the following ",(0,r.kt)("strong",{parentName:"p"},"OpenSSL")," command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openssl pkcs12 -inkey cli-key.pem -in cli.pem -export -out nomad.pfx\n\nEnter Export Password:\nVerifying - Enter Export Password:\n")),(0,r.kt)("p",null,"You can add a password here or leave it empty. Then download the certificate and import it into your web browser - e.g. Google Chromium:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Hashicorp Nomad",src:a(3216).Z,width:"1098",height:"736"})),(0,r.kt)("p",null,"Refresh the Nomad WebUI and accept the certificate - and you should be back on!"))}m.isMDXComponent=!0},7444:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Hashicorp_Nomad_01-87b7bff39f98e78adeafcdbcfbefecb5.png"},3216:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Hashicorp_Nomad_02-e351aa7d4795171de4e9ed364d37dec9.png"},4202:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/photo-kt443t6d_64hdh43hfh6dgjdfhg4_d-2303da2d3163237ced63ba004d49b187.jpg"}}]);