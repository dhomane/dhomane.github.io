"use strict";(self.webpackChunkmikes_dev_notebook=self.webpackChunkmikes_dev_notebook||[]).push([[92105],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>h});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(t),h=r,m=u["".concat(l,".").concat(h)]||u[h]||d[h]||i;return t?a.createElement(m,o(o({ref:n},p),{},{components:t})):a.createElement(m,o({ref:n},p))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=t[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},42375:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var a=t(87462),r=(t(67294),t(3905));const i={sidebar_position:9050,slug:"2019-09-13",title:"Magento 2 and Varnish 6",authors:"mpolinowski",tags:["LINUX","Magento"]},o=void 0,s={unversionedId:"Development/Magento/2019-09-13--magento-and-varnish/index",id:"Development/Magento/2019-09-13--magento-and-varnish/index",title:"Magento 2 and Varnish 6",description:"Victoria Harbour, Hongkong",source:"@site/docs/Development/Magento/2019-09-13--magento-and-varnish/index.mdx",sourceDirName:"Development/Magento/2019-09-13--magento-and-varnish",slug:"/Development/Magento/2019-09-13--magento-and-varnish/2019-09-13",permalink:"/docs/Development/Magento/2019-09-13--magento-and-varnish/2019-09-13",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Development/Magento/2019-09-13--magento-and-varnish/index.mdx",tags:[{label:"LINUX",permalink:"/docs/tags/linux"},{label:"Magento",permalink:"/docs/tags/magento"}],version:"current",sidebarPosition:9050,frontMatter:{sidebar_position:9050,slug:"2019-09-13",title:"Magento 2 and Varnish 6",authors:"mpolinowski",tags:["LINUX","Magento"]},sidebar:"tutorialSidebar",previous:{title:"Magento 2 Manual Theme Installation",permalink:"/docs/Development/Magento/2019-09-14--magento-and-themes/2019-09-14"},next:{title:"Magento 2 and Elasticsearch",permalink:"/docs/Development/Magento/2019-09-12--magento-and-elasticsearch/2019-09-12"}},l={},c=[{value:"Install Varnish 6 on Debian 10",id:"install-varnish-6-on-debian-10",level:2},{value:"Configure NGINX",id:"configure-nginx",level:2},{value:"Modify the Varnish system configuration",id:"modify-the-varnish-system-configuration",level:2},{value:"Modify default.vcl",id:"modify-defaultvcl",level:2},{value:"Configure Magento to use Varnish",id:"configure-magento-to-use-varnish",level:2},{value:"Export a Varnish Configuration File",id:"export-a-varnish-configuration-file",level:2},{value:"The Varnishing of the TopMenu",id:"the-varnishing-of-the-topmenu",level:2},{value:"/etc/varnish/default.vcl",id:"etcvarnishdefaultvcl",level:2},{value:"/etc/default/varnish",id:"etcdefaultvarnish",level:2},{value:"/etc/systemd/system/varnish.service",id:"etcsystemdsystemvarnishservice",level:2},{value:"/etc/nginx/conf.d/default.conf",id:"etcnginxconfddefaultconf",level:2},{value:"Check if Varnish is Running",id:"check-if-varnish-is-running",level:3},{value:"Excluding Backend URLs",id:"excluding-backend-urls",level:2},{value:"default.vcl",id:"defaultvcl",level:3},{value:"Testing",id:"testing",level:3}],p={toc:c};function d(e){let{components:n,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Victoria Harbour, Hongkong",src:t(35203).Z,width:"1500",height:"645"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#install-varnish-6-on-debian-10"},"Install Varnish 6 on Debian 10")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#configure-nginx"},"Configure NGINX")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#modify-the-varnish-system-configuration"},"Modify the Varnish system configuration")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#modify-defaultvcl"},"Modify default.vcl")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#configure-magento-to-use-varnish"},"Configure Magento to use Varnish")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#export-a-varnish-configuration-file"},"Export a Varnish Configuration File")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#the-varnishing-of-the-topmenu"},"The Varnishing of the TopMenu"))),(0,r.kt)("h2",{id:"install-varnish-6-on-debian-10"},"Install Varnish 6 on Debian 10"),(0,r.kt)("p",null,"In order to get ",(0,r.kt)("a",{parentName:"p",href:"https://varnish-cache.org/docs/6.0/installation/install.html"},"Varnish")," up and running type sudo apt-get install varnish. Enter the following command to display the version of Varnish you are running:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"varnishd -V\nvarnishd (varnish-6.1.1 revision efc2f6c1536cf2272e471f5cff5f145239b19460)\nCopyright (c) 2006 Verdens Gang AS\nCopyright (c) 2006-2015 Varnish Software AS\n")),(0,r.kt)("h2",{id:"configure-nginx"},"Configure NGINX"),(0,r.kt)("p",null,"Configure your web server to listen on a port other than the default port ",(0,r.kt)("inlineCode",{parentName:"p"},"80")," because Varnish responds directly to incoming HTTP requests, not the web server. In the sections that follow, we use port ",(0,r.kt)("inlineCode",{parentName:"p"},"8080")," as an example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/nginx/sites-available/magento.conf\n")),(0,r.kt)("p",null,"Change the server to listen to port ",(0,r.kt)("inlineCode",{parentName:"p"},"8080"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"upstream fastcgi_backend {\n  server  unix:/run/php/php7.2-fpm.sock;\n}\n\nserver {\n\n  listen 8080 default_server;\n  server_name your-server.de;\n  set $MAGE_ROOT /var/www/html/magento;\n  include /var/www/html/magento/nginx.conf.sample;\n}\n")),(0,r.kt)("p",null,"Test and reload NGINX:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nginx -t\nservice nginx reload\n")),(0,r.kt)("h2",{id:"modify-the-varnish-system-configuration"},"Modify the Varnish system configuration"),(0,r.kt)("p",null,"As a user with root privileges, open your Vanish configuration file in a text editor:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/default/varnish\n")),(0,r.kt)("p",null,"Set the Varnish listen port to 80:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"VARNISH_LISTEN_PORT = 80\n")),(0,r.kt)("p",null,"Make sure that DAEMON_OPTS contains the correct listening port for the ",(0,r.kt)("inlineCode",{parentName:"p"},"-a")," parameter:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"DAEMON_OPTS =\n  '-a :80 \\\n             -T localhost:6082 \\\n             -f /etc/varnish/default.vcl \\\n             -S /etc/varnish/secret \\\n             -s malloc,256m'\n")),(0,r.kt)("p",null,"Save your changes to the Varnish configuration file and exit the text editor."),(0,r.kt)("h2",{id:"modify-defaultvcl"},"Modify default.vcl"),(0,r.kt)("p",null,"This section discusses how to provide minimal configuration so Varnish returns HTTP response headers. This enables you to verify Varnish works before you configure Magento to use Varnish."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Back up default.vcl:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cp /etc/varnish/default.vcl /etc/varnish/default.vcl.bak\n")),(0,r.kt)("p",null,"Open ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/varnish/default.vcl")," in a text editor and locate the ",(0,r.kt)("inlineCode",{parentName:"p"},"backend default")," and replace the value of .host with the fully qualified hostname or IP address and listen port of the Varnish backend or origin server; that is, the server providing the content Varnish will accelerate. Replace the value of .port with the web server\u2019s listen port:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'backend default {\n    .host = "my.domain.com";\n    .port = "8080";\n}\n')),(0,r.kt)("p",null,"Save your changes to default.vcl and exit the text editor and restart Varnish:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"service varnish restart\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Unfortunatly")," this did not change the Port Varnish was running on:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"netstat -tulpn | grep varnish\ntcp        0      0 0.0.0.0:6081            0.0.0.0:*               LISTEN      1634/varnishd\ntcp        0      0 127.0.0.1:6082          0.0.0.0:*               LISTEN      1634/varnishd\ntcp6       0      0 :::6081                 :::*                    LISTEN      1634/varnishd\n")),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://serverfault.com/questions/824389/varnish-daemon-not-listening-on-configured-port/824399"},"Following this guide"),", applying changes to the default service is best done by creating a new file ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/systemd/system/varnish.service.d/customexec.conf"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# create the drop in directory\nmkdir /etc/systemd/system/varnish.service.d\n# create the drop in file. The name is irrelevant, as long as it ends in .conf\nnano /etc/systemd/system/varnish.service.d/customexec.conf\n")),(0,r.kt)("p",null,"Here you only need to add the settings you want do change, everything else will be loaded from the default definition file."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"[Service]\nExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :80 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m\n")),(0,r.kt)("p",null,"Afterwards, tell systemctl to reload it's config files and to restart the service"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl daemon-reload\nservice varnish restart\n")),(0,r.kt)("p",null,"Now I received an error message:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"service varnish restart\nFailed to restart varnish.service: Unit varnish.service has a bad unit file setting.\nSee system logs and 'systemctl status varnish.service' for details.\n\nsystemctl status varnish.service\nWarning: The unit file, source configuration file or drop-ins of varnish.service changed on disk\u25cf varnish.service - Varnish HTTP accelerator\n   Loaded: bad-setting (Reason: Unit varnish.service has a bad unit file setting.)\n  Drop-In: /etc/systemd/system/varnish.service.d\n           \u2514\u2500customexec.conf\n   Active: active (running) since Fri 2020-02-07 11:10:15 CET; 33min ago\n     Docs: https://www.varnish-cache.org/docs/6.1/\n           man:varnishd\n Main PID: 1634 (varnishd)\n    Tasks: 217 (limit: 4915)\n   Memory: 71.4M\n   CGroup: /system.slice/varnish.service\n           \u251c\u25001634 /usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/v           \u2514\u25001646 /usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/v\nFeb 07 11:10:15 Magento2 systemd[1]: Started Varnish HTTP accelerator.\nFeb 07 11:10:16 Magento2 varnishd[1634]: Debug: Version: varnish-6.1.1 revision efc2f6c1536cf227Feb 07 11:10:16 Magento2 varnishd[1634]: Debug: Platform: Linux,4.19.0-6-amd64,x86_64,-junix,-smFeb 07 11:10:16 Magento2 varnishd[1634]: Version: varnish-6.1.1 revision efc2f6c1536cf2272e471f5Feb 07 11:10:16 Magento2 varnishd[1634]: Platform: Linux,4.19.0-6-amd64,x86_64,-junix,-smalloc,-Feb 07 11:10:16 Magento2 varnishd[1634]: Debug: Child (1646) Started\nFeb 07 11:10:16 Magento2 varnishd[1634]: Child (1646) Started\nFeb 07 11:10:16 Magento2 varnishd[1634]: Info: Child (1646) said Child starts\nFeb 07 11:10:16 Magento2 varnishd[1634]: Child (1646) said Child starts\nFeb 07 11:43:32 Magento2 systemd[1]: varnish.service: Service has more than one ExecStart= setti\n")),(0,r.kt)("p",null,"The duplicated ",(0,r.kt)("inlineCode",{parentName:"p"},"ExecStart")," line is in ",(0,r.kt)("inlineCode",{parentName:"p"},"/lib/systemd/system/varnish.service"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"cat /lib/systemd/system/varnish.service\n[Unit]\nDescription=Varnish HTTP accelerator\nDocumentation=https://www.varnish-cache.org/docs/6.1/ man:varnishd\n\n[Service]\nType=simple\nLimitNOFILE=131072\nLimitMEMLOCK=82000\nExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m\nExecReload=/usr/share/varnish/varnishreload\nProtectSystem=full\nProtectHome=true\nPrivateTmp=true\nPrivateDevices=true\n\n[Install]\nWantedBy=multi-user.target\n")),(0,r.kt)("p",null,"Note that the drop-in should have an empty ",(0,r.kt)("inlineCode",{parentName:"p"},"ExecStart=")," to prevent this problem:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"[Service]\nExecStart=\nExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :80 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m\n")),(0,r.kt)("p",null,"Varnish is now running on port 80:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"netstat -tulpn | grep varnish\ntcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      2972/varnishd\ntcp        0      0 127.0.0.1:6082          0.0.0.0:*               LISTEN      2972/varnishd\ntcp6       0      0 :::80                   :::*                    LISTEN      2972/varnishd\n")),(0,r.kt)("p",null,"And I am able to access the Magento store again on port 80. You can check that your shop is served by Varnish by querying the HTTP header of your page:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -I http://my.domain.com/\nHTTP/1.1 200 OK\nServer: nginx/1.14.2\nDate: Fri, 07 Feb 2020 12:46:23 GMT\nContent-Type: text/html; charset=UTF-8\nSet-Cookie: X-Magento-Vary=6b1086e51dc44ada73095007287c835c2e8a8cb2; expires=Fri, 07-Feb-2020 13:46:23 GMT; Max-Age=3600; path=/; HttpOnly\nX-Magento-Cache-Control: max-age=86400, public, s-maxage=86400\nX-Magento-Cache-Debug: MISS\nX-Magento-Tags: store,cms_b,FPC\nPragma: no-cache\nCache-Control: max-age=0, must-revalidate, no-cache, no-store\nExpires: Thu, 07 Feb 2019 12:46:23 GMT\nX-Content-Type-Options: nosniff\nX-XSS-Protection: 1; mode=block\nX-Frame-Options: SAMEORIGIN\nContent-Encoding: gzip\nVary: Accept-Encoding\nX-Varnish: 98400\nAge: 0\nVia: 1.1 varnish (Varnish/6.1)\nConnection: keep-alive\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Before you can look at headers, you must set Magento for developer mode. You can also use the ",(0,r.kt)("a",{parentName:"p",href:"https://devdocs.magento.com/guides/v2.3/config-guide/cli/config-cli-subcommands-mode.html#change-to-developer-mode"},"magento deploy:mode:set")," command.")),(0,r.kt)("p",null,"Make sure Varnish is running then enter the following command on the Varnish server and click on a link on your website:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"varnishlog\n")),(0,r.kt)("h2",{id:"configure-magento-to-use-varnish"},"Configure Magento to use Varnish"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Log in to the Magento Admin as an administrator."),(0,r.kt)("li",{parentName:"ol"},"Click ",(0,r.kt)("strong",{parentName:"li"},"Stores")," > ",(0,r.kt)("strong",{parentName:"li"},"Configuration")," > ",(0,r.kt)("strong",{parentName:"li"},"Advanced")," > ",(0,r.kt)("strong",{parentName:"li"},"System")," > ",(0,r.kt)("strong",{parentName:"li"},"Full Page Cache"),"."),(0,r.kt)("li",{parentName:"ol"},"From the Caching Application list, click Varnish Caching."),(0,r.kt)("li",{parentName:"ol"},"Enter a value in the TTL for public content field."),(0,r.kt)("li",{parentName:"ol"},"Expand Varnish Configuration and enter the following information:")),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Field"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Access list"),(0,r.kt)("td",{parentName:"tr",align:null},"Enter the fully qualified hostname, IP address, or Classless Inter-Domain Routing (CIDR) notation IP address range for which to invalidate content. ",(0,r.kt)("a",{parentName:"td",href:"https://www.varnish-cache.org/docs/3.0/tutorial/purging.html"},"More information"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Backend host"),(0,r.kt)("td",{parentName:"tr",align:null},"Enter the fully qualified hostname or IP address and listen port of the Varnish backend or origin server; that is, the server providing the content Varnish will accelerate. Typically, this is your web server. ",(0,r.kt)("a",{parentName:"td",href:"https://www.varnish-cache.org/docs/trunk/users-guide/vcl-backends.html"},"More information"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Backend port"),(0,r.kt)("td",{parentName:"tr",align:null},"Origin server's listen port.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Grace period"),(0,r.kt)("td",{parentName:"tr",align:null},"The grace period determines how long Varnish serves stale content if the backend is not responsive. The default value is 300 seconds.")))),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Magento 2 with Varnish 6",src:t(78548).Z,width:"972",height:"849"})),(0,r.kt)("ol",{start:6},(0,r.kt)("li",{parentName:"ol"},"Click Save Config.")),(0,r.kt)("h2",{id:"export-a-varnish-configuration-file"},"Export a Varnish Configuration File"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Click one of the export button to create a ",(0,r.kt)("inlineCode",{parentName:"li"},"varnish.vcl")," you can use with Varnish.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Magento 2 with Varnish 6",src:t(94647).Z,width:"1028",height:"167"})),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Upload the file to ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/varnish/varnish.vcl"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"It is recommended to change the value of ",(0,r.kt)("inlineCode",{parentName:"p"},"acl purge")," to the IP address of the Varnish host."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},' acl purge {\n    "localhost";\n }\n')),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Edit ",(0,r.kt)("inlineCode",{parentName:"li"},"nano /etc/default/varnish")," to add the new configuration file:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"DAEMON_OPTS =\n  '-a :80 \\\n             -T localhost:6082 \\\n             -f /etc/varnish/varnish.vcl \\\n             -S /etc/varnish/secret \\\n             -s malloc,256m'\n")),(0,r.kt)("ol",{start:5},(0,r.kt)("li",{parentName:"ol"},"Static files should not be cached by default, but if you want to cache them, you can edit the section ",(0,r.kt)("inlineCode",{parentName:"li"},"Static files caching")," in the VCL to have the following content:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# Static files should not be cached by default\n  return (pass);\n\n# But if you use a few locales and don't use CDN you can enable caching static files by commenting previous line (#return (pass);) and uncommenting next 3 lines\n  #unset req.http.Https;\n  #unset req.http./*  */;\n  #unset req.http.Cookie;\n")),(0,r.kt)("ol",{start:6},(0,r.kt)("li",{parentName:"ol"},"And reload Varnish and NGINX:")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl daemon-reload\nservice varnish restart\nservice nginx restart\n")),(0,r.kt)("ol",{start:7},(0,r.kt)("li",{parentName:"ol"},"Now that you\u2019re using the ",(0,r.kt)("inlineCode",{parentName:"li"},"default.vcl")," generated for you by Magento, you can perform some final verifications to make sure Varnish is working.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -I -v --location-trusted 'http://my.domain.com'\n")),(0,r.kt)("h2",{id:"the-varnishing-of-the-topmenu"},"The Varnishing of the TopMenu"),(0,r.kt)("p",null,"After switching to Varnish I noticed that my ",(0,r.kt)("em",{parentName:"p"},"topmenu")," module was no longer loading. Checking the page source showed me that the ",(0,r.kt)("a",{parentName:"p",href:"https://varnish-cache.org/docs/6.0/users-guide/esi.html"},"Edge Side Include")," was failing:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Varnish 6 on Magento 2",src:t(56995).Z,width:"1158",height:"718"})),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/magento/magento2/issues/3421"},"problem in my case")," was a ",(0,r.kt)("inlineCode",{parentName:"p"},'ttl="3600"')," parameter given in the menu component that has to be deleted:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<?xml version="1.0"?>\n<page xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="urn:magento:framework:View/Layout/etc/page_configuration.xsd">\n    <body>\n        <referenceContainer name="div.sidebar.main">\n            <block class="TemplateMonster\\Megamenu\\Block\\Html\\Topmenu"\n                   name="catalog.sidebarnav"\n                   template="TemplateMonster_Megamenu::html/topmenu.phtml"\n                   ifconfig="megamenu/config/megamenu_general_show_left"\n                   before="-"\n                   ttl="3600" />\n        </referenceContainer>\n        <referenceBlock name="catalog.topnav" template="TemplateMonster_Megamenu::html/topmenu.phtml" />\n    </body>\n')),(0,r.kt)("p",null,"I found this block in ",(0,r.kt)("inlineCode",{parentName:"p"},"themeXXX\\app\\code\\TemplateMonster\\Megamenu\\view\\frontend\\layout\\default.xml")," in the template source. And on the server inside the magento installation dir ",(0,r.kt)("inlineCode",{parentName:"p"},"/vendor/magento/module-theme/view/frontend/layout/default.xml"),"."),(0,r.kt)("p",null,"There might also be issues with ",(0,r.kt)("a",{parentName:"p",href:"https://support.magento.com/hc/en-us/articles/360028757791-Top-navigation-panel-does-not-load-on-storefront"},"HTTPS on the backend side"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"nano /etc/default/varnish\n")),(0,r.kt)("p",null,"In the DAEMON_OPTS variable, add -p feature=+esi_ignore_https, -p feature=+esi_ignore_other_elements, -p feature=+esi_disable_xml_check. This would look like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"DAEMON_OPTS =\n  '-a :80 \\\n             -p feature=+esi_ignore_other_elements \\\n             -p feature=+esi_disable_xml_check \\\n             -p feature=+esi_ignore_https \\\n             -T localhost:6082 \\\n             -f /etc/varnish/varnish.vcl \\\n             -S /etc/varnish/secret \\\n             -s malloc,256m'\n")),(0,r.kt)("p",null,"When you change this, you need to run ",(0,r.kt)("inlineCode",{parentName:"p"},"service varnish restart")," for the changes to take effect."),(0,r.kt)("h1",{id:"going-to-production-https"},"Going to Production (HTTPS)"),(0,r.kt)("p",null,"I am now going to use NGINX to add SSL encryption to my cached content - since ",(0,r.kt)("strong",{parentName:"p"},"Varnish does not natively supports encryption"),"."),(0,r.kt)("h2",{id:"etcvarnishdefaultvcl"},"/etc/varnish/default.vcl"),(0,r.kt)("p",null,"Magento will still be served on port ",(0,r.kt)("inlineCode",{parentName:"p"},"8080")," by NGINX - so we have to set the Varnish default backend accordingly (this is the default - nothing to change here):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},'backend default {\n    .host = "localhost";\n    .port = "8080";\n    .first_byte_timeout = 6000s;\n}\n')),(0,r.kt)("h2",{id:"etcdefaultvarnish"},"/etc/default/varnish"),(0,r.kt)("p",null,"For testing I set the Varnish listening port to port ",(0,r.kt)("inlineCode",{parentName:"p"},"80")," - I am now reversing it back to port ",(0,r.kt)("inlineCode",{parentName:"p"},"6081")," - the reasoning is that I will tell NGINX to automatically upgrade all incoming traffic on port ",(0,r.kt)("inlineCode",{parentName:"p"},"80")," (HTTP) to port ",(0,r.kt)("inlineCode",{parentName:"p"},"443")," (HTTPS). Port ",(0,r.kt)("inlineCode",{parentName:"p"},"6081")," will only be used on ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost")," and can be blocked to outside traffic:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},'DAEMON_OPTS="-a :6081 \\\n             -T localhost:6082 \\\n             -f /etc/varnish/default.vcl \\\n             -S /etc/varnish/secret \\\n             -s malloc,256m"\n')),(0,r.kt)("h2",{id:"etcsystemdsystemvarnishservice"},"/etc/systemd/system/varnish.service"),(0,r.kt)("p",null,"The SystemD service file also specifies the ports being used by Varnish. This seems redundant (they are also defined in the varnish configuration). So either remove them (i did not try) or revert them back to use the default ports ",(0,r.kt)("inlineCode",{parentName:"p"},"6081")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"6082"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},"[Unit]\nDescription=Varnish HTTP accelerator\nDocumentation=https://www.varnish-cache.org/docs/6.1/ man:varnishd\n\n[Service]\nType=simple\nLimitNOFILE=131072\nLimitMEMLOCK=82000\nExecStart=\nExecStart=/usr/sbin/varnishd -j unix,user=vcache -F -a :6081 -T localhost:6082 -f /etc/varnish/default.vcl -S /etc/varnish/secret -s malloc,256m\nExecReload=/usr/share/varnish/varnishreload\nProtectSystem=full\nProtectHome=true\nPrivateTmp=true\nPrivateDevices=true\n\n[Install]\nWantedBy=multi-user.target\n")),(0,r.kt)("h2",{id:"etcnginxconfddefaultconf"},"/etc/nginx/conf.d/default.conf"),(0,r.kt)("p",null,"The NGINX server needs 3 blocks:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"server block port 80"),": forced upgrade to HTTPS ",(0,r.kt)("inlineCode",{parentName:"li"},"443")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"server block port 8080"),": execute the Magento backend and make your shop available to Varnish"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"server block port 443"),": ",(0,r.kt)("inlineCode",{parentName:"li"},"proxy_pass")," the Varnish cash from port ",(0,r.kt)("inlineCode",{parentName:"li"},"6081")," to the web and add encryption")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-cfg"},"upstream fastcgi_backend {\n    server unix:/run/php/php7.3-fpm.sock;\n  }\n\nserver {\n    listen 80;\n    listen [::]:80;\n\n    server_name my.server-domain.com;\n\n    return 301 https://$server_name$request_uri;\n  }\n\nserver {\n   listen 8080;\n    server_name my.server-domain.com;\n    set $MAGE_ROOT /var/www/magento2;\n    set $MAGE_MODE developer; # or production\n    include /var/www/magento2/nginx.conf.sample;\n    fastcgi_read_timeout 600;\n    proxy_read_timeout 600;\n\n\n\n    set $MAGE_DEBUG_SHOW_ARGS 1;\n    set $MAGE_ROOT /var/www/magento2;\n\n    location ~ (index|get|static|report|404|503)\\.php$ {\n            fastcgi_pass   unix:/run/php/php7.0-fpm.sock;\n            fastcgi_buffers 1024 4k;\n            fastcgi_read_timeout 600s;\n            fastcgi_connect_timeout 600s;\n            fastcgi_index  index.php;\n            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;\n            include        fastcgi_params;\n        }\n\n      location / {\n          try_files $uri $uri/ /index.php$is_args$args;\n\n          proxy_read_timeout 600s;\n          proxy_connect_timeout 75s;\n          proxy_headers_hash_max_size 5120000;\n          proxy_headers_hash_bucket_size 640000;\n        }\n        #proxy the php scripts to php-fpm\n        location ~ \\.php$ {\n            include /etc/nginx/fastcgi.conf;\n            fastcgi_intercept_errors on;\n            fastcgi_pass unix:/var/run/php7.3-fpm.sock;\n        }\n}\n\n\n\nserver {\n\n    listen 443 ssl http2 default_server;\n    listen [::]:443 ssl;\n    server_name my.server-domain.com; # managed by Certbot\n\n    ssl on;\n\n    # ssl_certificate /etc/nginx/pems/public_cert.pem;\n    # ssl_certificate_key /etc/nginx/pems/privat_key.pem;\n    ssl_certificate /etc/letsencrypt/live/my.server-domain.com/fullchain.pem; # managed by Certbot\n    ssl_certificate_key /etc/letsencrypt/live/my.server-domain.com/privkey.pem; # managed by Certbot\n    include /etc/nginx/ssl/ssl-params.conf; # add additional SSL parameter\n    include /etc/nginx/conf.d/header.conf; ## add additional HEADER\n\n\n\n    location / {\n       proxy_pass http://127.0.0.1:6081;\n       proxy_set_header Host               $http_host;\n       proxy_set_header X-Forwarded-Host   $http_host;\n       proxy_set_header X-Real-IP          $remote_addr;\n       proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;\n       proxy_set_header X-Forwarded-Proto  https;\n       proxy_set_header X-Forwarded-Port   443;\n       proxy_buffer_size                   128k;\n       proxy_buffers                       4 256k;\n       proxy_busy_buffers_size             256k;\n       fastcgi_buffer_size                 32k;\n       fastcgi_buffers                     4 32k;\n   }\n\n\n}\n")),(0,r.kt)("h3",{id:"check-if-varnish-is-running"},"Check if Varnish is Running"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -I https://my.domain.com\n\nHTTP/2 200\nserver: nginx\ndate: Thu, 29 Apr 2021 09:19:57 GMT\ncontent-type: text/html; charset=UTF-8\nvary: Accept-Encoding\nvary: Accept-Encoding\nstrict-transport-security: max-age=31536000\ncontent-security-policy: upgrade-insecure-requests;\nx-content-type-options: nosniff\nx-xss-protection: 1; mode=block\nx-magento-cache-control: max-age=86400, public, s-maxage=86400\nage: 35212\nx-magento-cache-debug: HIT\ngrace: none\npragma: no-cache\nexpires: -1\ncache-control: no-store, no-cache, must-revalidate, max-age=0\naccept-ranges: bytes\nx-frame-options: DENY\nx-content-type-options: nosniff\nx-xss-protection: 1; mode=block\ncache-control: public, must-revalidate, proxy-revalidate, max-age=0\n")),(0,r.kt)("p",null,"You should see either a ",(0,r.kt)("inlineCode",{parentName:"p"},"x-magento-cache-debug: HIT")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"x-magento-cache-debug: MISS"),". If you are not seeing it:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Make sure that you activated the DEVELOPER mode in the Magento Server Block in NGINX: ",(0,r.kt)("inlineCode",{parentName:"p"},"set $MAGE_MODE developer;"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Activate ",(0,r.kt)("strong",{parentName:"p"},"Full Page Cache")," under ",(0,r.kt)("strong",{parentName:"p"},"System"),"/",(0,r.kt)("strong",{parentName:"p"},"Cache Management"),":"))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"bin/magento cache:status\n\nCurrent status:\n                        config: 1\n                        layout: 1\n                    block_html: 1\n                   collections: 1\n                    reflection: 1\n                        db_ddl: 1\n               compiled_config: 1\n                           eav: 1\n         customer_notification: 1\n            config_integration: 1\n        config_integration_api: 1\n                google_product: 1\n                     full_page: 0\n             config_webservice: 1\n                     translate: 1\n                        vertex: 1\n")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Magento 2 with Varnish 6",src:t(88706).Z,width:"800",height:"525"})),(0,r.kt)("h2",{id:"excluding-backend-urls"},"Excluding Backend URLs"),(0,r.kt)("h3",{id:"defaultvcl"},"default.vcl"),(0,r.kt)("p",null,"Add exclude statements to ",(0,r.kt)("inlineCode",{parentName:"p"},"/etc/varnish/default.vcl"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-vcl"},'sub vcl_recv {\n\n    if (req.url == "/example.html") {\n          return(pass);\n    }\n\n    # Static files caching\n    if (req.url ~ "/downloads/") {\n        # Static files should not be cached by default\n        return (pass);\n\n        # But if you use a few locales and don\'t use CDN you can enable caching static files by commenting previous line (#return (pass);) and uncommenting next 3 lines\n        #unset req.http.Https;\n        #unset req.http.SSL-OFFLOADED;\n        #unset req.http.Cookie;\n    }\n\n    if (req.url ~ "^/(pub/)?(media|static)/") {\n        # Static files should not be cached by default\n        return (pass);\n    }\n\n    return (hash);\n}\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-vcl"},'sub vcl_backend_response {\n\n    if (bereq.url == "/example.html") {\n        set beresp.uncacheable = true;\n        set beresp.ttl = 120s;\n        return(deliver);\n    }\n\n    if (bereq.url ~ "/downloads/") {\n        set beresp.uncacheable = true;\n        set beresp.ttl = 120s;\n        return(deliver);\n    }\n\n    if (bereq.url ~ "^/(pub/)?(media|static)/") {\n        set beresp.uncacheable = true;\n        set beresp.ttl = 120s;\n        return(deliver);\n    }\n\n    return (deliver);\n}\n')),(0,r.kt)("h3",{id:"testing"},"Testing"),(0,r.kt)("p",null,"Now check your pages for the ",(0,r.kt)("inlineCode",{parentName:"p"},"x-magento-cache-debug: HIT")," result:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -I https://www.instar.com/\n\nHTTP/2 200\nserver: nginx\ndate: Tue, 27 Jul 2021 07:30:13 GMT\ncontent-type: text/html; charset=UTF-8\nvary: Accept-Encoding\nvary: Accept-Encoding\nstrict-transport-security: max-age=31536000\ncontent-security-policy: upgrade-insecure-requests;\nx-content-type-options: nosniff\nx-xss-protection: 1; mode=block\nx-magento-cache-control: max-age=86400, public, s-maxage=86400\nage: 83\nx-magento-cache-debug: HIT\ngrace: none\npragma: no-cache\nexpires: -1\ncache-control: no-store, no-cache, must-revalidate, max-age=0\naccept-ranges: bytes\nx-frame-options: DENY\nx-content-type-options: nosniff\nx-xss-protection: 1; mode=block\ncache-control: public, must-revalidate, proxy-revalidate, max-age=0\naccess-control-allow-origin: *\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'curl -I https://www.instar.com/static/test.txt\n\nHTTP/2 200\nserver: nginx\ndate: Tue, 27 Jul 2021 07:31:10 GMT\ncontent-type: text/plain; charset=utf-8\ncontent-length: 10\nlast-modified: Tue, 06 Jul 2021 06:55:08 GMT\netag: "60e3fe4c-a"\naccept-ranges: bytes\nx-frame-options: DENY\nx-content-type-options: nosniff\nx-xss-protection: 1; mode=block\ncache-control: public, must-revalidate, proxy-revalidate, max-age=0\naccess-control-allow-origin: *\n')),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'curl -I https://www.instar.com/instar/downloads/IN-9008-PoE_FW_4.1.2.48_WebUI_3.0.\\(328\\)_update.zip\n\nHTTP/2 200\nserver: nginx\ndate: Tue, 27 Jul 2021 07:32:19 GMT\ncontent-type: application/zip\ncontent-length: 7962962\nlast-modified: Mon, 14 Dec 2020 09:45:54 GMT\netag: "5fd73452-798152"\naccept-ranges: bytes\npragma: no-cache\nexpires: -1\ncache-control: no-store, no-cache, must-revalidate, max-age=0\nx-frame-options: DENY\nx-content-type-options: nosniff\nx-xss-protection: 1; mode=block\ncache-control: public, must-revalidate, proxy-revalidate, max-age=0\naccess-control-allow-origin: *\n')))}d.isMDXComponent=!0},88706:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Full-Page-Cache-3e9c388e5e9c994c0ad6fe4b1c823829.png"},78548:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Magento_Varnish_01-b18a2fcee34a61cc368a83a8582621a6.png"},94647:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Magento_Varnish_02-c067fa7020d27385f4423aa701be06e0.png"},56995:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/Varnish_ESI_Problems_01-e03a7730bf6a29fcdb31a10dc881080b.png"},35203:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/photo-kt456d_645dhfh6dgjkhg4_d-145ed6eb6aa8262c20e6ec230401d047.jpg"}}]);